

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>AFRICA PHONE - Gestion des Ventes</title>
  <!-- jsPDF and jsPDF-AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-auth-compat.js"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@0.474.0/dist/umd/lucide.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
  <!-- Link to the manifest -->
<link rel="manifest" href="manifest.json">
<!-- Charger SheetJS pour générer des .xlsx -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dynamsoft-barcode-reader-bundle@10.5.3000/dist/dbr.bundle.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"></script>
<script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css" />
<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

<!-- Set the theme color (should match the one in your manifest) -->
<meta name="theme-color" content="#006064">
  <style>
        /* Masquage automatique des prix pour les employés */
    body.role-employe .price-label {
      display: none !important;
    }

    body.role-employe #nav-tresorerie,
body.role-employe #nav-menu,
body.role-employe #nav-appro-hist,
body.role-employe #nav-aide-commande {
  display: none !important;
}

body.role-employe .delete-btn {
  display: none !important;
}

body.role-employe #screen-accueil .ako-quick-item[data-role="manager"],
body.role-employe #screen-accueil .ako-card.receivables {
  display: none !important;
}

body.role-employe #screen-accueil .ako-quick-grid {
  grid-template-columns: repeat(2, minmax(0, 1fr));
}

.performance-metrics {
  display: grid;
  gap: 16px;
}

.performance-card {
  background: var(--white);
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.performance-card h3 {
  margin: 0;
  font-size: 16px;
  color: var(--secondary-color);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.performance-card strong {
  font-size: 26px;
  color: var(--primary-color);
}

.performance-card small {
  color: var(--secondary-color);
}

.performance-loader {
  text-align: center;
  padding: 20px 0;
  color: var(--secondary-color);
  font-style: italic;
}

.performance-empty {
  text-align: center;
  color: var(--secondary-color);
  margin: 20px 0 0;
}

.inventory-preview {
  display: none;
  background: var(--white);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 16px;
      margin-top: 15px;
    }

    .inventory-preview.active {
      display: block;
    }

    .inventory-preview h2,
    .inventory-preview h3 {
      margin: 0 0 8px;
      color: var(--primary-color);
      font-size: 18px;
    }

    .inventory-preview-subtitle {
      margin: 0 0 12px;
      color: var(--secondary-color);
      font-size: 13px;
    }

    .inventory-preview table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .inventory-preview th,
    .inventory-preview td {
      border: 1px solid #e0e0e0;
      padding: 8px;
      font-size: 14px;
    }

    .inventory-preview th {
      background: #f5f5f5;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.05em;
    }

    .inventory-preview td.align-center {
      text-align: center;
      font-weight: 600;
    }

    .inventory-preview tfoot td {
      font-weight: 700;
      background: #fafafa;
    }

    .inventory-preview .inventory-placeholder,
    .inventory-preview .inventory-error {
      margin: 0;
      font-size: 14px;
      color: var(--secondary-color);
    }

    .inventory-preview .inventory-error {
      color: #d32f2f;
    }

    .inventory-preview .inventory-section {
      margin-top: 16px;
    }

    body.role-employe #screen-menu .menu-list-item[onclick*=\'tresorerie\'],
    body.role-employe #screen-menu .menu-list-item[onclick*=\'approvisionnement\'] {
      display: none !important;
    }

    .nav-item.hidden-by-role {
      display: none !important;
    }

    /* Désactivation globale de la sélection de texte (sauf input et textarea) */
    body *:not(input):not(textarea) {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

  /* CORRECTIF POUR LE SCROLL APRÈS L'AJOUT D'IONIC
  */
  .screen {
    /* Permet à chaque écran d'avoir sa propre barre de défilement si le contenu dépasse */
    overflow-y: auto; 
    
    /* On s'assure que l'écran ne dépasse pas de la vue visible.
       100vh = 100% de la hauteur de l'écran.
       On soustrait la hauteur de votre barre de navigation du bas (~60px) 
       et le padding du conteneur #app (~15px) pour éviter une double barre de scroll.
    */
    height: calc(100vh - 75px); 
  }

  /* On exclut l'écran de détail de cette règle, car Ionic s'en occupe déjà */
  #screen-article-detail {
      height: auto;
      overflow-y: initial;
  }

  /* On exclut aussi l'écran de démarrage qui doit être centré */
   #screen-start-day {
      height: 100vh;
      overflow-y: hidden;
   }

    /* Désactivation de l'effet de sélection (outline) sur boutons, liens et éléments cliquables */
    button, a, div.section, div.nav-item, div.shortcut {
      outline: none;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    /* Preloader Styles */
    #preloader {
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      z-index: 5000;
      background-color: var(--white);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .spinner {
      border: 8px solid #f3f3f3;
      border-top: 8px solid var(--primary-color);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Sale Loader Popup Styles */
    #saleLoader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 6000;
      background: rgba(255,255,255,0.8);
      display: none;
      align-items: center;
      justify-content: center;
    }
    #saleLoader .loader-content {
      text-align: center;
    }
    #saleLoader .loader-content p {
      font-size: 16px;
      color: var(--primary-color);
      margin-top: 10px;
    }
    /* Toast Notification */
    #toast {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #007BFF;
      color: white;
      padding: 12px 24px;
      border-radius: 5px;
      z-index: 3000;
      font-size: 16px;
    }
    /* Sale Stepper Styles */
    .sale-step {
      display: none;
      animation: slideIn 0.3s ease-in-out;
    }
    .sale-step.active {
      display: block;
    }
    .step-intro {
      font-size: 15px;
      color: #475569;
      margin: 6px 0 22px;
    }
    .step-two-layout {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .step-two-layout .info-card {
      flex: 1 1 320px;
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.22);
      padding: 22px;
      box-shadow: 0 25px 45px rgba(15, 23, 42, 0.08);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .info-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }
    .info-card-header h3 {
      margin: 0;
      font-size: 18px;
      color: var(--text-color);
    }
    .info-card-header p {
      margin: 4px 0 0 0;
      font-size: 13px;
      color: #6b7280;
    }
    .info-badge {
      background: rgba(59,130,246,0.12);
      color: #1d4ed8;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      align-self: flex-start;
    }
    .livraison-lieu label {
      font-weight: 600;
      display: block;
      color: #1f2937;
      margin-bottom: 6px;
    }
    .livraison-lieu input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 15px;
    }
    .livraison-lieu small {
      display: block;
      margin-top: 6px;
      color: #6b7280;
      font-size: 12px;
    }
    #screen-accueil {
      --ako-blue: #2b6de9;
      --ako-dark: #0e1326;
      --ako-success: #27c29a;
      --ako-orange: #ff9f3d;
      --ako-red: #ff4155;
      --ako-bg: #f5f7fb;
      --ako-card: #ffffff;
      --ako-stroke: #e6e8ec;
      --ako-text: #0f172a;
      --ako-muted: #6b7280;
      background: var(--ako-bg);
      min-height: 100vh;
      padding: 0;
    }
    .ako-dashboard {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--ako-bg);
    }
    .ako-appbar {
      position: sticky;
      top: 0;
      z-index: 20;
      display: grid;
      grid-template-columns: 56px 1fr auto;
      align-items: center;
      height: 56px;
      padding: 0 12px;
      background: #fff;
      border-bottom: 1px solid var(--ako-stroke);
    }
    .ako-icon-btn {
      width: 44px;
      height: 44px;
      border: none;
      border-radius: 999px;
      background: transparent;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--ako-text);
      cursor: pointer;
    }
    .ako-brand {
      font-weight: 700;
      font-size: 18px;
      color: var(--ako-text);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .ako-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .ako-icon-circle {
      position: relative;
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: 1px solid var(--ako-stroke);
      background: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--ako-text);
    }
    .ako-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      padding: 2px 6px;
      line-height: 1;
      border-radius: 999px;
      background: var(--ako-red);
      color: #fff;
      font-size: 10px;
      font-weight: 600;
      border: 2px solid #fff;
    }
    .ako-tabs {
      position: relative;
      display: flex;
      align-items: center;
      gap: 24px;
      height: 56px;
      padding: 0 16px;
      background: #fff;
      border-bottom: 1px solid var(--ako-stroke);
    }
    .ako-tab {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: none;
      background: transparent;
      color: var(--ako-muted);
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      padding: 10px 0;
    }
    .ako-tab.is-active {
      color: var(--ako-blue);
      font-weight: 700;
    }
    .ako-tab-indicator {
      position: absolute;
      bottom: 0;
      left: 16px;
      width: 110px;
      height: 3px;
      border-radius: 2px;
      background: var(--ako-blue);
    }
    .ako-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
    }
    .ako-welcome {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 12px;
      align-items: center;
    }
    .ako-welcome-icon {
      font-size: 20px;
    }
    .ako-welcome-text h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 800;
      color: var(--ako-text);
    }
    .ako-welcome-text p {
      margin: 4px 0 0;
      color: var(--ako-muted);
      font-size: 15px;
    }
    .ako-date {
      margin-top: 6px;
      font-size: 13px;
      color: var(--ako-muted);
    }
    .ako-card {
      background: var(--ako-card);
      border: 1px solid var(--ako-stroke);
      border-radius: 16px;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .ako-quick-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }
    .ako-quick-item {
      display: grid;
      gap: 6px;
      place-items: center;
      border: none;
      background: transparent;
      color: var(--ako-text);
      font-weight: 600;
      font-size: 13px;
      text-align: center;
      cursor: pointer;
    }
    .ako-quick-avatar {
      position: relative;
      display: grid;
      place-items: center;
      width: 56px;
      height: 56px;
      border-radius: 999px;
      background: rgba(43, 109, 233, 0.1);
      color: var(--ako-blue);
    }
    .ako-quick-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: #fff;
      color: var(--ako-blue);
      border: 2px solid var(--ako-card);
      font-size: 12px;
      font-weight: 700;
      display: grid;
      place-items: center;
    }
    .ako-card.receivables {
      gap: 12px;
    }
    .ako-receivables-content {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 16px;
      align-items: center;
    }
    .ako-receivables-content h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      color: var(--ako-text);
    }
    .ako-receivables-content p {
      margin: 6px 0 16px;
      color: var(--ako-muted);
      font-size: 14px;
      line-height: 1.4;
    }
    .ako-btn-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 0 20px;
      height: 44px;
      border-radius: 999px;
      background: var(--ako-dark);
      color: #fff;
      font-weight: 700;
      font-size: 15px;
      border: none;
      cursor: pointer;
    }
    .ako-receivables-visual {
      width: 100px;
      height: 72px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(43, 109, 233, 0.12), rgba(39, 194, 154, 0.18));
      position: relative;
      overflow: hidden;
    }
    .ako-chart-line {
      position: absolute;
      inset: 16px;
      border-bottom: 2px solid rgba(43, 109, 233, 0.4);
      border-left: 2px solid rgba(43, 109, 233, 0.4);
      transform: skewY(-10deg);
      border-radius: 4px;
    }
    .ako-chart-point {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--ako-orange);
      right: 18px;
      top: 18px;
      box-shadow: 0 0 0 4px rgba(255, 159, 61, 0.25);
    }
    .ako-hidden-data {
      display: none !important;
    }
    @media (max-width: 420px) {
      .ako-tabs {
        gap: 16px;
      }
      .ako-tab-indicator {
        width: 96px;
      }
      .ako-quick-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .ako-receivables-content {
        grid-template-columns: 1fr;
      }
      .ako-receivables-visual {
        margin-top: 4px;
      }
    }
    @media (max-width: 360px) {
      .ako-main {
        padding: 12px;
      }
      .ako-appbar {
        padding: 0 8px;
      }
    }
    .client-search-hint {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }
    .client-search-mode {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .client-type-group {
      margin-bottom: 16px;
    }
    .client-type-group-title {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
      display: block;
      margin-bottom: 6px;
    }
    .client-type-options {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .client-type-chip {
      display: inline-flex;
      align-items: center;
    }
    .client-type-hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
      display: block;
    }
    .selection-summary {
      border: 1px dashed rgba(59,130,246,0.3);
      background: rgba(59,130,246,0.08);
      border-radius: var(--border-radius);
      padding: 12px 14px;
      margin-bottom: 16px;
      color: #1f2937;
      font-size: 15px;
    }
    .selection-summary p {
      margin: 0;
      font-weight: 500;
    }
    .selection-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-top: 12px;
    }
    .selection-actions .btn-modern {
      flex: 0 0 auto;
    }
    .selection-actions .btn-link {
      flex: 0 0 auto;
    }
    .selection-page {
      max-width: 720px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }
    .selection-page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 20px;
    }
    .selection-page-header h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 700;
      color: #0f172a;
      flex: 1;
      text-align: center;
    }
    .selection-page-body {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .selection-page .back-btn {
      flex: 0 0 auto;
      white-space: nowrap;
    }
    .btn-icon {
      background: #1d4ed8;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 42px;
      height: 42px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .btn-icon:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(29,78,216,0.25);
    }
    .btn-icon i {
      width: 20px;
      height: 20px;
    }
    .selection-search-bar {
      gap: 0;
    }
    .selection-search-bar input {
      flex: 1;
    }
    .selection-form {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .selection-form label {
      font-weight: 600;
      color: #0f172a;
    }
    .selection-form input {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 15px;
    }
    .new-client-type-group {
      border: 1px solid rgba(59,130,246,0.2);
      border-radius: var(--border-radius);
      padding: 14px;
      background: #f8fafc;
    }
    .new-client-type-options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .client-type-radio {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 999px;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .client-type-radio input {
      margin: 0;
    }
    .client-type-radio:hover {
      border-color: rgba(59,130,246,0.6);
      box-shadow: 0 2px 8px rgba(59,130,246,0.15);
    }
    .client-type-radio input:checked + span,
    .client-type-radio input:checked ~ span {
      font-weight: 600;
      color: #1d4ed8;
    }
    .selection-form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 8px;
    }
    .client-type-tag {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      margin-top: 6px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(59,130,246,0.12);
      color: #1d4ed8;
    }
    .client-type-tag.revendeur {
      background: rgba(16,185,129,0.15);
      color: #047857;
    }
    .client-type-tag.ordinaire {
      background: rgba(59,130,246,0.12);
      color: #1d4ed8;
    }
    .client-search-chip {
      border: 1px solid rgba(59,130,246,0.3);
      background: rgba(59,130,246,0.1);
      color: #1d4ed8;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .client-search-chip.active {
      background: #1d4ed8;
      color: #fff;
      border-color: #1d4ed8;
    }
    .client-search-chip:hover {
      transform: translateY(-1px);
    }
    .client-search-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .client-search-bar input {
      flex: 1 1 220px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-size: 15px;
    }
    .client-search-feedback {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 10px;
    }
    .client-search-results {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 260px;
      overflow-y: auto;
      margin-bottom: 12px;
    }
    .client-search-result {
      border: 1px solid #e2e8f0;
      border-radius: var(--border-radius);
      padding: 12px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      background: #fff;
    }
    .client-search-result:hover {
      border-color: #93c5fd;
      box-shadow: 0 4px 12px rgba(59,130,246,0.12);
    }
    .client-search-result.selected {
      border-color: #1d4ed8;
      box-shadow: 0 4px 16px rgba(29,78,216,0.18);
    }
    .client-search-result h4 {
      margin: 0;
      font-size: 15px;
      color: #1f2937;
    }
    .client-search-result span {
      font-size: 13px;
      color: #6b7280;
    }
    .client-selected-summary {
      background: rgba(34,197,94,0.1);
      border: 1px solid rgba(34,197,94,0.3);
      border-radius: var(--border-radius);
      padding: 12px;
      margin-bottom: 12px;
    }
    .client-selected-summary h3 {
      margin: 0 0 6px 0;
      font-size: 15px;
      color: #166534;
    }
    .client-selected-summary p {
      margin: 0;
      font-size: 14px;
      color: #14532d;
    }
    .client-search-actions {
      margin-bottom: 10px;
    }
    .client-create-form {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: var(--border-radius);
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 12px rgba(15,23,42,0.08);
    }
    .client-create-form h3 {
      margin-top: 0;
      margin-bottom: 12px;
      font-size: 16px;
      color: #1f2937;
    }
    .client-create-actions {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }
    .btn-link {
      border: none;
      background: none;
      color: #2563eb;
      font-size: 14px;
      cursor: pointer;
      padding: 0;
    }
    .btn-link:hover {
      text-decoration: underline;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(100%); }
      to { opacity: 1; transform: translateX(0); }
    }
    .step-navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
    }
    .vente-payments-block {
      margin-top: 15px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .vente-payments-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .vente-payments-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .vente-payment-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: 10px;
      align-items: center;
    }
    .vente-payment-row select,
    .vente-payment-row input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      background: #fff;
    }
    .vente-payment-remove {
      min-width: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .vente-payments-summary {
      font-size: 14px;
      line-height: 1.5;
      background: #f8f9fb;
      padding: 10px;
      border-radius: var(--border-radius);
    }
    .vente-payments-summary p {
      margin: 0;
    }
    .vente-payment-warning {
      color: #c0392b;
      font-weight: 600;
      margin-top: 6px;
    }
    .vente-payment-row-vente {
      display: block;
    }
    .vente-payment-card {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: var(--border-radius);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      box-shadow: 0 3px 14px rgba(15, 23, 42, 0.08);
    }
    .vente-payment-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .vente-payment-card-header .vente-payment-account {
      flex: 1;
    }
    .vente-payment-card-header .vente-payment-remove {
      width: auto;
      margin-bottom: 0;
    }
    .vente-payment-amounts {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    .vente-payment-amounts input {
      width: 100%;
    }
    .vente-payment-proof-actions {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      width: 100%;
    }
    .vente-payment-proof-actions .btn-modern {
      margin-bottom: 0;
    }
    @media (max-width: 520px) {
      .vente-payment-card {
        padding: 12px;
      }
      .vente-payment-card-header {
        flex-direction: column;
        align-items: stretch;
      }
      .vente-payment-card-header .vente-payment-remove {
        width: 100%;
      }
      .vente-payment-proof-actions {
        grid-template-columns: 1fr;
      }
    }

    /* Barre de progression fluide */
    .progress-container {
      position: relative;
      width: 100%;
      height: 8px;
      background: #f0f0f0;
      border-radius: 4px;
      margin: 10px 0;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: var(--primary-color);
      transition: width 0.4s ease;
    }
    #progressText {
      margin-top: 5px;
      font-size: 14px;
      color: var(--text-color);
      text-align: center;
      display: block;
    }
    /* CSS Variables */
    :root {
      --primary-color: #006064;
      --secondary-color: #004d40;
      --accent-color: #ff6f00;
      --bg-color: #f5f7fa;
      --white: #ffffff;
      --text-color: #333;
      --border-radius: 8px;
      --shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    /* Global Reset & Mobile Base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Roboto', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      overflow-x: hidden;
    }
    input, button, textarea, select {
      font-family: inherit;
      font-size: 18px;
    }
    /* App container and screens */
    #app {
      padding-bottom: 60px;
    }
    .screen {
      display: none;
      padding: 15px;
    }
    .screen.active {
      display: block;
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    header {
      text-align: center;
      margin-bottom: 15px;
      position: relative;
    }
    header h1 {
      font-size: 22px;
      color: var(--primary-color);
    }
    .back-btn {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--primary-color);
    }
    .logo {
      font-size: 24px;
      font-weight: bold;
      color: var(--accent-color);
      margin-bottom: 5px;
    }
    .timestamp {
      font-size: 14px;
      color: var(--secondary-color);
      margin-top: 5px;
    }
    /* Form sections */
    .form-section {
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }
    .form-section h2 {
      margin-bottom: 15px;
      color: var(--primary-color);
      font-size: 20px;
      text-align: center;
    }
    .vente-form label {
      font-weight: 500;
      margin-bottom: 8px;
      display: block;
      font-size: 16px;
    }
    .vente-form input,
    .vente-form textarea,
    .vente-form button,
    .vente-form select {
      width: 100%;
      padding: 12px;
      margin-bottom: 16px;
      border: 1px solid #ccc;
      border-radius: var(--border-radius);
      font-size: 16px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    .vente-form input:focus,
    .vente-form textarea:focus,
    .vente-form select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 8px rgba(0, 96, 100, 0.2);
      outline: none;
    }
    /* Modern Input Fields with Icons */
    .input-with-icon {
      position: relative;
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }
    .input-with-icon i {
      position: absolute;
      left: 10px;
      font-size: 24px;
      color: var(--primary-color);
    }
    .input-with-icon input {
      width: 100%;
      padding: 10px 10px 10px 40px;
      border: 1px solid #ccc;
      border-radius: var(--border-radius);
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    .input-with-icon input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 8px rgba(0, 96, 100, 0.2);
      outline: none;
    }
    /* Boutons Modernes Inspirés des Apps Mobiles */
    .btn-modern {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 14px;
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      border: none;
      border-radius: 50px;
      background: linear-gradient(45deg, #1877F2, #0056b3);
      color: white;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: transform 0.1s ease-in-out, box-shadow 0.2s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      outline: none;
      margin-bottom: 10px;
    }
    .btn-modern:active {
      transform: scale(0.96);
    }
    .btn-modern::after {
      content: "";
      position: absolute;
      width: 200%;
      height: 200%;
      background: rgba(255, 255, 255, 0.3);
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      border-radius: 50%;
      transition: transform 0.4s ease-out;
      pointer-events: none;
    }
    .btn-modern:active::after {
      transform: translate(-50%, -50%) scale(1);
    }
    .btn-modern i {
      margin-right: 8px;
      font-size: 24px;
    }
    .btn-modern.secondary {
      background: #E4E6EB;
      color: black;
      box-shadow: none;
    }
    /* Stock Section */
    .cards-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .product-card {
      background: var(--white);
      border: 1px solid #ccc;
      border-radius: var(--border-radius);
      padding: 12px;
      width: calc(50% - 10px);
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
    }
    #stock-category .product-card {
      width: 100% !important;
    }
    .product-icon {
      font-size: 36px;
      margin-right: 10px;
    }
    .product-details h3 {
      margin: 0 0 5px;
      font-size: 18px;
    }
    .price-item {
      background: var(--white);
      border: 1px solid #ccc;
      border-radius: var(--border-radius);
      padding: 12px;
      margin-bottom: 10px;
      font-size: 18px;
    }
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      padding: 15px;
    }
    .modal-content {
      background: var(--white);
      border-radius: var(--border-radius);
      width: 100%;
      max-width: 500px;
      max-height: 90%;
      overflow-y: auto;
      padding: 15px;
      position: relative;
      box-shadow: var(--shadow);
    }
    .modal-content h2 {
      margin-bottom: 10px;
      text-align: center;
      font-size: 20px;
      color: var(--primary-color);
    }
    .modal .close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 26px;
      font-weight: bold;
      color: var(--text-color);
      cursor: pointer;
    }
    .modal .sale-type-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 20px;
    }
    .modal .btn-modal-option {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 12px 16px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .modal .btn-modal-option i {
      font-size: 22px;
    }
    .modal .btn-modal-option.direct {
      background: var(--primary-color);
      color: var(--white);
    }
    .modal .btn-modal-option.delivery {
      background: #fbe9d7;
      color: #c56812;
    }
    .modal .btn-modal-option:active {
      transform: scale(0.97);
    }
    .purchase-modal-content {
      max-width: 520px;
      padding: 20px 24px 24px;
    }
    .purchase-modal-body {
      max-height: 70vh;
      overflow-y: auto;
    }
    .purchase-modal-card {
      background: var(--white);
      border-radius: var(--border-radius);
      box-shadow: 0 18px 35px rgba(52, 72, 128, 0.18);
      padding: 18px 20px;
      margin-top: 12px;
    }
    .purchase-modal-card .main-content-wrapper {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
    }
    .purchase-modal-card .avatar-circle {
      width: 44px;
      height: 44px;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      color: #fff;
      font-weight: 600;
    }
    .purchase-modal-card .left-info {
      display: flex;
      flex-direction: column;
      flex: 1;
    }
    .purchase-modal-card .supplier-name {
      font-weight: 600;
      font-size: 16px;
      color: #222;
      margin-bottom: 4px;
    }
    .purchase-modal-card .purchase-date {
      font-size: 13px;
      color: #6b7280;
    }
    .purchase-modal-card .item-list-container {
      margin-top: 8px;
    }
    .purchase-modal-card .item-line {
      margin: 0;
      font-size: 14px;
      color: #374151;
    }
    .purchase-modal-card .right-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      min-width: 120px;
    }
    .purchase-modal-card .total-amount {
      font-weight: 600;
      font-size: 18px;
      color: #333;
      margin-bottom: 4px;
    }
    .purchase-modal-card .payment-method {
      font-size: 13px;
      color: #6b7280;
      text-transform: uppercase;
      font-weight: 500;
    }
    .movement-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin-top: 18px;
      padding: 16px;
      background: #f4f6fb;
      border-radius: var(--border-radius);
      font-size: 13px;
      color: #374151;
    }
    .movement-summary strong {
      display: inline-block;
      margin-right: 4px;
      color: #111827;
    }
    .purchase-modal-note {
      margin-top: 14px;
      font-size: 13px;
      color: #6b7280;
      line-height: 1.4;
    }
    .history-reason {
      display: block;
      margin-top: 6px;
      font-size: 12px;
      color: #6b7280;
    }
    .stock-adjust-modal {
      max-width: 420px;
      padding: 22px 24px 26px;
    }
    .stock-adjust-modal h2 {
      text-align: center;
      margin-bottom: 12px;
      color: var(--primary-color);
    }
    .stock-adjust-hint {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 16px;
      line-height: 1.4;
    }
    .stock-adjust-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .stock-adjust-form label {
      font-size: 13px;
      font-weight: 600;
      color: #374151;
    }
    .stock-adjust-form input,
    .stock-adjust-form textarea {
      width: 100%;
      border: 1px solid #d6d9e4;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      resize: vertical;
      background: #fff;
    }
    .stock-adjust-form input:focus,
    .stock-adjust-form textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(56, 128, 255, 0.18);
    }
    .stock-adjust-error {
      margin-top: -4px;
      font-size: 13px;
      color: #b91c1c;
      background: rgba(248, 113, 113, 0.12);
      border-radius: 6px;
      padding: 8px 10px;
    }
    .stock-adjust-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 8px;
    }
    .modal-warning-list {
      margin: 15px 0;
      padding-left: 20px;
      color: var(--text-color);
      font-size: 15px;
    }
    .modal-warning-list li {
      margin-bottom: 8px;
      line-height: 1.4;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 20px;
    }
    /* Bottom Navigation Modernisée */
    .bottom-nav-pro {
      display: flex;
      justify-content: space-around;
      background: #fff;
      border-top: 1px solid #ddd;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      padding: 5px 0;
    }
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      font-size: 12px;
      color: #555;
      transition: color 0.3s ease;
      padding: 5px 0;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    .nav-item.active {
      color: var(--primary-color);
      font-weight: bold;
      background: rgba(0, 96, 100, 0.1);
      border-radius: 12px;
    }
    .nav-item i {
      font-size: 24px;
      margin-bottom: 2px;
    }
    .nav-item::after {
      content: "";
      position: absolute;
      width: 200%;
      height: 200%;
      background: rgba(255, 255, 255, 0.3);
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      border-radius: 50%;
      transition: transform 0.4s ease-out;
      pointer-events: none;
    }
    .nav-item:active::after {
      transform: translate(-50%, -50%) scale(1);
    }
    /* Sales History Cards */
    .list-container {
      padding: 5px;
    }
    .vente-card {
      background: var(--white);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 12px;
      margin-bottom: 10px;
      font-size: 16px;
      position: relative;
      width: 100%;
    }
    .vente-card p {
      margin-bottom: 6px;
    }
    .vente-card button {
      width: auto;
      padding: 10px 14px;
      font-size: 16px;
      background-color: var(--primary-color);
      color: var(--white);
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      margin-right: 5px;
    }
    .vente-card button:hover {
      background-color: var(--secondary-color);
    }
    .delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      font-size: 22px;
      color: red;
      cursor: pointer;
    }
    .echouee {
      border: 2px solid red;
    }
    .panier-item {
      background: #fafafa;
      border: 1px solid #eee;
      border-radius: var(--border-radius);
      padding: 12px;
      margin-bottom: 8px;
      font-size: 16px;
    }
/* =============================== Drawer Menu =============================== */
#screen-menu {
  position: fixed;
  inset: 0;
  padding: 0 !important;
  display: none;
  z-index: 4010;
}

#screen-menu.active {
  display: block;
}

#screen-menu .drawer-scrim {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.45);
  opacity: 0;
  transition: opacity 0.24s ease;
  pointer-events: none;
}

#screen-menu.active .drawer-scrim {
  opacity: 1;
  pointer-events: auto;
}

#screen-menu .drawer-panel {
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  width: min(360px, 84vw);
  max-width: 360px;
  background: #ffffff;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.18);
  transform: translateX(-100%);
  transition: transform 0.24s ease;
  display: flex;
  flex-direction: column;
  padding-bottom: env(safe-area-inset-bottom, 16px);
  border-radius: 0;
}

#screen-menu.active .drawer-panel {
  transform: translateX(0);
}

#screen-menu .drawer-account {
  position: relative;
  display: grid;
  grid-template-columns: 48px 1fr 36px;
  align-items: center;
  gap: 12px;
  padding: 20px 16px 18px;
  padding-top: calc(env(safe-area-inset-top, 0px) + 16px);
  border-bottom: 1px solid #E6E8EC;
}

#screen-menu .drawer-avatar {
  width: 48px;
  height: 48px;
  border-radius: 999px;
  background: #EEF2FF;
  display: grid;
  place-items: center;
  font-size: 18px;
  font-weight: 600;
  color: #2B6DE9;
}

#screen-menu .drawer-name {
  font-size: 17px;
  font-weight: 700;
  color: #111827;
}

#screen-menu .drawer-mail {
  font-size: 14px;
  font-weight: 500;
  color: #6B7280;
  margin-top: 4px;
}

#screen-menu .drawer-caret {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  border: 1px solid #E6E8EC;
  background: transparent;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  color: #111827;
  cursor: pointer;
}

#screen-menu .drawer-nav {
  padding: 12px 8px 24px;
  display: flex;
  flex-direction: column;
  gap: 4px;
  overflow-y: auto;
  flex: 1;
}

#screen-menu .drawer-item {
  display: grid;
  grid-template-columns: 28px 1fr auto;
  align-items: center;
  gap: 12px;
  height: 56px;
  padding: 0 12px;
  border-radius: 8px;
  background: transparent;
  border: none;
  color: #111827;
  font-size: 16px;
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
}

#screen-menu .drawer-item:focus-visible,
#screen-menu .drawer-item:hover {
  outline: none;
  background: #F5F7FB;
}

#screen-menu .drawer-item.is-active {
  background: #2B6DE9;
  color: #ffffff;
}

#screen-menu .drawer-item .drawer-icon {
  width: 24px;
  height: 24px;
  display: grid;
  place-items: center;
  color: currentColor;
}

#screen-menu .drawer-item.is-active .drawer-icon {
  color: #ffffff;
}

#screen-menu .drawer-item .drawer-chevron {
  margin-left: auto;
  color: inherit;
  transition: transform 0.2s ease;
}

#screen-menu .drawer-item[aria-expanded="true"] .drawer-chevron {
  transform: rotate(180deg);
}

#screen-menu .drawer-submenu {
  display: none;
  flex-direction: column;
  gap: 4px;
  padding: 4px 0 0 52px;
}

#screen-menu .drawer-submenu[aria-hidden="false"] {
  display: flex;
}

#screen-menu .drawer-subitem {
  background: transparent;
  border: none;
  padding: 8px 0;
  text-align: left;
  font-size: 14px;
  font-weight: 500;
  color: #6B7280;
  cursor: pointer;
}

#screen-menu .drawer-subitem:hover,
#screen-menu .drawer-subitem:focus-visible {
  color: #111827;
  outline: none;
}

#screen-menu .drawer-account-menu {
  position: absolute;
  right: 0;
  top: calc(100% + 8px);
  background: #ffffff;
  border: 1px solid #E6E8EC;
  border-radius: 12px;
  box-shadow: 0 12px 24px rgba(15, 23, 42, 0.12);
  padding: 8px;
  min-width: 190px;
  display: none;
  z-index: 2;
}

#screen-menu .drawer-account-menu[aria-hidden="false"] {
  display: grid;
  gap: 4px;
}

#screen-menu .drawer-account-menu button {
  background: transparent;
  border: none;
  padding: 10px;
  border-radius: 8px;
  text-align: left;
  font-size: 14px;
  font-weight: 500;
  color: #111827;
  cursor: pointer;
}

#screen-menu .drawer-account-menu button:hover,
#screen-menu .drawer-account-menu button:focus-visible {
  background: #F5F7FB;
  outline: none;
}

#screen-menu .drawer-account-menu button.danger {
  color: #DC2626;
}

body.drawer-open {
  overflow: hidden;
}

#screen-salaires {
  padding: 20px;
}

#screen-salaires .salary-grid {
  display: grid;
  gap: 15px;
  margin-bottom: 20px;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
}

#screen-salaires .salary-card {
  background: var(--white);
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
  padding: 16px;
}

#screen-salaires .salary-card h3 {
  font-size: 16px;
  color: var(--primary-color);
  margin-bottom: 8px;
}

#screen-salaires .salary-card p {
  font-size: 20px;
  font-weight: 600;
  margin: 0;
  color: #0f172a;
}

#screen-salaires .salary-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
}

#screen-salaires .salary-actions .btn-modern.secondary {
  background: linear-gradient(45deg, #64748b, #334155);
}

#screen-salaires .salary-actions .btn-modern.secondary:hover {
  box-shadow: 0 6px 16px rgba(100, 116, 139, 0.35);
}

#screen-salaires .salary-list {
  background: var(--white);
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
  overflow: hidden;
}

#screen-salaires .salary-list table {
  width: 100%;
  border-collapse: collapse;
}

#screen-salaires .salary-list th,
#screen-salaires .salary-list td {
  padding: 12px 16px;
  border-bottom: 1px solid #f1f5f9;
  text-align: left;
}

#screen-salaires .salary-list thead {
  background: #f8fafc;
  font-weight: 600;
  color: var(--primary-color);
}

#screen-salaires .empty-state {
  padding: 24px;
  text-align: center;
  color: #94a3b8;
}
    /* CSS pour l'écran de recherche d'article */
    #searchProduitInput {
      width: 100%;
      padding: 10px;
      border-radius: var(--border-radius);
      border: 1px solid #ccc;
      margin-bottom: 15px;
    }
    /* Styles ajoutés pour la liste de suggestions */
.suggestion-list {
  /* REMPLACEZ 'position: absolute;' par la ligne ci-dessous ou supprimez-la. */
  /* position: absolute; */ /* Ligne à commenter ou supprimer */
  position: static; /* NOUVELLE LIGNE: pour la remettre dans le flux */
  background: var(--white);
  border: 1px solid #ccc;
  /* z-index: 1000; */ /* Ligne à commenter ou supprimer, car pas nécessaire pour un élément statique */
  max-height: 150px;
  overflow-y: auto;
  width: 100%;
  display: none; /* Toujours caché par défaut via CSS */
  margin-top: 5px; /* Optionnel: ajoute un petit espace */
  box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Ajoute une légère ombre comme une carte */
  border-radius: var(--border-radius); /* Bords légèrement arrondis */
}
    .suggestion-item {
      padding: 8px 10px;
      cursor: pointer;
    }

    .suggestion-item:hover {
      background: #f0f0f0;
    }

    /* Style pour l'option "Ajouter nouveau fournisseur" */
.suggestion-item.add-new-supplier {
  background-color: #e0f2f7; /* Un fond bleu/vert très clair pour le distinguer */
  color: var(--primary-color); /* Couleur du texte principale */
  font-weight: 500;
  padding: 8px 10px;
  border-top: 1px solid #cce9ef; /* Une petite ligne de séparation subtile */
  cursor: pointer;
  display: flex; /* Pour aligner l'icône et le texte */
  align-items: center;
  gap: 5px; /* Espace entre l'icône et le texte */
  font-size: 14px; /* Rendre le texte plus petit */
  transition: background-color 0.2s ease;
}

.suggestion-item.add-new-supplier:hover {
  background-color: #cce9ef; /* Un peu plus foncé au survol */
}

.suggestion-item.add-new-supplier i {
  font-size: 16px; /* Taille de l'icône plus petite */
  margin-right: 2px;
}


  </style>
  <!-- Styles spécifiques aux suggestions déjà existants -->
  <style>


    /* Icône panier + badge */
.cart-icon {
  position: relative;
  cursor: pointer;
  font-size: 24px;
  color: var(--primary-color);
}

/* Au lieu de cacher tout le container, on cache juste le badge */
#searchCartCount {
  display: none;
}

/* Styles pour le conteneur du badge à l'intérieur du segment button */
#screen-approvisionnement-historique ion-segment-button[value="credit"] .credit-badge-container {
    display: flex; /* <-- ASSUREZ-VOUS QUE C'EST TOUJOURS FLEX */
    align-items: center;
    justify-content: center;
    width: 100%;
    position: relative;
    height: 100%;
    font-size: 15px;
}
.cart-icon .cart-badge {
  position: absolute;
  top: -5px;
  right: -10px;
  background: #f44336;
  color: #fff;
  font-size: 12px;
  line-height: 1;
  width: 18px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  pointer-events: none;
}

    
.accounts-container {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}
.account-card {
  flex: 1;
  background: #fff;
  padding: 12px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.account-card h3 {
  margin: 0 0 8px;
  font-size: 16px;
  color: #006064;
}
.account-card p {
  margin: 0;
  font-size: 18px;
  font-weight: bold;
}

/* === Cart Footer === */
.cart-footer {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 56px;              /* laisse la place à la bottom-nav-pro (hauteur ~56px) */
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 24px; 
  background: var(--white);
  box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
  z-index: 1001;
  /* === NOUVEAU : coins arrondis en haut === */
  border-top-left-radius: 16px;
  border-top-right-radius: 16px;
}

.cart-footer .footer-info,
.cart-footer .footer-total {
  display: flex;
  align-items: baseline;
  gap: 4px;
}

.cart-footer .footer-label {
  font-size: 14px;
  color: var(--text-color);
  font-weight: 500;
}

.cart-footer #footerQuantity,
.cart-footer #footerTotal {
  font-size: 18px;
  font-weight: bold;
  color: var(--primary-color);
}

/* Réduire le bouton "Suivant" du panier */
#cartFooter .btn-modern {
  padding: 6px 12px;      /* moins d'espace intérieur */
  font-size: 14px;        /* texte un peu plus petit */
  border-radius: 30px;    /* coins un peu moins arrondis */
  /* si besoin, limiter la largeur max : */
  max-width: 120px;
}
#screen-panier {
  height: 100vh;
}

#screen-panier .sale-type-badge {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 14px;
  border-radius: 999px;
  font-size: 13px;
  font-weight: 600;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  border: 1px solid transparent;
  margin-bottom: 15px;
  background: #e3f2fd;
  color: #0d47a1;
}

#screen-panier .sale-type-badge.badge-direct {
  background: #e3f2fd;
  color: #0d47a1;
  border-color: #90caf9;
}

#screen-panier .sale-type-badge.badge-delivery {
  background: #fff3e0;
  color: #ef6c00;
  border-color: #ffcc80;
}

#screen-panier .sale-type-badge i {
  font-size: 18px;
}

#screen-panier header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 15px;
  /* si vous voulez une ligne en dessous : */
  border-bottom: 1px solid #e0e0e0;
}
#screen-panier header h1 {
  margin: 0;
  font-size: 20px;
  color: var(--primary-color);
  flex: 1;
  text-align: center;
}
#screen-panier .header-icons {
  margin-left: auto;    /* pousse les icônes tout à droite */
}
#screen-panier .btn-back-panier {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  border: none;
  background: transparent;
  color: var(--primary-color);
  font-weight: 600;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 999px;
  transition: background-color 0.2s ease;
}
#screen-panier .btn-back-panier:hover {
  background-color: rgba(0, 96, 100, 0.08);
}
#screen-panier .btn-back-panier i {
  font-size: 20px;
}
#screen-panier .header-icons i {
  font-size: 24px;
  margin-left: 16px;    /* espace entre chaque icône */
  cursor: pointer;
}

#screen-panier header .header-icons {
  display: flex;      /* assure-toi que c'est un flex container */
  gap: 35px;          /* espace entre chaque icône */
  padding: 0 15px;    /* éventuellement un peu de padding autour */
  align-items: center;
}

.btn-search {
  position: relative;
  overflow: hidden;
  background: none;
  border: none;
  padding: 8px;
  cursor: pointer;
}

.btn-search .ripple {
  position: absolute;
  border-radius: 50%;
  background: rgba(0, 0, 0, 0.15);
  transform: scale(0);
  animation: ripple 0.6s linear;
  pointer-events: none;
}

@keyframes ripple {
  to {
    transform: scale(4);
    opacity: 0;
  }
}

/* ============================================================
   BOUTON  "HISTORY"  SUR CHAQUE CARTE PRODUIT (STOCK)
   ============================================================ */
   .product-card {           /* ta carte existante : on ajoute…   */
  position: relative;     /* …un contexte pour l'absolute       */
}

/* bouton rond translucide */
.product-card .history-btn{
  position:absolute;
  top:6px; right:6px;                 /* coin haut-droit          */
  width:28px; height:28px;
  display:flex; align-items:center; justify-content:center;
  border:none; border-radius:50%;
  background:rgba(0,0,0,.05);
  cursor:pointer;
  transition:background .25s;
}
.product-card .history-btn i{
  width:18px; height:18px;
  color:var(--primary-color);
}

.product-card .history-btn:hover i{
  color:#fff;
}

/* Écran Démarrer la journée */
#screen-start-day {                   /* caché par défaut */
  background: var(--bg-color);
  height: 100vh;
  text-align: center;
  padding-top: 40vh;                  /* bouton centré verticalement */
}
#screen-start-day.active {           /* devient visible quand on ajoute .active */
  display: block;
}
/* Cache la bottom-nav quand l'écran #screen-start-day est actif */
#screen-start-day.active ~ .bottom-nav-pro {
  display: none;
}

/* Cache la bottom-nav quand l'ecran panier est actif */
#screen-panier.active ~ .bottom-nav-pro {
  display: none;
}

.start-day-container {
  display: flex;
  justify-content: center;
}

.btn-start-day {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  border: none;
  background: var(--accent-color);
  color: white;
  font-size: 16px;
  font-weight: bold;
  box-shadow: 0 8px 16px rgba(0,0,0,0.2);
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}

.btn-start-day:hover {
  transform: scale(1.05);
  box-shadow: 0 12px 24px rgba(0,0,0,0.3);
}

.btn-start-day:active {
  transform: scale(0.95);
}
/* =========================================================
   NOUVEAU STYLE POUR LES CARTES D'HISTORIQUE DES VENTES
   ========================================================= */

/* On retire la classe .vente-card pour la remplacer par .history-card */
#ventesContainer .history-card {
    display: flex;
    align-items: center;
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: 0 2px 5px rgba(0,0,0,0.08);
    padding: 12px;
    margin-bottom: 12px;
    position: relative;
    border-left: 4px solid transparent; /* Bordure de statut */
}

/* --- Statuts colorés --- */
.history-card.status-reussie { border-left-color: #4CAF50; } /* Vert */
.history-card.status-echouee { border-left-color: #F44336; } /* Rouge */
.history-card.status-en-cours { border-left-color: #FF9800; } /* Orange */
.history-card.status-vente-directe { border-left-color: #2196F3; } /* Bleu */


/* --- Conteneur de l'icône à gauche --- */
.history-card .icon-container {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
}
.history-card.status-reussie .icon-container { background-color: #e8f5e9; }
.history-card.status-echouee .icon-container { background-color: #ffebee; }
.history-card.status-en-cours .icon-container { background-color: #fff3e0; }
.history-card.status-vente-directe .icon-container { background-color: #e3f2fd; }

.history-card .icon-container i {
    width: 22px;
    height: 22px;
}
.history-card.status-reussie i { color: #4CAF50; }
.history-card.status-echouee i { color: #F44336; }
.history-card.status-en-cours i { color: #FF9800; }
.history-card.status-vente-directe i { color: #2196F3; }


/* --- Bloc d'informations central --- */
.history-card .info-container {
    flex-grow: 1;
}

.history-card .client-name {
    font-weight: 500;
    font-size: 16px;
    color: var(--text-color);
    margin-bottom: 4px;
}

.history-card .meta-info {
    font-size: 13px;
    color: #666;
}

/* --- Bloc montant à droite --- */
.history-card .amount-container {
    text-align: right;
    margin-left: 10px;
}

.history-card .total-amount {
    font-size: 16px;
    font-weight: 700;
    color: var(--primary-color);
}

.history-card .sale-time {
    font-size: 12px;
    color: #777;
}

/* --- Bouton Annuler (icône) --- */
.history-card .cancel-btn-icon {
    position: absolute;
    top: 5px;
    right: 5px;
    background: none;
    border: none;
    color: #aaa;
    cursor: pointer;
    padding: 5px;
}
.history-card .cancel-btn-icon:hover {
    color: #F44336;
}

/* --- Bouton Détails (plus discret) --- */
.history-card .details-btn-link {
    font-size: 13px;
    color: var(--primary-color);
    text-decoration: none;
    font-weight: 500;
    cursor: pointer;
    margin-top: 6px;
    display: inline-block;
}
  </style>
</head>
<body>
  <!-- Preloader -->
  <div id="preloader">
    <div class="spinner"></div>
  </div>
  
  <!-- Sale Loader Popup -->
  <div id="saleLoader">
    <div class="loader-content">
      <div class="spinner" style="width:40px; height:40px; border: 6px solid #f3f3f3; border-top: 6px solid var(--primary-color);"></div>
      <p>Enregistrement de la vente...</p>;
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast"></div>

  <!-- Message de progression pour les téléchargements -->
  <div id="downloadProgress" style="display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%); background:var(--primary-color); color:var(--white); padding:10px 20px; border-radius:5px; z-index:3000;"></div>
  
  <div id="app" style="display: none;">
    <!-- Screen 1: Nouvelle Vente - Multi-steps -->
    
<section id="screen-accueil" class="screen active">
  <div class="ako-dashboard">
    <header class="ako-appbar">
      <button class="ako-icon-btn" type="button" aria-label="Ouvrir le menu" onclick="window.location.hash='menu'">
        <i data-lucide="menu"></i>
      </button>
      <div class="ako-brand">Ako</div>
      <div class="ako-actions">
        <button class="ako-icon-circle" type="button" aria-label="Aide">
          <i data-lucide="help-circle"></i>
        </button>
        <button class="ako-icon-circle" type="button" aria-label="Notifications">
          <span class="ako-badge" aria-label="1 nouvelle notification">01</span>
          <i data-lucide="bell"></i>
        </button>
      </div>
    </header>
    <nav class="ako-tabs" role="tablist" aria-label="Navigation principale">
      <button class="ako-tab is-active" type="button" role="tab" aria-selected="true" tabindex="0">
        <i data-lucide="layout-dashboard"></i>
        <span>Tableau de bord</span>
      </button>
      <button class="ako-tab" type="button" role="tab" aria-selected="false" tabindex="-1">
        <i data-lucide="sparkles"></i>
        <span>Prise en main</span>
      </button>
      <span class="ako-tab-indicator" aria-hidden="true"></span>
    </nav>
    <main class="ako-main">
      <section class="ako-welcome" aria-labelledby="akoWelcomeTitle">
        <div class="ako-welcome-icon" aria-hidden="true">✨</div>
        <div class="ako-welcome-text">
          <h1 id="akoWelcomeTitle">Bienvenue AKODA ZIDANE</h1>
          <p>Voici l'aperçu de votre organisation</p>
          <p class="ako-date" id="accueil-date" aria-live="polite">--</p>
        </div>
      </section>

      <section class="ako-card ako-card-quick" aria-label="Actions rapides">
        <div class="ako-quick-grid">
          <button class="ako-quick-item" type="button" onclick="window.location.hash='ajouter-client'" aria-label="Enregistrer un client">
            <span class="ako-quick-avatar">
              <i data-lucide="user-plus"></i>
              <span class="ako-quick-badge">+</span>
            </span>
            <span>Enregistrer un client</span>
          </button>
          <button class="ako-quick-item" type="button" onclick="window.location.hash='ajouter-livreur'" aria-label="Enregistrer un livreur">
            <span class="ako-quick-avatar">
              <i data-lucide="truck"></i>
              <span class="ako-quick-badge">+</span>
            </span>
            <span>Enregistrer un livreur</span>
          </button>
          <button class="ako-quick-item" type="button" onclick="window.location.hash='start-day'" aria-label="Ouvrir le journal">
            <span class="ako-quick-avatar">
              <i data-lucide="book-open"></i>
              <span class="ako-quick-badge">+</span>
            </span>
            <span>Journal</span>
          </button>
        </div>
      </section>

      <section class="ako-card receivables" aria-labelledby="receivablesTitle">
        <div class="ako-receivables-content">
          <div>
            <h2 id="receivablesTitle">Consultez le résumé de vos créances</h2>
            <p>Surveillez les montants en cours et en retard dus par vos clients.</p>
            <button class="ako-btn-pill" type="button" onclick="ouvrirModalTypeVente()">
              <i data-lucide="plus"></i>
              <span>Enregistrer une vente</span>
            </button>
          </div>
          <div class="ako-receivables-visual" aria-hidden="true">
            <span class="ako-chart-line"></span>
            <span class="ako-chart-point"></span>
          </div>
        </div>
        <div class="ako-hidden-data" aria-hidden="true">
          <span id="accueil-ventes-count">0</span>
          <span id="accueil-ventes-ca">0 FCFA</span>
          <span id="accueil-ventes-profit">Profit : 0 FCFA</span>
          <span id="accueil-depenses">0 FCFA</span>
          <span id="accueil-stock-items">0</span>
          <span id="accueil-stock-detail"></span>
          <span id="accueil-livraisons-count">0</span>
          <span id="accueil-livraisons-subtext">Cliquer pour consulter</span>
          <span id="accueil-ventes-livraison">0 livraisons en attente</span>
        </div>
      </section>
    </main>
  </div>
</section>
<section id="screen-vendre" class="screen">
      <header>
        <!-- Entête retiré selon la demande -->
      </header>
      

      <div id="saleSteps">
        <div class="progress-container">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <span id="progressText">Étape 1 / 4</span>
        <div class="sale-step active" id="step1">
          <h2>Étape 1 : Ajouter des Articles</h2>
          <form class="vente-form" onsubmit="event.preventDefault();">
            <label for="produit">Article</label>
            <div class="input-container">
              <input type="text" id="produit" placeholder="Rechercher un article" autocomplete="off" />
              <div id="suggestionList" class="suggestion-list"></div>
            </div>
            <label for="prix">Prix Unitaire</label>
            <input type="number" id="prix" placeholder="Prix unitaire" oninput="calculerTotalArticle()" />
            <label for="quantite">Quantité</label>
            <div class="quantity-container">
              <button type="button" onclick="decrementQuantity()">–</button>
              <input type="number" id="quantite" min="1" value="1" oninput="calculerTotalArticle()" />
              <button type="button" onclick="incrementQuantity()">+</button>
            </div>
            <label for="totalArticle">Montant Total</label>
            <input type="number" id="totalArticle" readonly placeholder="Calcul automatique" />
            <button type="button" class="btn-modern" onclick="ajouterArticle()">
              <i data-lucide="shopping-cart"></i> Ajouter Article
            </button>
          </form>
          <button class="btn-modern secondary" onclick="ouvrirPanier()">
            <i data-lucide="shopping-bag"></i> Voir Panier
          </button>
          <div class="step-navigation">
            <button class="btn-modern secondary" onclick="prevStep()">
              <i data-lucide="arrow-left"></i> Retour
            </button>
            <button id="installBtn" style="display: none;">
  📲 Installer l'application
</button>
            <button class="btn-modern" onclick="nextStep()">
              Suivant <i data-lucide="arrow-right"></i>
            </button>
          </div>
        </div>
        <!-- Étape 2 : Informations Client -->
        <div class="sale-step" id="step2">
          <h2>Étape 2 : Client & Livraison</h2>
          <p class="step-intro">Identifiez clairement le client et, si nécessaire, préparez la livraison avant de passer aux paiements.</p>
          <div class="step-two-layout">
            <section class="info-card client-card" id="clientCard">
              <header class="info-card-header">
                <div>
                  <h3>Client</h3>
                  <p>Identifiez le client pour cette vente.</p>
                </div>
              </header>
              <div id="clientSelectedSummary" class="selection-summary">
                <p id="clientSelectedText">Aucun client sélectionné.</p>
              </div>
              <div class="client-type-group" role="group" aria-labelledby="clientTypeLabel">
                <span id="clientTypeLabel" class="client-type-group-title">Type de client</span>
                <div class="client-type-options">
                  <button type="button" class="client-search-chip client-type-chip" data-type="ordinaire" onclick="setClientType('ordinaire')">
                    Client ordinaire
                  </button>
                  <button type="button" class="client-search-chip client-type-chip" data-type="revendeur" onclick="setClientType('revendeur')">
                    Revendeur
                  </button>
                </div>
                <span class="client-type-hint">Choisissez le profil du client pour cette vente.</span>
              </div>
              <div class="selection-actions">
                <button type="button" class="btn-modern" onclick="openClientSelection()">
                  <i data-lucide="users"></i> Choisir client
                </button>
                <button type="button" class="btn-link" onclick="clearSelectedClient()">Effacer la sélection</button>
              </div>
            </section>
            <section class="info-card livreur-card" id="deliveryCard" style="display:none;">
              <header class="info-card-header">
                <div>
                  <h3>Livreur</h3>
                  <p>Assignez un livreur enregistré pour suivre la course.</p>
                </div>
                <span class="info-badge" id="deliveryModeBadge" style="display:none;">Livraison active</span>
              </header>
              <div id="livreurSelectedSummary" class="selection-summary">
                <p id="livreurSelectedText">Aucun livreur sélectionné.</p>
              </div>
              <div class="selection-actions">
                <button type="button" class="btn-modern" onclick="openLivreurSelection()">
                  <i data-lucide="truck"></i> Choisir livreur
                </button>
                <button type="button" class="btn-link" onclick="clearSelectedLivreur()">Effacer la sélection</button>
              </div>
              <div class="livraison-lieu">
                <label for="lieuLivraison">Lieu de livraison</label>
                <input type="text" id="lieuLivraison" placeholder="Adresse, quartier, point de repère" />
                <small>Indiquez le lieu exact pour faciliter la livraison.</small>
              </div>
            </section>
          </div>
          <input type="hidden" id="clientNom">
          <input type="hidden" id="clientNumero">
          <input type="hidden" id="clientId">
          <input type="hidden" id="clientType" value="">
          <input type="hidden" id="livreurId">
          <input type="hidden" id="livreurNom">
          <input type="hidden" id="livreurNumero">
          <div class="step-navigation">
            <button class="btn-modern secondary" onclick="prevStep()">
              <i data-lucide="arrow-left"></i> Retour
            </button>
            <button class="btn-modern" onclick="nextStep()">
              Suivant <i data-lucide="arrow-right"></i>
            </button>
          </div>
        </div>
        <!-- Étape 3 : Canal de vente -->
        <div class="sale-step" id="step3">
          <h2>Étape 3 : Canal de vente</h2>
          <form class="vente-form" onsubmit="event.preventDefault();">
            <label for="vendeurSelect">Canal de vente</label>
            <select id="vendeurSelect">
              <!-- Options canal de vente -->
            </select>
            <p class="sale-mode-note" id="saleModeSummary" style="margin-top:12px; font-weight:600;">Mode de vente : Vente directe</p>
                        <!-- ====== Section : Encaissements détaillés ====== -->

            <div class="vente-payments-block">

              <div class="vente-payments-header">

                <span>Encaissements</span>

                <button type="button" class="btn-modern secondary" onclick="ajouterLignePaiementVente()">

                  <i data-lucide="plus-circle"></i> Ajouter un encaissement

                </button>

              </div>

              <div id="ventePaymentsContainer" class="vente-payments-container"></div>

              <div class="vente-payments-summary">

                <p>Montant a encaisser : <strong id="vente-summary-total-due">0 FCFA</strong></p>

                <p>Total encaisse : <strong id="vente-summary-total-paid">0 FCFA</strong></p>

                <p>Monnaie rendue : <strong id="vente-summary-total-change">0 FCFA</strong></p>

                <p>Net encaisse : <strong id="vente-summary-net">0 FCFA</strong></p>

                <p id="vente-payment-warning" class="vente-payment-warning"></p>

              </div>

            </div>
            <p class="payment-hint" id="deliveryPaymentHint" style="display:none; margin-top:12px; font-size:0.9em; color:#2563eb;">Encaissement non obligatoire pour les livraisons. Vous pourrez encaisser lors de la remise.</p>

<label for="photoFacture">Photos de la facture</label>
            <input type="file" accept="image/*" capture="camera" id="photoFacture" multiple />
            <label for="observationsVendeur">Observations</label>
            <textarea id="observationsVendeur" placeholder="Observations (facultatif)"></textarea>
          </form>
          <div class="step-navigation">
            <button class="btn-modern secondary" onclick="prevStep()">
              <i data-lucide="arrow-left"></i> Retour
            </button>
            <button class="btn-modern" onclick="nextStep()">
              Suivant <i data-lucide="arrow-right"></i>
            </button>
          </div>
        </div>
        <!-- Étape 4 : Confirmation -->
        <div class="sale-step" id="step4">
          <h2>Étape 4 : Confirmation</h2>
          <div id="saleRecap">
            <!-- Récapitulatif dynamique de la vente -->
          </div>
          <div class="step-navigation">
            <button class="btn-modern secondary" onclick="prevStep()">
              <i data-lucide="arrow-left"></i> Retour
            </button>
            <button class="btn-modern" id="btnValider" onclick="if(confirm(getValidationMessage())) { validerVente(); }">
              Confirmer la Vente
            </button>
          </div>
        </div>
      </div>
    </section>

    <section id="screen-choisir-client" class="screen">
      <div class="selection-page">
        <header class="selection-page-header">
          <button type="button" class="back-btn" onclick="returnToSaleFromSelection()">
            ← Retour
          </button>
          <h1>Choisir un client</h1>
          <button type="button" class="btn-icon" onclick="openCreateClientPage()" aria-label="Ajouter un client">
            <i data-lucide="plus"></i>
          </button>
        </header>
        <div class="selection-page-body">
          <div class="client-search-mode">
            <button type="button" class="client-search-chip active" data-mode="nom" onclick="setClientSearchMode('nom')">
              Par nom
            </button>
            <button type="button" class="client-search-chip" data-mode="numero" onclick="setClientSearchMode('numero')">
              Par numéro
            </button>
          </div>
          <div class="client-search-bar selection-search-bar">
            <input
              type="text"
              id="clientSearchInput"
              placeholder="Rechercher un client"
              autocomplete="off"
            />
          </div>
          <div id="clientSearchFeedback" class="client-search-feedback">
            Tapez pour lancer la recherche.
          </div>
          <div id="clientSearchResults" class="client-search-results"></div>
        </div>
      </div>
    </section>

    <section id="screen-ajouter-client" class="screen">
      <div class="selection-page">
        <header class="selection-page-header">
          <button type="button" class="back-btn" onclick="openClientSelectionFromCreate()">
            ← Retour
          </button>
          <h1>Nouveau client</h1>
        </header>
        <form class="selection-form" onsubmit="event.preventDefault(); createClientFromSale();">
          <label for="newClientName">Nom</label>
          <input type="text" id="newClientName" placeholder="Nom complet" autocomplete="off" />
          <label for="newClientPhone">Numéro WhatsApp</label>
          <input type="text" id="newClientPhone" placeholder="Numéro WhatsApp" autocomplete="off" />
          <div class="client-type-group new-client-type-group" role="group" aria-labelledby="newClientTypeLabel">
            <span id="newClientTypeLabel" class="client-type-group-title">Type de client</span>
            <div class="client-type-options new-client-type-options">
              <label class="client-type-radio">
                <input type="radio" name="newClientType" value="ordinaire" />
                <span>Client ordinaire</span>
              </label>
              <label class="client-type-radio">
                <input type="radio" name="newClientType" value="revendeur" />
                <span>Revendeur</span>
              </label>
            </div>
            <span class="client-type-hint">Sélectionnez un type. Aucun choix n’est présélectionné.</span>
          </div>
          <div id="clientCreateFeedback" class="client-search-feedback" style="display:none;"></div>
          <div class="selection-form-actions">
            <button type="button" class="btn-modern secondary" onclick="openClientSelectionFromCreate()">Annuler</button>
            <button type="submit" class="btn-modern" id="createClientSubmitBtn">Enregistrer</button>
          </div>
        </form>
      </div>
    </section>

    <section id="screen-choisir-livreur" class="screen">
      <div class="selection-page">
        <header class="selection-page-header">
          <button type="button" class="back-btn" onclick="returnToSaleFromSelection()">
            ← Retour
          </button>
          <h1>Choisir un livreur</h1>
          <button type="button" class="btn-icon" onclick="openCreateLivreurPage()" aria-label="Ajouter un livreur">
            <i data-lucide="plus"></i>
          </button>
        </header>
        <div class="selection-page-body">
          <div class="client-search-mode livreur-search-mode">
            <button type="button" class="client-search-chip active" data-mode="nom" onclick="setLivreurSearchMode('nom')">
              Par nom
            </button>
            <button type="button" class="client-search-chip" data-mode="numero" onclick="setLivreurSearchMode('numero')">
              Par numéro
            </button>
          </div>
          <div class="client-search-bar selection-search-bar">
            <input
              type="text"
              id="livreurSearchInput"
              placeholder="Rechercher un livreur"
              autocomplete="off"
            />
          </div>
          <div id="livreurSearchFeedback" class="client-search-feedback">
            Tapez pour lancer la recherche.
          </div>
          <div id="livreurSearchResults" class="client-search-results"></div>
        </div>
      </div>
    </section>

    <section id="screen-ajouter-livreur" class="screen">
      <div class="selection-page">
        <header class="selection-page-header">
          <button type="button" class="back-btn" onclick="openLivreurSelectionFromCreate()">
            ← Retour
          </button>
          <h1>Nouveau livreur</h1>
        </header>
        <form class="selection-form" onsubmit="event.preventDefault(); createLivreurFromSale();">
          <label for="newLivreurName">Nom</label>
          <input type="text" id="newLivreurName" placeholder="Nom complet" autocomplete="off" />
          <label for="newLivreurPhone">Numéro de téléphone</label>
          <input type="text" id="newLivreurPhone" placeholder="Numéro de téléphone" autocomplete="off" />
          <div id="livreurCreateFeedback" class="client-search-feedback" style="display:none;"></div>
          <div class="selection-form-actions">
            <button type="button" class="btn-modern secondary" onclick="openLivreurSelectionFromCreate()">Annuler</button>
            <button type="submit" class="btn-modern" id="createLivreurSubmitBtn">Enregistrer</button>
          </div>
        </form>
      </div>
    </section>
    
    <!-- Screen 2: Livraisons -->
    <section id="screen-livraisons" class="screen">
  <header>
    <h1>Historique des Livraisons</h1>
    <div class="timestamp">
      <span id="dateLivraison"></span>
    </div>
  </header>
  <div class="livraisons-stats">
    <div>
      <span>Livraisons en cours</span>
      <strong id="livraisons-header-count">0</strong>
    </div>
  </div>
  <div id="livraisonsContainer" class="list-container"></div>
</section>

    <!-- Screen 2b: Détail Livraison -->
    <section id="screen-livraison-detail" class="screen">
      <div class="delivery-detail-header">
        <div class="delivery-detail-left">
          <button type="button" class="btn-modern secondary delivery-back-btn" onclick="window.location.hash='historique'">
            <i data-lucide="arrow-left"></i>
            <span class="btn-label">Retour</span>
          </button>
          <div class="delivery-detail-heading">
            <h1 id="livraisonDetailTitle">Livraison</h1>
            <p id="livraisonDetailSubtitle" class="delivery-detail-subtitle"></p>
          </div>
        </div>
        <div class="delivery-detail-actions">
          <div id="livraisonDetailStatusPill" class="delivery-status-pill">--</div>
          <button type="button" class="btn-modern success" id="livraisonMarkSuccessBtn" onclick="marquerLivraisonReussie()">
            <i data-lucide="check-circle-2"></i>
            <span class="btn-label">Marquer comme réussie</span>
          </button>
          <button type="button" class="btn-modern danger" id="livraisonMarkFailedBtn" onclick="marquerLivraisonEchouee()">
            <i data-lucide="x-circle"></i>
            <span class="btn-label">Marquer comme échouée</span>
          </button>
        </div>
      </div>
      <div class="delivery-detail-content">
        <div id="livraisonDetailAlert" class="delivery-detail-alert" style="display:none;"></div>

        <div class="delivery-highlight">
          <div class="delivery-highlight-item">
            <span>Total vente</span>
            <strong id="livraisonDetailTotalAmount">0 FCFA</strong>
          </div>
          <div class="delivery-highlight-item">
            <span>Déjà encaissé</span>
            <strong id="livraisonDetailTotalPaid">0 FCFA</strong>
          </div>
          <div class="delivery-highlight-item outstanding">
            <span>Reste à encaisser</span>
            <strong id="livraisonDetailOutstanding">0 FCFA</strong>
          </div>
        </div>

        <div class="delivery-detail-layout">
          <div class="delivery-detail-main">
            <div class="delivery-card delivery-summary-card">
              <div class="delivery-card-header">
                <h2>Résumé client</h2>
                <span id="livraisonDetailReferenceBadge" class="delivery-reference-badge">Référence —</span>
              </div>
              <div class="delivery-summary-grid">
                <div>
                  <h3>Client</h3>
                  <p id="livraisonDetailClientName">—</p>
                  <small id="livraisonDetailClientPhone">—</small>
                </div>
                <div>
                  <h3>Livreur</h3>
                  <p id="livraisonDetailLivreur">—</p>
                  <small id="livraisonDetailLivreurPhone">—</small>
                </div>
                <div>
                  <h3>Lieu</h3>
                  <p id="livraisonDetailLieu">—</p>
                </div>
                <div>
                  <h3>Créée le</h3>
                  <p id="livraisonDetailDate">—</p>
                  <small id="livraisonDetailHeure">—</small>
                </div>
              </div>
              <div class="delivery-quick-actions">
                <a id="livraisonCallClientBtn" class="delivery-chip" href="#" target="_blank" rel="noopener">
                  <i data-lucide="phone"></i>
                  <span>Appeler client</span>
                </a>
                <a id="livraisonWhatsappClientBtn" class="delivery-chip" href="#" target="_blank" rel="noopener">
                  <i data-lucide="message-circle"></i>
                  <span>Message WhatsApp</span>
                </a>
                <a id="livraisonCallLivreurBtn" class="delivery-chip secondary" href="#" target="_blank" rel="noopener">
                  <i data-lucide="user-round"></i>
                  <span>Contacter livreur</span>
                </a>
              </div>
            </div>

            <div class="delivery-card">
              <div class="delivery-card-header">
                <h2>Articles</h2>
                <span id="livraisonItemsCountBadge" class="delivery-count-pill">—</span>
              </div>
              <table class="delivery-items-table">
                <thead>
                  <tr>
                    <th>Article</th>
                    <th>Qté</th>
                    <th>Prix</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody id="livraisonDetailItems">
                  <tr><td colspan="4" style="text-align:center; color:#94a3b8;">Aucun article</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <aside class="delivery-detail-side">
            <div class="delivery-card delivery-payments-card">
              <div class="delivery-card-header">
                <h2>Encaissements</h2>
                <button type="button" class="btn-modern primary delivery-add-payment-btn" onclick="encaisserLivraisonRestante()">
                  <i data-lucide="plus"></i>
                  <span class="btn-label">Ajouter un encaissement</span>
                </button>
              </div>
              <div id="livraisonPaymentsHistory" class="delivery-payments-history"></div>
            </div>

            <div class="delivery-card delivery-actions-card">
              <h2>Suivi de la livraison</h2>
              <div class="delivery-status-meta">
                <div>
                  <span>Préparée</span>
                  <strong id="livraisonDetailPreparedAt">—</strong>
                </div>
                <div>
                  <span>Clôture</span>
                  <strong id="livraisonDetailClosedAt">—</strong>
                </div>
              </div>
              <p id="livraisonDetailStatusDescription" class="delivery-status-description">Sélectionnez une action pour mettre à jour la livraison.</p>
              <div id="livraisonDetailFailureReason" class="delivery-failure-note" style="display:none;"></div>
            </div>
          </aside>
        </div>
      </div>
      <div id="livraisonDetailLoader" class="delivery-detail-loader" style="display:none;">
        <div class="sale-loader-spinner"></div>
        <p>Chargement...</p>
      </div>
    </section>
    
    <!-- Screen 3: Historique des Ventes -->
     <section id="screen-historique" class="screen">
<ion-app>
    <ion-header class="ion-no-border">
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button onclick="window.location.hash='menu'">
            <ion-icon name="arrow-back-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Historique des Ventes</ion-title>
        <ion-buttons slot="end">
          <ion-button onclick="ouvrirClotureVendeurDepuisHistorique()">
            <ion-icon name="calculator-outline"></ion-icon>
          </ion-button>
          <ion-button>
            <ion-icon name="search-outline"></ion-icon>
          </ion-button>
          <ion-button>
            <ion-icon name="ellipsis-vertical-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
      <ion-toolbar class="segment-toolbar">
        <ion-segment value="all" id="sales-tabs">
          <ion-segment-button value="all">
            <ion-label>Tout</ion-label>
          </ion-segment-button>
          <ion-segment-button value="delivery">
            <ion-label>Livraison</ion-label>
          </ion-segment-button>
          <ion-segment-button value="successful">
            <ion-label>Réussies</ion-label>
          </ion-segment-button>
          <ion-segment-button value="pending">
            <ion-label>En Cours</ion-label>
          </ion-segment-button>
          <ion-segment-button value="failed">
            <ion-label>Échouées</ion-label>
          </ion-segment-button>
        </ion-segment>
      </ion-toolbar>
    </ion-header>

    <ion-content fullscreen>
      <div id="history-filters" style="padding:10px; text-align:center; background: #f5f7fa; border-bottom: 1px solid #eee;">
        <input type="date" id="filterHistoryDate" onchange="filterSalesHistory()" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;"/>
         <select id="filterSalesByUser" onchange="filterSalesHistory(document.getElementById('sales-tabs').value)" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; background-color: white;">
      <option value="all" selected>Tous les utilisateurs</option>
    </select>
        <div id="totalPhonesSold" style="margin-top:5px; font-weight:bold; color: var(--primary-color);"></div>
        <div id="totalSalesAmount" style="margin-top: 5px; font-weight: bold; color: #28a745; font-size: 1.1em;"></div>
      </div>
      <ion-list lines="full" id="ventesContainerList">
        <ion-item>
          <ion-label style="text-align:center; padding: 20px; color: #888;">Chargement des ventes...</ion-label>
        </ion-item>
      </ion-list>
    </ion-content>
  </ion-app>
      <style>
      /* ==============================================================
       STYLES POUR L'HISTORIQUE DES VENTES (Similaire à Achats)
       ============================================================== */

    #screen-historique {
        --ion-background-color: #ffffff; /* Un arrière-plan très léger */
        --ion-text-color: #2e3748; /* Couleur de texte principale */
        font-family: 'Roboto', sans-serif; /* Assure la police globale */
    }

    /* En-tête (Header) - Design plat */
    #screen-historique ion-header {
        border-bottom: 1px solid #e0e0e0; /* Ligne de séparation fine */
    }

    #screen-historique ion-toolbar {
        --background: #fff; /* Fond blanc */
        --border-width: 0 !important; /* Pas de bordure */
        --box-shadow: none !important; /* PAS D'OMBRE */
        padding-left: 10px;
        padding-right: 10px;
    }

    #screen-historique ion-title {
        font-weight: 600;
        color: #333; /* Plus sombre pour le titre */
        font-size: 18px;
        padding-inline-start: 0;
    }

    #screen-historique ion-buttons ion-button {
        --color: #333; /* Couleur des icônes pour rester plat */
        font-size: 1.5em;
        --padding-end: 8px;
        --padding-start: 8px;
    }

    /* Segment (Onglets : Tout, Réussies, En Cours, Échouées) */
    #screen-historique .segment-toolbar {
        --background: #fff; /* Fond blanc pour la toolbar du segment */
        border-bottom: 1px solid #e0e0e0; /* Ligne de séparation fine */
        padding-bottom: 5px;
        --box-shadow: none !important; /* PAS D'OMBRE */
    }

    #screen-historique ion-segment {
        --background: transparent;
        --indicator-color: var(--primary-color); /* Couleur de la barre indicatrice */
        --indicator-height: 2px;
        flex-grow: 1;
        margin: 0 5px;
    }

    #screen-historique ion-segment-button {
        --color: #a0a0a0;
        --color-checked: #2e3748;
        --indicator-box-shadow: none;
        text-transform: none;
        font-weight: 500;
        font-size: 15px;
        letter-spacing: 0;
        min-height: 40px;
    }

    #screen-historique ion-content {
        --padding-bottom: 70px; /* Space for the FAB (if any) and bottom-nav-pro */
        padding-bottom: calc(var(--ion-safe-area-bottom) + 60px + 20px) !important;
    }

    /* Conteneur des items (liste) */
    #ventesContainerList {
        background-color: transparent; /* Pour que le fond de la liste soit celui de l'écran */
        padding: 0; /* Supprime le padding par défaut si la liste le gère elle-même */
        margin-top: 0; /* Espace après les filtres */
        margin-bottom: 0; /* Pas de marge en bas, géré par padding-bottom du content */
    }

    /* Styles des ion-item individuels */
    #ventesContainerList ion-item {
        --background: #ffffff; /* Fond blanc pour chaque élément de la liste */
        --padding-start: 0px; /* Supprime le padding gauche par défaut d'Ionic pour coller le bord */
        --padding-end: 0px;   /* Supprime le padding droit par défaut d'Ionic pour coller le bord */
        --inner-padding-end: 0px; /* Supprime le padding interne droit par défaut */
        --inner-border-width: 0; /* Assure qu'aucune bordure interne par défaut ne crée d'espace */
        border-radius: 0;
        margin-bottom: 0;
        min-height: 70px;
        align-items: stretch; /* Permet aux éléments flex de s'étirer en hauteur si besoin */
        padding-top: 0px; /* Le padding est géré par .main-content-wrapper */
        padding-bottom: 0px; /* Le padding est géré par .main-content-wrapper */
        position: relative;
        border-bottom: 1px solid #eee; /* Ligne de séparation fine entre les éléments */
        
    }


    /* Pour le dernier élément, pas de bordure en bas */
    #ventesContainerList ion-item:last-child {
        border-bottom: none;
    }

    /* Pas de bordure par défaut, on les gère par l'ombre et la marge */
    #ventesContainerList ion-list {
        --ion-item-border-color: transparent;
        background-color: #ffffff; /* Fond blanc pour la liste entière */
        border-radius: 8px; /* Coins arrondis pour la liste complète */
        overflow: hidden; /* Important pour que les coins arrondis s'appliquent sur le contenu */
        margin: 10px 16px; /* Marges latérales pour que la liste flotte un peu */
        box-shadow: 0 2px 5px rgba(0,0,0,0.08); /* Légère ombre pour la profondeur */
    }


    /* Mise en forme du contenu d'un ion-item pour qu'il ressemble à la capture Zoho */
    #ventesContainerList ion-item .main-content-wrapper {
        display: flex;
        justify-content: space-between; /* Pour pousser le montant à droite */
        align-items: center; /* Aligner verticalement les blocs principal (avatar, gauche, droite) */
        width: 100%;
        padding: 12px 16px; /* Applique le padding interne à ce wrapper, pour le contenu */
    }

    #ventesContainerList ion-item .avatar-circle {
        background-color: #6daaf2; /* Default blue, will be overridden by JS */
        color: white;
        border-radius: 50%;
        min-width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 15px;
        margin-right: 12px; /* Espace entre l'avatar et le texte */
        flex-shrink: 0; /* Empêche l'avatar de rétrécir */
    }

    #ventesContainerList ion-item .left-info {
        display: flex;
        flex-direction: column;
        flex-grow: 1; /* Permet à ce bloc de prendre tout l'espace disponible au centre */
        overflow: hidden; /* Important pour que l'ellipsis fonctionne */
    }

    /* Date/Time line (sur une seule ligne avec ellipsis) */
    #ventesContainerList ion-item .purchase-date {
        font-weight: bold;
        font-size: 14px;
        color: #333;
        margin-bottom: 4px; /* Espace sous la date */
        white-space: nowrap; /* Force sur une seule ligne */
        overflow: hidden; /* Cache le débordement */
        text-overflow: ellipsis; /* Ajoute des points de suspension */
        max-width: 100%; /* S'assure que le contenu respecte la largeur de son parent */
        display: block; /* Nécessaire pour que l'ellipsis fonctionne */
    }

    /* Client Name (sur une seule ligne avec ellipsis) */
    #ventesContainerList ion-item .supplier-name { /* Utilisé pour le client dans ce contexte */
        font-weight: 500;
        font-size: 16px;
        color: #333;
        margin-bottom: 4px;
        white-space: nowrap; /* Force sur une seule ligne */
        overflow: hidden; /* Cache le débordement */
        text-overflow: ellipsis; /* Ajoute des points de suspension */
        max-width: 100%; /* S'assure que le contenu respecte la largeur de son parent */
        display: block; /* Nécessaire pour que l'ellipsis fonctionne */
    }

    /* Conteneur de la liste des articles */
    #ventesContainerList ion-item .item-list-container {
        margin-top: 5px; /* Petit espace entre le nom du client et la liste des articles */
    }

    /* Lignes d'articles individuelles (sur une seule ligne avec ellipsis) */
    #ventesContainerList ion-item .item-line {
        font-size: 13px;
        color: #555;
        margin: 2px 0; /* Resserre l'espacement entre les articles individuels */
        white-space: nowrap; /* Force sur une seule ligne */
        overflow: hidden; /* Cache le débordement */
        text-overflow: ellipsis; /* Ajoute des points de suspension */
        max-width: 100%; /* S'assure que le contenu respecte la largeur de son parent */
        display: block; /* Nécessaire pour que l'ellipsis fonctionne */
    }

    #ventesContainerList ion-item .right-info {
        display: flex;
        flex-direction: column;
        align-items: flex-end; /* Aligner le texte à droite */
        margin-left: 15px; /* Espace entre la colonne de gauche et le montant */
        flex-shrink: 0; /* Empêche le bloc de droite de rétrécir */
    }

    #ventesContainerList ion-item .total-amount {
        font-weight: 600;
        font-size: 18px;
        color: #333;
        margin-bottom: 4px;
    }
    #ventesContainerList ion-item.status-reussie .total-amount {
        color: #3880ff; /* Bleu pour "Réussie" */
    }
    #ventesContainerList ion-item.status-echouee .total-amount {
        color: #f04141; /* Rouge pour "Échouée" */
    }

    #ventesContainerList ion-item .sale-status-text { /* Texte de statut */
        font-size: 13px;
        color: #888;
        text-transform: uppercase;
        font-weight: 500;
    }
    #ventesContainerList ion-item .sale-status-text.sale-status-delivery {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 2px;
        color: #1d4ed8;
    }
    #ventesContainerList ion-item .sale-status-text.sale-status-delivery ion-icon {
        font-size: 16px;
        margin-bottom: 2px;
    }
    #ventesContainerList ion-item .sale-status-text.sale-status-delivery span {
        font-weight: 600;
        letter-spacing: 0.08em;
    }
    #ventesContainerList ion-item .sale-status-text.sale-status-delivery small {
        font-size: 11px;
        color: #2563eb;
        text-transform: none;
    }
    #ventesContainerList ion-item .sale-actions-line {
        margin-top: 10px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }
    #ventesContainerList ion-item .delivery-details {
        margin-top: 10px;
        padding: 10px 12px;
        background: rgba(37, 99, 235, 0.05);
        border-radius: 8px;
        font-size: 13px;
        color: #334155;
    }
    #ventesContainerList ion-item .delivery-details div + div {
        margin-top: 4px;
    }
    .delivery-detail-left {
        display: flex;
        align-items: center;
        gap: 16px;
    }
    .delivery-detail-actions {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }
    .delivery-detail-actions .btn-modern {
        min-width: 0;
        white-space: nowrap;
        width: auto;
        padding: 12px 18px;
        margin-bottom: 0;
    }
    .delivery-detail-actions .btn-modern .btn-label {
        font-size: 16px;
    }
    .delivery-detail-actions .delivery-status-pill {
        margin-left: 4px;
        margin-right: auto;
    }
    .modal-livraison {
        max-width: 620px;
        width: 95%;
    }
    .modal-subtitle {
        text-align: center;
        font-size: 14px;
        color: #64748b;
        margin-bottom: 16px;
    }
    .livraison-payments-block {
        margin-top: 12px;
    }
    .livraisons-toolbar {
        display: flex;
        flex-direction: column;
        gap: 14px;
        padding: 16px;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
    }
    .livraisons-stats {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
    }
    .livraisons-stats div {
        background: #ffffff;
        border-radius: 12px;
        padding: 10px 16px;
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
        min-width: 120px;
    }
    .livraisons-stats span {
        display: block;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #94a3b8;
        margin-bottom: 4px;
    }
    .livraisons-stats strong {
        font-size: 20px;
        color: #0f172a;
    }
    .livraisons-filters {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    .livraison-filter-chip {
        border: 1px solid rgba(59,130,246,0.3);
        background: #ffffff;
        color: #1d4ed8;
        border-radius: 999px;
        padding: 6px 16px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .livraison-filter-chip.active {
        background: #1d4ed8;
        color: #ffffff;
        box-shadow: 0 6px 18px rgba(59,130,246,0.25);
    }
    .livraison-card {
        background: #ffffff;
        border-radius: 16px;
        margin: 0 16px 16px;
        padding: 18px;
        box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
        display: flex;
        flex-direction: column;
        gap: 14px;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .livraison-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
    }
    .livraison-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 16px;
    }
    .livraison-card-header h3 {
        margin: 0;
        font-size: 18px;
        color: #0f172a;
    }
    .livraison-card-header p {
        margin: 4px 0 0 0;
        font-size: 14px;
        color: #64748b;
    }
    .livraison-status-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
    }
    .livraison-status-pill ion-icon {
        font-size: 16px;
    }
    .livraison-status-pill.success {
        background: rgba(34,197,94,0.12);
        color: #15803d;
    }
    .livraison-status-pill.warning {
        background: rgba(59,130,246,0.12);
        color: #1d4ed8;
    }
    .livraison-status-pill.danger {
        background: rgba(248,113,113,0.15);
        color: #b91c1c;
    }
    .livraison-card-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 10px;
        font-size: 13px;
        color: #475569;
    }
    .livraison-card-meta span {
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    .livraison-card-outstanding {
        margin-top: 6px;
        font-size: 13px;
        color: #b91c1c;
        font-weight: 600;
    }
    .livraison-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }
    .livraison-card-footer .amount {
        font-size: 16px;
        font-weight: 600;
        color: #0f172a;
    }
    .livraison-card-footer .actions {
        display: flex;
        gap: 10px;
    }
    .livraison-count-btn {
        width: calc(100% - 32px);
        margin: 12px 16px 0;
        border: none;
        border-radius: 16px;
        padding: 14px 18px;
        background: linear-gradient(135deg, rgba(59,130,246,0.12), rgba(59,130,246,0.22));
        color: #1d4ed8;
        display: none;
        align-items: center;
        justify-content: center;
        gap: 10px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .livraison-count-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 30px rgba(59,130,246,0.18);
    }
    .livraison-count-btn i {
        font-size: 20px;
    }
    .livraison-count-btn strong {
        font-size: 18px;
    }

    #screen-livraison-detail {
        background: #f5f7fb;
        min-height: 100vh;
        padding-bottom: 40px;
    }
    .delivery-detail-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        padding: 20px;
        background: #ffffff;
        border-bottom: 1px solid #e2e8f0;
    }
    .delivery-detail-heading h1 {
        margin: 0;
        font-size: 22px;
        color: #1e293b;
    }
    .delivery-detail-subtitle {
        margin: 4px 0 0 0;
        color: #64748b;
        font-size: 14px;
    }
    .delivery-status-pill {
        background: rgba(59,130,246,0.12);
        color: #1d4ed8;
        padding: 8px 16px;
        border-radius: 999px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 12px;
    }
    .delivery-status-pill.success {
        background: rgba(34,197,94,0.15);
        color: #15803d;
    }
    .delivery-status-pill.danger {
        background: rgba(248,113,113,0.18);
        color: #b91c1c;
    }
    .delivery-status-pill.warning {
        background: rgba(251,191,36,0.18);
        color: #92400e;
    }
    .delivery-detail-content {
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        position: relative;
    }
    .delivery-card {
        background: #ffffff;
        border-radius: 20px;
        box-shadow: 0 18px 50px rgba(15, 23, 42, 0.08);
        padding: 24px;
    }
    .delivery-card h2 {
        margin: 0 0 16px;
        font-size: 18px;
        color: #0f172a;
    }
    .delivery-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 16px;
    }
    .delivery-card-header h2 {
        margin: 0;
    }
    .delivery-reference-badge {
        padding: 6px 12px;
        background: rgba(15, 23, 42, 0.08);
        color: #0f172a;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
    }
    .delivery-highlight {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }
    .delivery-highlight-item {
        background: linear-gradient(135deg, rgba(248, 250, 252, 0.9), rgba(226, 232, 240, 0.6));
        border-radius: 18px;
        padding: 18px;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    .delivery-highlight-item span {
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 12px;
        color: #64748b;
    }
    .delivery-highlight-item strong {
        font-size: 20px;
        color: #0f172a;
        font-weight: 700;
    }
    .delivery-highlight-item.outstanding strong {
        color: #b91c1c;
    }
    .delivery-detail-layout {
        display: grid;
        grid-template-columns: minmax(0, 2fr) minmax(280px, 1fr);
        gap: 20px;
    }
    .delivery-detail-main,
    .delivery-detail-side {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    .delivery-quick-actions {
        margin-top: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    .delivery-back-btn {
        width: auto;
        padding: 10px 20px;
        margin-bottom: 0;
    }
    .delivery-back-btn .btn-label {
        font-size: 15px;
    }
    .delivery-chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        border-radius: 999px;
        background: #f1f5f9;
        color: #1e293b;
        text-decoration: none;
        font-size: 14px;
        font-weight: 600;
        transition: background 0.2s ease, transform 0.2s ease;
    }
    .delivery-chip:hover {
        transform: translateY(-1px);
        background: #e2e8f0;
    }
    .delivery-chip.secondary {
        background: rgba(59, 130, 246, 0.12);
        color: #1d4ed8;
    }
    .delivery-chip.is-disabled {
        opacity: 0.5;
        pointer-events: none;
    }
    .delivery-chip i {
        font-size: 18px;
    }
    .delivery-count-pill {
        padding: 6px 12px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.08);
        color: #0f172a;
        font-size: 13px;
        font-weight: 600;
    }
    .delivery-payments-card .delivery-card-header {
        align-items: flex-start;
    }
    .delivery-add-payment-btn {
        width: auto;
        padding: 10px 18px;
        font-size: 15px;
        margin-bottom: 0;
    }
    .delivery-add-payment-btn i {
        font-size: 20px;
    }
    .delivery-add-payment-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }
    .delivery-status-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 12px;
        margin-bottom: 16px;
    }
    .delivery-status-meta span {
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 12px;
        color: #94a3b8;
    }
    .delivery-status-meta strong {
        margin-top: 6px;
        font-size: 15px;
        color: #0f172a;
        font-weight: 700;
        display: block;
    }
    .delivery-failure-note {
        margin-top: 12px;
        padding: 12px 14px;
        border-radius: 12px;
        background: rgba(248, 113, 113, 0.12);
        color: #7f1d1d;
        font-size: 14px;
        font-weight: 600;
    }
    @media (max-width: 1024px) {
        .delivery-detail-layout {
            grid-template-columns: 1fr;
        }
    }
    @media (max-width: 640px) {
        .delivery-detail-header {
            flex-direction: column;
            align-items: flex-start;
        }
        .delivery-detail-actions {
            width: 100%;
        }
        .delivery-detail-actions .btn-modern {
            width: 100%;
        }
        .delivery-quick-actions {
            flex-direction: column;
        }
    }
    .delivery-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
    }
    .delivery-summary-grid h3 {
        margin: 0 0 6px;
        font-size: 14px;
        text-transform: uppercase;
        color: #94a3b8;
        letter-spacing: 0.08em;
    }
    .delivery-summary-grid p {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: #1e293b;
    }
    .delivery-summary-grid small {
        color: #64748b;
        font-size: 13px;
    }
    .delivery-items-table {
        width: 100%;
        border-collapse: collapse;
    }
    .delivery-items-table th,
    .delivery-items-table td {
        padding: 10px 12px;
        font-size: 14px;
        text-align: left;
    }
    .delivery-items-table thead {
        background: #f8fafc;
        color: #475569;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .delivery-items-table tbody tr:nth-child(even) {
        background: #f8fafc;
    }
    .delivery-amounts {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    .delivery-amounts span {
        display: block;
        color: #94a3b8;
        font-size: 13px;
        text-transform: uppercase;
        margin-bottom: 6px;
        letter-spacing: 0.08em;
    }
    .delivery-amounts strong {
        font-size: 20px;
        color: #0f172a;
    }
    .delivery-payment-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
        align-items: end;
    }
    .delivery-payment-form .form-row {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    .delivery-payment-form label {
        font-size: 13px;
        text-transform: uppercase;
        color: #94a3b8;
        letter-spacing: 0.08em;
    }
    .delivery-payment-form input,
    .delivery-payment-form select {
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #dbe3f0;
        font-size: 15px;
        background: #fff;
    }
    .delivery-payments-history {
        margin-top: 16px;
        font-size: 13px;
        color: #475569;
        border-top: 1px solid #e2e8f0;
        padding-top: 14px;
    }
    .delivery-payments-history p {
        margin: 4px 0;
    }
    .delivery-detail-alert {
        padding: 14px 18px;
        border-radius: 12px;
        background: rgba(251, 191, 36, 0.15);
        color: #92400e;
        font-size: 14px;
    }
    .delivery-detail-alert.info {
        background: rgba(59, 130, 246, 0.12);
        color: #1d4ed8;
    }
    .delivery-detail-alert.success {
        background: rgba(34, 197, 94, 0.12);
        color: #166534;
    }
    .delivery-detail-alert.danger {
        background: rgba(248, 113, 113, 0.15);
        color: #7f1d1d;
    }
    .delivery-detail-loader {
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.78);
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 12px;
        border-radius: 12px;
        z-index: 10;
    }
    .sale-loader-spinner {
        width: 44px;
        height: 44px;
        border: 4px solid rgba(148, 163, 184, 0.5);
        border-top-color: #2563eb;
        border-radius: 50%;
        animation: spin 0.9s linear infinite;
    }
    .btn-modern.success {
        background: #16a34a;
        color: #fff;
    }
    .btn-modern.success:hover {
        background: #15803d;
    }
    .btn-modern.danger {
        background: #dc2626;
        color: #fff;
    }
    .btn-modern.danger:hover {
        background: #b91c1c;
    }
    #ventesContainerList ion-item .sale-status-text.sale-status-delivery {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 2px;
        color: #1d4ed8;
    }
    #ventesContainerList ion-item .sale-status-text.sale-status-delivery ion-icon {
        font-size: 16px;
        margin-bottom: 2px;
    }
    #ventesContainerList ion-item .sale-status-text.sale-status-delivery span {
        font-weight: 600;
        letter-spacing: 0.08em;
    }
    #ventesContainerList ion-item .sale-status-text.sale-status-delivery small {
        font-size: 11px;
        color: #2563eb;
        text-transform: none;
    }
    #ventesContainerList ion-item .sale-actions-line {
        margin-top: 10px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }
    #ventesContainerList ion-item .delivery-details {
        margin-top: 10px;
        padding: 10px 12px;
        background: rgba(37, 99, 235, 0.05);
        border-radius: 8px;
        font-size: 13px;
        color: #334155;
    }
    #ventesContainerList ion-item .delivery-details div + div {
        margin-top: 4px;
    }

    /* Styles pour les liens "Détails" et "Facture" */
    #ventesContainerList ion-item .details-btn-link ion-icon {
        font-size:16px;
        vertical-align: -3px; /* Ajuste l'alignement de l'icône */
        margin-right: 4px; /* Espace entre l'icône et le texte */
    }
    /* Style pour l'affichage du nom de l'opérateur de saisie */
.recorded-by-tag {
    margin-top: 12px; /* Espace au-dessus */
    padding-top: 8px; /* Espace au-dessus de la ligne */
    border-top: 1px solid #f0f0f0; /* Ligne de séparation discrète */
    text-align: right; /* Aligner à droite */
    font-size: 14px;   /* Police plus grande */
    color: #555;       /* Couleur de base du texte */
}

.recorded-by-tag strong {
    color: #000;       /* Nom en noir pour plus de visibilité */
    font-weight: 600;  /* Un peu plus gras */
}
      </style>

      <script>
   function getAvatarColor(name) {
        const colors = [
            '#3498DB', '#2ECC71', '#E74C3C', '#9B59B6', '#1ABC9C',
            '#34495E', '#9B59B6', '#C0392B', '#2980B9', '#27AE60',
            '#8E44AD', '#7F8C8D', '#D35400', '#20B2AA', '#BA55D3',
            '#00CED1', '#4682B4', '#D2691E', '#6A5ACD', '#8B0000'
        ];
        // Remove potentially "forbidden" or clashing colors if you have a specific palette
        const forbiddenColors = ['#FFC107', '#FF9800', '#FFD700', '#FFA500']; // Example
        const filteredColors = colors.filter(color => !forbiddenColors.includes(color.toUpperCase()));

        let hash = 0;
        if (name.length === 0) return filteredColors[0]; // Default color for empty name
        for (let i = 0; i < name.length; i++) {
            hash = name.charCodeAt(i) + ((hash << 5) - hash);
        }
        const index = Math.abs(hash % filteredColors.length);
        return filteredColors[index];
    }

    /**
 * Récupère la liste des utilisateurs depuis la collection 'users'
 * et peuple les menus déroulants des filtres de ventes et d'achats.
 * C'est beaucoup plus rapide que de scanner toutes les ventes/achats.
 */
async function populateUserFilters() {
    const salesSelect = document.getElementById("filterSalesByUser");
    const purchaseSelect = document.getElementById("filterPurchasesByUser");

    // Si employé: il ne doit pas pouvoir sélectionner d'autres utilisateurs
    const isEmployee = (typeof window !== 'undefined' && window.userRole === 'employe') ||
                       (typeof document !== 'undefined' && document.body.classList.contains('role-employe'));

    if (isEmployee) {
        try {
            const user = firebase.auth().currentUser;
            if (salesSelect) {
                // Masquer le select côté UI pour les employés
                salesSelect.style.setProperty('display', 'none', 'important');
                // Optionnel: le forcer à la valeur de l'utilisateur courant si besoin
                if (user && (user.displayName || user.email)) {
                    salesSelect.innerHTML = '';
                    const opt = document.createElement('option');
                    opt.value = user.displayName || user.email;
                    opt.textContent = opt.value;
                    opt.selected = true;
                    salesSelect.appendChild(opt);
                }
            }
        } catch (e) {
            console.warn('Impossible de configurer le filtre utilisateur pour employé:', e);
        }
        // Pour les employés, on ne charge pas la liste complète des utilisateurs
        return;
    }

    // Pour admin/patron: remplir les listes normalement
    // Si les menus sont déjà remplis, on ne fait rien.
    if (salesSelect && purchaseSelect && salesSelect.options.length > 1 && purchaseSelect.options.length > 1) {
        return;
    }

    try {
        const usersSnapshot = await dbFirestore.collection("users").orderBy("name").get();
        const userNames = [];
        usersSnapshot.forEach(doc => {
            const user = doc.data();
            if (user.name) {
                userNames.push(user.name);
            }
        });

        const addOptions = (selectElement) => {
            if (selectElement && selectElement.options.length <= 1) {
                userNames.forEach(name => {
                    const option = document.createElement("option");
                    option.value = name;
                    option.textContent = name;
                    selectElement.appendChild(option);
                });
            }
        };

        addOptions(salesSelect);
        addOptions(purchaseSelect);

    } catch (error) {
        console.error("Erreur lors de la récupération des utilisateurs pour les filtres :", error);
    }
}

    function displaySalesHistory(salesList) {
    const container = document.getElementById("ventesContainerList");
    container.innerHTML = "";

    if (salesList.length === 0) {
        container.innerHTML = `
            <ion-item style="--background: transparent; box-shadow: none; border-bottom: none; margin-bottom: 0;">
                <ion-label style="text-align:center; padding: 20px; color: #888;">
                    <ion-icon name="happy-outline" style="font-size: 40px; margin-bottom: 10px;"></ion-icon><br>
                    Aucune vente enregistrée pour cette période.
                </ion-label>
            </ion-item>
        `;
        return;
    }

    salesList.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));

    salesList.forEach(sale => {
        const slidingItem = document.createElement('ion-item-sliding');

        const isCancelled = sale.status === 'annulé';
        const isDelivery = !!sale.isDelivery;
        const deliveryStatus = sale.deliveryStatus || null;

        let statusClass = 'status-vente-directe';
        let statusLabel = 'Vente directe';
        let deliveryDescriptor = '';

        if (isDelivery) {
            switch (deliveryStatus) {
                case 'réussie':
                    statusClass = 'status-reussie';
                    deliveryDescriptor = 'Réussie';
                    break;
                case 'échouée':
                    statusClass = 'status-echouee';
                    deliveryDescriptor = 'Échouée';
                    break;
                default:
                    statusClass = 'status-en-cours';
                    deliveryDescriptor = 'En cours';
                    break;
            }
            statusLabel = 'Livraison';
        }

        const clientName = sale.clientNom || 'Client inconnu';
        const displayClientName = clientName.length > 30 ? clientName.substring(0, 27) + '…' : clientName;
        const initials = clientName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        const avatarBgColor = getAvatarColor(clientName);
        const totalFormatted = parseFloat(sale.overallTotal || 0).toLocaleString('fr-FR');
        let displayDateTime = 'Date invalide';

        if (sale.timestamp && typeof sale.timestamp.toDate === 'function') {
            const jsDate = sale.timestamp.toDate();
            const options = { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', timeZone: 'Africa/Lagos' };
            displayDateTime = jsDate.toLocaleDateString("fr-FR", options);
        }

        let itemListHTML = '';
        if (sale.items && Array.isArray(sale.items)) {
            sale.items.forEach(item => {
                const itemName = item.produit || 'Article inconnu';
                const displayItemName = itemName.length > 35 ? itemName.substring(0, 32) + '…' : itemName;
                itemListHTML += `<p class="item-line">${item.quantite} x ${displayItemName} - ${parseFloat(item.prix || 0).toLocaleString('fr-FR')} FCFA</p>`;
            });
        } else {
            itemListHTML = '<p class="item-line" style="color: #888;">Aucun article</p>';
        }

        const statusBadge = isDelivery
            ? `<div class="sale-status-text sale-status-delivery"><ion-icon name="cube-outline"></ion-icon><span>Livraison</span><small>${deliveryDescriptor || 'Non défini'}</small></div>`
            : `<div class="sale-status-text">${statusLabel}</div>`;

        const detailLabel = isDelivery ? 'Gérer la livraison' : 'Détails';
        const deliveryDetailsSection = isDelivery ? `
            <div class="delivery-details">
                <div><strong>Livreur :</strong> ${sale.livreurNom || 'Non renseigné'} (${sale.livreurNumero || '-'})</div>
                <div><strong>Lieu :</strong> ${sale.lieuLivraison || 'Non renseigné'}</div>
            </div>` : '';

        slidingItem.innerHTML = `
            <ion-item class="${statusClass} sale-history-item" data-sale-id="${sale.id}" data-is-delivery="${isDelivery ? '1' : '0'}" data-delivery-status="${deliveryStatus || ''}" button="true" lines="none" style="${isCancelled ? 'opacity:0.6; text-decoration: line-through; background-color:#ffebee;' : ''}">
                <ion-label style="padding: 12px 16px;">
                    <div class="main-content-wrapper" style="display:flex; align-items:center; width:100%;">
                        <div class="avatar-circle" style="background-color:${avatarBgColor};">
                            ${initials}
                        </div>
                        <div class="left-info" style="flex-grow:1;">
                            <div class="supplier-name">${displayClientName}</div>
                            <div class="purchase-date">${displayDateTime}</div>
                            <div class="item-list-container">${itemListHTML}</div>
                            ${deliveryDetailsSection}
                            <div class="sale-actions-line">
                                <a class="details-btn-link" data-action="${isDelivery ? 'delivery' : 'sale'}" data-sale-id="${sale.id}">
                                    <ion-icon name="information-circle-outline"></ion-icon> ${detailLabel}
                                </a>
                                <a class="details-btn-link download-invoice-btn" data-sale-id="${sale.id}" title="Télécharger la facture">
                                    <ion-icon name="download-outline"></ion-icon> Facture
                                </a>
                            </div>
                            <div class="recorded-by-tag">
                                Saisi par : <strong>${sale.enregistreParNom || 'N/A'}</strong>
                            </div>
                        </div>
                        <div class="right-info">
                            <div class="total-amount">XOF ${totalFormatted}</div>
                            ${statusBadge}
                        </div>
                    </div>
                </ion-label>
                <ion-ripple-effect></ion-ripple-effect>
                <button class="edit-client-btn" onclick="event.stopPropagation(); preparerModificationClient('${sale.id}', '${sale.clientNom}', '${sale.clientNumero || ''}')" title="Modifier le client">
                    <i data-lucide="square-pen"></i>
                </button>
            </ion-item>
            <ion-item-options side="end">
                <ion-item-option color="danger" expandable onclick="preparerAnnulationVente('${sale.id}', event)">
                    <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                    Annuler
                </ion-item-option>
            </ion-item-options>
        `;

        container.appendChild(slidingItem);
    });

    container.querySelectorAll('.sale-history-item').forEach(item => {
        item.addEventListener('click', (event) => {
            if (event.target.closest('.download-invoice-btn') || event.target.closest('.edit-client-btn')) {
                return;
            }
            const saleId = item.dataset.saleId;
            const isDelivery = item.dataset.isDelivery === '1';
            if (!saleId) return;
            if (isDelivery) {
                ouvrirLivraisonDetail(saleId);
            } else {
                ouvrirDetails(saleId);
            }
        });
    });

    container.querySelectorAll('.details-btn-link[data-action]').forEach(link => {
        link.addEventListener('click', (event) => {
            event.preventDefault();
            event.stopPropagation();
            const saleId = link.dataset.saleId;
            const action = link.dataset.action;
            if (!saleId) return;
            if (action === 'delivery') {
                ouvrirLivraisonDetail(saleId);
            } else {
                ouvrirDetails(saleId);
            }
        });
    });

    container.querySelectorAll('.download-invoice-btn').forEach(button => {
        button.addEventListener('click', (event) => {
            event.preventDefault();
            event.stopPropagation();
            const saleId = event.currentTarget.getAttribute('data-sale-id');
            const saleData = salesList.find(s => s.id === saleId);
            if (saleData) {
                generateInvoicePDF(saleData);
            } else {
                console.error('Données de vente non trouvées pour ID :', saleId);
                alert('Erreur: Impossible de trouver les données de la vente.');
            }
        });
    });

    refreshLucideIcons();
}

/**
 * Prépare et demande la confirmation pour l'annulation d'une vente.
 * @param {string} saleId - L'ID du document de la vente à annuler.
 * @param {Event} event - L'objet d'événement du clic pour pouvoir fermer le slide.
 */
async function preparerAnnulationVente(saleId, event) {
    // Empêche le clic de se propager à l'ion-item principal
    event.stopPropagation();
    
    // Ferme l'élément <ion-item-sliding> pour une meilleure expérience utilisateur
    const slidingItem = event.target.closest('ion-item-sliding');
    if (slidingItem) {
        await slidingItem.close();
    }

    // Appelle la fonction de confirmation existante
    demanderAnnulation(saleId);
}

      // Initialisation de la date par défaut et appel automatique du filtrage à l'ouverture de la page
      window.addEventListener("load", () => {
        const todayISO = new Date().toISOString().split("T")[0];
        document.getElementById("filterHistoryDate").value = todayISO;
        // The filter will be called by handleSalesTabChange when the screen is activated
      });

      
async function filterSalesHistory(statusFilter = 'all') {
        const selectedUser = (document.getElementById("filterSalesByUser") || {}).value;
        const dateInput = document.getElementById("filterHistoryDate").value;
        if (!dateInput) {
          console.warn("Aucune date sélectionnée");
          return;
        }

        const container = document.getElementById("ventesContainerList");
        container.innerHTML = `
            <ion-item style="--background: transparent; box-shadow: none; border-bottom: none; margin-bottom: 0;">
                <ion-label style="text-align:center; padding: 20px; color: #888;">
                    <ion-spinner name="crescent" style="width: 30px; height: 30px;"></ion-spinner><br>
                    Chargement des ventes...
                </ion-label>
            </ion-item>
        `;

        const selectedDate = new Date(dateInput);
        const startOfDay = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), 0, 0, 0, 0);
        const endOfDay = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), 23, 59, 59, 999);

        const startOfDayFirestoreTimestamp = firebase.firestore.Timestamp.fromDate(startOfDay);
        const endOfDayFirestoreTimestamp = firebase.firestore.Timestamp.fromDate(endOfDay);

        try {
            let query = dbFirestore.collection("ventes")
                .where("timestamp", ">=", startOfDayFirestoreTimestamp)
                .where("timestamp", "<=", endOfDayFirestoreTimestamp)
                .orderBy("timestamp", "desc");

            // Appliquer les restrictions d'accès: un employé ne voit que ses ventes
            const isEmployee = (typeof window !== 'undefined' && window.userRole === 'employe') ||
                              (typeof document !== 'undefined' && document.body.classList.contains('role-employe'));
            if (isEmployee) {
                const user = firebase.auth().currentUser;
                if (user && user.uid) {
                    query = query.where("enregistreParUid", "==", user.uid);
                }
            } else {
                // Admin/Patron: autoriser le filtre par utilisateur si sélectionné
                if (selectedUser && selectedUser !== 'all') {
                    query = query.where("enregistreParNom", "==", selectedUser);
                }
            }

            if (statusFilter === 'successful') {
                query = query.where("deliveryStatus", "==", "réussie");
            } else if (statusFilter === 'delivery') {
                query = query.where("isDelivery", "==", true).where("deliveryStatus", "==", "en cours");
            } else if (statusFilter === 'pending') {
                query = query.where("deliveryStatus", "==", "en cours");
            } else if (statusFilter === 'failed') {
                query = query.where("deliveryStatus", "==", "échouée");
            }

            const querySnapshot = await query.get();
            let totalPhones = 0;
            let totalSalesValue = 0;
            const salesList = [];

            querySnapshot.forEach(doc => {
                const sale = doc.data();

                if (sale.status === 'annulé') {
                    return;
                }

                const isDelivery = !!sale.isDelivery;
                const deliveryStatus = sale.deliveryStatus || null;

                if (statusFilter === 'all' && isDelivery && deliveryStatus !== 'réussie') {
                    return;
                }

                sale.id = doc.id;
                salesList.push(sale);

                totalSalesValue += parseFloat(sale.overallTotal) || 0;

                if (sale.items && Array.isArray(sale.items)) {
                    sale.items.forEach(item => {
                        if (item.category && item.category.toLowerCase() === "telephones") {
                            totalPhones += parseInt(item.quantite) || 0;
                        }
                    });
                }
            });

            document.getElementById("totalPhonesSold").innerText = "Total Téléphones vendus : " + totalPhones;
            document.getElementById("totalSalesAmount").innerText = `Montant Total : ${totalSalesValue.toLocaleString('fr-FR')} FCFA`;
            displaySalesHistory(salesList);

        } catch (err) {
            console.error("Erreur lors du filtrage des ventes par date:", err);
            container.innerHTML = `
                <ion-item style="--background: transparent; box-shadow: none; border-bottom: none; margin-bottom: 0;">
                    <ion-label style="text-align:center; color:red; padding:20px;">
                        Erreur de chargement des ventes.
                    </ion-label>
                </ion-item>
            `;
        }
      }
      // Handle tab changes for sales history
      document.addEventListener('DOMContentLoaded', () => {
          const salesTabs = document.getElementById('sales-tabs');
          if (salesTabs) {
              salesTabs.addEventListener('ionChange', (event) => {
                  filterSalesHistory(event.detail.value);
              });
          }
          toggleDeliveryFields();
      });
      
function generateInvoicePDF(sale) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'pt', 'a4'); // Utilise les points comme unité pour un meilleur contrôle

    // --- Fonction utilitaire pour la conversion de nombre en lettres ---
    // Cible : "vingt cinq mille quatre cent"
    const numberToWordsFr = (n) => {
        if (n === 0) return 'zéro';

        const units = ['', 'un', 'deux', 'trois', 'quatre', 'cinq', 'six', 'sept', 'huit', 'neuf'];
        const teens = ['dix', 'onze', 'douze', 'treize', 'quatorze', 'quinze', 'seize', 'dix-sept', 'dix-huit', 'dix-neuf'];
        const tens = ['', 'dix', 'vingt', 'trente', 'quarante', 'cinquante', 'soixante', 'soixante-dix', 'quatre-vingt', 'quatre-vingt-dix'];

        const convertChunk = (num) => {
            let chunkWords = "";
            if (num >= 100) {
                const hundreds = Math.floor(num / 100);
                chunkWords += (hundreds > 1 ? units[hundreds] + ' ' : '') + 'cent';
                num %= 100;
                if (num > 0) chunkWords += ' ';
            }
            if (num >= 10) {
                if (num < 20) {
                    chunkWords += teens[num - 10];
                } else {
                    const ten = Math.floor(num / 10);
                    chunkWords += tens[ten];
                    if (num % 10 === 1 && ten < 8) { // soixante et un, etc.
                         chunkWords += ' et ' + units[num % 10];
                    } else if (num % 10 !== 0) {
                         chunkWords += ' ' + units[num % 10];
                    }
                }
            } else if (num > 0) {
                chunkWords += units[num];
            }
            return chunkWords;
        };
        
        if (n < 1000) return convertChunk(n);

        const thousands = Math.floor(n / 1000);
        const remainder = n % 1000;

        let words = "";
        if (thousands === 1) {
            words = 'mille';
        } else {
            words = convertChunk(thousands) + ' mille';
        }

        if (remainder > 0) {
            words += ' ' + convertChunk(remainder);
        }

        return words.trim().replace(/-/g, ' ');
    };

    // --- Fonction utilitaire pour nettoyer les nombres ---
    const cleanNumber = (input) => {
        if (typeof input === 'number') return input;
        // Retire les slashes et les espaces, puis convertit en nombre
        return parseFloat(String(input).replace(/[\/\s]/g, '')) || 0;
    };


    try {
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.text("AFRICA PHONE", 40, 50);

        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        doc.text("RB/ABC/24 B 8356", 40, 65);
        doc.text("Nà Ifu: 3202413299289", 40, 78);
        doc.text("Ilot: 168, Agori, Abomey-Calavi, Bénin", 40, 91);
        doc.text("E-mail: africaphone24@gmail.com", 40, 104);
        doc.text("+229 54 15 15 22", 40, 117);

        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(28);
        doc.text("FACTURE", doc.internal.pageSize.getWidth() / 2, 80, { align: 'center' });

       
        doc.setLineWidth(1);
        doc.line(40, 135, 555, 135);

        let y = 160;
        doc.setFont("helvetica", "bold");
        doc.setFontSize(10);

        doc.text("Référence :", 40, y);
        doc.setFont("helvetica", "normal");
        doc.text(`AFPNE${(sale.id || '00000').substring(0, 5).toUpperCase()}`, 150, y);

        y += 20;
        doc.setFont("helvetica", "bold");
        doc.text("Date :", 40, y);
        doc.setFont("helvetica", "normal");
        doc.text(sale.dateVente || 'N/A', 150, y);

        y += 20;
        doc.setFont("helvetica", "bold");
        doc.text("Objet de la facture :", 40, y);
        doc.setFont("helvetica", "normal");
        doc.text("Achat de téléphone portable", 150, y);

        y += 20;
        doc.setFont("helvetica", "bold");
        doc.text("Client :", 40, y);
        doc.setFont("helvetica", "normal");
        doc.text(sale.clientNom || 'Client Inconnu', 150, y);


        // --- Tableau des articles ---
        const tableColumn = ["Désignation", "P.U.", "Qté", "Montant"];
        const tableRows = [];

        sale.items.forEach(item => {
            const pu = cleanNumber(item.prix);
            const total = cleanNumber(item.total);
            
            const itemData = [
                item.produit || "Article inconnu",
                fmt(pu),
                item.quantite || "0",
                `${fmt(total)} FCFA`
            ];
            tableRows.push(itemData);
        });

        doc.autoTable({
            head: [tableColumn],
            body: tableRows,
            startY: y + 30,
            theme: 'grid',
            headStyles: {
                fillColor: [220, 220, 220],
                textColor: [0, 0, 0],
                fontStyle: 'bold'
            },
            styles: {
                font: 'helvetica',
                fontSize: 10
            },
            columnStyles: {
                0: { cellWidth: 'auto' },
                1: { halign: 'right' },
                2: { halign: 'center' },
                3: { halign: 'right' }
            },
            margin: { left: 40, right: 40 }
        });

        // ==========================================================
        //          DÉBUT DU PIED DE PAGE CORRIGÉ (AVEC footerY)
        // ==========================================================

        // On définit notre position de départ ('footerY') juste en dessous du tableau des articles
        let footerY = doc.lastAutoTable.finalY + 30; // Marge de 30pt sous le tableau

        // --- TOTAL HT ---
        // On aligne le total à droite
        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        const overallTotal = cleanNumber(sale.overallTotal);
        const totalText = `TOTAL HT: ${fmt(overallTotal)} FCFA`;
        doc.text(totalText, 555, footerY, { align: 'right' });

        // --- Garantie 1 an ---
        // On aligne cette mention à gauche, sur la même ligne visuelle que le total
        doc.setFont("helvetica", "italic");
        doc.setFontSize(9);
        doc.text("Avec Garantie de 1 semaine", 40, footerY);

        // On descend pour la suite
        footerY += 30;

        // --- Montant en lettres ---
        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        const totalAmountInWords = numberToWordsFr(overallTotal);
        const fullText = `Arrêté la présente facture à la somme de ${totalAmountInWords} FCFA.`;
        const splitText = doc.splitTextToSize(fullText, 515); // On gère le retour à la ligne
        doc.text(splitText, 40, footerY);

        // On se décale vers le bas de la hauteur du texte qu'on vient d'écrire, plus une marge
        footerY += (splitText.length * 12) + 20; // 12pt de hauteur par ligne + 20pt de marge

        // --- Section des Conditions de Garantie ---

        // On vérifie qu'on a assez de place, sinon on crée une nouvelle page
        if (footerY > 680) {
            doc.addPage();
            footerY = 40; // On repart en haut de la nouvelle page
        }

        // 1. Ligne de séparation
        doc.setDrawColor(200, 200, 200); // Gris clair
        doc.setLineWidth(0.5);
        doc.line(40, footerY, 555, footerY); // Ligne horizontale sur toute la largeur
        footerY += 25;

        // 2. Titre des conditions
        doc.setFont("helvetica", "bold");
        doc.setFontSize(10);
        doc.text("Conditions de Garantie", doc.internal.pageSize.getWidth() / 2, footerY, { align: 'center' });
        footerY += 25;

        // 3. Le contenu des conditions
        const warrantyParagraphs = [
            "Couverture : La garantie s'applique uniquement aux défauts de fabrication ou problèmes techniques du téléphone.",
            "Exclusions : Tout dommage causé par l'utilisateur (chute, contact avec l'eau, mauvaise utilisation, etc.) est exclu de la garantie.",
            "Procédure de retour :",
            "a. Le produit doit être examiné pour confirmer le problème.",
            "b. Une réparation sera tentée en priorité.",
            "c. Un remplacement ne sera envisagé que si la réparation est impossible.",
            "Délais : Le temps de réparation varie selon la nature de la panne et la disponibilité des techniciens.",
            "Conditions de prise en charge : Aucun service de garantie ne sera effectué si le téléphone n'est pas retourné avec son emballage d'origine complet (boîte, accessoires, etc.) et en bon état."
        ];

        // 4. On dessine les paragraphes
        doc.setFont("helvetica", "normal");
        doc.setFontSize(8);
        
        warrantyParagraphs.forEach(p => {
            const isListItem = /^[a-z]\./.test(p);
            const xPosition = isListItem ? 55 : 40; // Indentation pour les listes a,b,c

            const lines = doc.splitTextToSize(p, 515);
            doc.text(lines, xPosition, footerY);

            footerY += (lines.length * 10) + (isListItem ? 2 : 6); // On descend après chaque paragraphe
        });

        // ==========================================================
        //            FIN DU PIED DE PAGE CORRIGÉ
        // ==========================================================


        // --- Sauvegarde du PDF ---
        doc.save(`Facture_AFONE_${(sale.clientNom || 'Vente').replace(/ /g, '_')}_${sale.id.substring(0, 5)}.pdf`);
        showToast('Facture PDF générée avec succès.');

    } catch (e) {
        console.error("Erreur lors de la génération de la facture PDF :", e);
        alert("Une erreur est survenue lors de la génération de la facture.");
    }
}

</script>
    </section>


    <!-- Screen  : Démarrer la journée -->
<section id="screen-cloture-vendeur" class="screen">
  <div class="cloture-vendeur-wrapper">
    <div class="cloture-vendeur-header">
      <button type="button" class="cloture-vendeur-back" onclick="window.location.hash='historique'">
        <i data-lucide="arrow-left"></i>
        <span>Retour ventes</span>
      </button>
      <h1>Cloture vendeur</h1>
    </div>

    <div class="cloture-vendeur-controls">
      <div class="cloture-control-group">
        <label for="clotureVendeurDate">Date de cloture</label>
        <input type="date" id="clotureVendeurDate" class="cloture-vendeur-input">
      </div>
      <div class="cloture-control-group">
        <label for="clotureVendeurSelect">Vendeur</label>
        <select id="clotureVendeurSelect" class="cloture-vendeur-select">
          <option value="">Selectionnez un vendeur</option>
        </select>
      </div>
      <div class="cloture-control-group" style="min-width:160px;">
        <label>&nbsp;</label>
        <button type="button" class="btn-modern secondary" onclick="rafraichirClotureVendeur()" id="clotureRefreshButton">
          <i data-lucide="refresh-cw"></i> Recalculer
        </button>
      </div>
    </div>

    <div id="clotureVendeurLoader" class="cloture-empty-state" style="display:none;">
      Calcul des ventes en cours...
    </div>

    <div id="clotureVendeurMessage" class="cloture-empty-state" style="display:none;">
      Selectionnez un vendeur et une date pour lancer la cloture.
    </div>

    <div id="clotureVendeurSummary" style="display:none; display:flex; flex-direction:column; gap:20px;">
      <div class="cloture-summary-grid">
        <div class="cloture-card">
          <span>Total ventes</span>
          <strong id="clotureTotalVentes">0 FCFA</strong>
          <small id="clotureTotalVentesCount">0 vente</small>
        </div>
        <div class="cloture-card">
          <span>Cash attendu</span>
          <strong id="clotureCashAttendu">0 FCFA</strong>
          <small>Somme des encaissements en caisse (net)</small>
        </div>
        <div class="cloture-card">
          <span>MoMo encaisse</span>
          <strong id="clotureMomoEncaisse">0 FCFA</strong>
          <small>Total des paiements via MoMo</small>
        </div>
        <div class="cloture-card">
          <span>Monnaie MoMo</span>
          <strong id="clotureMomoMonnaie">0 FCFA</strong>
          <small>Rendus effectues depuis MoMo</small>
        </div>
      </div>

      <div class="cloture-details">
        <div class="cloture-detail-block">
          <p class="cloture-detail-title">Cash remis par le vendeur</p>
          <input type="number" id="clotureCashRemisInput" class="cloture-vendeur-input" placeholder="Montant recu en especes" min="0" step="0.01" oninput="mettreAJourClotureCalculs()">
          <small>Cash attendu : <strong id="clotureCashAttenduLabel">0 FCFA</strong></small>
        </div>
        <div class="cloture-detail-block">
          <p class="cloture-detail-title">Somme calculee</p>
          <div class="cloture-detail-highlight" id="clotureCalculTotal">0 FCFA</div>
          <small>Formule : Cash remis + MoMo encaisse - MoMo monnaie</small>
        </div>
        <div class="cloture-detail-block">
          <p class="cloture-detail-title">Ecart</p>
          <div class="cloture-difference" id="clotureDifference">0 FCFA</div>
          <small id="clotureDifferenceLabel">Ecart par rapport au total des ventes</small>
        </div>
      </div>

      <div class="cloture-history">
        <h3>Detail des comptes utilises</h3>
        <div id="clotureAccountsContainer"></div>
      </div>

      <div class="cloture-history">
        <h3>Ventes du jour</h3>
        <div id="clotureSalesList"></div>
      </div>

      <div class="cloture-actions">
        <textarea id="clotureNotes" placeholder="Notes ou remarques supplementaires..."></textarea>
        <button type="button" class="btn-modern" id="clotureSaveButton" onclick="enregistrerClotureVendeur()">
          <i data-lucide="check-circle"></i> Enregistrer la cloture
        </button>
        <div class="cloture-save-feedback" id="clotureSaveFeedback"></div>
      </div>

      <div class="cloture-history">
        <h3>Historique des dernieres clotures</h3>
        <ul class="cloture-history-list" id="clotureHistoryList"></ul>
      </div>
    </div>
  </div>
</section>
<section id="screen-start-day" class="screen">
  <div class="start-day-container">
    <button id="btnStartDay" class="btn-start-day">
      <span>▶ Démarrer la journée</span>
    </button>
  </div>
</section>

<section id="screen-canaux-performance" class="screen">
  <style>
    .canaux-performance-container {
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .canaux-performance-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .canaux-performance-controls label {
      font-size: 13px;
      font-weight: 600;
      color: #555;
      display: block;
      margin-bottom: 4px;
    }
    .canaux-performance-controls select,
    .canaux-performance-controls input {
      width: 100%;
      padding: 8px;
      border: 1px solid #EEE;
      border-radius: 8px;
      font-size: 14px;
    }
    .canaux-performance-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
    }
    .canaux-performance-card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .canaux-performance-card span {
      font-size: 12px;
      color: #777;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .canaux-performance-card strong {
      font-size: 20px;
      color: var(--text-color);
    }
    .canaux-performance-loading {
      font-size: 14px;
      color: #555;
    }
    .canaux-performance-empty {
      font-size: 14px;
      color: #777;
      text-align: center;
      padding: 16px;
      background: rgba(0,0,0,0.03);
      border-radius: var(--border-radius);
    }
    .canaux-performance-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .canaux-performance-item {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .canaux-performance-item-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
    }
    .canaux-performance-item-title {
      font-weight: 600;
      color: var(--text-color);
    }
    .canaux-performance-item-amount {
      font-weight: 700;
      color: #2e7d32;
      font-size: 16px;
    }
    .canaux-performance-item-meta {
      display: flex;
      gap: 16px;
      color: #777;
      font-size: 13px;
      flex-wrap: wrap;
    }
    .canaux-performance-item-profit {
      color: #0d47a1;
      font-weight: 600;
    }
    .canaux-performance-item-payments {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
      color: #555;
    }
  </style>

  <header>
    <button class="back-btn" onclick="window.location.hash='menu'">
      <i data-lucide="arrow-left"></i>
    </button>
    <h1>Performance des canaux</h1>
  </header>

  <div class="canaux-performance-container">
    <div class="canaux-performance-controls">
      <div>
        <label for="canaux-performance-select">Canal</label>
        <select id="canaux-performance-select"></select>
      </div>
      <div>
        <label for="canaux-performance-start">Du</label>
        <input type="date" id="canaux-performance-start">
      </div>
      <div>
        <label for="canaux-performance-end">Au</label>
        <input type="date" id="canaux-performance-end">
      </div>
    </div>

    <div class="canaux-performance-summary">
      <div class="canaux-performance-card">
        <span>Nombre de ventes</span>
        <strong id="canaux-performance-count">0</strong>
      </div>
      <div class="canaux-performance-card">
        <span>Chiffre d'affaires</span>
        <strong id="canaux-performance-revenue">0 FCFA</strong>
      </div>
      <div class="canaux-performance-card">
        <span>Profit total</span>
        <strong id="canaux-performance-profit">0 FCFA</strong>
      </div>
    </div>

    <div id="canaux-performance-loading" class="canaux-performance-loading" style="display:none;">Chargement des ventes...</div>
    <div id="canaux-performance-empty" class="canaux-performance-empty" style="display:none;">Aucune vente pour ce canal et cette période.</div>
    <div id="canaux-performance-list" class="canaux-performance-list"></div>
  </div>
</section>

<section id="screen-commande-reception" class="screen">
  <header>
    <button class="back-btn" onclick="fermerReceptionCommande()">
      <i data-lucide="arrow-left"></i> Retour
    </button>
    <h1>Réception commande</h1>
  </header>

  <div class="reception-content">
    <div class="reception-card">
      <div id="commandeReceptionSummary" class="reception-summary">
        <p>Aucune commande sélectionnée.</p>
      </div>
    </div>

    <div class="reception-card">
      <h2>Articles à réceptionner</h2>
      <div id="commandeReceptionItemsContainer" class="reception-items"></div>
    </div>

    <div class="reception-card">
      <h2>Détails de réception</h2>
      <label for="commandeReceptionTransport">Frais de transport (FCFA)</label>
      <input type="number" id="commandeReceptionTransport" min="0" step="100" placeholder="0" />

      <label for="compteSelectCommandeReceptionTransport">Compte utilisé pour le transport</label>
      <select id="compteSelectCommandeReceptionTransport">
        <option value="">-- Sélectionner un compte --</option>
      </select>

      <label for="commandeReceptionNotes">Notes internes</label>
      <textarea id="commandeReceptionNotes" rows="3" placeholder="Commentaires sur la réception (optionnel)"></textarea>
    </div>

    <div class="reception-footer">
      <div class="reception-total">
        <span>Total réception :</span>
        <strong id="commandeReceptionTotal">0 FCFA</strong>
      </div>
      <button class="btn-modern" id="commandeReceptionSubmitBtn" onclick="soumettreReceptionCommande()" disabled>
        <i data-lucide="check-circle"></i>
        Confirmer la réception
      </button>
    </div>
  </div>
</section>

    <!-- Screen 4: Stock -->
    <section id="screen-stock" class="screen">
      <header>
        <h1>Stock</h1>
        <div class="timestamp">
          <span id="dateStock"></span>
        </div>
      </header>
      <div id="stock-home">
        <div class="summary" style="padding: 15px; background: var(--white); border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 15px;">
          <p><strong>Total Téléphones :</strong> <span id="total-telephones">0</span></p>
          <p><strong>Total Accessoires :</strong> <span id="total-accessoires">0</span></p>
        </div>
        <div class="card-buttons" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
  <button class="btn-modern" onclick="showStockCategory('telephones')">
    <i data-lucide="package"></i> Téléphones
  </button>
  <button class="btn-modern" onclick="showStockCategory('accessoires')">
    <i data-lucide="headphones"></i> Accessoires
  </button>
  <button id="exportStockBtn" class="btn-modern secondary">
    <i data-lucide="download"></i> Exporter Stock Téléphones (PDF)
  </button>
  <button id="exportInventoryBtn" class="btn-modern secondary">
    <i data-lucide="clipboard-list"></i> Exporter Fiche d'Inventaire
  </button>
</div>
        <div id="inventoryPreview" class="inventory-preview">
          <div class="inventory-preview-header">
            <h2>Fiche d'inventaire</h2>
            <p class="inventory-preview-subtitle">
              Visualisez directement le contenu de la fiche sans export.
            </p>
          </div>
          <div id="inventoryPreviewContent"></div>
        </div>
        
      </div>
      <div id="stock-category" style="display: none;">
        <button class="btn-modern secondary" onclick="backToStockHome()">
          <i data-lucide="arrow-left"></i> Retour
        </button>
        <input type="text" id="search-category" placeholder="Rechercher..." style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: var(--border-radius);" oninput="filterStockCategory()">
        <div id="category-container" class="cards-container"></div>
      </div>
    </section>

<!-- === Screen Stock : Historique (avec contenu) === -->
<section id="screen-stock-history" class="screen">
  <header>
    <button class="back-btn" onclick="window.location.hash='stock'">← Retour</button>
    <h1>Historique du Stock</h1>
  </header>
  <div id="stockHistoryContainer" class="list-container">
    <!-- JS injectera ici les variations -->
  </div>
</section>



    <!-- Screen 5: Entrée de Stock -->
    <section id="screen-entree-stock" class="screen">
      <header>
        <button class="back-btn" onclick="window.location.hash='parametres'">← Retour</button>
        <h1>Nouvelle Entrée de Stock</h1>
      </header>
      <div class="form-section">
        <h2>Ajouter un Article</h2>
        <form class="vente-form" onsubmit="event.preventDefault(); ajouterEntreeStock();">
          <label for="categorieEntree">Catégorie</label>
          <select id="categorieEntree">
            <option value="telephones">Téléphones</option>
            <option value="accessoires">Accessoires</option>
          </select>
          <label for="produitEntree">Article</label>
          <div class="input-with-icon">
            <i data-lucide="package"></i>
            <input type="text" id="produitEntree" placeholder="Rechercher un article" autocomplete="off" />
            <div id="suggestionListEntree" class="suggestion-list"></div>
          </div>
          <label for="prixEntree">Prix d'Achat Unitaire</label>
          <div class="input-with-icon">
            <i data-lucide="dollar-sign"></i>
            <input type="number" id="prixEntree" placeholder="Prix d'achat unitaire" oninput="calculerTotalEntree()" />
          </div>
          <label for="quantiteEntree">Quantité</label>
          <input type="number" id="quantiteEntree" min="1" value="1" oninput="calculerTotalEntree()" />
          <label for="totalEntree">Montant Total</label>
          <div class="input-with-icon">
            <i data-lucide="calculator"></i>
            <input type="number" id="totalEntree" readonly placeholder="Calcul automatique" />
          </div>
          <button class="btn-modern" type="submit">Ajouter Entrée</button>
        </form>
      </div>
    </section>

    <!-- Section Avance de Paiement -->
<section id="screen-advance" class="screen">
  <header>
    <button class="back-btn" onclick="window.location.hash='menu'">
      <i data-lucide="arrow-left"></i> Retour
    </button>
    <h1>Enregistrer une Avance</h1>
  </header>
  <div class="form-section">
    <h2>Avance de Paiement</h2>
    <form id="formAdvance" onsubmit="event.preventDefault(); enregistrerAvance();">
      <label for="saleId">ID de la Vente</label>
      <input type="text" id="saleId" placeholder="Entrez l'ID de la vente" required />

      <label for="avanceAmount">Montant de l'Avance (FCFA)</label>
      <input type="number" id="avanceAmount" placeholder="Montant de l'avance" required />

      <label for="modePaiement">Mode de Paiement</label>
      <select id="modePaiement">
        <option value="espèces">Espèces</option>
        <option value="carte">Carte bancaire</option>
        <option value="virement">Virement</option>
      </select>

      <button type="submit" class="btn-modern">Enregistrer l'Avance</button>
    </form>
  </div>
</section>

<!-- Script pour la gestion des avances -->
<script>
  /**
   * Fonction pour enregistrer une avance de paiement sur une vente.
   * Elle récupère le document de vente par son ID, vérifie le solde restant,
   * ajoute le paiement dans la sous-collection "paiements" puis met à jour le document.
   */
  function enregistrerAvance() {
    const saleId = document.getElementById("saleId").value.trim();
    const avanceAmount = parseFloat(document.getElementById("avanceAmount").value);
    const modePaiement = document.getElementById("modePaiement").value;

    if (!saleId) {
      alert("Veuillez saisir l'ID de la vente.");
      return;
    }
    if (isNaN(avanceAmount) || avanceAmount <= 0) {
      alert("Veuillez saisir un montant d'avance valide.");
      return;
    }

    // Récupérer le document de vente dans la collection "ventes"
    const saleRef = dbFirestore.collection("ventes").doc(saleId);
    saleRef.get().then(doc => {
      if (!doc.exists) {
        alert("Vente introuvée !");
        return;
      }
      const saleData = doc.data();
      // Si la vente est déjà réglée, on ne peut pas enregistrer d'avance
      if (saleData.status === "complet") {
        alert("La vente est déjà réglée en totalité.");
        return;
      }
      // Calculer le solde restant (en utilisant le champ remainingBalance si présent)
      const remaining = saleData.remainingBalance !== undefined
                        ? saleData.remainingBalance
                        : saleData.totalAmount - (saleData.paidAmount || 0);
      if (avanceAmount > remaining) {
        alert("Le montant d'avance dépasse le solde restant (" + remaining.toLocaleString() + " FCFA).");
        return;
      }
      // Créer un document de paiement dans la sous-collection "paiements"
      const paiement = {
        montant: avanceAmount,
        datePaiement: new Date().toISOString(),
        modePaiement: modePaiement
      };
      saleRef.collection("paiements").add(paiement)
        .then(() => {
          // Mettre à jour le document de vente avec le nouveau cumul et recalculer le solde
          const newPaidAmount = (saleData.paidAmount || 0) + avanceAmount;
          const newRemaining = saleData.totalAmount - newPaidAmount;
          const newStatus = newRemaining <= 0 ? "complet" : "avance partielle";
          return saleRef.update({
            paidAmount: newPaidAmount,
            remainingBalance: newRemaining,
            status: newStatus
          });
        })
        .then(() => {
          alert("Avance enregistrée avec succès !");
          document.getElementById("formAdvance").reset();
        })
        .catch(err => {
          console.error("Erreur lors de l'enregistrement de l'avance :", err);
          alert("Erreur lors de l'enregistrement de l'avance : " + err.message);
        });
    })
    .catch(error => {
      console.error("Erreur lors de la récupération de la vente :", error);
      alert("Erreur lors de la récupération de la vente : " + error.message);
    });
  }
</script>

<section id="screen-article-detail" class="screen">
  <ion-app>
    <ion-header class="ion-no-border">
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button onclick="window.location.hash='stock'">
            <ion-icon name="arrow-back-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Détail de l'article</ion-title>
        <ion-buttons slot="end">
          <ion-button>
            <ion-icon slot="icon-only" name="pencil-outline"></ion-icon>
          </ion-button>
          <ion-button>
            <ion-icon slot="icon-only" name="ellipsis-vertical-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content>
      <div class="main-content">
        <div class="product-info-grid">
          <div class="product-details">
            <h1 id="detail-product-title" class="product-title">Chargement...</h1>
            
            <span class="product-price-label">Prix de vente</span>
            <span id="detail-selling-price" class="product-price-value">...</span>

            <span class="product-price-label">Coût d'achat</span>
            <span id="detail-purchase-cost" class="product-price-value">...</span>

            <div class="product-actions">
              <button type="button" class="btn-modern adjust-stock-btn" onclick="ouvrirModalAjustementStock()">
                <i data-lucide="sliders"></i>
                Ajustement stock
              </button>
            </div>
          </div>
          
          <div class="add-image-box">
            <span>+ Add</span>
            <span>Image</span>
          </div>
        </div>

        <ion-segment value="details" id="article-tabs">
  <ion-segment-button value="details">
    <ion-label>Détails</ion-label>
  </ion-segment-button>
  <ion-segment-button value="transactions">
    <ion-label>Transactions</ion-label>
  </ion-segment-button>
  <ion-segment-button value="history">
    <ion-label>Historique</ion-label>
  </ion-segment-button>
</ion-segment>

<div id="detailsContent" class="tab-content">
  <ion-card>
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="stats-chart-outline"></ion-icon>
        Stock Summary
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div class="summary-grid">
        <div></div>
        <div class="summary-header">Comptable</div>
        <div class="summary-header">Physique</div>
        <div class="summary-label">Stock disponible</div>
        <div id="detail-stock-on-hand" class="summary-value">...</div>
        <div class="summary-value">...</div>
        <div class="summary-label">Stock engagé</div>
        <div class="summary-value">0.00</div>
        <div class="summary-value">0.00</div>
        <div class="summary-label">Disponible à la vente</div>
        <div id="detail-available-for-sale" class="summary-value">...</div>
        <div class="summary-value">...</div>
      </div>
    </ion-card-content>
  </ion-card>

  <ion-card>
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="cube-outline"></ion-icon>
        Stock Status
      </ion-card-title>
    </ion-header>
    <ion-card-content>
       <div class="status-grid">
         </div>
    </ion-card-content>
  </ion-card>
</div>

<div id="transactionsContent" class="tab-content" style="display: none;">
  </div>

<div id="historyContent" class="tab-content" style="display: none;">
  </div>
    </ion-content>
  </ion-app>
</section>
<style>
  /* Styles spécifiques pour l'écran de détail d'article */
#screen-article-detail {
    --ion-background-color: #f5f4fa; 
    --ion-text-color: #2e3748; 
    --ion-font-family: 'Inter', sans-serif;
}
#screen-article-detail ion-header ion-toolbar {
    --background: var(--ion-background-color);
    --border-width: 0 !important;
    box-shadow: none;
}
#screen-article-detail ion-content {
    --background: var(--ion-background-color);
}
#screen-article-detail ion-toolbar {
    --padding-start: 10px;
    --padding-end: 10px;
}
#screen-article-detail ion-toolbar ion-title {
    font-weight: 600;
    color: var(--ion-text-color);
}
#screen-article-detail ion-toolbar ion-buttons ion-icon {
    font-size: 24px;
    color: var(--ion-text-color);
}
#screen-article-detail .main-content {
    padding: 0 16px;
}
#screen-article-detail .product-info-grid {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-top: 16px;
    margin-bottom: 24px;
}
#screen-article-detail .product-details {
    display: flex;
    flex-direction: column;
}
#screen-article-detail .product-title {
    font-size: 24px;
    font-weight: 700;
    color: var(--ion-text-color);
    margin-bottom: 12px;
}
#screen-article-detail .product-price-label {
    font-size: 14px;
    color: #6c757d;
    margin-bottom: 2px;
}
#screen-article-detail .product-price-value {
    font-size: 18px;
    font-weight: 600;
    color: var(--ion-text-color);
    margin-bottom: 12px;
}
#screen-article-detail .product-actions {
    margin-top: 12px;
}
#screen-article-detail .adjust-stock-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: var(--primary-color);
    color: #ffffff;
    border: none;
    padding: 10px 18px;
    border-radius: 24px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
    box-shadow: 0 12px 24px rgba(56, 128, 255, 0.25);
}
#screen-article-detail .adjust-stock-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 16px 30px rgba(56, 128, 255, 0.28);
}
#screen-article-detail .adjust-stock-btn i {
    font-size: 18px;
}
#screen-article-detail .add-image-box {
    width: 100px;
    height: 100px;
    border: 2px dashed #d0d0e0;
    border-radius: 8px;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    color: #8a92a6;
    background-color: #ffffff;
    font-size: 14px;
    font-weight: 500;
}
#screen-article-detail ion-segment {
    --background: var(--ion-background-color);
    box-shadow: none;
    border-bottom: 1px solid #e0e0e0;
    margin-bottom: 16px;
}
#screen-article-detail ion-segment-button {
    --color: #6c757d;
    --color-checked: var(--ion-text-color);
    --indicator-color: var(--ion-text-color);
    --indicator-height: 3px;
    text-transform: uppercase;
    font-weight: 600;
    font-size: 14px;
    letter-spacing: 0.5px;
    box-shadow: none !important;
}
#screen-article-detail ion-card {
    --background: #ffffff;
    box-shadow: none;
    border-radius: 8px;
    border: 1px solid #edeaf2;
    margin-left: 0;
    margin-right: 0;
    margin-bottom: 16px;
}
#screen-article-detail ion-card-header {
    padding-bottom: 8px;
}
#screen-article-detail ion-card-title {
    display: flex;
    align-items: center;
    font-size: 16px;
    font-weight: 600;
    color: var(--ion-text-color);
}
#screen-article-detail ion-card-title ion-icon {
    font-size: 20px;
    margin-right: 8px;
}
#screen-article-detail ion-card-content {
    padding-top: 8px;
}
#screen-article-detail .summary-grid {
    display: grid;
    grid-template-columns: 1fr auto auto;
    gap: 12px 16px;
    font-size: 14px;
}
#screen-article-detail .summary-header {
    font-weight: 600;
    color: #6c757d;
    text-align: right;
}
#screen-article-detail .summary-label {
    color: var(--ion-text-color);
}
#screen-article-detail .summary-value {
    text-align: right;
    color: var(--ion-text-color);
    font-weight: 500;
}
#screen-article-detail .status-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    font-size: 14px;
}
#screen-article-detail .status-item {
    display: flex;
    flex-direction: column;
}
#screen-article-detail .status-value {
    font-size: 16px;
    font-weight: 600;
    color: var(--ion-text-color);
}
#screen-article-detail .status-label {
    color: #6c757d;
}
/* Cache la barre de navigation quand l'écran de détail d'un article est actif */
#screen-article-detail.active ~ .bottom-nav-pro {
    display: none;
}
</style>
<script>
  /**
   * Initialise les écouteurs d'événements pour les onglets de la page de détail.
   * Doit être appelé une seule fois au chargement de la page.
   */
  function setupArticleTabs() {
    const tabs = document.getElementById('article-tabs');
    // On vérifie si l'écouteur n'a pas déjà été attaché pour éviter les doublons
    if (tabs && !tabs.listenerAttached) {
      tabs.addEventListener('ionChange', (event) => {
        const selectedTab = event.detail.value;
        handleTabChange(selectedTab);
      });
      tabs.listenerAttached = true; // On marque l'écouteur comme attaché
    }
  }

  /**
   * Gère le changement d'onglet et charge les données appropriées.
   * @param {string} tabValue - La valeur de l'onglet sélectionné ('details', 'transactions', 'history').
   */
  function handleTabChange(tabValue) {
    // Masquer tous les conteneurs de contenu des onglets
    document.querySelectorAll('#screen-article-detail .tab-content').forEach(content => {
      content.style.display = 'none';
    });

    // Afficher le conteneur sélectionné et charger ses données si nécessaire
    switch (tabValue) {
      case 'details':
        document.getElementById('detailsContent').style.display = 'block';
        // Les détails sont déjà chargés par loadArticleDetail(), donc rien à faire de plus.
        break;
      case 'transactions':
        document.getElementById('transactionsContent').style.display = 'block';
        loadArticleTransactions(currentArticleId);
        break;
      case 'history':
        document.getElementById('historyContent').style.display = 'block';
        loadArticleStockHistory(currentArticleId);
        break;
    }
  }

  /**
   * Charge et affiche l'historique des ventes et approvisionnements pour un article.
   * @param {string} articleId - L'ID de l'article dans la collection 'stock'.
   */
  async function loadArticleTransactions(articleId) {
    const container = document.getElementById('transactionsContent');
    container.innerHTML = '<p>Chargement des transactions...</p>';

    try {
      const stockDoc = await dbFirestore.collection("stock").doc(articleId).get();
      if (!stockDoc.exists) {
        container.innerHTML = '<p>Article non trouvé.</p>';
        return;
      }
      const articleName = stockDoc.data().name;

      // Récupérer les ventes récentes qui contiennent cet article
      const salesSnapshot = await dbFirestore.collection("ventes")
        .orderBy("timestamp", "desc")
        .limit(50) // On limite pour ne pas surcharger
        .get();

      const transactions = [];

      salesSnapshot.forEach(doc => {
        const sale = doc.data();
        // On vérifie si un des articles de la vente correspond à notre article
        const relevantItem = sale.items && sale.items.find(item => item.produit === articleName);
        if (relevantItem) {
          transactions.push({
            date: new Date(sale.timestamp).toLocaleDateString('fr-FR'),
            type: 'Vente',
            details: `Client: ${sale.clientNom || 'N/A'}`,
            montant: relevantItem.total
          });
        }
      });
      
      // Ici, vous pourriez ajouter une logique similaire pour les approvisionnements

      if (transactions.length === 0) {
        container.innerHTML = '<p>Aucune transaction récente pour cet article.</p>';
        return;
      }

      // Afficher les transactions trouvées
      container.innerHTML = '<h3>Transactions Récentes</h3>';
      transactions.forEach(t => {
        const div = document.createElement('div');
        div.className = 'vente-card'; // Réutilisation d'un style existant
        div.style.marginBottom = '8px';
        div.innerHTML = `<p><strong>${t.date} - ${t.type}</strong><br>${t.details}<br>Montant: <strong>${t.montant.toLocaleString()} FCFA</strong></p>`;
        container.appendChild(div);
      });

    } catch (error) {
        console.error("Erreur lors du chargement des transactions :", error);
        container.innerHTML = '<p>Erreur lors du chargement des transactions.</p>';
    }
  }

  /**
   * Charge et affiche l'historique des variations de stock pour un article.
   * @param {string} articleId - L'ID de l'article dans la collection 'stock'.
   */
  async function loadArticleStockHistory(articleId) {
    const container = document.getElementById("historyContent");
    container.innerHTML = "<p>Chargement de l'historique du stock...</p>";

    try {
      let articleName = '';
      if (articleId) {
        const stockDoc = await dbFirestore.collection("stock").doc(articleId).get();
        if (stockDoc.exists) {
          articleName = stockDoc.data().name || '';
        }
      }

      const snapshot = await dbFirestore
        .collection("stock")
        .doc(articleId)
        .collection("history")
        .orderBy("timestamp", "desc")
        .limit(50)
        .get();

      if (snapshot.empty) {
        container.innerHTML = "<p>Aucune variation de stock enregistrée pour cet article.</p>";
        return;
      }

      container.innerHTML = '<h3>Historique des Mouvements de Stock</h3>';
      snapshot.forEach(doc => {
        const d = doc.data();
        const dateObj = d.timestamp && typeof d.timestamp.toDate === "function"
          ? d.timestamp.toDate()
          : null;
        const date = dateObj ? dateObj.toLocaleString("fr-FR") : "Date indisponible";
        const change = d.change || 0;
        const signe = change > 0 ? "+" : "";
        const color = change > 0 ? "green" : "red";

        let typeMouvement = "Mouvement";
        switch (d.type) {
          case "approvisionnement":
          case "approvisionnement-reception":
            typeMouvement = "Approvisionnement";
            break;
          case "vente":
            typeMouvement = "Vente";
            break;
          case "annulation_achat":
            typeMouvement = "Annulation achat";
            break;
          case "annulation_vente":
            typeMouvement = "Retour vente";
            break;
          case "ajustement_stock":
            typeMouvement = "Ajustement stock";
            break;
        }

        const row = document.createElement("div");
        row.className = "vente-card";
        row.style.marginBottom = '8px';
        row.innerHTML = `
          <p>
            <strong>${date}</strong> - <span>${typeMouvement}</span><br>
            Mouvement : <span style="color:${color}; font-weight:bold;">${signe}${change}</span> unités<br>
            Nouveau Stock : <strong>${d.newStock != null ? d.newStock : 'N/A'}</strong>
            ${d.reason ? `<br><span class="history-reason">Raison : ${escapeHtmlStock(d.reason)}</span>` : ''}
          </p>`;

        if (['approvisionnement', 'approvisionnement-reception'].includes(d.type)) {
          row.classList.add('history-item-clickable');
          const openPurchaseModal = () => {
            if (d.sourceApproId) {
              ouvrirModalAchatStock(d.sourceApproId, d, articleName || d.sourceApproItemName || '');
            } else if (typeof showToast === 'function') {
              showToast("Aucun détail disponible pour cet achat.", "warning");
            } else {
              alert("Aucun détail disponible pour cet achat.");
            }
          };
          row.addEventListener('click', openPurchaseModal);
          row.setAttribute('role', 'button');
          row.setAttribute('tabindex', '0');
          row.addEventListener('keydown', evt => {
            if (evt.key === 'Enter' || evt.key === ' ') {
              evt.preventDefault();
              openPurchaseModal();
            }
          });
        }

        container.appendChild(row);
      });
    } catch (err) {
      console.error("Erreur chargement historique stock:", err);
      container.innerHTML = "<p>Erreur de chargement de l'historique.</p>";
    }
  }

  // Lancement de la configuration des onglets au chargement de la page.
  window.addEventListener('load', setupArticleTabs);

</script>
<section id="screen-approvisionnement-historique" class="screen">
    <ion-app>
        <ion-header class="ion-no-border">
            <ion-toolbar>
                <ion-title>Historique des Achats</ion-title>
                <ion-buttons slot="end">
                    <ion-button>
                        <ion-icon name="search-outline"></ion-icon>
                    </ion-button>
                    <ion-button>
                        <ion-icon name="ellipsis-vertical-outline"></ion-icon>
                    </ion-button>
                </ion-buttons>
            </ion-toolbar>
            <ion-toolbar class="segment-toolbar">
                <ion-segment value="all" id="purchase-tabs">
                    <ion-segment-button value="all">
                        <ion-label>Tout</ion-label>
                    </ion-segment-button>
                    <ion-segment-button value="commandes">
                        <ion-label>Commandes</ion-label>
                    </ion-segment-button>
                    <ion-segment-button value="paid">
                        <ion-label>Payé</ion-label>
                    </ion-segment-button>
                </ion-segment>
                <ion-buttons slot="end">
                    <ion-button>
                        <ion-icon name="options-outline"></ion-icon>
                    </ion-button>
                </ion-buttons>
            </ion-toolbar>
        </ion-header>

        <ion-content fullscreen>
            <div id="purchase-history-filters" style="padding:10px; text-align:center; background: #f5f7fa; border-bottom: 1px solid #eee;">
                <input type="date" id="filterPurchaseDate" onchange="chargerApprovisionnements()" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;"/>
                <select id="filterPurchasesByUser" onchange="chargerApprovisionnements(document.getElementById('purchase-tabs').value)" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; background-color: white;">
      <option value="all" selected>Tous les utilisateurs</option>
    </select>
                <div id="totalPurchaseCost" style="margin-top:5px; font-weight:bold; color: var(--primary-color);"></div>
            </div>
            <ion-list lines="full" id="approvisionnementHistoryList">
                <ion-item>
                    <ion-label style="text-align:center; padding: 20px; color: #888;">Chargement des approvisionnements...</ion-label>
                </ion-item>
            </ion-list>

            <ion-fab vertical="bottom" horizontal="end" slot="fixed" onclick="window.location.hash='approvisionnement'">
                <ion-fab-button>
                    <ion-icon name="add-outline"></ion-icon>
                </ion-fab-button>
            </ion-fab>
        </ion-content>
    </ion-app>
    <style>
/* ==============================================================
   STYLES POUR L'HISTORIQUE DES APPROVISIONNEMENTS (Zoho Inventory Like - SANS OMBRE)
   ============================================================== */

#screen-approvisionnement-historique {
    --ion-background-color: #ffffff; /* Un arrière-plan très léger */
    --ion-text-color: #2e3748; /* Couleur de texte principale */
    font-family: 'Roboto', sans-serif; /* Assure la police globale */
}


/* En-tête (Header) - Design plat */
#screen-approvisionnement-historique ion-header {
    /* box-shadow: none !important;  PAS D'OMBRE SUR L'EN-TÊTE */
    border-bottom: 1px solid #e0e0e0; /* Ligne de séparation fine */
}

#screen-approvisionnement-historique ion-toolbar {
    --background: #fff; /* Fond blanc */
    --border-width: 0 !important; /* Pas de bordure */
    --box-shadow: none !important; /* PAS D'OMBRE */
    padding-left: 10px;
    padding-right: 10px;
}
/* Styles pour le conteneur du badge à l'intérieur du segment button */
#screen-approvisionnement-historique ion-title {
    font-weight: 600;
    color: #333; /* Plus sombre pour le titre */
    font-size: 18px;
    padding-inline-start: 0;
}

#screen-approvisionnement-historique ion-buttons ion-button {
    --color: #333; /* Couleur des icônes pour rester plat */
    font-size: 1.5em;
    --padding-end: 8px;
    --padding-start: 8px;
}

/* Segment (Onglets : Tout, Crédit, Payé) */
#screen-approvisionnement-historique .segment-toolbar {
    --background: #fff; /* Fond blanc pour la toolbar du segment */
    border-bottom: 1px solid #e0e0e0; /* Ligne de séparation fine */
    padding-bottom: 5px;
    --box-shadow: none !important; /* PAS D'OMBRE */
}

#screen-approvisionnement-historique ion-segment {
    --background: transparent;
    --indicator-color: #6D5DFD; /* Couleur de la barre indicatrice comme sur l'image */
    --indicator-height: 2px;
    flex-grow: 1;
    margin: 0 5px;
}

#screen-approvisionnement-historique ion-segment-button {
    --color: #a0a0a0;
    --color-checked: #2e3748;
    --indicator-box-shadow: none;
    text-transform: none;
    font-weight: 500;
    font-size: 15px;
    letter-spacing: 0;
    min-height: 40px;
}
#screen-approvisionnement-historique ion-content {
    /* The `fullscreen` property of Ionic already handles a lot, but sometimes an adjustment is needed */
    /* Ensure that the bottom padding is sufficient for the FAB and the bottom-nav-pro */
    --padding-bottom: 70px; /* Space for the FAB (~56px) + a small additional offset */
    /* You could also add space for the bottom-nav-pro if it's not already globally managed */
    padding-bottom: calc(var(--ion-safe-area-bottom) + 60px + 20px) !important; /* Example: safe-area + nav-bar + margin */
    /* I add 60px for the bottom-nav-pro and 20px margin above for the FAB,
       the safe-area is an Ionic variable for notches on mobile */
}

/* Ensure the floating button does not overlap the content */
/* The FAB is already `slot="fixed"` and `vertical="bottom"`, `horizontal="end"`
   so it should position correctly relative to `ion-content`.
   Make sure there's no negative `margin-bottom` or other oddities. */
#screen-approvisionnement-historique ion-fab {
    margin-bottom: calc(var(--ion-safe-area-bottom) + 60px) !important; /* Pousse le bouton de 80px + safe area */
}
/* S'assurer que la liste scrollable a un padding-bottom suffisant */
#approvisionnementHistoryList {
    /* Si ion-content gère déjà le padding-bottom, ce n'est pas toujours nécessaire,
       mais peut servir de sécurité pour le contenu interne de la liste */
    padding-bottom: 80px; /* Un peu plus que le FAB + marge si nécessaire */
}

/* Conteneur des items (liste) */
#approvisionnementHistoryList {
    background-color: transparent; /* Pour que le fond de la liste soit celui de l'écran */
    padding: 0; /* Supprime le padding par défaut si la liste le gère elle-même */
    margin-top: 10px; /* Espace après les onglets */
}

/* Styles des ion-item individuels (remplace les anciennes cartes) */
#approvisionnementHistoryList ion-item {
    --background: #ffffff; /* Fond blanc pour chaque élément de la liste */
    --padding-start: 16px;
    --padding-end: 16px;
    --inner-padding-end: 16px;
    --border-width: 0; /* Pas de bordure interne par défaut d'Ionic */
    /* box-shadow: none !important;  PAS D'OMBRE SUR LES ITEMS */
    border-radius: 0; /* PAS DE COINS ARRONDIS pour un effet "liste propre" */
    margin-bottom: 0; /* La bordure seule gérera la séparation */
    min-height: 70px; /* Hauteur minimale pour l'item */
    align-items: center; /* Aligner le contenu au centre verticalement */
    padding-top: 12px;
    padding-bottom: 12px;
    position: relative; /* Pour les pseudo-éléments si besoin */
    border-bottom: 1px solid #eee; /* Ligne de séparation fine entre les éléments */
}

/* Pour le dernier élément, pas de bordure en bas */
#approvisionnementHistoryList ion-item:last-child {
    border-bottom: none;
}

/* Pas de bordure par défaut, on les gère par l'ombre et la marge */
#approvisionnementHistoryList ion-list {
    --ion-item-border-color: transparent;
    background-color: #ffffff; /* Fond blanc pour la liste entière */
    border-radius: 8px; /* Coins arrondis pour la liste complète */
    overflow: hidden; /* Important pour que les coins arrondis s'appliquent sur le contenu */
    margin: 10px 16px; /* Marges latérales pour que la liste flotte un peu */
}


/* Mise en forme du contenu d'un ion-item pour qu'il ressemble à la capture Zoho */
#approvisionnementHistoryList ion-item .main-content-wrapper {
    display: flex;
    justify-content: space-between; /* Pour pousser le montant à droite */
    align-items: center; /* Aligner verticalement */
    width: 100%;
}

#approvisionnementHistoryList ion-item .left-info {
    display: flex;
    flex-direction: column;
    flex-grow: 1; /* Permet de prendre l'espace restant */
}

#approvisionnementHistoryList ion-item .supplier-name {
    font-weight: 500; /* Moins gras que 700 */
    font-size: 16px; /* Taille un peu plus petite */
    color: #333; /* Couleur de texte sombre */
    margin-bottom: 4px; /* Espace sous le nom */
}

#approvisionnementHistoryList ion-item .purchase-date {
    font-size: 13px; /* Plus petite */
    color: #888; /* Couleur plus discrète */
}

#approvisionnementHistoryList ion-item .right-info {
    display: flex;
    flex-direction: column;
    align-items: flex-end; /* Aligner le texte à droite */
    margin-left: 15px; /* Espace entre les deux colonnes */
}

#approvisionnementHistoryList ion-item .total-amount {
    font-weight: 600; /* Plus léger que 700 */
    font-size: 18px; /* Correspond à l'image */
    color: #333; /* Couleur de texte par défaut */
    margin-bottom: 4px; /* Espace sous le montant */
}
#approvisionnementHistoryList ion-item.status-paid .total-amount {
    color: #3880ff; /* Bleu pour "Paid" comme Zoho */
}
#approvisionnementHistoryList ion-item.status-credit .total-amount {
    color: #f04141; /* Rouge pour "Due" comme Zoho */
}
#approvisionnementHistoryList ion-item.status-depot .total-amount {
    color: #6c757d;
}
#approvisionnementHistoryList ion-item.status-commande .total-amount {
    color: #f39c12;
}
#approvisionnementHistoryList ion-item.status-partial .total-amount {
    color: #3f51b5;
}
#approvisionnementHistoryList ion-item.status-commande .payment-method,
#approvisionnementHistoryList ion-item.status-partial .payment-method {
    color: #555;
    font-weight: 600;
}


#approvisionnementHistoryList ion-item .payment-method {
    font-size: 13px;
    color: #888;
    text-transform: uppercase; /* CASH / DUE / PAID */
    font-weight: 500;
}

/* Floating Action Button (FAB) - inchangé car déjà plat par Ionic */
ion-fab-button {
    --background: #2e3748;
    --background-activated: #000;
    --box-shadow: none !important; /* Supprime toute ombre résiduelle */
}
.recorded-by-tag {
    margin-top: 12px; /* Espace au-dessus */
    padding-top: 8px; /* Espace au-dessus de la ligne */
    border-top: 1px solid #f0f0f0; /* Ligne de séparation discrète */
    text-align: right; /* Aligner à droite */
    font-size: 14px;   /* Police plus grande */
    color: #555;       /* Couleur de base du texte */
}

.recorded-by-tag strong {
    color: #000;       /* Nom en noir pour plus de visibilité */
    font-weight: 600;  /* Un peu plus gras */
}

    </style>
<script>
// La fonction getAvatarColor (qui est déjà présente dans votre code)
function getAvatarColor(name) {
    const colors = [
        '#3498DB', '#2ECC71', '#E74C3C', '#9B59B6', '#1ABC9C',
        '#34495E', '#9B59B6', '#C0392B', '#2980B9', '#27AE60',
        '#8E44AD', '#7F8C8D', '#D35400'
    ];
    const forbiddenColors = ['#FFC107', '#FF9800', '#FFD700', '#FFA500'];
    const filteredColors = colors.filter(color => !forbiddenColors.includes(color.toUpperCase()));

    let hash = 0;
    for (let i = 0; i < name.length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
    }
    const index = Math.abs(hash % filteredColors.length);
    return filteredColors[index];
}

async function chargerApprovisionnements(statusFilter = 'all') {
    const selectedUser = document.getElementById("filterPurchasesByUser").value;
    const container = document.getElementById("approvisionnementHistoryList");
    container.innerHTML = `
        <ion-item style="--background: transparent; box-shadow: none; border-bottom: none; margin-bottom: 0;">
            <ion-label style="text-align:center; padding: 20px; color: #888;">
                <ion-spinner name="crescent"></ion-spinner><br>Chargement...
            </ion-label>
        </ion-item>`;

    try {
        let query = dbFirestore.collection("approvisionnement");
        let snapshot;

        if (statusFilter === 'commandes') {
            const dateInput = document.getElementById("filterPurchaseDate").value;
            const hasDateFilter = !!dateInput;
            let dateStart = null;
            let dateEnd = null;
            if (hasDateFilter) {
                const selectedDate = new Date(dateInput);
                dateStart = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), 0, 0, 0, 0);
                dateEnd = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), 23, 59, 59, 999);
            }

            const statuses = ['commande', 'reception_partielle'];
            const snapshots = await Promise.all(statuses.map(status => {
                let statusQuery = dbFirestore.collection("approvisionnement").where("status", "==", status);
                if (selectedUser && selectedUser !== 'all') {
                    statusQuery = statusQuery.where("enregistreParNom", "==", selectedUser);
                }
                if (hasDateFilter) {
                    statusQuery = statusQuery
                        .where("timestamp", ">=", firebase.firestore.Timestamp.fromDate(dateStart))
                        .where("timestamp", "<=", firebase.firestore.Timestamp.fromDate(dateEnd));
                }
                return statusQuery.get();
            }));

            const commandes = [];
            snapshots.forEach(snap => {
                snap.forEach(doc => {
                    const data = doc.data();
                    if (data.status === 'annulé') {
                        return;
                    }
                    data.id = doc.id;
                    commandes.push(data);
                });
            });

            commandes.sort((a, b) => {
                const timeA = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : new Date(a.timestamp || 0).getTime();
                const timeB = b.timestamp?.toDate ? b.timestamp.toDate().getTime() : new Date(b.timestamp || 0).getTime();
                return timeB - timeA;
            });

            container.innerHTML = "";
            if (commandes.length === 0) {
                container.innerHTML = `
                    <ion-item style="text-align:center; --background: transparent; box-shadow: none;">
                        <ion-label>
                            <ion-icon name="cart-outline" style="font-size: 40px;"></ion-icon><br>
                            Aucune commande fournisseur en attente.
                        </ion-label>
                    </ion-item>`;
                document.getElementById("totalPurchaseCost").innerText = "Total commandes en attente : 0 FCFA";
                return;
            }

            let totalPendingOrders = 0;
            commandes.forEach(appro => {
                const totalOrderCost = parseFloat(appro.orderTotalCost || appro.totalCost || 0);
                const receivedValue = parseFloat(appro.receivedTotalCost || 0);
                const paidValue = parseFloat(appro.paymentsTotalPaid || 0);
                const goodsRemainingValue = Math.max(0, totalOrderCost - receivedValue);
                totalPendingOrders += goodsRemainingValue;
                const advanceValue = Math.max(0, paidValue - receivedValue);
                const paymentDue = Math.max(0, receivedValue - paidValue);
                const timestamp = appro.timestamp instanceof firebase.firestore.Timestamp ? appro.timestamp.toDate() : new Date(appro.timestamp);
                const dateAppro = timestamp.toLocaleString("fr-FR", { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                const expectedDateRaw = appro.commandeMeta && appro.commandeMeta.expectedDate ? new Date(appro.commandeMeta.expectedDate) : null;
                const expectedDateDisplay = expectedDateRaw ? expectedDateRaw.toLocaleDateString('fr-FR') : null;
                const supplierName = appro.fournisseur || 'Fournisseur';
                const initials = supplierName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                const avatarBgColor = getAvatarColor(supplierName);
                const items = Array.isArray(appro.items) ? appro.items : [];
                let itemsHtml = '';
                items.forEach(item => {
                    itemsHtml += `<p class="item-line">${item.quantite} x ${item.produit || 'Article'} - ${parseFloat(item.prixAchat || item.adjustedPrixAchat || 0).toLocaleString('fr-FR')} FCFA</p>`;
                });
                if (!itemsHtml) {
                    itemsHtml = '<p class="item-line" style="color:#888;">Aucun article détaillé</p>';
                }

                const receptionStats = appro.receptionStats || {};
                const totalOrdered = receptionStats.totalOrdered || items.reduce((acc, item) => acc + (parseFloat(item.quantite) || 0), 0);
                const totalReceived = receptionStats.totalReceived || 0;
                const statusClass = appro.status === 'commande' ? 'status-commande' : 'status-partial';
                const statusLabel = appro.status === 'commande' ? 'À recevoir' : 'Réception partielle';
                const goodsRemainingLine = goodsRemainingValue > 0 ? `<div class="purchase-date">À recevoir : ${goodsRemainingValue.toLocaleString('fr-FR')} FCFA</div>` : '';
                const advanceLine = advanceValue > 0 ? `<div class="purchase-date" style="color:#2e7d32;">Avance fournisseur : ${advanceValue.toLocaleString('fr-FR')} FCFA</div>` : '';
                const paymentDueLine = paymentDue > 0 ? `<div class="purchase-date" style="color:#f04141;">Solde à payer : ${paymentDue.toLocaleString('fr-FR')} FCFA</div>` : '';
                const expectedLine = expectedDateDisplay ? `<div class="purchase-date">Prévu : ${expectedDateDisplay}</div>` : '';
                const receptionLine = appro.status === 'commande'
                    ? `<div class="purchase-date">Commandé : ${totalOrdered}</div>`
                    : `<div class="purchase-date">Réception : ${totalReceived}/${totalOrdered}</div>`;
                const receivedValueLine = receivedValue > 0 ? `<div class="purchase-date">Reçu : ${receivedValue.toLocaleString('fr-FR')} FCFA</div>` : '';
                const financialLabel = advanceValue > 0 ? 'Avance fournisseur' : (paymentDue > 0 ? 'À payer' : statusLabel);
                const supplierNameEncoded = encodeURIComponent(supplierName);

                const slidingItem = document.createElement('ion-item-sliding');
                slidingItem.innerHTML = `
                  <ion-item class="${statusClass}" button="true" lines="none" style="border-bottom:1px solid #eee; margin:0; padding:0; --padding-start:0; --padding-end:0; --inner-padding-end:0;">
                    <ion-label style="padding: 12px 16px;">
                        <div class="main-content-wrapper" style="display: flex; align-items: center; width: 100%;">
                            <div class="avatar-circle" style="background-color: ${avatarBgColor};"> ${initials} </div>
                            <div class="left-info">
                                <div class="supplier-name">${supplierName}</div>
                                <div class="purchase-date">${dateAppro}</div>
                                <div class="item-list-container" style="margin-top: 5px;">${itemsHtml}</div>
                                ${expectedLine}
                                ${receivedValueLine}
                                ${advanceLine}
                                ${paymentDueLine}
                                ${goodsRemainingLine}
                                ${receptionLine}
                                <ion-badge color="${appro.status === 'commande' ? 'warning' : 'tertiary'}" style="margin-top:6px;">${statusLabel}</ion-badge>
                            </div>
                            <div class="right-info">
                                <div class="total-amount">XOF ${totalOrderCost.toLocaleString('fr-FR')}</div>
                                <div class="payment-method">${financialLabel}</div>
                            </div>
                        </div>
                    </ion-label>
                    <ion-ripple-effect></ion-ripple-effect>
                  </ion-item>

                  <ion-item-options side="end">
                    <ion-item-option color="success" expandable onclick="ouvrirReceptionCommande('${appro.id}', event)">
                      <ion-icon slot="icon-only" name="download-outline"></ion-icon>
                      Réceptionner
                    </ion-item-option>
                    <ion-item-option color="medium" expandable onclick="ouvrirFournisseurBalance(decodeURIComponent('${supplierNameEncoded}'), event)">
                      <ion-icon slot="icon-only" name="person-circle-outline"></ion-icon>
                      Détails
                    </ion-item-option>
                    <ion-item-option color="danger" expandable onclick="annulerCommandeFournisseur('${appro.id}', event)">
                      <ion-icon slot="icon-only" name="close-circle-outline"></ion-icon>
                      Annuler
                    </ion-item-option>
                  </ion-item-options>
                `;

                slidingItem.addEventListener('click', () => ouvrirReceptionCommande(appro.id));
                container.appendChild(slidingItem);
            });

            document.getElementById("totalPurchaseCost").innerText = `Valeur restante à recevoir : ${totalPendingOrders.toLocaleString('fr-FR')} FCFA`;
            return;
        } else {
            // Logic for "All" and "Paid" tabs
            const dateInput = document.getElementById("filterPurchaseDate").value;
            if (!dateInput) {
                document.getElementById("totalPurchaseCost").innerText = "Veuillez choisir une date";
                 container.innerHTML = `<ion-item style="text-align:center; --background: transparent; box-shadow: none;"><ion-label>Veuillez choisir une date.</ion-label></ion-item>`;
                return;
            }

            const selectedDate = new Date(dateInput);
            const startOfDayFirestoreTimestamp = firebase.firestore.Timestamp.fromDate(new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), 0, 0, 0, 0));
            const endOfDayFirestoreTimestamp = firebase.firestore.Timestamp.fromDate(new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), 23, 59, 59, 999));
            
            //  FIX: REMOVED .where("status", "!=", "annulé") from the query
            query = query
                .where("timestamp", ">=", startOfDayFirestoreTimestamp)
                .where("timestamp", "<=", endOfDayFirestoreTimestamp)
                .orderBy("timestamp", "desc");
            
            if (selectedUser && selectedUser !== 'all') {
                query = query.where("enregistreParNom", "==", selectedUser);
            }
            

            if (statusFilter === 'paid') {
                query = query.where("isPaid", "==", true);
            }

            snapshot = await query.get();
            container.innerHTML = ""; 
            let totalPurchasesForDate = 0;

            if (snapshot.empty) {
                container.innerHTML = `
                    <ion-item style="text-align:center; --background: transparent; box-shadow: none;">
                        <ion-label>
                             <ion-icon name="happy-outline" style="font-size: 40px;"></ion-icon><br>
                             Aucun achat pour cette date et ce filtre.
                        </ion-label>
                    </ion-item>`;
                document.getElementById("totalPurchaseCost").innerText = "Total des achats : 0 FCFA";
                return;
            }

            snapshot.forEach(doc => {
                const appro = doc.data();
                
                //  FIX: ADDED client-side filtering to skip cancelled items
                if (appro.status === 'annulé' || appro.status === 'commande' || appro.status === 'reception_partielle') {
                    return;
                }

                appro.id = doc.id;
                const jsDate = appro.timestamp instanceof firebase.firestore.Timestamp ? appro.timestamp.toDate() : new Date(appro.timestamp);
                const dateAppro = jsDate.toLocaleString("fr-FR", { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                totalPurchasesForDate += parseFloat(appro.totalCost || 0);

                const fraisTransport = parseFloat(appro.fraisTransport || 0);
                let fraisTransportDisplay = '';
                if (fraisTransport > 0) {
                    fraisTransportDisplay = `<p class="item-line">Frais transport: <strong>${fraisTransport.toLocaleString('fr-FR')} FCFA</strong></p>`;
                }

                const remainingAmount = parseFloat(appro.remainingAmount || 0);
                const isPaid = !!appro.isPaid && remainingAmount <= 0;
                let paymentStatusText = isPaid ? 'PAYÉ' : 'DUE';
                let statusClass = isPaid ? 'status-paid' : 'status-credit';
                let amountColor = isPaid ? '#3880ff' : '#f04141';
                let remainingAmountDisplay = '';

                if (!isPaid && remainingAmount > 0) {
                    remainingAmountDisplay = `<div class="purchase-date" style="color: ${amountColor};">Solde: ${remainingAmount.toLocaleString('fr-FR')} FCFA</div>`;
                } else if (appro.paymentMethod === 'depot') {
                    paymentStatusText = 'DÉPÔT';
                    statusClass = 'status-depot';
                    amountColor = '#6c757d';
                } else if (isPaid) {
                    if (Array.isArray(appro.paymentsDetails) && appro.paymentsDetails.length > 0) {
                        const accountsLabels = [...new Set(appro.paymentsDetails.map(p => {
                            const compteId = p.compteId || p.account || '';
                            const compteNom = p.compteNom || getCompteNomById(compteId);
                            return compteNom || compteId;
                        }))].filter(Boolean);
                        if (accountsLabels.length > 0) {
                            paymentStatusText = accountsLabels.join(' + ');
                        } else {
                            paymentStatusText = 'PAYÉ';
                        }
                    } else if (appro.paymentMethod === 'credit') {
                        paymentStatusText = 'RÉGLÉ';
                    } else if (appro.paymentMethod && appro.paymentMethod !== 'paid') {
                        paymentStatusText = (appro.paymentMethod || 'payé').toUpperCase();
                    } else {
                        paymentStatusText = 'PAYÉ';
                    }
                }

                const supplierName = appro.fournisseur || 'Fournisseur Inconnu';
                const initials = supplierName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                const avatarBgColor = getAvatarColor(supplierName);
                let itemListHTML = '';
                if (appro.items && Array.isArray(appro.items)) {
                    // CORRECTION : On parcourt tous les articles au lieu de se limiter aux 2 premiers.
                    appro.items.forEach(item => {
                        const itemName = item.produit || 'Article inconnu';
                        itemListHTML += `<p class="item-line">${item.quantite} x ${itemName} - ${parseFloat(item.prixAchat || 0).toLocaleString('fr-FR')} FCFA</p>`;
                    });
                } else {
                    itemListHTML = '<p class="item-line" style="color: #888;">Aucun article détaillé</p>';
                }


                const slidingItem = document.createElement('ion-item-sliding');
                slidingItem.innerHTML = `
                  <ion-item class="${statusClass}" button="true" lines="none" style="border-bottom:1px solid #eee; margin:0; padding:0; --padding-start:0; --padding-end:0; --inner-padding-end:0;">
                    <ion-label style="padding: 12px 16px;">
                        <div class="main-content-wrapper" style="display: flex; align-items: center; width: 100%;">
                            <div class="avatar-circle" style="background-color: ${avatarBgColor};"> ${initials} </div>
                           <div class="left-info">
    <div class="supplier-name">${supplierName}</div>
    <div class="purchase-date">${dateAppro}</div>
    <div class="item-list-container" style="margin-top: 5px;">${itemListHTML}</div>
    ${fraisTransportDisplay} ${remainingAmountDisplay}

    <div class="recorded-by-tag">
        Saisi par : <strong>${appro.enregistreParNom || 'N/A'}</strong>
    </div>
</div>
                            <div class="right-info">
                                <div class="total-amount" style="color: ${amountColor};">XOF ${parseFloat(appro.totalCost || 0).toLocaleString('fr-FR')}</div>
                                <div class="payment-method">${paymentStatusText}</div>
                            </div>
                        </div>
                    </ion-label>
                    <ion-ripple-effect></ion-ripple-effect>
                  </ion-item>

                  <ion-item-options side="end">
                    <ion-item-option color="danger" expandable onclick="preparerAnnulationAchat('${appro.id}', event)">
                      <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                      Annuler
                    </ion-item-option>
                  </ion-item-options>
                `;

                if (appro.paymentMethod === 'credit' && parseFloat(appro.remainingAmount || 0) > 0) {
                    slidingItem.addEventListener('click', () => {
                        const supplierDetailData = {
                            name: supplierName,
                            totalDue: parseFloat(appro.remainingAmount || 0),
                            procurements: [appro]
                        };
                        showSupplierDebtDetailsPage(supplierDetailData);
                    });
                }
                container.appendChild(slidingItem);
            });
            document.getElementById("totalPurchaseCost").innerText = `Total des achats : ${totalPurchasesForDate.toLocaleString('fr-FR')} FCFA`;
        }

        if (container.lastElementChild && container.lastElementChild.style) {
             if (container.lastElementChild.tagName === 'ION-ITEM-SLIDING') {
                const innerItem = container.lastElementChild.querySelector('ion-item');
                if(innerItem) innerItem.style.borderBottom = 'none';
             }
        }

    } catch (error) {
        console.error("Erreur lors du chargement des approvisionnements :", error);
        container.innerHTML = `<ion-item style="color:red; text-align:center; --background: transparent; box-shadow: none;"><ion-label>Erreur de chargement.</ion-label></ion-item>`;
        document.getElementById("totalPurchaseCost").innerText = "Erreur";
    }
}

document.addEventListener("DOMContentLoaded", () => {
    const todayISO = new Date().toISOString().split("T")[0];
    document.getElementById("filterPurchaseDate").value = todayISO;

    const purchaseTabs = document.getElementById('purchase-tabs');
    if (purchaseTabs) {
        purchaseTabs.addEventListener('ionChange', (event) => {
            console.log('Segment changed', event.detail.value);
            chargerApprovisionnements(event.detail.value);
        });
    }

    // --- MODIFICATION STARTS HERE ---
    // Instead of immediately loading 'all', we'll prepare the screen
    // by ensuring all relevant data (including credit counts) is fetched.
    // The default tab will still show 'all' purchases for today first.
    // We explicitly call for 'all' to be displayed first, but the credit count
    // will be fetched in the background as part of the 'all' call's flow,
    // as it is always updated regardless of the filter.

    // Load initial 'all' data for the current date.
    // The credit count logic is already inside chargerApprovisionnements
    // and will update the badge regardless of the currently active tab.
    chargerApprovisionnements('all');
});

// We also need to ensure that when the hash changes to approvisionnement-historique,
// the default tab ('all') is loaded and the credit count is updated.
window.addEventListener('hashchange', () => {
    if (window.location.hash === '#approvisionnement-historique') {
        const purchaseTabs = document.getElementById('purchase-tabs');
        const currentTab = purchaseTabs ? purchaseTabs.value : 'all'; // Get current selected tab, default to 'all'
        chargerApprovisionnements(currentTab); // Load data for the current tab (usually 'all' on first visit)
    }
});
document.addEventListener('DOMContentLoaded', () => {
    const purchaseTabs = document.getElementById('purchase-tabs');
    if (purchaseTabs) {
        purchaseTabs.addEventListener('ionChange', (event) => {
            console.log('Segment changed', event.detail.value); // Check if this message appears in your browser's console
            chargerApprovisionnements(event.detail.value);
        });
    }
});
</script>
  
</section>

<section id="screen-fournisseur-credit-detail" class="screen">
  <ion-app>
    <ion-header class="ion-no-border" mode="ios">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button onclick="window.location.hash='approvisionnement-historique'">
        <ion-icon slot="icon-only" name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title id="supplierCreditDetailTitle">Détails de la dette</ion-title>
    <ion-buttons slot="end">
      <ion-button>
        <ion-icon slot="icon-only" name="pencil-outline"></ion-icon>
      </ion-button>
      <ion-button onclick="generateSupplierCreditPDF()">
        <ion-icon slot="icon-only" name="download-outline"></ion-icon>
      </ion-button>
      <ion-button>
        <ion-icon slot="icon-only" name="mail-outline"></ion-icon>
      </ion-button>
      <ion-button>
        <ion-icon slot="icon-only" name="ellipsis-vertical-outline"></ion-icon>
      </ion-button>
      
    </ion-buttons>
  </ion-toolbar>
</ion-header>

    <ion-content [fullscreen]="true">
      <div class="summary-section">
        <div class="ion-padding-horizontal">
          <div class="summary-header">
            <div>
              <h1 class="credit-id" id="detailSupplierName">Chargement...</h1>
              <p class="credit-ref" id="detailSupplierDebtRef">Dette Fournisseur</p>
            </div>
            <ion-chip class="draft-chip">
              <ion-label id="detailDebtStatus">EN COURS</ion-label>
            </ion-chip>
          </div>
          <div class="summary-amount">
            <div>
              <span class="amount-title">Montant Total Dû</span>
              <p class="amount-value" id="detailTotalDueAmount">XOF 0</p>
            </div>
            <ion-button fill="clear" color="medium">
              <ion-icon slot="icon-only" name="attach-outline"></ion-icon>
            </ion-button>
          </div>
          <span class="order-date" id="detailLastPurchaseDate">Dernier achat : N/A</span>
        </div>
      </div>

      <div class="main-content">
        <ion-segment value="details" mode="md" id="supplier-debt-tabs">
          <ion-segment-button value="details">
            <ion-label>DÉTAILS</ion-label>
          </ion-segment-button>
          <ion-segment-button value="purchases">
            <ion-label>ACHATS LIÉS</ion-label>
          </ion-segment-button>
          <ion-segment-button value="payments">
            <ion-label>PAIEMENTS</ion-label>
          </ion-segment-button>
          <ion-segment-button value="comments">
            <ion-label>COMMENTAIRES</ion-label>
          </ion-segment-button>
        </ion-segment>

        <div class="ion-padding">
          <div id="supplierDebtDetailsContent" class="tab-content active">
            <ion-card class="custom-card">
              <ion-card-content>
                <span class="card-title" style="color: #6b7280;">Détails du Fournisseur</span>
                <p class="card-main-text" id="detailSupplierContact">Contact: N/A</p>
                <p class="card-sub-text" id="detailSupplierEmail">Email: N/A</p>
              </ion-card-content>
            </ion-card>
            <ion-card class="custom-card">
              <ion-card-content>
                <span class="card-title" style="color: #6b7280;">Informations sur la dette</span>
                <p class="card-main-text">Nombre d'achats à crédit : <span id="detailNumCreditPurchases">0</span></p>
                <p class="card-sub-text">Dette la plus ancienne : <span id="detailOldestDebtDate">N/A</span></p>
              </ion-card-content>
            </ion-card>
          </div>

          <div id="supplierDebtPurchasesContent" class="tab-content" style="display: none;">
            <ion-card class="custom-card">
              <div class="items-header">
                <span class="card-title" style="color: #6b7280;">Articles des achats</span>
                <span class="card-title" style="color: #6b7280;">Montant</span>
              </div>
              <div id="supplierDebtItemsList">
                <ion-item lines="none">
                  <ion-label>Chargement des articles...</ion-label>
                </ion-item>
              </div>
              <ion-card-content class="totals-section">
                <div class="total-row">
                  <span style="color: #374151;">Total Achats (Fournisseur)</span>
                  <span style="color: #374151; font-weight: 500;" id="totalSupplierPurchases">XOF 0</span>
                </div>
                <div class="total-row final-total">
                  <span style="color: #1f2937;">Montant restant</span>
                  <span style="color: #1f2937;" id="finalRemainingDebt">XOF 0</span>
                </div>
              </ion-card-content>
            </ion-card>
          </div>

          <div id="supplierDebtPaymentsContent" class="tab-content" style="display: none;">
            <ion-card class="custom-card">
              <ion-card-content>
                <span class="card-title" style="color: #6b7280;">Historique des Paiements</span>
                <ul id="supplierPaymentsHistoryList" style="list-style: none; padding: 0;">
                  <li>Aucun paiement enregistré.</li>
                </ul>

                <h4 style="margin-top: 20px; margin-bottom: 10px; color: #1f2937;">Enregistrer un Paiement</h4>
                <form id="formRecordSupplierPayment" onsubmit="event.preventDefault(); recordSupplierPayment();">
                  <label for="paymentAmountSupplierDebt">Montant (FCFA)</label>
                  <input type="number" id="paymentAmountSupplierDebt" placeholder="Montant du paiement" required min="1" />

                  <label for="paymentAccountSupplierDebt">Payer depuis le compte</label>
                  <select id="paymentAccountSupplierDebt" required>
                    </select>

                  <button type="submit" class="btn-modern primary" style="margin-top: 15px;">
                    <i data-lucide="wallet"></i> Enregistrer le Paiement
                  </button>
                </form>
                </ion-card-content>
            </ion-card>
          </div>

          <div id="supplierDebtCommentsContent" class="tab-content" style="display: none;">
            <ion-card class="custom-card">
              <ion-card-content>
                <span class="card-title" style="color: #6b7280;">Commentaires</span>
                <p id="supplierCommentsText">Aucun commentaire pour l'instant.</p>
              </ion-card-content>
            </ion-card>
          </div>

        </div>
      </div>
    </ion-content>
  </ion-app>

  <style>
    #screen-fournisseur-credit-detail {
        --ion-background-color: #f8f6ff;
    }
    #screen-fournisseur-credit-detail ion-header ion-toolbar {
        --background: #f8f6ff;
        --color: #333;
    }
    #screen-fournisseur-credit-detail ion-title {
        font-weight: 700;
        font-size: 1.1rem;
    }
    #screen-fournisseur-credit-detail .summary-section {
        background: #f8f6ff;
        padding-top: 8px;
        padding-bottom: 16px;
    }
    #screen-fournisseur-credit-detail .summary-section .summary-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }
    #screen-fournisseur-credit-detail .summary-section .credit-id {
        font-size: 1.75rem;
        font-weight: 800;
        color: #1f2937;
        margin: 0;
    }
    #screen-fournisseur-credit-detail .summary-section .credit-ref {
        color: #4b5563;
        margin-top: 4px;
    }
    #screen-fournisseur-credit-detail .summary-section .draft-chip {
        --background: #e5e7eb;
        --color: #374151;
        font-weight: 600;
        height: 26px;
        font-size: 0.7rem;
        margin-top: 4px;
    }
    #screen-fournisseur-credit-detail .summary-section .summary-amount {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        margin-top: 16px;
    }
    #screen-fournisseur-credit-detail .summary-section .amount-title {
        font-size: 0.9rem;
        color: #6b7280;
    }
    #screen-fournisseur-credit-detail .summary-section .amount-value {
        font-size: 2.5rem;
        font-weight: 800;
        color: #1f2937;
        line-height: 1.1;
        margin-top: 4px;
        margin-bottom: 0;
    }
    #screen-fournisseur-credit-detail .summary-section ion-button[fill="clear"] {
        --padding-end: 0;
        --padding-start: 0;
        margin-bottom: -4px;
    }
    #screen-fournisseur-credit-detail .summary-section ion-button ion-icon {
        font-size: 1.8rem;
    }
    #screen-fournisseur-credit-detail .summary-section .order-date {
        display: block;
        font-size: 0.9rem;
        color: #6b7280;
        margin-top: 8px;
    }
    #screen-fournisseur-credit-detail .main-content {
        background: #fff;
        border-top-left-radius: 16px;
        border-top-right-radius: 16px;
        margin-top: -10px;
        position: relative;
        padding-bottom: 16px;
    }
    #screen-fournisseur-credit-detail ion-segment {
        --background: #fff;
        border-top-left-radius: 16px;
        border-top-right-radius: 16px;
    }
    #screen-fournisseur-credit-detail ion-segment-button {
        --color: #6b7280;
        --color-checked: #4f46e5;
        --indicator-color: #4f46e5;
        text-transform: uppercase;
        font-weight: 600;
        font-size: 0.85rem;
    }
    #screen-fournisseur-credit-detail .custom-card {
        --background: #ffffff;
        border-radius: 8px;
        margin: 0 0 16px 0;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    }
    #screen-fournisseur-credit-detail .custom-card .card-title {
        font-size: 0.8rem;
        font-weight: 500;
        margin-bottom: 4px;
        display: block;
    }
    #screen-fournisseur-credit-detail .custom-card .card-main-text {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 2px;
    }
    #screen-fournisseur-credit-detail .custom-card .card-sub-text {
        color: #4b5563;
    }
    #screen-fournisseur-credit-detail .items-header {
        display: flex;
        justify-content: space-between;
        padding: 16px 16px 8px 16px;
    }
    #screen-fournisseur-credit-detail ion-item {
        --inner-padding-end: 16px;
        --padding-start: 16px;
    }
    #screen-fournisseur-credit-detail ion-item .image-placeholder {
        width: 48px;
        height: 48px;
        background: #f3f4f6;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    #screen-fournisseur-credit-detail ion-item .image-placeholder ion-icon {
        font-size: 1.5rem;
    }
    #screen-fournisseur-credit-detail ion-item .item-name {
        font-weight: 600;
        color: #1f2937;
    }
    #screen-fournisseur-credit-detail ion-item .item-details {
        font-size: 0.9rem;
        color: #6b7280;
    }
    #screen-fournisseur-credit-detail ion-item .item-sku {
        font-size: 0.75rem;
        color: #9ca3af;
        margin-top: 4px;
    }
    #screen-fournisseur-credit-detail ion-item .item-amount {
        font-weight: 600;
        color: #1f2937;
    }
    #screen-fournisseur-credit-detail .totals-section {
        padding-top: 8px;
    }
    #screen-fournisseur-credit-detail .totals-section .total-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        font-size: 0.95rem;
    }
    #screen-fournisseur-credit-detail .totals-section .total-row.final-total {
        font-weight: 700;
        font-size: 1rem;
    }
    #screen-fournisseur-credit-detail.active ~ .bottom-nav-pro {
        display: none;
    }
    #screen-fournisseur-credit-detail .tab-content {
        display: none;
    }
    #screen-fournisseur-credit-detail .tab-content.active {
        display: block;
    }
    #supplierPaymentsHistoryList li {
        padding: 8px 4px;
        border-bottom: 1px solid #eee;
        font-size: 0.9rem;
        color: #333;
    }
    #supplierPaymentsHistoryList li:last-child {
        border-bottom: none;
    }
    #screen-aide-commande {
        background: #f5f5fa;
        padding: 20px 16px 80px;
        min-height: 100vh;
    }
    .aide-commande-wrapper {
        max-width: 1040px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 18px;
    }
    .aide-commande-header {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
    }
    .aide-commande-header h1 {
        margin: 0;
        font-size: 24px;
        font-weight: 700;
        color: #0f172a;
    }
    .aide-commande-header p {
        margin: 4px 0 0;
        color: #64748b;
        font-size: 14px;
    }
    .aide-commande-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: flex-end;
    }
    .aide-commande-controls .control-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 210px;
    }
    .aide-commande-controls label {
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: #94a3b8;
    }
    .aide-commande-select {
        appearance: none;
        border: 1px solid #d1d5db;
        border-radius: 12px;
        padding: 10px 14px;
        font-size: 14px;
        background: #fff;
        color: #1e293b;
        min-height: 40px;
    }
    .aide-commande-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
        gap: 14px;
    }
    .aide-commande-card {
        background: #fff;
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    .aide-commande-card span {
        text-transform: uppercase;
        font-size: 11px;
        letter-spacing: 0.08em;
        color: #94a3b8;
        font-weight: 600;
    }
    .aide-commande-card strong {
        font-size: 22px;
        color: #1e293b;
    }
    .aide-commande-card small {
        font-size: 12px;
        color: #94a3b8;
    }
    .aide-commande-section {
        display: flex;
        flex-direction: column;
        gap: 14px;
    }
    .aide-commande-section h2 {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
        color: #0f172a;
    }
    .aide-commande-table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        border-radius: 18px;
        overflow: hidden;
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
    }
    .aide-commande-table thead {
        background: #0f172a;
        color: #fff;
    }
    .aide-commande-table th,
    .aide-commande-table td {
        padding: 14px 18px;
        text-align: left;
        font-size: 14px;
        vertical-align: top;
    }
    .aide-commande-table th {
        text-transform: uppercase;
        letter-spacing: 0.06em;
        font-size: 12px;
    }
    .aide-commande-table tbody tr:nth-child(even) {
        background: #f8fafc;
    }
    .aide-commande-table tbody tr.is-alert td {
        background: rgba(248, 113, 113, 0.12);
    }
    .aide-commande-article {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    .aide-commande-article strong {
        font-size: 15px;
        color: #0f172a;
    }
    .aide-commande-article small {
        color: #94a3b8;
        font-size: 12px;
        text-transform: uppercase;
    }
    .aide-commande-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.04em;
    }
    .aide-commande-badge.ok {
        background: rgba(34, 197, 94, 0.16);
        color: #15803d;
    }
    .aide-commande-badge.faible {
        background: rgba(251, 191, 36, 0.18);
        color: #b45309;
    }
    .aide-commande-badge.rupture {
        background: rgba(248, 113, 113, 0.2);
        color: #b91c1c;
    }
    .aide-commande-empty {
        padding: 22px;
        border-radius: 16px;
        background: #fff;
        box-shadow: 0 6px 20px rgba(15, 23, 42, 0.08);
        font-size: 14px;
        color: #64748b;
        text-align: center;
    }
    .aide-commande-alerts {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .aide-commande-alert {
        background: #fff;
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
        gap: 12px;
        align-items: start;
    }
    .aide-commande-alert h3 {
        margin: 0;
        font-size: 16px;
        color: #0f172a;
    }
    .aide-commande-alert .alert-meta {
        margin: 0;
        font-size: 13px;
        color: #475569;
    }
    .aide-commande-alert .alert-meta strong {
        color: #0f172a;
    }
    .aide-commande-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: flex-end;
    }
    .aide-commande-helper {
        font-size: 13px;
        color: #64748b;
    }
    @media (max-width: 720px) {
        .aide-commande-table {
            font-size: 13px;
        }
        .aide-commande-table th,
        .aide-commande-table td {
            padding: 12px;
        }
        .aide-commande-controls .control-group {
            width: 100%;
        }
        .aide-commande-select {
            width: 100%;
        }
    }
    #screen-cloture-vendeur {
        background: #f4f6fb;
        min-height: 100vh;
        padding: 24px 16px 90px;
    }
    .cloture-vendeur-wrapper {
        max-width: 1040px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    .cloture-vendeur-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }
    .cloture-vendeur-header h1 {
        margin: 0;
        font-size: 24px;
        font-weight: 700;
        color: #0f172a;
    }
    .cloture-vendeur-back {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #fff;
        border: 1px solid #d1d5db;
        border-radius: 999px;
        padding: 6px 14px;
        font-size: 14px;
        color: #1f2937;
        cursor: pointer;
        box-shadow: 0 6px 20px rgba(15, 23, 42, 0.08);
        transition: background 0.2s ease, transform 0.2s ease;
    }
    .cloture-vendeur-back:hover {
        background: #e5e7eb;
        transform: translateY(-1px);
    }
    .cloture-vendeur-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: flex-end;
    }
    .cloture-control-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 220px;
    }
    .cloture-control-group label {
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: #94a3b8;
    }
    .cloture-vendeur-input,
    .cloture-vendeur-select {
        border: 1px solid #d1d5db;
        border-radius: 12px;
        padding: 10px 14px;
        font-size: 15px;
        background: #fff;
        color: #1e293b;
        min-height: 42px;
    }
    .cloture-vendeur-select.cloture-select-locked {
        background: #f5f5f5;
        color: #64748b;
        cursor: not-allowed;
    }
    .cloture-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }
    .cloture-card {
        background: #fff;
        border-radius: 18px;
        padding: 18px;
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .cloture-card span {
        font-size: 12px;
        letter-spacing: 0.08em;
        color: #94a3b8;
        text-transform: uppercase;
        font-weight: 600;
    }
    .cloture-card strong {
        font-size: 24px;
        color: #111827;
    }
    .cloture-card small {
        font-size: 12px;
        color: #64748b;
    }
    .cloture-details {
        background: #fff;
        border-radius: 18px;
        padding: 20px;
        box-shadow: 0 10px 28px rgba(15, 23, 42, 0.08);
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
    }
    .cloture-detail-block {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .cloture-detail-title {
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #94a3b8;
        margin: 0;
    }
    .cloture-detail-highlight {
        font-size: 22px;
        font-weight: 700;
        color: #0f172a;
    }
    .cloture-difference {
        font-size: 18px;
        font-weight: 600;
    }
    .cloture-difference.positive {
        color: #16a34a;
    }
    .cloture-difference.negative {
        color: #dc2626;
    }
    .cloture-accounts-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    .cloture-accounts-table th,
    .cloture-accounts-table td {
        padding: 10px 12px;
        font-size: 14px;
        text-align: left;
    }
    .cloture-accounts-table thead {
        background: #f1f5f9;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        font-size: 12px;
        color: #475569;
    }
    .cloture-accounts-table tbody tr:nth-child(even) {
        background: #f9fafb;
    }
    .cloture-actions {
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: #fff;
        border-radius: 18px;
        padding: 20px;
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
    }
    .cloture-actions textarea {
        border: 1px solid #d1d5db;
        border-radius: 12px;
        padding: 12px;
        resize: vertical;
        min-height: 90px;
        font-size: 14px;
        color: #1e293b;
    }
    .cloture-save-feedback {
        font-size: 13px;
        color: #64748b;
    }
    .cloture-history {
        background: #fff;
        border-radius: 18px;
        padding: 20px;
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
    }
    .cloture-history h3 {
        margin-top: 0;
        font-size: 16px;
        font-weight: 700;
        color: #0f172a;
    }
    .cloture-history-list {
        margin: 0;
        padding: 0;
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .cloture-history-item {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 12px;
        padding: 12px;
        border-radius: 12px;
        background: #f8fafc;
        font-size: 13px;
        color: #475569;
    }
    .cloture-empty-state {
        padding: 22px;
        border-radius: 16px;
        background: #fff;
        box-shadow: 0 6px 22px rgba(15, 23, 42, 0.08);
        font-size: 14px;
        color: #64748b;
        text-align: center;
    }
    .vente-payment-proof-wrapper {
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
        margin-top: 10px;
    }
    .vente-payment-proof-thumb {
        width: 56px;
        height: 56px;
        object-fit: cover;
        border-radius: 10px;
        border: 1px solid #d1d5db;
        cursor: pointer;
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.12);
    }
    .vente-payment-proof-remove {
        border: none;
        background: #dc2626;
        color: #fff;
        padding: 6px 10px;
        border-radius: 8px;
        font-size: 12px;
        cursor: pointer;
    }
    .cloture-payment-entry {
        padding: 10px 0;
        border-bottom: 1px dashed #e2e8f0;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .cloture-payment-entry:last-child {
        border-bottom: none;
    }
    .cloture-payment-amount {
        font-weight: 600;
        color: #0f172a;
    }
    .cloture-payment-proof {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }
    .cloture-payment-proof span {
        font-size: 12px;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.06em;
    }
    .cloture-proof-image {
        width: 80px;
        height: 80px;
        border-radius: 12px;
        object-fit: cover;
        border: 1px solid rgba(99, 102, 241, 0.35);
        cursor: pointer;
        box-shadow: 0 12px 30px rgba(79, 70, 229, 0.18);
        transition: transform 0.2s ease;
    }
    .cloture-proof-image:hover {
        transform: translateY(-2px);
    }
    @media (max-width: 720px) {
        .cloture-vendeur-controls {
            flex-direction: column;
            align-items: stretch;
        }
        .cloture-control-group {
            width: 100%;
        }
    }
  </style>

  <script>
    let currentDetailedSupplierData = null;

    async function showSupplierDebtDetailsPage(supplierData) {
    if (!supplierData || !supplierData.name) {
        console.error("Données du fournisseur invalides pour l'affichage des détails.");
        // Optionally, navigate back or show an error message on the page
        window.location.hash = 'approvisionnement-historique'; // Go back to list
        showToast("Impossible d'afficher les détails du fournisseur.", "error");
        return;
    }

    currentDetailedSupplierData = supplierData; 

    // Fetch all procurements for this supplier if not fully passed
    // This ensures `currentDetailedSupplierData.procurements` is complete for payment allocation
    if (!supplierData.procurements || supplierData.procurements.length === 0 || 
        (supplierData.procurements.length === 1 && supplierData.procurements[0].id === undefined)) { // Heuristic: if only one item without ID, it's likely a summary
        try {
            const procurementsSnapshot = await dbFirestore.collection("approvisionnement")
                .where("fournisseur", "==", supplierData.name)
                .where("paymentMethod", "==", "credit")
                // .where("remainingAmount", ">", 0) // Fetch all credit purchases, even paid ones, for full history
                .orderBy("timestamp", "asc")
                .get();
            
            currentDetailedSupplierData.procurements = [];
            let calculatedTotalDue = 0;
            procurementsSnapshot.forEach(doc => {
                const procData = { id: doc.id, ...doc.data() };
                currentDetailedSupplierData.procurements.push(procData);
                if (parseFloat(procData.remainingAmount || 0) > 0) {
                     calculatedTotalDue += parseFloat(procData.remainingAmount || 0);
                }
            });
            currentDetailedSupplierData.totalDue = calculatedTotalDue; // Recalculate total due from fresh data
        } catch (e) {
            console.error("Erreur lors de la récupération des achats du fournisseur:", e);
            showToast("Erreur de chargement des achats du fournisseur.", "error");
            // return; // Or handle gracefully
        }
    }


    window.location.hash = 'fournisseur-credit-detail';

    const supplierNameEl = document.getElementById('detailSupplierName');
    const totalDueAmountEl = document.getElementById('detailTotalDueAmount');
    const debtStatusChip = document.getElementById('detailDebtStatus');
    const lastPurchaseDateEl = document.getElementById('detailLastPurchaseDate');
    const contactEl = document.getElementById('detailSupplierContact');
    const emailEl = document.getElementById('detailSupplierEmail');
    const numCreditPurchasesEl = document.getElementById('detailNumCreditPurchases');
    const oldestDebtDateEl = document.getElementById('detailOldestDebtDate');
    const itemsListContainer = document.getElementById('supplierDebtItemsList'); // This is for "Achats Liés"
    const totalPurchasesEl = document.getElementById('totalSupplierPurchases');
    const finalRemainingDebtEl = document.getElementById('finalRemainingDebt');
    const paymentsHistoryList = document.getElementById('supplierPaymentsHistoryList');
    const paymentAccountSelect = document.getElementById('paymentAccountSupplierDebt');

    supplierNameEl.textContent = currentDetailedSupplierData.name;
    totalDueAmountEl.textContent = `XOF ${parseFloat(currentDetailedSupplierData.totalDue || 0).toLocaleString('fr-FR')}`;

    if (parseFloat(currentDetailedSupplierData.totalDue || 0) <= 0) {
        debtStatusChip.textContent = 'RÉGLÉE';
        debtStatusChip.style.setProperty('--background', '#d4edda');
        debtStatusChip.style.setProperty('--color', '#155724');
    } else {
        debtStatusChip.textContent = 'EN COURS';
        debtStatusChip.style.setProperty('--background', '#ffeeba'); // Using a common color for "pending/in progress"
        debtStatusChip.style.setProperty('--color', '#856404');
    }
    
    const sortedProcurements = [...(currentDetailedSupplierData.procurements || [])].sort((a, b) => {
        const dateA = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : (new Date(a.timestamp).getTime() || 0);
        const dateB = b.timestamp?.toDate ? b.timestamp.toDate().getTime() : (new Date(b.timestamp).getTime() || 0);
        return dateB - dateA; // Most recent first for "last purchase"
    });


    lastPurchaseDateEl.textContent = sortedProcurements.length > 0
        ? `Dernier achat à crédit : ${ (sortedProcurements[0].timestamp?.toDate ? sortedProcurements[0].timestamp.toDate() : new Date(sortedProcurements[0].timestamp)).toLocaleDateString('fr-FR')}`
        : 'Dernier achat à crédit : N/A';

    numCreditPurchasesEl.textContent = (currentDetailedSupplierData.procurements || []).filter(p => p.paymentMethod === 'credit').length;
    
    const oldestProcurement = [...(currentDetailedSupplierData.procurements || [])]
        .filter(p => p.paymentMethod === 'credit' && parseFloat(p.remainingAmount || 0) > 0)
        .sort((a, b) => {
            const dateA = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : (new Date(a.timestamp).getTime() || 0);
            const dateB = b.timestamp?.toDate ? b.timestamp.toDate().getTime() : (new Date(b.timestamp).getTime() || 0);
            return dateA - dateB; // Oldest first
        })[0];

    oldestDebtDateEl.textContent = oldestProcurement
        ? (oldestProcurement.timestamp?.toDate ? oldestProcurement.timestamp.toDate() : new Date(oldestProcurement.timestamp)).toLocaleDateString('fr-FR')
        : 'N/A';

    try {
        const supplierDocQuery = await dbFirestore.collection("fournisseurs").where("name", "==", currentDetailedSupplierData.name).limit(1).get();
        if (!supplierDocQuery.empty) {
            const supplierDocData = supplierDocQuery.docs[0].data();
            contactEl.textContent = `Contact: ${supplierDocData.contact || 'N/A'}`;
            emailEl.textContent = `Email: ${supplierDocData.email || 'N/A'}`;
        } else {
            contactEl.textContent = `Contact: N/A`;
            emailEl.textContent = `Email: N/A`;
        }
    } catch(e) { console.error("Erreur récupération détails fournisseur:", e); }

    // Populate "Achats Liés" (Purchases Tab)
    itemsListContainer.innerHTML = ''; 
    let sumOfOriginalCreditCosts = 0;
    const creditProcurementsWithDebt = (currentDetailedSupplierData.procurements || [])
        .filter(p => p.paymentMethod === 'credit' /*&& parseFloat(p.remainingAmount || 0) > 0*/) // Show all credit purchases for history, not just those with debt
        .sort((a,b) => ( (a.timestamp?.toDate ? a.timestamp.toDate().getTime() : new Date(a.timestamp).getTime()) || 0) - ( (b.timestamp?.toDate ? b.timestamp.toDate().getTime() : new Date(b.timestamp).getTime()) || 0)); // Oldest first

    if (creditProcurementsWithDebt.length === 0) {
        itemsListContainer.innerHTML = `<ion-item lines="none"><ion-label style="text-align: center;">Aucun achat à crédit pour ce fournisseur.</ion-label></ion-item>`;
    } else {
        creditProcurementsWithDebt.forEach(appro => {
            sumOfOriginalCreditCosts += parseFloat(appro.totalCost || 0);
            const procurementRow = document.createElement('ion-item');
            procurementRow.setAttribute('lines', 'full');
            let itemsSummary = (appro.items || []).map(it => `${it.quantite}x ${it.produit}`).join(', ');
            if (itemsSummary.length > 50) itemsSummary = itemsSummary.substring(0, 47) + "...";
            const approDate = appro.timestamp?.toDate ? appro.timestamp.toDate() : new Date(appro.timestamp);

            procurementRow.innerHTML = `
                <div slot="start" class="image-placeholder" style="background-color: ${getAvatarColor(approDate.toISOString())}; color: white; display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:0.7em; padding:2px; text-align:center; width:52px; height:52px;">
                   <span>${approDate.getDate()}</span>
                   <span style="text-transform:uppercase;">${approDate.toLocaleString('fr-FR', { month: 'short' })}</span>
                   <span>${approDate.getFullYear()}</span>
                </div>
                <ion-label>
                    <h2 class="item-name">Coût Initial: XOF ${parseFloat(appro.totalCost || 0).toLocaleString('fr-FR')}</h2>
                    <p class="item-details" style="${parseFloat(appro.remainingAmount || 0) > 0 ? 'color: red; font-weight: bold;' : 'color: green;'}">
                        Solde Actuel: XOF ${parseFloat(appro.remainingAmount || 0).toLocaleString('fr-FR')}
                        ${parseFloat(appro.remainingAmount || 0) <= 0 && appro.paymentMethod === 'credit' ? ' (Réglé)' : ''}
                    </p>
                    <p class="item-sku">Articles: ${itemsSummary || 'Détails non disponibles'}</p>
                </ion-label>
                <span slot="end" class="item-amount" style="${parseFloat(appro.remainingAmount || 0) > 0 ? 'color: red;' : 'color: green;'}">
                    XOF ${parseFloat(appro.remainingAmount || 0).toLocaleString('fr-FR')}
                </span>
            `;
            itemsListContainer.appendChild(procurementRow);
        });
    }
    totalPurchasesEl.textContent = `XOF ${sumOfOriginalCreditCosts.toLocaleString('fr-FR')}`; // Sum of all original credit purchase costs
    finalRemainingDebtEl.textContent = `XOF ${parseFloat(currentDetailedSupplierData.totalDue || 0).toLocaleString('fr-FR')}`;


    // Populate "Paiements" (Payments Tab) - Unified Chronological List
    paymentsHistoryList.innerHTML = '<li>Chargement des paiements...</li>';
    let allPaymentsList = [];
    if (currentDetailedSupplierData.procurements && currentDetailedSupplierData.procurements.length > 0) {
        for (const appro of currentDetailedSupplierData.procurements) {
            if (appro.id) { // Ensure procurement has an ID to fetch payments
                const paymentsSnapshot = await dbFirestore.collection("approvisionnement").doc(appro.id).collection("payments").orderBy("date", "desc").get();
                paymentsSnapshot.forEach(paymentDoc => {
                    const paymentData = paymentDoc.data();
                    const paymentTimestamp = paymentData.date?.toDate ? paymentData.date.toDate() : (paymentData.date ? new Date(paymentData.date) : new Date());
                    allPaymentsList.push({
                        date: paymentTimestamp,
                        amount: parseFloat(paymentData.amount || 0),
                        account: paymentData.account || 'N/A',
                        procurementDate: appro.timestamp?.toDate ? appro.timestamp.toDate() : new Date(appro.timestamp)
                    });
                });
            }
        }
    }

    if (allPaymentsList.length > 0) {
        allPaymentsList.sort((a, b) => b.date.getTime() - a.date.getTime()); // Sort most recent first

        let paymentsHtml = '';
        allPaymentsList.forEach(p => {
            paymentsHtml += `<li>
                ${p.date.toLocaleString('fr-FR', { day: '2-digit', month: 'short', year:'numeric', hour:'2-digit', minute:'2-digit' })}: 
                <strong>${p.amount.toLocaleString('fr-FR')} FCFA</strong> 
                (Compte: ${p.account}) 
                <small>- Appliqué à l'achat du ${p.procurementDate.toLocaleDateString('fr-FR')}</small>
            </li>`;
        });
        paymentsHistoryList.innerHTML = paymentsHtml;
    } else {
        paymentsHistoryList.innerHTML = '<li>Aucun paiement enregistré pour ce fournisseur.</li>';
    }
    
    remplirTousSelectComptes(paymentAccountSelect);
    document.getElementById('paymentAmountSupplierDebt').value = ''; 

    // Comments Tab (Placeholder)
    document.getElementById('supplierCommentsText').textContent = 'Aucun commentaire pour l\'instant.';

    // Tab Management
    const tabs = document.getElementById('supplier-debt-tabs');
    if (tabs) {
        // Remove existing listener if any, to prevent multiple attachments
        if (tabs.listenerFunction) {
            tabs.removeEventListener('ionChange', tabs.listenerFunction);
        }
        tabs.listenerFunction = (event) => {
            document.querySelectorAll('#screen-fournisseur-credit-detail .tab-content').forEach(content => {
                content.style.display = 'none';
                content.classList.remove('active');
            });
            const selectedTabValue = event.detail.value;
            let contentId;
            if (selectedTabValue === 'details') contentId = 'supplierDebtDetailsContent';
            else if (selectedTabValue === 'purchases') contentId = 'supplierDebtPurchasesContent';
            else if (selectedTabValue === 'payments') contentId = 'supplierDebtPaymentsContent';
            else if (selectedTabValue === 'comments') contentId = 'supplierDebtCommentsContent';
            
            const selectedTabContent = document.getElementById(contentId);
            if (selectedTabContent) {
                selectedTabContent.style.display = 'block';
                selectedTabContent.classList.add('active');
            }
        };
        tabs.addEventListener('ionChange', tabs.listenerFunction);
        tabs.listenerAttached = true; // Mark that a listener is attached

        // Set default tab and trigger change
        if (tabs.value !== 'details') { // Only set if not already details to avoid redundant trigger
             tabs.value = 'details';
        }
        // Manually trigger the display for the default tab
        tabs.listenerFunction({ detail: { value: tabs.value } });
    }
    refreshLucideIcons();
}
    async function recordSupplierPayment() {
    if (!currentDetailedSupplierData || !currentDetailedSupplierData.procurements) {
        alert("Aucune dette fournisseur sélectionnée ou détails des achats manquants.");
        return;
    }

    const paymentAmount = parseFloat(document.getElementById('paymentAmountSupplierDebt').value);
    const paymentAccount = document.getElementById('paymentAccountSupplierDebt').value;

    if (isNaN(paymentAmount) || paymentAmount <= 0) {
        alert("Veuillez entrer un montant de paiement valide.");
        return;
    }
    if (!paymentAccount) {
        alert("Veuillez sélectionner le compte de paiement.");
        return;
    }

    showSaleLoader(); 

    try {
        let remainingToPayGlobally = paymentAmount;
        const nowForPayments = firebase.firestore.Timestamp.now(); // Use a single timestamp for all payment records in this batch

        // Sort procurements: oldest first, and among those with same timestamp, those with smaller remaining amount first (to clear smaller debts)
        const procurementsToPay = [...currentDetailedSupplierData.procurements]
            .filter(p => p.paymentMethod === 'credit' && parseFloat(p.remainingAmount || 0) > 0) // Only pay outstanding credit purchases
            .sort((a, b) => {
                const dateA = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : (new Date(a.timestamp).getTime() || 0);
                const dateB = b.timestamp?.toDate ? b.timestamp.toDate().getTime() : (new Date(b.timestamp).getTime() || 0);
                if (dateA !== dateB) return dateA - dateB; // Oldest timestamp first
                return (parseFloat(a.remainingAmount || 0)) - (parseFloat(b.remainingAmount || 0)); // Smaller remaining amount first
            });

        if (procurementsToPay.length === 0 && paymentAmount > 0) {
            alert("Ce fournisseur n'a aucune dette à crédit en cours. Paiement non applicable.");
            hideSaleLoader();
            return;
        }


        const batch = dbFirestore.batch();

        for (const appro of procurementsToPay) {
            if (remainingToPayGlobally <= 0) break; 

            const approRef = dbFirestore.collection("approvisionnement").doc(appro.id);
            // Note: In a batched write, we operate on the assumption of current data.
            // For critical consistency, one might fetch within a transaction, but batch is usually for optimistic updates.
            // Here, we use the `appro.remainingAmount` from the `currentDetailedSupplierData` which was recently fetched/updated.

            const outstandingOnThisAppro = parseFloat(appro.remainingAmount || 0);
            if (outstandingOnThisAppro > 0) {
                const amountForThisAppro = Math.min(remainingToPayGlobally, outstandingOnThisAppro);
                const newRemainingForAppro = outstandingOnThisAppro - amountForThisAppro;
                const newIsPaidForAppro = newRemainingForAppro <= 0;

                batch.update(approRef, {
                    remainingAmount: newRemainingForAppro,
                    isPaid: newIsPaidForAppro
                });

                const paymentRecordRef = approRef.collection("payments").doc();
                batch.set(paymentRecordRef, {
                    amount: amountForThisAppro,
                    date: nowForPayments, // Consistent timestamp
                    account: paymentAccount,
                    refApproId: appro.id 
                });
                
                // Update local data for UI refresh
                appro.remainingAmount = newRemainingForAppro;
                appro.isPaid = newIsPaidForAppro;

                remainingToPayGlobally -= amountForThisAppro;
            }
        }
        
        await batch.commit(); // Commit all batched writes

        // Record the overall cash movement from the selected account
        await enregistrerMouvementTresorerie({
            compteId: paymentAccount,
            type: 'paiement_fournisseur_dette',
            sens: 'out',
            montant: paymentAmount - remainingToPayGlobally, // Actual amount paid out
            description: `Paiement dette fournisseur ${currentDetailedSupplierData.name}`
        });
        
        // Update the supplier's total due locally for UI refresh
        currentDetailedSupplierData.totalDue = Math.max(0, parseFloat(currentDetailedSupplierData.totalDue || 0) - (paymentAmount - remainingToPayGlobally));

        if (remainingToPayGlobally > 0) {
             alert(`Paiement de ${(paymentAmount - remainingToPayGlobally).toLocaleString('fr-FR')} FCFA enregistré. Il restait ${remainingToPayGlobally.toLocaleString('fr-FR')} FCFA du paiement qui n'a pas pu être alloué (dettes soldées).`);
        } else {
            alert("Paiement enregistré avec succès !");
        }
        
        document.getElementById('paymentAmountSupplierDebt').value = ''; 
        
        // Refresh UI
        // Option 1: Full refresh of supplier list and then detail page (safer for data consistency)
        await chargerDettesFournisseurs(); // This will update the main list
        // We need to ensure currentDetailedSupplierData is fully up-to-date before calling showSupplierDebtDetailsPage
        // The best way is to re-fetch the specific supplier's aggregated data if chargerApprovisionnements doesn't return it
        // For now, we rely on local updates to currentDetailedSupplierData and then refresh the detail page.
        showSupplierDebtDetailsPage(currentDetailedSupplierData);


        updateBalanceDisplay(); 

    } catch (error) {
        console.error("Erreur lors de l'enregistrement du paiement fournisseur :", error);
        alert("Erreur lors de l'enregistrement du paiement : " + error.message);
    } finally {
        currentApproItems = [];
        updatePanierApprovisionnement();

        const fournisseurField = document.getElementById("fournisseurAppro");
        if (fournisseurField) {
            fournisseurField.value = "";
        }

        const fraisTransportField = document.getElementById("fraisTransportAppro");
        if (fraisTransportField) {
            fraisTransportField.value = "";
        }
        const transportAccountField = document.getElementById("compteSelectTransportAppro");
        if (transportAccountField) {
            transportAccountField.value = "";
        }

        const purchaseTypeSelect = document.getElementById("typeAchatAppro");
        if (purchaseTypeSelect) {
            purchaseTypeSelect.value = "normal";
        }

        const paymentStatusSelect = document.getElementById("purchasePaymentStatus");
        if (paymentStatusSelect) {
            paymentStatusSelect.value = 'no';
        }

        resetApproPayments();
        handlePurchaseTypeChange();
        const purchaseTabsEl = document.getElementById('purchase-tabs');
        const activePurchaseTab = purchaseTabsEl ? (purchaseTabsEl.value || 'all') : 'all';
        chargerApprovisionnements(activePurchaseTab);
        updateStockSummary();
        updateBalanceDisplay();
        hideSaleLoader();
    }
}

// Add this helper function to your script if it's not already there
function fmt(x){
  return Number(x).toLocaleString("fr-FR").replace(/\u202F/g," ");
}

async function generateSupplierCreditPDF() {
    if (!currentDetailedSupplierData) {
        showToast("Aucun détail de fournisseur n'est chargé.", "error");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'pt', 'a4');

    const supplierName = currentDetailedSupplierData.name || 'Fournisseur Inconnu';
    const totalDue = parseFloat(currentDetailedSupplierData.totalDue || 0);

    let yOffset = 80; // New starting Y for the title

    // Title: Point de Crédit Fournisseur
    doc.setFont("helvetica", "bold");
    doc.setFontSize(22);
    doc.text("POINT DE CRÉDIT FOURNISSEUR", doc.internal.pageSize.getWidth() / 2, yOffset, { align: 'center' });
    yOffset += 30;

    // Supplier and Debt Summary
    doc.setFont("helvetica", "normal");
    doc.setFontSize(11);
    doc.text(`Fournisseur : ${supplierName}`, 40, yOffset); yOffset += 15;
    doc.text(`Date du rapport : ${new Date().toLocaleDateString('fr-FR')}`, 40, yOffset); yOffset += 15;
    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.text(`Montant total dû : ${fmt(totalDue)} FCFA`, 40, yOffset);
    yOffset += 30;

    // --- Section Achats Liés ---
    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.text("Achats à Crédit Liés", 40, yOffset);
    yOffset += 15;

    // Adjusted columns for the "Articles" table
    const purchaseColumns = ["Date Achat", "Détails Articles", "Coût Initial", "Montant Restant"];
    const purchaseRows = [];

    let totalOriginalCost = 0;
    const sortedPurchases = [...currentDetailedSupplierData.procurements || []].sort((a, b) => {
        const dateA = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : (new Date(a.timestamp).getTime() || 0);
        const dateB = b.timestamp?.toDate ? b.timestamp.toDate().getTime() : (new Date(b.timestamp).getTime() || 0);
        return dateA - dateB; // Oldest first
    });

    sortedPurchases.forEach(appro => {
        const approDate = appro.timestamp?.toDate ? appro.timestamp.toDate().toLocaleDateString('fr-FR') : 'N/A';
        
        // Construct detailed items summary for the "Détails Articles" column
        let detailedItemsSummary = (appro.items || []).map(it => {
            const itemTotal = (parseFloat(it.prixAchat || 0) * parseInt(it.quantite || 0));
            return `${it.produit} (Qté: ${it.quantite}, P.U.: ${fmt(parseFloat(it.prixAchat || 0))}, Total: ${fmt(itemTotal)})`;
        }).join('\n'); // Use newline for better readability if multiple items

        if (detailedItemsSummary === "") {
            detailedItemsSummary = "Aucun article détaillé";
        }

        const initialCost = parseFloat(appro.totalCost || 0);
        const remaining = parseFloat(appro.remainingAmount || 0);

        purchaseRows.push([
            approDate,
            detailedItemsSummary,
            `${fmt(initialCost)} FCFA`,
            `${fmt(remaining)} FCFA`
        ]);
        totalOriginalCost += initialCost;
    });

    if (purchaseRows.length === 0) {
        purchaseRows.push(["Aucun achat à crédit enregistré.", "", "", ""]);
    }

    doc.autoTable({
        startY: yOffset,
        head: [purchaseColumns],
        body: purchaseRows,
        theme: 'grid',
        headStyles: { fillColor: [0, 96, 100], textColor: [255, 255, 255], fontStyle: 'bold' },
        styles: { fontSize: 8, cellPadding: 4, overflow: 'linebreak' },
        columnStyles: {
            0: { cellWidth: 70 },
            1: { cellWidth: 280 },
            2: { cellWidth: 80, halign: 'right' },
            3: { cellWidth: 80, halign: 'right' }
        },
        margin: { left: 40, right: 40 }
    });

    yOffset = doc.lastAutoTable.finalY + 20;

    // Total original des achats
    doc.setFont("helvetica", "bold");
    doc.setFontSize(10);
    doc.text(`Total initial des achats à crédit : ${fmt(totalOriginalCost)} FCFA`, 40, yOffset);
    yOffset += 20;

    // --- Section Historique des Paiements ---
    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.text("Historique des Paiements", 40, yOffset);
    yOffset += 15;

    // MODIFIED: Removed "Compte (Référence Achat)" column
    const paymentColumns = ["Date Paiement", "Montant Payé"];
    const paymentRows = [];
    let totalPaid = 0;

    let allPayments = [];
    for (const appro of sortedPurchases) {
        if (appro.id) {
            const paymentsSnapshot = await dbFirestore.collection("approvisionnement").doc(appro.id).collection("payments").orderBy("date", "desc").get();
            paymentsSnapshot.forEach(paymentDoc => {
                const pData = paymentDoc.data();
                const paymentDate = pData.date?.toDate ? pData.date.toDate() : new Date(pData.date);
                allPayments.push({
                    date: paymentDate,
                    amount: parseFloat(pData.amount || 0),
                    account: pData.account || 'N/A',
                    refApproDate: appro.timestamp?.toDate ? appro.timestamp.toDate().toLocaleDateString('fr-FR') : 'N/A'
                });
            });
        }
    }

    allPayments.sort((a, b) => a.date.getTime() - b.date.getTime());

    allPayments.forEach(payment => {
        // MODIFIED: Adjusted push to match new column structure
        paymentRows.push([
            `${payment.date.toLocaleDateString('fr-FR')} (${payment.date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'})})`,
            `${fmt(payment.amount)} FCFA`
        ]);
        totalPaid += payment.amount;
    });

    if (paymentRows.length === 0) {
        paymentRows.push(["Aucun paiement enregistré.", ""]); // Adjusted empty message to 2 columns
    }

    doc.autoTable({
        startY: yOffset,
        head: [paymentColumns],
        body: paymentRows,
        theme: 'grid',
        headStyles: { fillColor: [0, 96, 100], textColor: [255, 255, 255], fontStyle: 'bold' },
        styles: { fontSize: 9, cellPadding: 5 },
        // MODIFIED: Adjusted column styles for 2 columns
        columnStyles: {
            0: { cellWidth: 150 }, // Increased width for Date Paiement
            1: { cellWidth: 100, halign: 'right' } // Increased width for Montant Payé
        },
        margin: { left: 40, right: 40 }
    });

    yOffset = doc.lastAutoTable.finalY + 20;

    doc.setFont("helvetica", "bold");
    doc.setFontSize(10);
    doc.text(`Total des paiements effectués : ${fmt(totalPaid)} FCFA`, 40, yOffset);
    yOffset += 15;
    doc.text(`Solde restant dû : ${fmt(totalDue)} FCFA`, 40, yOffset);

    doc.save(`Point_Credit_${supplierName.replace(/ /g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
    showToast('Point de crédit fournisseur généré avec succès.');
}

  </script>
</section>

    <!-- Drawer Menu -->
    <section id="screen-menu" class="screen" aria-hidden="true">
      <div class="drawer-scrim" id="menuDrawerScrim" aria-hidden="true" onclick="fermerDrawerMenu()"></div>
      <aside class="drawer-panel" id="menuDrawerPanel" role="dialog" aria-modal="true" aria-labelledby="menuDrawerTitle" aria-hidden="true" tabindex="-1">
        <header class="drawer-account">
          <div class="drawer-avatar" aria-hidden="true">A</div>
          <div>
            <div class="drawer-name" id="menuDrawerTitle">Ako</div>
            <div class="drawer-mail">zidaneakoda1.2@gmail.com</div>
          </div>
          <button class="drawer-caret" type="button" id="drawerAccountToggle" aria-label="Changer de compte" aria-expanded="false" onclick="toggleDrawerAccountMenu()">
            <i data-lucide="chevron-down"></i>
          </button>
          <div class="drawer-account-menu" id="drawerAccountMenu" role="menu" aria-hidden="true">
            <button type="button" role="menuitem">Changer d'organisation</button>
            <button type="button" role="menuitem" class="danger" onclick="deconnexion()">Déconnexion</button>
          </div>
        </header>
        <nav class="drawer-nav" role="navigation" aria-label="Menu principal">
          <button class="drawer-item menu-list-item" type="button" data-hash="accueil" onclick="window.location.hash='accueil'" data-drawer-focus>
            <span class="drawer-icon"><i data-lucide="home"></i></span>
            <span>Home</span>
          </button>
          <button class="drawer-item menu-list-item" type="button" data-hash="clients" onclick="window.location.hash='clients'">
            <span class="drawer-icon"><i data-lucide="users"></i></span>
            <span>Customers</span>
          </button>
          <button class="drawer-item menu-list-item" type="button" data-hash="stock" onclick="window.location.hash='stock'">
            <span class="drawer-icon"><i data-lucide="package"></i></span>
            <span>Items</span>
          </button>
          <button class="drawer-item menu-list-item" type="button" onclick="openDrawerComingSoon('Quotes')">
            <span class="drawer-icon"><i data-lucide="file-text"></i></span>
            <span>Quotes</span>
          </button>
          <button class="drawer-item menu-list-item" type="button" data-hash="historique" onclick="window.location.hash='historique'">
            <span class="drawer-icon"><i data-lucide="receipt-text"></i></span>
            <span>Invoices</span>
          </button>
          <button class="drawer-item menu-list-item" type="button" data-hash="vendre" onclick="window.location.hash='vendre'">
            <span class="drawer-icon"><i data-lucide="file-check-2"></i></span>
            <span>Sales Receipts</span>
          </button>
          <button class="drawer-item menu-list-item" type="button" data-hash="tresorerie" onclick="window.location.hash='tresorerie'">
            <span class="drawer-icon"><i data-lucide="wallet"></i></span>
            <span>Payments Received</span>
          </button>
          <button class="drawer-item menu-list-item" type="button" data-hash="depenses" onclick="window.location.hash='depenses'">
            <span class="drawer-icon"><i data-lucide="credit-card"></i></span>
            <span>Expenses</span>
          </button>
          <button class="drawer-item menu-list-item has-sub" type="button" aria-expanded="false" onclick="toggleDrawerTimeTracking(this)">
            <span class="drawer-icon"><i data-lucide="clock-4"></i></span>
            <span>Time Tracking</span>
            <span class="drawer-chevron"><i data-lucide="chevron-down"></i></span>
          </button>
          <div class="drawer-submenu" id="drawerTimeTrackingSubmenu" aria-hidden="true">
            <button class="drawer-subitem" type="button" onclick="window.location.hash='start-day'">Timesheets</button>
            <button class="drawer-subitem" type="button" onclick="openDrawerComingSoon('Approvals')">Approvals</button>
          </div>
          <button class="drawer-item menu-list-item" type="button" data-hash="rapports" onclick="window.location.hash='rapports'">
            <span class="drawer-icon"><i data-lucide="bar-chart-3"></i></span>
            <span>Reports</span>
          </button>
          <button class="drawer-item menu-list-item" type="button" data-hash="parametres" onclick="window.location.hash='parametres'">
            <span class="drawer-icon"><i data-lucide="settings"></i></span>
            <span>Settings</span>
          </button>
          <button class="drawer-item menu-list-item" type="button" data-hash="advance" onclick="window.location.hash='advance'">
            <span class="drawer-icon"><i data-lucide="layers"></i></span>
            <span>Advanced Billing</span>
          </button>
        </nav>
      </aside>
    </section>

<section id="screen-salaires" class="screen">
  <header>
    <button class="back-btn" onclick="window.location.hash='menu'">
      <i data-lucide="arrow-left"></i>
    </button>
    <h1>Gestion des Salaires</h1>
  </header>

  <div class="salary-grid">
    <div class="salary-card">
      <h3>Masse salariale du mois</h3>
      <p id="salarySummaryTotal">0 FCFA</p>
    </div>
    <div class="salary-card">
      <h3>Montant paye</h3>
      <p id="salarySummaryPaid">0 FCFA</p>
    </div>
    <div class="salary-card">
      <h3>Restant a payer</h3>
      <p id="salarySummaryDue">0 FCFA</p>
    </div>
  </div>

  <div class="salary-actions">
    <button class="btn-modern" id="salaryAddBtn" style="gap: 8px;">
      <i data-lucide="plus-circle"></i>
      <span>Enregistrer un paiement</span>
    </button>
    <button class="btn-modern secondary" id="salaryExportBtn" style="gap: 8px;">
      <i data-lucide="file-down"></i>
      <span>Exporter le journal</span>
    </button>
  </div>

  <div class="salary-list">
    <table>
      <thead>
        <tr>
          <th>Employe</th>
          <th>Periode</th>
          <th>Montant</th>
          <th>Statut</th>
        </tr>
      </thead>
      <tbody id="salaryTableBody"></tbody>
    </table>
    <div class="empty-state" id="salaryEmptyState">
      Aucun paiement de salaire n'est encore enregistre.
    </div>
  </div>
</section>
</section>
    <!-- Nouvel écran dédié à la recherche d'article -->
    <section id="screen-search-article" class="screen">
      <header style="position: relative; display: flex; align-items: center; padding: 15px;">
        <button class="back-btn" onclick="window.location.hash='vendre'">
          <i data-lucide="arrow-left"></i>
        </button>
        <h1 style="flex: 1; text-align: center; margin: 0;">Rechercher un Article</h1>
        <div id="searchCartIcon" class="cart-icon" title="Voir le panier">
          <i data-lucide="shopping-bag"></i>
          <span id="searchCartCount" class="cart-badge">0</span>
        </div>
      </header>
      <div style="padding:15px;">
        <input type="text" id="searchProduitInput" placeholder="Rechercher un article..." />
        <div id="searchResults" class="cards-container"></div>
      </div>
    </section>

    <section id="screen-repertoire-imei" class="screen">
      <header>
        <button class="back-btn" onclick="window.location.hash='menu'">
          <i data-lucide="arrow-left"></i>
        </button>
        <h1>Répertoire d'IMEI</h1>
      </header>
      <div style="padding: 15px;">
        <!-- Ajoutez ici le contenu du répertoire d'IMEI -->
        <p>Liste des IMEI...</p>
      </div>
    </section>

    <!-- Nouvel écran : Trésorerie - Inspiré de Qonto -->
<!-- Screen: Trésorerie -->
<!-- Nouvel écran : Trésorerie - Inspiré de Qonto -->
<section id="screen-tresorerie" class="screen">
  <style>
    :root {
      --primary-color: #6D5DFD;
      --background-color: #F5F5FA;
      --card-bg: #ffffff;
      --text-color: #333;
      --border-radius: 12px;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
    }
    .container {
      padding: 15px;
    }
    .balance-card {
      background-color: var(--card-bg);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 15px;
      text-align: center;
    }
    .balance-card h1 {
      margin: 0;
      font-size: 32px;
    }
    .accounts-chips {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 6px;
      margin-bottom: 15px;
      scrollbar-width: none;
    }
    .accounts-chips::-webkit-scrollbar {
      display: none;
    }
    .account-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid rgba(109,93,253,0.25);
      background-color: rgba(109,93,253,0.12);
      color: var(--text-color);
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
      transition: background-color 0.2s ease, transform 0.2s ease;
    }
    .account-chip:hover {
      background-color: rgba(109,93,253,0.2);
      transform: translateY(-1px);
    }
    .account-chip:focus {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }
    .chip-label {
      font-weight: 600;
    }
    .chip-amount {
      font-size: 13px;
      color: #555;
    }
    .account-chip-empty {
      font-size: 14px;
      color: #777;
    }
    .section-title {
      font-size: 18px;
      font-weight: bold;
      margin: 15px 0 10px;
    }
    .history-list {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      overflow: hidden;
      margin-bottom: 15px;
    }
    .history-item {
      padding: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #EEE;
    }
    .history-item-clickable {
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .history-item-clickable:hover {
      background: rgba(56, 128, 255, 0.08);
    }
    .history-item:last-child {
      border-bottom: none;
    }
    .amount {
      font-weight: bold;
    }
    .in { color: #28a745; }
    .out { color: #dc3545; }
    .btn {
      background-color: var(--primary-color);
      color: white;
      padding: 12px;
      text-align: center;
      border-radius: var(--border-radius);
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      border: none;
      margin-top: 10px;
    }
  </style>

  <div class="container">
    <div style="margin-bottom: 15px; background: var(--card-bg); padding: 10px; border-radius: var(--border-radius); box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
        <label for="treso-date-filter" style="font-weight: bold; margin-right: 8px;">Afficher le rapport du :</label>
        <input type="date" id="treso-date-filter" onchange="updateBalanceDisplay()" style="width: calc(100% - 170px); padding: 8px; border: 1px solid #EEE; border-radius: 8px;">
    </div>
    <div class="balance-card">
      <h1 id="balance-sold">XOF 0</h1>
      <p>Solde global</p>
    </div>

    <div class="accounts-chips" id="accounts-balances" aria-label="Comptes de tresorerie"></div>

    <button type="button" class="btn" id="btnVirementComptes" onclick="ouvrirModalVirementTresorerie()" style="width: 100%; margin-top: 0; margin-bottom: 12px;">
      <i data-lucide="repeat"></i> Virement entre comptes
    </button>

    <div class="section-title">Résumé des flux du jour</div>
    <div class="history-list">
        <div class="history-item">
            <div class="info">Solde initial</div>
            <div class="amount" id="treso-opening-balance">XOF 0</div>
        </div>
        <div class="history-item">
            <div class="info">Ventes (Entrées)</div>
            <div class="amount in" id="treso-total-ventes">+XOF 0</div>
        </div>
        <div class="history-item">
            <div class="info">Remboursements (Injection)</div>
            <div class="amount in" id="treso-total-remboursements">+XOF 0</div>
        </div>
        <div class="history-item">
            <div class="info">Dépenses Fonctionnelles</div>
            <div class="amount out" id="treso-total-depenses-fonctionnelles">-XOF 0</div>
        </div>
        <div class="history-item">
            <div class="info">Dépenses Papa</div>
            <div class="amount out" id="treso-total-depenses-papa">-XOF 0</div>
        </div>
        <div class="history-item">
            <div class="info">Frais de transport</div>
            <div class="amount out" id="treso-total-frais-transport">-XOF 0</div>
        </div>
        <div class="history-item">
            <div class="info">Approvisionnements (Achats de stock)</div>
            <div class="amount out" id="treso-total-appro">-XOF 0</div>
        </div>
        <div class="history-item">
            <div class="info">Profit net du jour</div>
            <div class="amount" id="treso-daily-profit">XOF 0</div>
        </div>
        </div>
        <button id="btnCloseDay" class="btn" onclick="ouvrirModalCloseDay()" style="width: 100%; margin-top: 10px;">
          <i data-lucide="moon-star"></i> Cloturer la journée & imprimer
        </button>

  <script>
    // Appel initial pour mettre à jour l'affichage des totaux et du solde
    updateBalanceDisplay();
  </script>
</section>

<section id="screen-tresorerie-compte" class="screen">
  <style>
    .compte-detail-container {
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .compte-detail-header {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .compte-detail-name {
      margin: 0;
      font-size: 22px;
      color: var(--text-color);
    }
    .compte-detail-date {
      margin: 0;
      font-size: 14px;
      color: #666;
      text-transform: capitalize;
    }
    .compte-detail-date-picker {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .compte-detail-date-picker label {
      font-weight: 600;
    }
    .compte-detail-date-picker input {
      flex: 1;
      padding: 8px;
      border: 1px solid #EEE;
      border-radius: 8px;
    }
    .compte-detail-alert {
      display: none;
      background-color: rgba(220,53,69,0.1);
      color: #a71d2a;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 14px;
    }
    .compte-detail-loading {
      font-size: 14px;
      color: #666;
    }
    .compte-detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
    }
    .compte-detail-section-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-color);
      margin: 4px 0;
    }
    .compte-detail-movements {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .compte-detail-movement {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .compte-detail-movement-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
    }
    .compte-detail-movement-type {
      font-weight: 600;
      text-transform: capitalize;
      color: #444;
    }
    .compte-detail-movement-amount {
      font-weight: 700;
      font-size: 16px;
    }
    .compte-detail-movement-amount.positive {
      color: #2e7d32;
    }
    .compte-detail-movement-amount.negative {
      color: #c62828;
    }
    .compte-detail-movement-meta {
      display: flex;
      justify-content: space-between;
      color: #777;
      font-size: 13px;
    }
    .compte-detail-movement-description {
      color: #555;
      font-size: 14px;
    }
    .compte-detail-empty {
      font-size: 14px;
      color: #777;
      background: rgba(0,0,0,0.03);
      border-radius: var(--border-radius);
      padding: 12px;
      text-align: center;
    }
    .compte-detail-card {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .compte-detail-card span {
      font-size: 12px;
      color: #666;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    .compte-detail-card strong {
      font-size: 18px;
      color: var(--text-color);
    }
  </style>

  <header>
    <button class="back-btn" onclick="window.location.hash='tresorerie'">
      <i data-lucide="arrow-left"></i>
    </button>
    <h1>Details du compte</h1>
  </header>

  <div class="compte-detail-container">
    <div class="compte-detail-header">
      <h2 id="compte-detail-name" class="compte-detail-name">Compte</h2>
      <p id="compte-detail-date-label" class="compte-detail-date"></p>
    </div>

    <div class="compte-detail-date-picker">
      <label for="compte-detail-date">Journee</label>
      <input type="date" id="compte-detail-date">
    </div>

    <div id="compte-detail-alert" class="compte-detail-alert">Selectionnez un compte depuis la tresorerie.</div>
    <div id="compte-detail-loading" class="compte-detail-loading" style="display:none;">Chargement des mouvements...</div>

    <div id="compte-detail-summary" class="compte-detail-grid" style="display:none;">
      <div class="compte-detail-card">
        <span>Solde initial</span>
        <strong id="compte-detail-opening">XOF 0</strong>
      </div>
      <div class="compte-detail-card">
        <span>Entrees</span>
        <strong id="compte-detail-entries">+XOF 0</strong>
      </div>
      <div class="compte-detail-card">
        <span>Sorties</span>
        <strong id="compte-detail-expenses">-XOF 0</strong>
      </div>
      <div class="compte-detail-card">
        <span>Solde final</span>
        <strong id="compte-detail-final">XOF 0</strong>
      </div>
    </div>

    <div>
      <h3 class="compte-detail-section-title">Mouvements de la journée</h3>
      <div id="compte-detail-empty" class="compte-detail-empty" style="display:none;">Aucun mouvement enregistré pour cette date.</div>
      <div id="compte-detail-movements" class="compte-detail-movements"></div>
    </div>
  </div>
</section>

    <!-- Screen: Dépenses -->
<!-- Screen: Dépenses -->
<section id="screen-depenses" class="screen">
  <style>
    .depenses-container {
      padding: 15px;
    }
    .depenses-summary {
      background: var(--white);
      box-shadow: var(--shadow);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 15px;
      text-align: center;
    }
    .summary-item h2 {
      margin-bottom: 5px;
      color: var(--primary-color);
    }
    .summary-item p {
      color: #666;
      font-size: 14px;
    }
    .actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 15px;
    }
    .btn-modern.secondary {
      background-color: #E4E6EB;
      color: black;
      box-shadow: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-modern.secondary i {
      font-size: 20px;
    }
    .section-title {
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 18px;
      color: var(--text-color);
    }
    .history-list .history-item {
      padding: 12px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .history-item:last-child {
      border-bottom: none;
    }
    .history-icon {
      margin-right: 8px;
    }
    /* Bouton Retour style Facebook */
    .back-btn-fb {
      width: 40px;
      height: 40px;
      border: none;
      background: none;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      border-radius: 50%;
      cursor: pointer;
      overflow: hidden;
      outline: none;
    }
    .back-btn-fb i {
      font-size: 24px;
      color: var(--primary-color);
    }
    .back-btn-fb::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 200%;
      height: 200%;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      transform: translate(-50%, -50%) scale(0);
      transition: transform 0.3s ease-out;
      pointer-events: none;
    }
    .back-btn-fb:active::after {
      transform: translate(-50%, -50%) scale(1);
    }
  </style>

  <header>
    <button class="back-btn-fb" onclick="window.location.hash='menu'">
      <i data-lucide="arrow-left"></i>
    </button>
    <h1>Dépenses</h1>
  </header>

  <div class="depenses-container">
    <div class="actions">
      <button class="btn-modern secondary" onclick="window.location.hash='depense-fonctionnelle'">
        <i data-lucide="file-minus"></i> Dépense Fonctionnelle
      </button>
      <button id="btnDepensePapa" class="btn-modern secondary" onclick="window.location.hash='depense-papa'">
        <i data-lucide="user-minus"></i> Dépense Papa
      </button>          
      <button class="btn-modern secondary" onclick="window.location.hash='remboursement-papa'">
        <i data-lucide="user-check"></i> Remboursement
      </button>
    </div>

    <div class="section-title">Historique récent</div>
    <div id="recent-depenses" class="history-list">
      <p style="text-align:center;">Chargement en cours...</p>
    </div>

    <button class="btn-modern secondary" onclick="exporterDepenses()">
      <i data-lucide="download"></i> Exporter PDF
    </button>
  </div>

  <script>

    
    /**
     * Récupère et affiche la somme de toutes les dépenses (type "depense" ou "papa")
     * pour la journée en cours, puis met à jour le champ #depenses-today.
     */
    function afficherDepensesAujourdhui() {
      const today = new Date();
      // On définit le début et la fin du jour en millisecondes
      const startOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
      const endOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1).getTime() - 1;

      dbFirestore.collection("depenses")
        .where("timestamp", ">=", startOfToday)
        .where("timestamp", "<=", endOfToday)
        .get()
        .then(snapshot => {
          let totalDepenses = 0;
          snapshot.forEach(doc => {
            const data = doc.data();
            // On somme uniquement les dépenses de type "depense" ou "papa"
            // (si vous n'avez pas de type, retirez simplement le if)
            if (data.type === "depense" || data.type === "papa" || !data.type) {
              totalDepenses += parseFloat(data.montant) || 0;
            }
          });
          // Mise à jour de l'affichage
          document.getElementById("depenses-today").textContent = `-XOF ${totalDepenses.toLocaleString()}`;

        })
        .catch(error => {
          console.error("Erreur lors de la récupération des dépenses du jour : " + error.message);
        });
    }

    /**
     * Récupère l'ensemble des documents de "depenses" et "remboursements",
     * les fusionne, puis affiche un historique récent.
     */
    // 1️⃣ Fonction d'affichage de chaque lot de documents
function renderDepenses(docs) {
  const container = document.getElementById("recent-depenses");
  docs.forEach(doc => {
    const item = doc.data();
    // … recopiez ici votre code HTML pour each history-item …
    let iconHtml = "";
    let montantDisplay = "";
    if (item.type === "depense" || item.type === "depense fonctionnelle" || item.type === "papa") {
      iconHtml = (item.type === "papa") 
        ? `<i data-lucide="user-minus"></i>` 
        : `<i data-lucide="file-minus"></i>`;
      montantDisplay = `<div class="amount out">-XOF ${parseFloat(item.montant).toLocaleString()}</div>`;
    } else if (item.type === "remboursement") {
      iconHtml = `<i data-lucide="user-check"></i>`;
      montantDisplay = `<div class="amount in">+XOF ${parseFloat(item.montant).toLocaleString()}</div>`;
    }
    const div = document.createElement("div");
    div.className = "history-item";
    div.innerHTML = `
      <div class="depense-icon">${iconHtml}</div>
      <div class="depense-info" style="flex-grow:1;">
        ${item.description || "Aucune description"}<br>
        <small style="color:#888;">${new Date(item.timestamp).toLocaleString()}</small>
      </div>
      ${montantDisplay}
    `;
    container.appendChild(div);
  });
  refreshLucideIcons();
}

// 2️⃣ Charge les 10 premières
function chargerHistoriqueDepensesInitial() {
  loadingDepenses       = true;
  lastVisibleDepenses   = null;

  return dbFirestore.collection("depenses")
    .orderBy("timestamp", "desc")
    .limit(10)
    .get()
    .then(snapshot => {
      if (snapshot.empty) {
        loadingDepenses = false;
        return;                           // rien à afficher
      }

      renderDepenses(snapshot.docs);      // affiche le 1ᵉ lot
      lastVisibleDepenses = snapshot.docs[snapshot.docs.length - 1];
      loadingDepenses = false;

      /* Si la liste ne déborde pas encore, on charge automatiquement
         le lot suivant pour remplir l'écran. */
      const c = document.getElementById("recent-depenses");
      if (c.scrollHeight <= c.clientHeight) {
        chargerHistoriqueDepensesSuivant();
      }
    })
    .catch(err => console.error(err));
}

function chargerHistoriqueDepensesSuivant() {
  if (loadingDepenses || !lastVisibleDepenses) return;
  loadingDepenses = true;

  dbFirestore.collection("depenses")
    .orderBy("timestamp", "desc")
    .startAfter(lastVisibleDepenses)
    .limit(10)
    .get()
    .then(snapshot => {
      if (!snapshot.empty) {
        renderDepenses(snapshot.docs);
        lastVisibleDepenses = snapshot.docs[snapshot.docs.length - 1];
      } else {
        lastVisibleDepenses = null;       // plus d'autres pages
      }
      loadingDepenses = false;
    })
    .catch(err => console.error(err));
}

/* ➜ affiche UNIQUEMENT les docs pas encore rendus */
function renderDepenses(docs) {
  const container = document.getElementById("recent-depenses");

  docs.forEach(doc => {
    if (renderedDepenseIds.has(doc.id)) return;   // stop doublon
    renderedDepenseIds.add(doc.id);

    const item = doc.data();
    let iconHtml = "", montantDisplay = "";

    if (item.type === "depense" || item.type === "depense fonctionnelle" || item.type === "papa") {
      iconHtml       = (item.type === "papa")
                      ? `<i data-lucide="user-minus"></i>`
                      : `<i data-lucide="file-minus"></i>`;
      montantDisplay = `<div class="amount out">-XOF ${parseFloat(item.montant).toLocaleString()}</div>`;
    } else if (item.type === "remboursement") {
      iconHtml       = `<i data-lucide="user-check"></i>`;
      montantDisplay = `<div class="amount in">+XOF ${parseFloat(item.montant).toLocaleString()}</div>`;
    }

    const div = document.createElement("div");
    div.className = "history-item";
    div.innerHTML = `
      <div class="history-icon">${iconHtml}</div>
      <div class="depense-info" style="flex-grow:1;">
        ${item.description || "Aucune description"}<br>
        <small style="color:#888;">${new Date(item.timestamp).toLocaleString()}</small>
      </div>
      ${montantDisplay}
    `;
    container.appendChild(div);
  });

  refreshLucideIcons();     // une seule fois par lot
}

    /**
     * On met à jour le total des dépenses du jour + l'historique
     * dès que l'écran "#depenses" est affiché.
     */
    window.addEventListener('hashchange', function(){
      if(window.location.hash === '#depenses') {
  afficherDepensesAujourdhui();
  chargerHistoriqueDepensesInitial();
  // mettre en place l'infinite scroll
  const container = document.getElementById("recent-depenses");
  container.addEventListener("scroll", () => {
    if (container.scrollTop + container.clientHeight >= container.scrollHeight - 50) {
      chargerHistoriqueDepensesSuivant();
    }
  });
} })

  </script>
</section>

<!-- ===== Début de la section Rapports & Statistiques ===== -->
<section id="screen-rapports" class="screen">
  <header class="rapport-header">
    <button class="btn-back" onclick="window.location.hash='menu'">
      <i data-lucide="arrow-left"></i>
    </button>
    <h1>Rapports & Statistiques</h1>
    <button class="btn-refresh" onclick="updateRapports()">
      <i data-lucide="rotate-ccw"></i> Actualiser
    </button>
  </header>

  <!-- Filtres avancés : Sélection d'une journée ou d'une période -->
  <div class="filter-container">
    <label for="filterDate">Journée :</label>
    <input type="date" id="filterDate" onchange="updateRapports()" />
    <span style="margin: 0 10px;">ou</span>
    <label for="startDate">Du :</label>
    <input type="date" id="startDate" onchange="updateRapports()" />
    <label for="endDate">Au :</label>
    <input type="date" id="endDate" onchange="updateRapports()" />
  </div>

  <!-- ===== AJOUT BOUTON EXPORT PDF JOURNALIER ===== -->
<button id="btnExportRapportPDF"
class="btn-modern secondary"
style="margin-top:12px;"
onclick="exportDailyReportPDF()">
<i data-lucide="download"></i> Exporter le rapport PDF du jour
</button>
<!-- ============================================== -->

<!-- À coller dans votre section Rapports, juste sous l'autre bouton -->
<button id="btnExportRapportMensuelPDF"
        class="btn-modern secondary"
        style="margin-top:8px;"
        onclick="askMonthlyExport()">
  <i data-lucide="download"></i> Exporter le rapport PDF du mois
</button>


  <div class="reports-container">
    <!-- Carte Résumé des Ventes -->
    <div class="report-card">
      <h2>Résumé des Ventes</h2>
      <ul>
        <li><span>Nombre total de ventes :</span> <span id="total-ventes">0</span></li>
        <li><span>Chiffre d'affaires :</span> <span id="chiffre-affaires">0 FCFA</span></li>
        <li><span>Moyenne par vente :</span> <span id="moyenne-vente">0 FCFA</span></li>
        <li><span>Répartition Ventes/Livraisons :</span> <span id="ventes-repartition">0 / 0</span></li>
      </ul>
    </div>

    <!-- Carte Profit Global dans la section Rapports -->
<div class="report-card" onclick="window.location.hash='profit'">
  <h2>Profit Global</h2>
  <ul>
    <li><span>Profit Total :</span> <span id="profit-total">0 FCFA</span></li>
    <li><span>Profit Moyen par Vente :</span> <span id="profit-moyen">0 FCFA</span></li>
  </ul>
</div>

    <!-- Carte Analyse des Livraisons -->
    <div class="report-card">
      <h2>Analyse des Livraisons</h2>
      <ul>
        <li><span>Total livraisons :</span> <span id="total-livraisons">0</span></li>
        <li><span>En cours :</span> <span id="livraisons-en-cours">0</span></li>
        <li><span>Réussies :</span> <span id="livraisons-reussies">0</span></li>
        <li><span>Échouées :</span> <span id="livraisons-echouees">0</span></li>
      </ul>
    </div>
    <!-- Carte Synthèse du Stock -->
    <div class="report-card">
      <h2>Synthèse du Stock</h2>
      <ul>
        <li><span>Téléphones :</span> <span id="rapport-total-telephones">0</span></li>
        <li><span>Accessoires :</span> <span id="rapport-total-accessoires">0</span></li>
        <li><span>Valeur du stock :</span> <span id="valeur-stock">0 FCFA</span></li>
      </ul>
    </div>
    <!-- Carte Détail Dépenses -->
    <div class="report-card">
      <h2>Détail Dépenses</h2>
      <ul>
        <li><span>Dépenses Fonctionnelles :</span> <span id="depenses-fonctionnelles">0 FCFA</span></li>
        <li><span>Dépenses "Papa" :</span> <span id="depenses-papa">0 FCFA</span></li>
        <li><span>Transactions :</span> <span id="nombre-transactions">0</span></li>
        <li><span>Moyenne dépense :</span> <span id="moyenne-depense">0 FCFA</span></li>
      </ul>
    </div>
    <!-- Carte Performance par canal -->
    <div class="report-card">
      <h2>Performance par canal</h2>
      <ul>
        <li><span>CA par canal :</span> <span id="ca-par-vendeur">-</span></li>
        <li><span>Ventes par canal :</span> <span id="ventes-par-vendeur">-</span></li>
      </ul>
    </div>
    <!-- Carte Indicateurs Clés -->
    <div class="report-card">
      <h2>Indicateurs Clés</h2>
      <ul>
        <li><span>Comparaison jour/semaine :</span> <span id="comparaison-temporelle">-</span></li>
        <li><span>Évolution stocks :</span> <span id="evolution-stocks">-</span></li>
        <li><span>KPIs globaux :</span> <span id="kpi-globaux">-</span></li>
      </ul>
    </div>
  </div>

  <!-- Section Graphique : Graphique de tendance des ventes -->
  <div class="chart-container">
    <h2>Tendance des Ventes</h2>
    <canvas id="salesChart"></canvas>
  </div>
</section>

<!-- ===== Styles CSS pour la section Rapports & Statistiques ===== -->
<style>
  /* Fond et structure générale */
  #screen-rapports {
    background-color: #ffffff;
    padding: 20px;
    min-height: calc(100vh - 60px);
    font-family: 'Roboto', sans-serif;
  }
  /* En-tête de la section */
  .rapport-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-bottom: 10px;
    border-bottom: 1px solid #e0e0e0;
  }
  .rapport-header h1 {
    font-size: 24px;
    color: #333;
    margin: 0;
  }
  /* Boutons plats, arrondis, avec couleurs neutres et accents */
  .btn-back,
  .btn-refresh {
    background-color: #f2f2f2;
    border: none;
    border-radius: 25px;
    padding: 8px 12px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .btn-back:hover,
  .btn-refresh:hover {
    background-color: #e0e0e0;
  }
  /* Filtres avancés */
  .filter-container {
    margin-top: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 16px;
  }
  .filter-container label {
    font-weight: 500;
    color: #333;
  }
  .filter-container input[type="date"] {
    padding: 6px 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 16px;
  }
  /* Grille de cartes pour les rapports */
  .reports-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }
  /* Style des cartes de rapport */
  .report-card {
    background-color: #fff;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 1px solid #f0f0f0;
    transition: box-shadow 0.3s ease;
  }
  .report-card:hover {
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  }
  /* Titres des cartes */
  .report-card h2 {
    font-size: 20px;
    color: #006064;
    margin-bottom: 15px;
    border-bottom: 2px solid #006064;
    padding-bottom: 8px;
  }
  /* Listes des indicateurs */
  .report-card ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .report-card ul li {
    display: flex;
    justify-content: space-between;
    font-size: 16px;
    color: #555;
    margin-bottom: 10px;
  }
  .report-card ul li span:first-child {
    font-weight: 500;
    color: #333;
  }
  .report-card ul li span:last-child {
    font-weight: bold;
    color: #000;
  }
  /* Section graphique */
  .chart-container {
    margin-top: 30px;
    background-color: #fff;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 1px solid #f0f0f0;
  }
  .chart-container h2 {
    font-size: 20px;
    color: #006064;
    margin-bottom: 15px;
    text-align: center;
  }
  /* Responsive */
  @media (max-width: 480px) {
    #screen-rapports {
      padding: 15px;
    }
    .report-card {
      padding: 15px;
    }
    .report-card h2 {
      font-size: 18px;
    }
    .report-card ul li {
      font-size: 14px;
    }
  }
</style>

<!-- ===== Intégration de Chart.js pour les graphiques ===== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- ===== Script JavaScript pour mettre à jour les rapports et le graphique ===== -->
<script>
  function updateRapports() {
    // Récupérer les valeurs des filtres
    const filterDate = document.getElementById("filterDate").value;
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;

    // Fonction de filtrage : si une période est renseignée (startDate et endDate),
    // on filtre par période. Sinon, on utilise filterDate (jour unique)
    const filterByDate = (sale) => {
      if (startDate && endDate) {
        const saleDate = new Date(sale.timestamp);
        const start = new Date(startDate);
        const end = new Date(endDate);
        end.setHours(23, 59, 59, 999);
        return saleDate >= start && saleDate <= end;
      } else if (filterDate) {
        return sale.dateVente === new Date(filterDate).toLocaleDateString("fr-FR");
      }
      return true;
    };

    // Mise à jour du résumé des ventes
    getSalesForTodayFirestore().then(sales => {
      sales = sales.filter(filterByDate);
      const totalVentes = sales.length;
      const chiffreAffaires = sales.reduce((sum, sale) => sum + (parseFloat(sale.overallTotal) || 0), 0);
      const moyenneVente = totalVentes > 0 ? chiffreAffaires / totalVentes : 0;
      const ventesClassiques = sales.filter(sale => !sale.isDelivery || (sale.isDelivery && sale.convertedToSale)).length;
      const livraisons = sales.filter(sale => sale.isDelivery && !sale.convertedToSale).length;
      document.getElementById("total-ventes").textContent = totalVentes;
      document.getElementById("chiffre-affaires").textContent = chiffreAffaires.toLocaleString() + " FCFA";
      document.getElementById("moyenne-vente").textContent = moyenneVente.toLocaleString() + " FCFA";
      document.getElementById("ventes-repartition").textContent = ventesClassiques + " / " + livraisons;
      
      // Mise à jour du graphique des ventes
      updateSalesChart(sales);
        // Calcul du profit global à l'intérieur du même bloc
      let totalProfit = 0;
      sales.forEach(sale => {
        totalProfit += parseFloat(sale.totalProfit) || 0;
      });
      const profitMoyen = totalVentes > 0 ? totalProfit / totalVentes : 0;
      document.getElementById("profit-total").textContent = totalProfit.toLocaleString() + " FCFA";
      document.getElementById("profit-moyen").textContent = profitMoyen.toLocaleString() + " FCFA";
      
    });

    // Mise à jour de l'analyse des livraisons
    getSalesForTodayFirestore().then(sales => {
      sales = sales.filter(filterByDate);
      const livraisonsSales = sales.filter(sale => sale.isDelivery);
      const totalLivraisons = livraisonsSales.length;
      const enCours = livraisonsSales.filter(sale => sale.deliveryStatus === "en cours").length;
      const reussies = livraisonsSales.filter(sale => sale.deliveryStatus === "réussie").length;
      const echouees = livraisonsSales.filter(sale => sale.deliveryStatus === "échouée").length;
      document.getElementById("total-livraisons").textContent = totalLivraisons;
      document.getElementById("livraisons-en-cours").textContent = enCours;
      document.getElementById("livraisons-reussies").textContent = reussies;
      document.getElementById("livraisons-echouees").textContent = echouees;
    });

    // Mise à jour de la synthèse du stock (indépendante du filtre de date)
    getAllStockFirestore().then(stocks => {
      const totalTelephones = stocks.filter(s => s.category === "telephones").reduce((sum, s) => sum + s.stock, 0);
      const totalAccessoires = stocks.filter(s => s.category === "accessoires").reduce((sum, s) => sum + s.stock, 0);
      const valeurStock = stocks.reduce((sum, s) => sum + (s.stock * s.price), 0);
      document.getElementById("rapport-total-telephones").textContent = totalTelephones;
      document.getElementById("rapport-total-accessoires").textContent = totalAccessoires;
      document.getElementById("valeur-stock").textContent = valeurStock.toLocaleString() + " FCFA";
    });

    // Mise à jour du détail des dépenses
    dbFirestore.collection("depenses").get().then(snapshot => {
      let depenseFonctionnelle = 0, depensePapa = 0, transactions = 0;
      snapshot.forEach(doc => {
        const data = doc.data();
        const montant = parseFloat(data.montant) || 0;
        transactions++;
        if (data.type === "papa") {
          depensePapa += montant;
        } else {
          depenseFonctionnelle += montant;
        }
      });
      document.getElementById("depenses-fonctionnelles").textContent = depenseFonctionnelle.toLocaleString() + " FCFA";
      document.getElementById("depenses-papa").textContent = depensePapa.toLocaleString() + " FCFA";
      document.getElementById("nombre-transactions").textContent = transactions;
      const moyenneDepense = transactions > 0 ? (depenseFonctionnelle + depensePapa) / transactions : 0;
      document.getElementById("moyenne-depense").textContent = moyenneDepense.toLocaleString() + " FCFA";
    });

    // Mise à jour de la performance par canal
    getSalesForTodayFirestore().then(sales => {
      sales = sales.filter(filterByDate);
      const caParVendeur = {};
      const ventesParVendeur = {};
      sales.forEach(sale => {
        const vendeur = sale.vendeur || "Inconnu";
        caParVendeur[vendeur] = (caParVendeur[vendeur] || 0) + (parseFloat(sale.overallTotal) || 0);
        ventesParVendeur[vendeur] = (ventesParVendeur[vendeur] || 0) + 1;
      });
      document.getElementById("ca-par-vendeur").textContent = JSON.stringify(caParVendeur);
      document.getElementById("ventes-par-vendeur").textContent = JSON.stringify(ventesParVendeur);
    });

    // Mise à jour des indicateurs clés
    document.getElementById("comparaison-temporelle").textContent = "À implémenter";
    document.getElementById("evolution-stocks").textContent = "À implémenter";
    document.getElementById("kpi-globaux").textContent = "À implémenter";
  }

  // Fonction pour créer ou mettre à jour le graphique des ventes
  let salesChart;
  function updateSalesChart(salesData) {
    const ventesParHeure = new Array(24).fill(0);
    salesData.forEach(sale => {
      const heure = new Date(sale.timestamp).getHours();
      ventesParHeure[heure]++;
    });
    const labels = ventesParHeure.map((_, index) => index + "h");

    if(salesChart) {
      salesChart.data.labels = labels;
      salesChart.data.datasets[0].data = ventesParHeure;
      salesChart.update();
    } else {
      const ctx = document.getElementById('salesChart').getContext('2d');
      salesChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Ventes par heure',
            data: ventesParHeure,
            backgroundColor: 'rgba(0, 96, 100, 0.2)',
            borderColor: 'rgba(0, 96, 100, 1)',
            borderWidth: 2,
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { display: true },
            y: { display: true, beginAtZero: true }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }
  }
</script>
<!-- ===== Fin de la section Rapports & Statistiques ===== -->

<!-- Screen: Profit -->
<section id="screen-profit" class="screen">
  <header class="rapport-header">
    <button class="btn-back" onclick="window.location.hash='rapports'">
      <i data-lucide="arrow-left"></i>
    </button>
    <h1>Détails du Profit</h1>
  </header>
  <div class="container">
    <!-- Profit Moyen par Vente -->
    <div class="report-card">
      <h2>Profit Moyen par Vente</h2>
      <p id="detail-profit-moyen">0 FCFA</p>
    </div>
    <!-- Profit par Catégorie -->
    <div class="report-card">
      <h2>Profit par Catégorie</h2>
      <ul id="profit-par-categorie">
        <!-- Exemples : Téléphones : 0 FCFA, Accessoires : 0 FCFA -->
      </ul>
    </div>
    <!-- Top 5 des Produits les Plus Profitables -->
    <div class="report-card">
      <h2>Top 5 Produits les Plus Profitables</h2>
      <ol id="top-produits-profit">
        <!-- Liste des produits -->
      </ol>
    </div>
    <!-- Profit par canal -->
    <div class="report-card">
      <h2>Profit par canal</h2>
      <ul id="profit-par-vendeur">
        <!-- Exemple : Canal A : 0 FCFA, Canal B : 0 FCFA -->
      </ul>
    </div>
    <!-- Évolution du Profit -->
    <div class="chart-container">
      <h2>Évolution du Profit</h2>
      <canvas id="profitChart"></canvas>
    </div>
    <!-- Marge Bénéficiaire Moyenne -->
    <div class="report-card">
      <h2>Marge Bénéficiaire Moyenne</h2>
      <p id="marge-beneficiaire">0%</p>
    </div>
  </div>
</section>

<!-- CSS pour l'écran Profit -->
<style>
  #screen-profit {
    background-color: #ffffff;
    padding: 20px;
    min-height: calc(100vh - 60px);
    font-family: 'Roboto', sans-serif;
  }
  #screen-profit .rapport-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-bottom: 10px;
    border-bottom: 1px solid #e0e0e0;
  }
  #screen-profit .rapport-header h1 {
    font-size: 24px;
    color: #333;
    margin: 0;
  }
  #screen-profit .container {
    padding: 15px;
  }
  #screen-profit .report-card {
    background-color: #fff;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 1px solid #f0f0f0;
    transition: box-shadow 0.3s ease;
  }
  #screen-profit .report-card:hover {
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  }
  #screen-profit .report-card h2 {
    font-size: 20px;
    color: #006064;
    margin-bottom: 15px;
    border-bottom: 2px solid #006064;
    padding-bottom: 8px;
  }
  #screen-profit .report-card ul,
  #screen-profit .report-card ol {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  #screen-profit .report-card ul li,
  #screen-profit .report-card ol li {
    font-size: 16px;
    color: #555;
    margin-bottom: 10px;
  }
  #screen-profit .chart-container {
    background-color: #fff;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 1px solid #f0f0f0;
  }
  #screen-profit .chart-container h2 {
    font-size: 20px;
    color: #006064;
    margin-bottom: 15px;
    text-align: center;
  }
</style>

<!-- JavaScript pour l'écran Profit -->
<script>
  // Fonction pour mettre à jour les détails du profit
  function updateProfitDetails() {
    // Récupère toutes les ventes d'aujourd'hui (vous pouvez adapter ce filtre selon vos besoins)
    getSalesForTodayFirestore().then(sales => {
      // Profit Total et Profit Moyen par Vente
      let totalProfit = 0;
      sales.forEach(sale => {
        totalProfit += parseFloat(sale.totalProfit) || 0;
      });
      const profitMoyen = sales.length > 0 ? totalProfit / sales.length : 0;
      document.getElementById("detail-profit-moyen").textContent = profitMoyen.toLocaleString() + " FCFA";

      // === AJOUT DES LIGNES MANQUANTES POUR LA CARTE "PROFIT GLOBAL" ===
    
      // Profit par Catégorie
      const profitCategorie = {};
      sales.forEach(sale => {
        if (sale.items && Array.isArray(sale.items)) {
          sale.items.forEach(item => {
            // Supposons que chaque item possède un champ "categorie" (ou utilisez une valeur par défaut "Divers")
            const cat = item.categorie || "Divers";
            profitCategorie[cat] = (profitCategorie[cat] || 0) + (item.profitTotal || 0);
          });
        }
      });
      const ulCat = document.getElementById("profit-par-categorie");
      ulCat.innerHTML = "";
      for (const [cat, profit] of Object.entries(profitCategorie)) {
        const li = document.createElement("li");
        li.textContent = `${cat} : ${parseFloat(profit).toLocaleString()} FCFA`;
        ulCat.appendChild(li);
      }

      // Top 5 des Produits les Plus Profitables
      const profitParProduit = {};
      sales.forEach(sale => {
        if (sale.items && Array.isArray(sale.items)) {
          sale.items.forEach(item => {
            const prod = item.produit;
            profitParProduit[prod] = (profitParProduit[prod] || 0) + (item.profitTotal || 0);
          });
        }
      });
      const topProduits = Object.entries(profitParProduit)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
      const olTop = document.getElementById("top-produits-profit");
      olTop.innerHTML = "";
      topProduits.forEach(([prod, profit]) => {
        const li = document.createElement("li");
        li.textContent = `${prod} : ${parseFloat(profit).toLocaleString()} FCFA`;
        olTop.appendChild(li);
      });

      // Profit par canal
      const profitParVendeur = {};
      sales.forEach(sale => {
        const vendeur = sale.vendeur || "Inconnu";
        profitParVendeur[vendeur] = (profitParVendeur[vendeur] || 0) + (parseFloat(sale.totalProfit) || 0);
      });
      const ulVendeur = document.getElementById("profit-par-vendeur");
      ulVendeur.innerHTML = "";
      for (const [vendeur, profit] of Object.entries(profitParVendeur)) {
        const li = document.createElement("li");
        li.textContent = `${vendeur} : ${parseFloat(profit).toLocaleString()} FCFA`;
        ulVendeur.appendChild(li);
      }

      // Calcul de la marge bénéficiaire moyenne
      let totalPrixVente = 0;
      let totalProfitUnitaire = 0;
      let totalQuantite = 0;
      sales.forEach(sale => {
        if (sale.items && Array.isArray(sale.items)) {
          sale.items.forEach(item => {
            totalPrixVente += parseFloat(item.prix) * item.quantite;
            totalProfitUnitaire += (parseFloat(item.profitUnitaire) || 0) * item.quantite;
            totalQuantite += item.quantite;
          });
        }
      });
      const marge = totalPrixVente > 0 ? (totalProfitUnitaire / totalPrixVente) * 100 : 0;
      document.getElementById("marge-beneficiaire").textContent = marge.toFixed(2) + "%";

      // Évolution du profit par heure (ou une autre période)
      const profitParHeure = new Array(24).fill(0);
      sales.forEach(sale => {
        const heure = new Date(sale.timestamp).getHours();
        profitParHeure[heure] += parseFloat(sale.totalProfit) || 0;
      });
      updateProfitChart(profitParHeure);
    }).catch(error => console.error("Erreur dans updateProfitDetails :", error));
  }

  // Fonction pour mettre à jour le graphique d'évolution du profit
  let profitChart;
  function updateProfitChart(profitParHeure) {
    const labels = profitParHeure.map((_, index) => index + "h");
    const ctx = document.getElementById("profitChart").getContext("2d");
    if (profitChart) {
      profitChart.data.labels = labels;
      profitChart.data.datasets[0].data = profitParHeure;
      profitChart.update();
    } else {
      profitChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "Profit par heure",
            data: profitParHeure,
            backgroundColor: "rgba(109, 93, 253, 0.2)",
            borderColor: "rgba(109, 93, 253, 1)",
            borderWidth: 2,
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { display: true },
            y: { display: true, beginAtZero: true }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }
  }

  // Ajoutez ici la fonction updateProfitScreen()
function updateProfitScreen() {
  updateProfitDetails();
}

/**  Enregistre un document dans la bonne collection  */
function logDepenseRemboursement({ collection, montant, description, type = "", timestamp = Date.now() }) {
  const d   = new Date(timestamp);
  const ref = dbFirestore.collection(collection);
  return ref.add({
    montant,
    description,
    type,                     // "depense fonctionnelle", "papa", …
    timestamp,
    date        : d.toISOString(),
    dateString  : d.toLocaleDateString("fr-FR")
  });
}

</script>


<!-- Section Approvisionnement -->
<section id="screen-approvisionnement" class="screen">
    <header>
        <button class="back-btn" onclick="window.location.hash='menu'">
            <i data-lucide="arrow-left"></i> Retour
        </button>
        <h1>Nouvel Achat</h1>
    </header>

    <div id="appro-mode-dialog" class="appro-mode-dialog" style="display:none;">
        <div class="appro-mode-dialog-content">
            <h2>Choisir le type d'achat</h2>
            <p>Sélectionnez le type d'achat que vous souhaitez enregistrer.</p>
            <div class="appro-mode-dialog-actions">
                <button type="button" class="btn-modern secondary" onclick="selectApproMode('normal')">
                    Achat direct
                </button>
                <button type="button" class="btn-modern" onclick="selectApproMode('commande')">
                    Commande à recevoir
                </button>
            </div>
        </div>
    </div>

    <div class="form-section">
        <h2>Détails de l'article</h2>
        <form class="vente-form" onsubmit="event.preventDefault(); ajouterApprovisionnementItem();">

            <label for="typeAchatAppro">Type d'achat <span style="color: #d9534f;">*</span></label>
            <select id="typeAchatAppro" required style="margin-bottom: 16px;">
                <option value="normal" selected>Achat Normal</option>
                <option value="depot">Dépôt Fournisseur</option>
                <option value="commande">Commande fournisseur</option>
            </select>

            <div id="commandeAdditionalFields" style="display: none;">
                <label for="commandeDatePrevue">Date prévue de réception</label>
                <input type="date" id="commandeDatePrevue" />

                <label for="commandeReference">Référence commande</label>
                <input type="text" id="commandeReference" placeholder="Référence fournisseur (optionnel)" />

                <label for="commandeNotes">Notes internes</label>
                <textarea id="commandeNotes" rows="2" placeholder="Instructions, conditions, etc."></textarea>

            </div>
            

            <label for="fournisseurAppro">Fournisseur <span style="color: #d9534f;">*</span></label>
            <div> <input type="text" id="fournisseurAppro" placeholder="Rechercher ou saisir un fournisseur" autocomplete="off" required />
                <div id="suggestionListFournisseur" class="suggestion-list"></div>
            </div>


            <label for="categorieAppro">Catégorie <span style="color: #d9534f;">*</span></label>
            <select id="categorieAppro" required>
                <option value="telephones">Téléphones</option>
                <option value="accessoires">Accessoires</option>
            </select>

            <label for="modeleAppro">Désignation article <span style="color: #d9534f;">*</span></label>
            <div class="input-container">
                <input type="text" id="modeleAppro" placeholder="Rechercher ou créer un article" autocomplete="off" required />
                <div id="suggestionListAppro" class="suggestion-list"></div>
            </div>

            <label for="quantiteAppro">Quantité <span style="color: #d9534f;">*</span></label>
            <div class="quantity-container">
                <button type="button" onclick="decrementQuantityAppro()">–</button>
                <input type="number" id="quantiteAppro" min="1" value="1" required oninput="calculerCoutTotalAppro()" />
                <button type="button" onclick="incrementQuantityAppro()">+</button>
            </div>

            <div style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <label for="prixAchatAppro">Prix d'achat unitaire <span style="color: #d9534f;">*</span></label>
                    <input type="number" id="prixAchatAppro" placeholder="0" required oninput="calculerCoutTotalAppro()" />
                </div>
                <div style="flex: 1;">
                    <label for="coutTotalAppro">Coût total</label>
                    <input type="number" id="coutTotalAppro" readonly placeholder="Calcul automatique" />
                </div>
            </div>

            <button type="button" class="btn-modern add-item-style" onclick="ajouterApprovisionnementItem()">Ajouter l'article</button>
        </form>
    </div>
<div class="panier-approvisionnement vente-form"> <h2>Panier d'Achat</h2>
    <div id="panierApproContent" class="list-container" style="margin-bottom: 15px;">
        <p>Le panier est vide.</p>
    </div>

    <div class="input-group" style="margin-bottom: 15px;">
        <label for="fraisTransportAppro">Frais de transport (FCFA)</label>
        <input type="number"
               id="fraisTransportAppro"
               placeholder="Saisir les frais de transport"
               min="0"
               oninput="updatePanierApprovisionnement()">
    </div>
    <div class="input-group" id="transportCompteApproGroup" style="margin-bottom: 15px;">
        <label for="compteSelectTransportAppro">Compte utilisé pour le transport</label>
        <select id="compteSelectTransportAppro">
            <option value="">-- Sélectionner un compte --</option>
        </select>
    </div>

    <div id="purchasePaymentSection" class="purchase-payment-section">
        <label id="purchasePaymentStatusLabel" for="purchasePaymentStatus">Achat réglé ? <span style="color: #d9534f;">*</span></label>
        <select id="purchasePaymentStatus" required>
            <option value="no" selected>Non - enregistrer comme dette</option>
            <option value="yes">Oui - paiement effectué</option>
        </select>

        <div id="purchasePaymentsBlock" class="vente-payments-block" style="display: none;">
            <div class="vente-payments-header">
                <h3>Paiements fournisseur</h3>
                <button type="button" class="btn-modern secondary" onclick="ajouterLignePaiementAppro()">Ajouter un paiement</button>
            </div>
            <div id="purchasePaymentsContainer" class="vente-payments-container"></div>
            <div class="vente-payments-summary">
                <p>Total achat : <strong id="purchase-summary-total-due">0 FCFA</strong></p>
                <p>Total payé : <strong id="purchase-summary-total-paid">0 FCFA</strong></p>
                <p>Différence : <strong id="purchase-summary-difference">0 FCFA</strong></p>
            </div>
            <p id="purchase-payment-warning" class="vente-payment-warning"></p>
        </div>
    </div>

    <button class="btn-modern" onclick="finaliserApprovisionnement()" style="margin-top: 20px;">Enregistrer l'Achat</button>
    </div>
    <div class="approvisionnement-history">
        <h2>Historique des Achats</h2>
        <div id="approvisionnementList" class="list-container">
        </div>
    </div>
</section>


<style>
  

/* On donne un fond gris clair à l'écran */
#screen-approvisionnement {
    background-color: #f5f7fa;
    padding: 10px;
}

#screen-approvisionnement .appro-mode-dialog {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(15, 23, 42, 0.45);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    padding: 20px;
}

#screen-approvisionnement .appro-mode-dialog-content {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 24px;
    box-shadow: 0 12px 30px rgba(15, 23, 42, 0.25);
    max-width: 360px;
    width: 100%;
    text-align: center;
    display: flex;
    flex-direction: column;
    gap: 16px;
}

#screen-approvisionnement .appro-mode-dialog-content h2 {
    margin: 0;
    font-size: 20px;
    color: var(--text-color);
}

#screen-approvisionnement .appro-mode-dialog-content p {
    margin: 0;
    font-size: 14px;
    color: #555;
}

#screen-approvisionnement .appro-mode-dialog-actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

#screen-approvisionnement .appro-mode-dialog-actions .btn-modern {
    width: 100%;
}

#screen-approvisionnement header h1 {
    font-size: 20px;
}

/* On transforme .form-section en la nouvelle carte blanche */
#screen-approvisionnement .form-section {
    background: var(--white);
    box-shadow: 0 1px 4px rgba(0,0,0,0.08); /* Ombre plus subtile */
    border-radius: var(--border-radius);
    padding: 20px;
}

/* On ajuste les titres des cartes */
#screen-approvisionnement .form-section h2 {
    font-size: 18px;
    font-weight: 700;
    color: #333;
    margin-bottom: 20px;
    text-align: left; /* On aligne à gauche */
}

/* Style pour les labels au-dessus des champs */
#screen-approvisionnement .vente-form label {
    font-size: 14px;
    color: #555;
    margin-bottom: 6px;
    font-weight: 500;
}

/* Style pour les champs de saisie (input, select) */
#screen-approvisionnement .vente-form input,
#screen-approvisionnement .vente-form select,
#screen-approvisionnement .vente-form textarea {
    width: 100%;
    padding: 10px 4px; /* Plus d'espace vertical */
    font-size: 16px;
    border: none; /* On enlève toutes les bordures */
    border-bottom: 1px solid #ccc; /* On ajoute la ligne en bas */
    border-radius: 0;
    background-color: transparent;
    box-shadow: none; /* On enlève l'ombre */
}

/* Effet au focus */
#screen-approvisionnement .vente-form input:focus,
#screen-approvisionnement .vente-form select:focus,
#screen-approvisionnement .vente-form textarea:focus {
    outline: none;
    box-shadow: none; /* Pas d'ombre au focus */
    border-bottom: 2px solid var(--primary-color); /* Ligne plus épaisse et colorée */
}

#screen-approvisionnement .vente-form textarea {
    resize: vertical;
    min-height: 60px;
}

#screen-approvisionnement .commande-flags {
    margin: 8px 0 16px;
}

#screen-approvisionnement .commande-flags .checkbox-inline {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #555;
}

#screen-approvisionnement .commande-flags input[type="checkbox"] {
    width: auto;
}

/* Cas particulier du sélecteur de quantité */
#screen-approvisionnement .quantity-container {
    display: flex;
    align-items: center;
    border-bottom: 1px solid #ccc; /* On met la bordure sur le conteneur */
    padding-bottom: 8px;
    margin-bottom: 16px;
}
#screen-approvisionnement .quantity-container input {
    border: none !important; /* On s'assure qu'il n'a pas de bordure */
    text-align: center;
}
#screen-approvisionnement .quantity-container button {
    background: #f0f0f0;
    border: 1px solid #ddd;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    font-size: 20px;
}

/* Style pour le bouton "Ajouter l'article" */
#screen-approvisionnement .btn-modern.add-item-style {
    color: var(--primary-color);
    background: transparent;
    border: 1px solid var(--primary-color);
    font-weight: bold;
    box-shadow: none;
}
#screen-approvisionnement .btn-modern.add-item-style:hover {
    background: var(--primary-color);
    color: white;
}

/* Unifier le style des autres cartes (Panier et Historique) */
.panier-approvisionnement, .approvisionnement-history {
    background: var(--white);
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    border-radius: var(--border-radius);
    padding: 20px;
    margin-top: 15px;
}
.panier-approvisionnement h2, .approvisionnement-history h2 {
    font-size: 18px;
    font-weight: 700;
    color: #333;
    margin-bottom: 20px;
    text-align: left;
}
/* Improved select styling */
#screen-approvisionnement select {
  padding: 10px;
  border: 1px solid var(--border-color, #ccc); /* Use a CSS variable if you have one */
  border-radius: var(--border-radius, 4px);
  appearance: none; /* Remove default styling */
  background-image: url("data:image/svg+xml,..."); /* Add a custom dropdown arrow */
  background-repeat: no-repeat;
  background-position: right 8px top 50%;
  background-size: 16px;
}

#screen-approvisionnement select:focus {
  outline: none;
  border-color: var(--primary-color, blue); /* Use a CSS variable */
  box-shadow: 0 0 4px rgba(0, 0, 255, 0.2); /* Example focus effect */
}

/* Distinct cart items */
#panierApproContent .panier-item {
  background-color: #f9f9f9;
  padding: 12px;
  margin-bottom: 8px;
  border-radius: 8px;
  font-size: 16px;
}

#panierApproContent .panier-item strong {
  font-weight: 600;
  margin-right: 8px;
}

#panierApproContent .panier-item span {
  color: #777;
}
/* Vous pouvez aussi ajuster le margin-bottom du sélecteur principal si vous voulez plus d'espace */
#screen-approvisionnement .vente-form select {
  margin-bottom: 16px; /* Ajustez cette valeur si nécessaire */
}
</style>

<script>
  // Variable globale pour stocker les articles ajoutés au panier d'approvisionnement
  let currentApproItems = [];
  let approPayments = [];
  let approPaymentAutoId = 0;
  let currentCommandeReception = null;
  let currentReceptionDraft = null;
  let scanUsageMode = 'appro';
  let currentReceptionScanIndex = null;

  function resetApproPayments() {
      approPayments = [];
      approPaymentAutoId = 0;
      const container = document.getElementById('purchasePaymentsContainer');
      if (container) {
          container.innerHTML = '';
      }
      rafraichirResumePaiementAppro();
  }

  function ensureApproPaymentsInitialized() {
      const container = document.getElementById('purchasePaymentsContainer');
      if (!container) {
          return;
      }
      if (approPayments.length === 0) {
          ajouterLignePaiementAppro();
      } else if (!container.childElementCount) {
          renderApproPayments();
      }
      rafraichirResumePaiementAppro();
  }

  function getCurrentPurchaseDueAmount() {
      return currentApproItems.reduce((sum, item) => {
          const valeur = parseFloat(item.coutTotal) || 0;
          return sum + valeur;
      }, 0);
  }

  function ajouterLignePaiementAppro(initialData) {
      const payload = initialData || {};
      approPayments.push({
          id: ++approPaymentAutoId,
          compteId: payload.compteId || '',
          montant: payload.montant || ''
      });
      renderApproPayments();
      rafraichirResumePaiementAppro();
  }

  function renderApproPayments() {
      const container = document.getElementById('purchasePaymentsContainer');
      if (!container) {
          return;
      }

      container.innerHTML = '';

      approPayments.forEach(payment => {
          const row = document.createElement('div');
          row.className = 'vente-payment-row';
          row.dataset.paymentId = payment.id;

          const compteSelect = document.createElement('select');
          compteSelect.id = `compteSelectApproPayment-${payment.id}`;
          compteSelect.className = 'vente-payment-account';
          compteSelect.addEventListener('change', event => {
              onApproPaymentFieldChange(payment.id, 'compteId', event.target.value);
          });
          row.appendChild(compteSelect);

          const amountInput = document.createElement('input');
          amountInput.type = 'number';
          amountInput.min = '0';
          amountInput.step = '100';
          amountInput.placeholder = 'Montant pay?';
          amountInput.value = payment.montant || '';
          amountInput.addEventListener('input', event => {
              onApproPaymentFieldChange(payment.id, 'montant', event.target.value);
          });
          row.appendChild(amountInput);

          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'vente-payment-remove btn-modern secondary';
          removeBtn.innerHTML = '<i data-lucide="trash-2"></i>';
          removeBtn.addEventListener('click', () => supprimerLignePaiementAppro(payment.id));
          row.appendChild(removeBtn);

          container.appendChild(row);
      });

      remplirTousSelectComptes();
      approPayments.forEach(payment => {
          const selectEl = document.getElementById(`compteSelectApproPayment-${payment.id}`);
          if (selectEl) {
              selectEl.value = payment.compteId || '';
          }
      });

      if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
          refreshLucideIcons();
      }
  }

  function onApproPaymentFieldChange(paymentId, field, value) {
      const payment = approPayments.find(p => p.id === paymentId);
      if (!payment) {
          return;
      }

      payment[field] = value;
      rafraichirResumePaiementAppro();
  }

  function supprimerLignePaiementAppro(paymentId) {
      if (approPayments.length <= 1) {
          const unique = approPayments[0];
          if (unique) {
              unique.compteId = '';
              unique.montant = '';
          }
          renderApproPayments();
          rafraichirResumePaiementAppro();
          return;
      }

      approPayments = approPayments.filter(p => p.id !== paymentId);
      renderApproPayments();
      rafraichirResumePaiementAppro();
  }

  function analyserPaiementsAppro() {
      const due = getCurrentPurchaseDueAmount();
      let totalPaid = 0;
      let valid = true;
      let message = '';
      let hasPositivePayment = false;
      const typeSelect = document.getElementById("typeAchatAppro");
      const paymentStatusSelect = document.getElementById("purchasePaymentStatus");
      const currentType = typeSelect ? typeSelect.value : 'normal';
      const paymentStatus = paymentStatusSelect ? paymentStatusSelect.value : 'no';
      const requirePayment = paymentStatus === 'yes';
      const allowPartialPayment = currentType === 'commande';

      for (const payment of approPayments) {
          const amount = parseFloat(payment.montant) || 0;
          if (amount < 0) {
              valid = false;
              message = 'Les montants pay?s ne peuvent pas ?tre n?gatifs.';
              break;
          }
          if (amount > 0 && !payment.compteId) {
              valid = false;
              message = 'S?lectionnez un compte de tr?sorerie pour chaque paiement.';
              break;
          }
          if (amount > 0) {
              hasPositivePayment = true;
          }
          totalPaid += amount;
      }

      const difference = due - totalPaid;

      if (valid) {
          if (requirePayment && due > 0 && !hasPositivePayment) {
              valid = false;
              message = 'Renseignez au moins un montant pay?.';
          } else if (requirePayment && !allowPartialPayment && Math.abs(difference) > 0.5) {
              valid = false;
              message = `Le total pay? (${fmt(totalPaid)} FCFA) doit ?tre ?gal au total de l'achat (${fmt(due)} FCFA).`;
          } else if (requirePayment && allowPartialPayment && difference < -0.5) {
              valid = false;
              message = `Le total pay? (${fmt(totalPaid)} FCFA) ne peut pas dépasser le montant de la commande (${fmt(due)} FCFA).`;
          }
      }

      return { valid, message, due, totalPaid, difference, allowPartial: allowPartialPayment, requirePayment };
  }

  function rafraichirResumePaiementAppro() {
      const totalDueEl = document.getElementById('purchase-summary-total-due');
      const totalPaidEl = document.getElementById('purchase-summary-total-paid');
      const differenceEl = document.getElementById('purchase-summary-difference');
      const warningEl = document.getElementById('purchase-payment-warning');

      if (!totalDueEl || !totalPaidEl || !differenceEl) {
          return analyserPaiementsAppro();
      }

      const stats = analyserPaiementsAppro();

      totalDueEl.textContent = `${fmt(stats.due)} FCFA`;
      totalPaidEl.textContent = `${fmt(stats.totalPaid)} FCFA`;
      differenceEl.textContent = `${fmt(stats.difference)} FCFA`;

      if (stats.difference === 0) {
          differenceEl.style.color = '#3880ff';
      } else if (stats.difference > 0) {
          differenceEl.style.color = '#f04141';
      } else {
          differenceEl.style.color = '#2e7d32';
      }

      if (warningEl) {
          warningEl.textContent = stats.valid ? '' : stats.message;
      }

      return stats;
  }

  function validateApproPayments(showAlert = true) {
      const stats = analyserPaiementsAppro();
      if (!stats.valid && showAlert) {
          alert(stats.message);
      }
      return stats;
  }

  function getCompteNomById(compteId) {
      if (!Array.isArray(comptesCache)) {
          return compteId;
      }
      const compte = comptesCache.find(c => c.id === compteId);
      return (compte && (compte.nom || compte.id)) || compteId;
  }

  // Global variables for supplier search


  // Calcul du coût total d'approvisionnement
  function calculerCoutTotalAppro() {
    const quantite = parseFloat(document.getElementById("quantiteAppro").value) || 0;
    const prix = parseFloat(document.getElementById("prixAchatAppro").value) || 0;
    const total = quantite * prix;
    document.getElementById("coutTotalAppro").value = total.toFixed(2);
  }
// Cette fonction sera appelée à chaque changement du type d'achat
function updatePurchasePaymentUI() {
    const paymentStatusSelect = document.getElementById("purchasePaymentStatus");
    const paymentBlock = document.getElementById("purchasePaymentsBlock");

    if (!paymentStatusSelect || !paymentBlock) {
        return;
    }

    if (paymentStatusSelect.value === 'yes') {
        paymentBlock.style.display = 'block';
        ensureApproPaymentsInitialized();
    } else {
        paymentBlock.style.display = 'none';
        resetApproPayments();
    }
}

function handlePurchaseTypeChange() {
    const typeSelect = document.getElementById("typeAchatAppro");
    const paymentSection = document.getElementById("purchasePaymentSection");
    const statusSelect = document.getElementById("purchasePaymentStatus");
    const paymentLabel = document.getElementById("purchasePaymentStatusLabel");
    const commandeFields = document.getElementById("commandeAdditionalFields");
    const transportGroup = document.getElementById("transportCompteApproGroup");
    const transportSelect = document.getElementById("compteSelectTransportAppro");

    if (!typeSelect || !paymentSection) {
        return;
    }

    const currentType = typeSelect.value;

    if (commandeFields) {
        commandeFields.style.display = currentType === 'commande' ? 'block' : 'none';
    }

    if (transportGroup) {
        if (currentType === 'commande') {
            transportGroup.style.display = 'none';
        } else {
            transportGroup.style.display = 'block';
        }
    }
    if (transportSelect) {
        if (currentType === 'commande') {
            transportSelect.value = '';
            transportSelect.disabled = true;
        } else {
            transportSelect.disabled = false;
        }
    }

    if (paymentLabel) {
        if (currentType === 'commande') {
            paymentLabel.innerHTML = 'Enregistrer un acompte ? <span style="color: #d9534f;">*</span>';
        } else {
            paymentLabel.innerHTML = 'Achat réglé ? <span style="color: #d9534f;">*</span>';
        }
    }

    if (statusSelect && statusSelect.options.length >= 2) {
        if (currentType === 'commande') {
            statusSelect.options[0].text = 'Non - aucun acompte';
            statusSelect.options[1].text = 'Oui - saisir un acompte';
        } else {
            statusSelect.options[0].text = 'Non - enregistrer comme dette';
            statusSelect.options[1].text = 'Oui - paiement effectué';
        }
    }

    if (currentType === 'depot') {
        paymentSection.style.display = 'none';
        if (statusSelect) {
            statusSelect.value = 'no';
        }
        resetApproPayments();
        rafraichirResumePaiementAppro();
    } else {
        paymentSection.style.display = 'block';
        if (statusSelect && !statusSelect.value) {
            statusSelect.value = 'no';
        }
        updatePurchasePaymentUI();
    }

    rafraichirResumePaiementAppro();
}

function showApproModeDialog() {
    const dialog = document.getElementById('appro-mode-dialog');
    if (!dialog) return;
    dialog.style.display = 'flex';
}

function hideApproModeDialog() {
    const dialog = document.getElementById('appro-mode-dialog');
    if (!dialog) return;
    dialog.style.display = 'none';
}

function selectApproMode(mode) {
    const typeSelect = document.getElementById('typeAchatAppro');
    if (typeSelect) {
        if (mode === 'commande') {
            typeSelect.value = 'commande';
        } else {
            typeSelect.value = 'normal';
        }
        typeSelect.dispatchEvent(new Event('change'));
    }
    hideApproModeDialog();
    const focusTarget = mode === 'commande'
        ? document.getElementById('commandeDatePrevue')
        : document.getElementById('fournisseurAppro');
    if (focusTarget) {
        setTimeout(() => focusTarget.focus(), 150);
    }
}

const typeAchatSelect = document.getElementById("typeAchatAppro");
if (typeAchatSelect) {
    typeAchatSelect.addEventListener('change', handlePurchaseTypeChange);
}
const purchasePaymentStatusSelect = document.getElementById("purchasePaymentStatus");
if (purchasePaymentStatusSelect) {
    purchasePaymentStatusSelect.addEventListener('change', updatePurchasePaymentUI);
}

function approCartIsEmpty() {
    return Array.isArray(currentApproItems) ? currentApproItems.length === 0 : true;
}

window.addEventListener('hashchange', () => {
    if (window.location.hash === '#approvisionnement') {
        handlePurchaseTypeChange();
        if (approCartIsEmpty()) {
            showApproModeDialog();
        } else {
            hideApproModeDialog();
        }
    } else {
        hideApproModeDialog();
    }
});

handlePurchaseTypeChange();
if (window.location.hash === '#approvisionnement') {
    if (approCartIsEmpty()) {
        showApproModeDialog();
    } else {
        hideApproModeDialog();
    }
}

  // Incrémenter/Décrémenter la quantité
  function decrementQuantityAppro() {
    const input = document.getElementById("quantiteAppro");
    let value = parseInt(input.value) || 1;
    if (value > 1) {
      input.value = --value;
      calculerCoutTotalAppro();
    }
  }
  function incrementQuantityAppro() {
    const input = document.getElementById("quantiteAppro");
    let value = parseInt(input.value) || 1;
    input.value = ++value;
    calculerCoutTotalAppro();
  }

  // Recherche en temps réel pour les modèles
  const modeleInput = document.getElementById("modeleAppro");
  const suggestionListAppro = document.getElementById("suggestionListAppro");
  /* Quand on change de catégorie : on nettoie l'input, on vide la liste */
document.getElementById("categorieAppro").addEventListener("change", () => {
  modeleInput.value = "";
  suggestionListAppro.innerHTML = "";
  suggestionListAppro.style.display = "none";

  // (facultatif) adapter le placeholder de l'input
  modeleInput.placeholder =
    document.getElementById("categorieAppro").value === "telephones"
      ? "Rechercher un modèle de téléphone…"
      : "Rechercher un accessoire…";
});

  modeleInput.addEventListener("input", function () {
    const query = this.value.trim().toLowerCase();
    suggestionListAppro.innerHTML = "";
    if (query === "") {
      suggestionListAppro.style.display = "none";
      return;
    }
    // Récupération des modèles de téléphones dans la collection "stock" avec catégorie "telephones"
// Récupération dynamique des modèles selon la catégorie choisie
const selectedCat = document.getElementById("categorieAppro").value;

dbFirestore.collection("stock")
  .where("category", "==", selectedCat)
  .get()

      .then(snapshot => {
        const models = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.name) {
            models.push(data.name);
          }
        });
        const filtered = models.filter(name => name.toLowerCase().includes(query));
        if (filtered.length === 0) {
          const noResult = document.createElement("div");
          noResult.className = "suggestion-item";
          noResult.textContent = "Aucun modèle trouvé";
          suggestionListAppro.appendChild(noResult);
        } else {
          filtered.forEach(model => {
            const div = document.createElement("div");
            div.className = "suggestion-item";
            div.textContent = model;
            div.addEventListener("click", function () {
              modeleInput.value = model;
              suggestionListAppro.innerHTML = "";
              suggestionListAppro.style.display = "none";
            });
            suggestionListAppro.appendChild(div);
          });
        }
        suggestionListAppro.style.display = "block";
      })
      .catch(err => {
        console.error("Erreur lors de la récupération des modèles : " + err.message);
        suggestionListAppro.innerHTML = "<div class='suggestion-item'>Erreur de récupération</div>";
        suggestionListAppro.style.display = "block";
      });
  });
  document.addEventListener("click", function (e) {
    if (e.target !== modeleInput) {
      suggestionListAppro.style.display = "none";
    }
  });

  async function ajouterApprovisionnementItem() {
  const fournisseur = document.getElementById("fournisseurAppro").value.trim();
  const categorie = document.getElementById("categorieAppro").value;
  const modele = document.getElementById("modeleAppro").value.trim();
  const quantite = parseInt(document.getElementById("quantiteAppro").value);
  const prixAchat = parseFloat(document.getElementById("prixAchatAppro").value);
  const coutTotal = parseFloat(document.getElementById("coutTotalAppro").value);
  const typeAchatSelectionne = document.getElementById("typeAchatAppro").value;

  // Validation
  if (!fournisseur || !categorie || !modele || isNaN(quantite) || quantite <= 0 || isNaN(prixAchat) || prixAchat <= 0) {
    alert("Veuillez remplir tous les champs d'article correctement.");
    return;
  }

  showSaleLoader(); // Show loading indicator

  try {
    // 1. Check if supplier exists. If not, add it to the 'fournisseurs' collection.
    const supplierQuery = dbFirestore.collection("fournisseurs").where("name", "==", fournisseur);
    const supplierSnapshot = await supplierQuery.get();

    if (supplierSnapshot.empty) {
      // Supplier does not exist, add it
      await dbFirestore.collection("fournisseurs").add({
        name: fournisseur,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      console.log(`Nouveau fournisseur '${fournisseur}' ajouté à la base de données.`);
    }

    // Now, continue with the existing logic for adding the item to the currentApproItems
    const item = {
      fournisseur,
      category: categorie,
      produit: modele,
      quantite,
      prixAchat,
      coutTotal: coutTotal.toFixed(2),
      imeis: []
    };

    if (typeAchatSelectionne === 'commande') {
      item.commande = true;
    }

    if (item.category !== 'telephones' || typeAchatSelectionne === 'commande') {
      currentApproItems.push(item);
      updatePanierApprovisionnement();
      showToast(`${item.produit} ajouté au panier.`);
    } else {
      lancerScanDynamsoft(item);
    }

    // Clear form fields
    document.getElementById("modeleAppro").value = "";
    document.getElementById("quantiteAppro").value = "1";
    document.getElementById("prixAchatAppro").value = "";
    document.getElementById("coutTotalAppro").value = "";
    document.getElementById("modeleAppro").focus();

  } catch (error) {
    console.error("Erreur lors de l'ajout de l'approvisionnement ou du fournisseur : ", error);
    alert("Une erreur est survenue : " + error.message);
  } finally {
    hideSaleLoader(); // Hide loading indicator
  }
}

// New function to handle the visibility of the account selection
// New function to handle the visibility of the account selection
function updatePanierApprovisionnement() {
  const container = document.getElementById("panierApproContent");
  container.innerHTML = "";

  // 1. Récupérer les frais de transport
  const fraisTransport = parseFloat(document.getElementById("fraisTransportAppro").value) || 0;
  
  // 2. Calculer le coût total des articles du panier SANS les frais de transport (coût fournisseur)
  let totalCostExcludingTransport = currentApproItems.reduce((acc, item) => acc + parseFloat(item.coutTotal), 0);
  
  // Affiche un message si le panier est vide
  if (currentApproItems.length === 0) {
    container.innerHTML = "<p>Le panier est vide.</p>";
    return;
  }
  
  // Parcourir chaque article pour l'afficher et calculer son coût ajusté
  currentApproItems.forEach((item, index) => {
    const div = document.createElement("div");
    div.className = "panier-item"; 
    
    // Informations sur les IMEI pour les téléphones
    let imeiInfo = '';
    if (item.category === 'telephones' && item.imeis && item.imeis.length > 0) {
      imeiInfo = `<br><small style="color: green;">✔ ${item.imeis.length} IMEI scannés</small>`;
    } else if (item.category === 'telephones') {
      imeiInfo = `<br><small style="color: orange;">à Pas d'IMEI scanné</small>`;
    }
    
    // Calcul du coût unitaire ajusté (prix d'achat fournisseur + part des frais de transport)
    let itemAdjustedCostDisplay = '';
    let itemAdjustedUnitCost = parseFloat(item.prixAchat); // Par défaut, c'est le prix d'achat fournisseur
    
    if (totalCostExcludingTransport > 0 && fraisTransport > 0) {
        // Calcul de la part proportionnelle des frais de transport pour cet article
        const itemShareOfTransport = (parseFloat(item.coutTotal) / totalCostExcludingTransport) * fraisTransport;
        itemAdjustedUnitCost = parseFloat(item.prixAchat) + (itemShareOfTransport / item.quantite);
        itemAdjustedCostDisplay = `<br><small>Coût unitaire ajusté: <strong>${itemAdjustedUnitCost.toLocaleString('fr-FR')} FCFA</strong></small>`;
    }

    // Mise à jour de l'HTML de l'article dans le panier
    div.innerHTML = `
        <strong>${item.produit}</strong> - Qté: ${item.quantite} - Coût Fournisseur: ${parseFloat(item.coutTotal).toLocaleString('fr-FR')} FCFA
        <span class="remove-item" onclick="retirerApproItem(${index})" style="cursor: pointer; color: red; float: right;">&times;</span>
        ${imeiInfo}
        ${itemAdjustedCostDisplay}
    `;
    container.appendChild(div);
  });
  rafraichirResumePaiementAppro();
}

// Permet de retirer un article du panier
function retirerApproItem(index) {
  currentApproItems.splice(index, 1);
  updatePanierApprovisionnement(); // Rafraîchit l'affichage après suppression
}

 async function finaliserApprovisionnement() {
  const user = firebase.auth().currentUser;
    if (!user) {
      alert("Erreur: Utilisateur non connecté. Reconnexion nécessaire.");
      hideSaleLoader();
      return;
    }
    if (currentApproItems.length === 0) {
        alert("Le panier d'approvisionnement est vide.");
        return;
    }

    // On récupère le type d'achat choisi
    const typeAchat = document.getElementById("typeAchatAppro").value;
    const fournisseur = currentApproItems[0].fournisseur;
    const fraisTransport = parseFloat(document.getElementById("fraisTransportAppro").value) || 0;
    const transportCompteSelect = document.getElementById("compteSelectTransportAppro");
    const transportCompteId = transportCompteSelect ? transportCompteSelect.value : '';
    const commandeDatePrevue = document.getElementById("commandeDatePrevue") ? document.getElementById("commandeDatePrevue").value : '';
    const commandeReference = document.getElementById("commandeReference") ? document.getElementById("commandeReference").value.trim() : '';
    const commandeNotes = document.getElementById("commandeNotes") ? document.getElementById("commandeNotes").value.trim() : '';

    // Validation spécifique pour l'achat normal
        let purchasePaymentStatus = 'no';
    let paymentStats = null;
    const paymentStatusSelect = document.getElementById("purchasePaymentStatus");
    if (paymentStatusSelect) {
        purchasePaymentStatus = paymentStatusSelect.value || 'no';
    }

    if ((typeAchat === 'normal' || typeAchat === 'commande') && purchasePaymentStatus === 'yes') {
        paymentStats = validateApproPayments(true);
        if (!paymentStats.valid) {
            return;
        }
    }

    if (typeAchat !== 'commande' && fraisTransport > 0 && !transportCompteId) {
        alert("Sélectionnez le compte de trésorerie utilisé pour les frais de transport.");
        return;
    }

    showSaleLoader();

    try {
        const batch = dbFirestore.batch();
        const serverTimestamp = firebase.firestore.FieldValue.serverTimestamp();
        const now = new Date();

        const totalCostOfAllItemsBeforeTransport = currentApproItems.reduce((acc, item) => acc + parseFloat(item.coutTotal), 0);

        const finalItemsForFirestore = currentApproItems.map(item => {
            let adjustedPrixAchat = parseFloat(item.prixAchat);
            if (totalCostOfAllItemsBeforeTransport > 0 && fraisTransport > 0) {
                const itemShareOfTransport = (parseFloat(item.coutTotal) / totalCostOfAllItemsBeforeTransport) * fraisTransport;
                adjustedPrixAchat += (itemShareOfTransport / item.quantite);
            }
            const itemCopy = { ...item };
            delete itemCopy.commande;
            const payload = {
                ...itemCopy,
                adjustedPrixAchat: adjustedPrixAchat
            };
            if (typeAchat === 'commande') {
                payload.receivedQty = 0;
                payload.remainingQty = item.quantite;
            }
            return payload;
        });

        const approRef = dbFirestore.collection("approvisionnement").doc();

        // La mise à jour du stock reste la même dans les deux cas
        if (typeAchat !== 'commande') {

            for (const item of finalItemsForFirestore) {
                const stockQuery = await dbFirestore.collection("stock").where("name", "==", item.produit).limit(1).get();
                let stockDocRef;
                let newStockQty;

                if (stockQuery.empty) {
                    stockDocRef = dbFirestore.collection("stock").doc();
                    newStockQty = item.quantite;
                    batch.set(stockDocRef, {
                        name: item.produit,
                        category: item.category,
                        stock: newStockQty,
                        price: item.adjustedPrixAchat,
                        icon: item.category === "accessoires" ? "🎧" : "📱",
                        createdAt: serverTimestamp
                    });
                } else {
                    stockDocRef = stockQuery.docs[0].ref;
                    const stockData = stockQuery.docs[0].data();
                    const oldStock = stockData.stock || 0;
                    const oldPrice = stockData.price || 0;
                    newStockQty = oldStock + item.quantite;

                    const newAveragePrice = newStockQty > 0 ? ((oldStock * oldPrice) + (item.quantite * item.adjustedPrixAchat)) / newStockQty : item.adjustedPrixAchat;

                    batch.update(stockDocRef, {
                        stock: newStockQty,
                        price: newAveragePrice
                    });
                }

                const historyRef = stockDocRef.collection("history").doc();
                batch.set(historyRef, {
                    timestamp: serverTimestamp,
                    change: +item.quantite,
                    newStock: newStockQty,
                    type: 'approvisionnement',
                    costOfChange: item.quantite * item.adjustedPrixAchat,
                    sourceApproId: approRef.id,
                    sourceApproItemName: item.produit
                });

                if (item.category === 'telephones' && item.imeis && item.imeis.length > 0) {
                    item.imeis.forEach(imei => {
                        const imeiDocRef = stockDocRef.collection("imeis").doc(imei);
                        batch.set(imeiDocRef, {
                            status: "disponible",
                            dateEntree: serverTimestamp
                        });
                    });
                }
            }
        }

        const totalCostFromSupplier = finalItemsForFirestore.reduce((acc, item) => acc + parseFloat(item.coutTotal), 0);
        
        // Construction de l'objet d'achat
        const approData = {
            fournisseur,
            items: finalItemsForFirestore,
            timestamp: serverTimestamp,
            fraisTransport: fraisTransport,
            status: typeAchat === 'commande' ? 'commande' : 'validé',
            typeAchat: typeAchat,// On ajoute le type d'achat ici
            productNames: finalItemsForFirestore.map(it => it.produit),
            enregistreParUid: user.uid,
            enregistreParNom: user.displayName || user.email// Ajoute la liste des noms de produits
        };

        approData.totalCost = typeAchat === 'commande' ? 0 : totalCostFromSupplier;
        approData.transportCompteId = transportCompteId || null;
        if (typeAchat === 'commande') {
            const totalOrderedUnits = finalItemsForFirestore.reduce((acc, it) => acc + (parseFloat(it.quantite) || 0), 0);
            approData.orderTotalCost = totalCostFromSupplier;
            approData.receptionStats = {
                totalOrdered: totalOrderedUnits,
                totalReceived: 0,
                totalRemaining: totalOrderedUnits
            };
            approData.receivedTotalCost = 0;
            approData.commandeMeta = {
                expectedDate: commandeDatePrevue || null,
                reference: commandeReference || null,
                notes: commandeNotes || ''
            };
        } else {
            approData.receivedTotalCost = totalCostFromSupplier;
        }
        approData.paymentsDetails = [];
        approData.paymentsTotalPaid = 0;
        approData.remainingAmount = 0;
        approData.isPaid = false;
        if (typeAchat === 'depot') {
            approData.paymentMethod = 'depot';
        } else if (typeAchat === 'commande') {
            approData.paymentMethod = 'commande';
        } else {
            approData.paymentMethod = 'credit';
        }
        approData.compteId = null;

        const paymentsToRegister = [];

        if ((typeAchat === 'normal' || typeAchat === 'commande') && purchasePaymentStatus === 'yes') {
            if (!paymentStats) {
                paymentStats = validateApproPayments(false);
            }

            const paymentsFromForm = approPayments
                .map(p => {
                    const amount = parseFloat(p.montant) || 0;
                    const compteId = p.compteId || '';
                    return { amount, compteId };
                })
                .filter(p => p.amount > 0 && p.compteId);

            if (paymentsFromForm.length === 0) {
                throw new Error('Aucun paiement valide pour cet achat.');
            }

            const paymentsDetails = paymentsFromForm.map(payment => {
                const compteNom = getCompteNomById(payment.compteId);
                return {
                    compteId: payment.compteId,
                    compteNom,
                    amount: payment.amount
                };
            });

            const paidTotal = paymentStats ? paymentStats.totalPaid : paymentsDetails.reduce((sum, detail) => sum + detail.amount, 0);
            const dueTotal = paymentStats ? paymentStats.due : totalCostFromSupplier;
            const baseDue = typeAchat === 'commande'
                ? (approData.receivedTotalCost || 0)
                : dueTotal;

            approData.paymentsDetails = paymentsDetails;
            approData.paymentsTotalPaid = paidTotal;
            approData.remainingAmount = Math.max(0, baseDue - paidTotal);
            if (typeAchat === 'commande') {
                approData.isPaid = false;
                approData.paymentMethod = 'commande';
            } else {
                approData.isPaid = approData.remainingAmount <= 0;
                approData.paymentMethod = approData.isPaid ? 'paid' : 'credit';
            }

            paymentsDetails.forEach(detail => {
                paymentsToRegister.push({
                    compteId: detail.compteId,
                    amount: detail.amount,
                    compteNom: detail.compteNom
                });
            });
        } else if (typeAchat === 'normal') {
            approData.paymentMethod = 'credit';
            approData.remainingAmount = totalCostFromSupplier;
            approData.isPaid = false;
        } else if (typeAchat === 'commande') {
            approData.paymentMethod = 'commande';
            approData.remainingAmount = Math.max(0, (approData.receivedTotalCost || 0) - (approData.paymentsTotalPaid || 0));
            approData.isPaid = false;
        }
        if (typeof approData.receivedTotalCost === 'undefined') {
            approData.receivedTotalCost = typeAchat === 'commande' ? 0 : totalCostFromSupplier;
        }
        approData.netSupplierBalance = (approData.paymentsTotalPaid || 0) - (approData.receivedTotalCost || 0);

        batch.set(approRef, approData);

        if (paymentsToRegister.length > 0) {
            const paymentTimestamp = firebase.firestore.Timestamp.now();
            paymentsToRegister.forEach(payment => {
                const paymentDocRef = approRef.collection("payments").doc();
                batch.set(paymentDocRef, {
                    amount: payment.amount,
                    account: payment.compteId,
                    compteNom: payment.compteNom,
                    date: paymentTimestamp,
                    origin: 'achat_initial',
                    refApproId: approRef.id
                });
            });

            for (const payment of paymentsToRegister) {
                await enregistrerMouvementTresorerie({
                    compteId: payment.compteId,
                    type: 'paiement_fournisseur',
                    sens: 'out',
                    montant: payment.amount,
                    description: `Achat fournisseur ${fournisseur}`,
                    refId: approRef.id
                });
            }
        }


        // La gestion des frais de transport reste la même, car c'est une dépense réelle
        if (typeAchat !== 'commande' && fraisTransport > 0) {
            const transportExpenseCompteId = transportCompteId;
            const transportCompteNom = getCompteNomById(transportExpenseCompteId);
            const transportDepenseRef = dbFirestore.collection("depenses").doc();

            batch.set(transportDepenseRef, {
                montant: fraisTransport,
                description: `Frais transport achat ${fournisseur}`,
                type: "depense fonctionnelle",
                timestamp: now.getTime(),
                date: now.toISOString(),
                compteId: transportExpenseCompteId,
                compteNom: transportCompteNom,
                refId: approRef.id
            });

            await enregistrerMouvementTresorerie({
                compteId: transportExpenseCompteId,
                type: 'frais_transport_appro',
                sens: 'out',
                montant: fraisTransport,
                description: `Frais transport achat ${fournisseur}`,
                refId: approRef.id
            });
        }

        await batch.commit();

        const typeLibelle = typeAchat === 'depot'
            ? 'Dépôt fournisseur'
            : typeAchat === 'commande'
                ? 'Commande fournisseur'
                : 'Achat normal';
        alert(`Approvisionnement de type "${typeLibelle}" enregistré avec succès !`);

    } catch (error) {
        console.error("Erreur lors de la finalisation de l'approvisionnement : ", error);
        alert("Une erreur est survenue : " + error.message);
    } finally {
        currentApproItems = [];
        updatePanierApprovisionnement();

        const fournisseurField = document.getElementById("fournisseurAppro");
        if (fournisseurField) {
            fournisseurField.value = "";
        }

        const fraisTransportField = document.getElementById("fraisTransportAppro");
        if (fraisTransportField) {
            fraisTransportField.value = "";
        }

        const purchaseTypeSelect = document.getElementById("typeAchatAppro");
        if (purchaseTypeSelect) {
            purchaseTypeSelect.value = "normal";
        }

        const paymentStatusSelect = document.getElementById("purchasePaymentStatus");
        if (paymentStatusSelect) {
            paymentStatusSelect.value = 'no';
        }

        const commandeDateField = document.getElementById("commandeDatePrevue");
        if (commandeDateField) {
            commandeDateField.value = "";
        }
        const commandeReferenceField = document.getElementById("commandeReference");
        if (commandeReferenceField) {
            commandeReferenceField.value = "";
        }
        const commandeNotesField = document.getElementById("commandeNotes");
        if (commandeNotesField) {
            commandeNotesField.value = "";
        }

        resetApproPayments();
        handlePurchaseTypeChange(); // Update UI
        const currentTabAfterSave = document.getElementById('purchase-tabs');
        chargerApprovisionnements(currentTabAfterSave ? (currentTabAfterSave.value || 'all') : 'all');
        updateStockSummary();
        updateBalanceDisplay();
        hideSaleLoader();
    }
}

// Function to record a payment for a credit purchase (Placeholder)
async function recordCreditPayment(approId, outstandingAmount) {
    const paymentAmount = parseFloat(prompt(`Montant à payer pour l'achat à crédit (Dû: ${outstandingAmount.toLocaleString()} FCFA):`));

    if (isNaN(paymentAmount) || paymentAmount <= 0) {
        alert("Montant de paiement invalide.");
        return;
    }

    if (paymentAmount > outstandingAmount) {
        alert("Le montant de paiement ne peut pas dépasser le montant dû.");
        return;
    }

    const compteId = prompt("Payer depuis quel compte (caisse, momo, banque)?:");
    if (!compteId || !['caisse', 'momo', 'banque'].includes(compteId.toLowerCase())) {
        alert("Compte invalide. Veuillez entrer 'caisse', 'momo' ou 'banque'.");
        return;
    }

    try {
        const approRef = dbFirestore.collection("approvisionnement").doc(approId);
        const approDoc = await approRef.get();

        if (!approDoc.exists) {
            alert("Achat à crédit non trouvé.");
            return;
        }

        const approData = approDoc.data();
        const newRemainingAmount = approData.remainingAmount - paymentAmount;
        const newIsPaid = newRemainingAmount <= 0;

        await dbFirestore.runTransaction(async t => {
            t.update(approRef, {
                remainingAmount: newRemainingAmount,
                isPaid: newIsPaid
            });

            // Record this as a cash outflow from the selected account
            await enregistrerMouvementTresorerie({
                compteId: compteId.toLowerCase(),
                type: 'paiement_credit_appro',
                sens: 'out',
                montant: paymentAmount,
                description: `Paiement crédit achat fournisseur ${approData.fournisseur}`,
                refId: approId
            });

             // Also record as a functional expense
             const depenseRef = dbFirestore.collection("depenses").doc();
             t.set(depenseRef, {
                 montant: paymentAmount,
                 description: `Paiement crédit achat fournisseur ${approData.fournisseur}`,
                 type: "depense fonctionnelle",
                 timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                 date: new Date().toISOString(),
                 dateString: new Date().toLocaleDateString("fr-FR")
             });
        });


        alert("Paiement enregistré avec succès!");
        const tabAfterPayment = document.getElementById('purchase-tabs');
        chargerApprovisionnements(tabAfterPayment ? (tabAfterPayment.value || 'all') : 'all'); // Refresh the list
        updateBalanceDisplay(); // Update treasury display
    } catch (error) {
        console.error("Error recording credit payment:", error);
        alert("Erreur lors de l'enregistrement du paiement à crédit: " + error.message);
    }
}

  
</script>
<section id="screen-scan-dynamsoft" class="screen">
  <header>
    <button class="back-btn" onclick="annulerScan()">← Annuler</button>
    <h1>Scanner les IMEI</h1>
  </header>

  <div style="padding: 15px;">
    <div class="form-section" style="padding: 15px; margin-bottom: 10px;">
      <h2 id="scanProductNameDynamsoft" style="font-size: 18px; color: var(--primary-color);"></h2>
      <p style="text-align: center; margin-top: 5px;">
        Quantité requise : <strong id="scanTargetCountDynamsoft">0</strong> / Scannés : <strong id="scanCurrentCountDynamsoft">0</strong>
      </p>
    </div>

    <div id="scan-container" style="min-height: 100px; border-radius: 8px; display: flex; justify-content: center; align-items: center; padding: 10px;">
      </div>
    
    <p id="scanFeedbackDynamsoft" style="text-align: center; color: var(--accent-color); height: 20px; margin-top: 10px;"></p>

    <div style="display: flex; gap: 8px; margin: 15px 0; align-items: stretch;">
      <textarea id="manualImeiInputDynamsoft" placeholder="Coller plusieurs IMEI (séparés par des retours à la ligne ou des espaces)" rows="3" style="flex-grow: 1; padding: 10px; border-radius: 5px; border: 1px solid #ccc; resize: vertical;"></textarea>
      <div style="display: flex; flex-direction: column; gap: 8px;">
        <button type="button" class="btn-modern secondary" onclick="ajouterListeImeisDynamsoft()" style="white-space: nowrap;">
          <i data-lucide="clipboard-plus"></i> Ajouter la liste
        </button>
        <button type="button" class="btn-modern" onclick="ajouterImeiManuellementDynamsoft()" style="white-space: nowrap;">
          <i data-lucide="plus"></i> Ajouter 1 IMEI
        </button>
      </div>
    </div>

    <hr style="margin: 15px 0;">

    <h4>IMEI à Ajouter :</h4>
    <ul id="scannedImeiListDynamsoft" style="list-style-type: none; padding: 10px; max-height: 120px; overflow-y: auto; background: #f9f9f9; border-radius: 5px;">
    </ul>

    <button id="btnConfirmerScanDynamsoft" class="btn-modern" onclick="confirmerScanApprovisionnementDynamsoft()" style="margin-top: 15px;">
      <i data-lucide="check-circle"></i> Confirmer et Ajouter au Panier
    </button>
  </div>
</section>

<style>
  #screen-commande-reception {
      background: #f5f7fa;
      padding: 10px;
  }
  #screen-commande-reception header {
      display: flex;
      align-items: center;
      gap: 12px;
  }
  #screen-commande-reception h1 {
      font-size: 20px;
      margin: 0;
      color: var(--primary-color);
  }
  .reception-content {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 8px 4px 60px;
  }
  .reception-card {
      background: var(--white);
      border-radius: var(--border-radius);
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      padding: 16px;
  }
  .reception-card h2 {
      margin-top: 0;
      font-size: 18px;
      color: #2e3748;
  }
  .reception-summary p {
      margin: 4px 0;
      color: #4a4a4a;
  }
  .reception-items {
      display: flex;
      flex-direction: column;
      gap: 12px;
  }
  .reception-item {
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 12px;
      background: #fafafa;
  }
  .reception-item h3 {
      margin: 0 0 6px;
      font-size: 16px;
      color: #1f2933;
  }
  .reception-item-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 13px;
      color: #5f6b7a;
      margin-bottom: 8px;
  }
  .reception-item-inputs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin-bottom: 8px;
  }
  .reception-item-inputs label {
      font-size: 13px;
      color: #444;
      display: block;
      margin-bottom: 4px;
  }
  .reception-item-inputs input {
      width: 100%;
      padding: 8px;
      border: 1px solid #d0d5dd;
      border-radius: 8px;
      font-size: 15px;
  }
  .reception-item-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
  }
  .reception-item-actions .btn-modern {
      padding: 8px 12px;
  }
  .reception-item-imeis {
      font-size: 12px;
      color: #5f6b7a;
  }
  .reception-item-imeis button {
      background: none;
      border: none;
      color: var(--primary-color);
      cursor: pointer;
      font-size: 12px;
      padding: 0;
  }
  .reception-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
  }
  .reception-total {
      font-size: 16px;
      color: #1f2933;
  }
  #commandeReceptionNotes {
      width: 100%;
      padding: 10px;
      border: 1px solid #d0d5dd;
      border-radius: 8px;
      font-size: 15px;
      resize: vertical;
  }
  #screen-commande-reception select {
      width: 100%;
      padding: 10px;
      border: 1px solid #d0d5dd;
      border-radius: 8px;
      background-color: #fff;
      font-size: 15px;
  }
  #screen-commande-reception select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(56, 128, 255, 0.2);
  }
</style>

<section id="screen-fournisseur-balance" class="screen">
  <header>
    <button class="back-btn" onclick="window.location.hash='approvisionnement-historique'">
      <i data-lucide="arrow-left"></i> Retour
    </button>
    <h1 id="supplierBalanceTitle">Fournisseur</h1>
  </header>

  <div class="supplier-balance-content">
    <div class="balance-summary-grid">
      <div class="balance-card">
        <span class="label">Total payé</span>
        <span class="value" id="supplierBalanceTotalPaid">0 FCFA</span>
      </div>
      <div class="balance-card">
        <span class="label">Valeur reçue</span>
        <span class="value" id="supplierBalanceReceived">0 FCFA</span>
      </div>
      <div class="balance-card">
        <span class="label">À recevoir (valeur)</span>
        <span class="value" id="supplierBalanceToReceive">0 FCFA</span>
      </div>
      <div class="balance-card positive">
        <span class="label">Avance chez le fournisseur</span>
        <span class="value" id="supplierBalanceAdvance">0 FCFA</span>
      </div>
      <div class="balance-card negative">
        <span class="label">Solde à payer</span>
        <span class="value" id="supplierBalanceDue">0 FCFA</span>
      </div>
    </div>

    <div class="balance-details-card">
      <h2>Enregistrer un paiement</h2>
      <form id="supplierPaymentForm" onsubmit="event.preventDefault(); enregistrerPaiementFournisseur();">
        <label for="supplierPaymentAmount">Montant</label>
        <input type="number" id="supplierPaymentAmount" min="0" step="100" placeholder="0" />

        <label for="supplierPaymentAccount">Compte de trésorerie</label>
        <select id="supplierPaymentAccount">
          <option value="">-- Sélectionner un compte --</option>
        </select>

        <button type="submit" class="btn-modern">
          <i data-lucide="wallet"></i> Enregistrer le paiement
        </button>
      </form>
      <p id="supplierPaymentWarning" class="payment-warning"></p>
    </div>

    <div class="balance-details-card">
      <h2>Commandes & réceptions</h2>
      <div id="supplierBalanceOrders" class="orders-list">
        <p class="placeholder">Chargement...</p>
      </div>
    </div>
  </div>
</section>

<style>
  #screen-fournisseur-balance {
      background: #f5f7fa;
      padding: 10px;
  }
  #screen-fournisseur-balance header {
      display: flex;
      align-items: center;
      gap: 12px;
  }
  #screen-fournisseur-balance h1 {
      font-size: 20px;
      margin: 0;
      color: var(--primary-color);
  }
  .supplier-balance-content {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding-bottom: 60px;
  }
  .balance-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
  }
  .balance-card {
      background: var(--white);
      border-radius: var(--border-radius);
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
  }
  .balance-card .label {
      font-size: 13px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.02em;
  }
  .balance-card .value {
      font-size: 18px;
      font-weight: 600;
      color: #1f2933;
  }
  .balance-card.positive .value {
      color: #2e7d32;
  }
  .balance-card.negative .value {
      color: #f04141;
  }
  .balance-details-card {
      background: var(--white);
      border-radius: var(--border-radius);
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      padding: 16px;
  }
  .balance-details-card h2 {
      margin-top: 0;
      font-size: 18px;
      color: #1f2933;
  }
  .balance-details-card form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
  }
  .balance-details-card form label {
      font-size: 13px;
      font-weight: 600;
      color: #475569;
  }
  .balance-details-card form input,
  .balance-details-card form select {
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      font-size: 15px;
      background: #f8fafc;
  }
  .balance-details-card form input:focus,
  .balance-details-card form select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(56, 128, 255, 0.2);
  }
  .balance-details-card .btn-modern {
      align-self: flex-start;
  }
  .payment-warning {
      color: #b91c1c;
      font-size: 13px;
      margin-top: 6px;
  }
  .orders-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
  }
  .orders-list .placeholder {
      color: #6b7280;
      text-align: center;
      margin: 0;
  }
  .supplier-order-card {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px;
      background: #fafafa;
      display: flex;
      flex-direction: column;
      gap: 6px;
  }
  .supplier-order-card header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
  }
  .supplier-order-card header h3 {
      margin: 0;
      font-size: 16px;
      color: #111827;
  }
  .supplier-order-card header span {
      font-size: 13px;
      color: #6b7280;
  }
  .supplier-order-card .order-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      font-size: 13px;
      color: #4b5563;
  }
  .supplier-order-card .order-amounts {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
  }
  .supplier-order-card .order-amounts span strong {
      color: #111827;
  }
  .supplier-order-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #e0f2fe;
      color: #0369a1;
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
  }
  .supplier-order-chip.partial {
      background: #ede9fe;
      color: #5b21b6;
  }
  .supplier-order-chip.completed {
      background: #dcfce7;
      color: #166534;
  }
</style>

<section id="screen-dettes-fournisseurs" class="screen">
  <header>
    <button class="back-btn" onclick="window.location.hash='menu'">
      <i data-lucide="arrow-left"></i> Retour
    </button>
    <h1>Dettes fournisseurs</h1>
  </header>

  <div class="dettes-container">
    <div class="dettes-summary-grid">
      <div class="dettes-summary-card due">
        <span class="label">Total à payer</span>
        <strong id="supplierDebtsTotalDue">0 FCFA</strong>
        <small id="supplierDebtsDueSuppliers">0 fournisseur(s)</small>
      </div>
      <div class="dettes-summary-card advance">
        <span class="label">Avances fournisseurs</span>
        <strong id="supplierDebtsTotalAdvance">0 FCFA</strong>
        <small id="supplierDebtsAdvanceSuppliers">0 fournisseur(s)</small>
      </div>
    </div>

    <div class="dettes-toolbar">
      <div class="search-field">
        <i data-lucide="search"></i>
        <input type="search" id="supplierDebtSearch" placeholder="Rechercher un fournisseur..." autocomplete="off" />
      </div>
    </div>

    <div id="supplierDebtsList" class="dettes-list">
      <p class="placeholder">Chargement des dettes fournisseurs...</p>
    </div>
  </div>
</section>

<style>
  #screen-dettes-fournisseurs {
      background: #f5f7fa;
      padding: 12px;
  }
  #screen-dettes-fournisseurs header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
  }
  #screen-dettes-fournisseurs h1 {
      font-size: 22px;
      margin: 0;
      color: var(--primary-color);
  }
  .dettes-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
  }
  .dettes-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
  }
  .dettes-summary-card {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
  }
  .dettes-summary-card .label {
      font-size: 13px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.04em;
  }
  .dettes-summary-card strong {
      font-size: 20px;
      color: #0f172a;
  }
  .dettes-summary-card small {
      font-size: 13px;
      color: #475569;
  }
  .dettes-summary-card.due strong {
      color: #b91c1c;
  }
  .dettes-summary-card.advance strong {
      color: #166534;
  }
  .dettes-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
  }
  .dettes-toolbar .search-field {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
      background: #fff;
      border-radius: 999px;
      padding: 8px 14px;
      box-shadow: inset 0 0 0 1px #e5e7eb;
  }
  .dettes-toolbar .search-field i {
      color: #64748b;
  }
  .dettes-toolbar input[type="search"] {
      border: none;
      outline: none;
      width: 100%;
      font-size: 15px;
      background: transparent;
      color: #0f172a;
  }
  .dettes-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
  }
  .dettes-list .placeholder {
      text-align: center;
      color: #6b7280;
      margin: 24px 0;
  }
  .debt-item {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
  }
  .debt-item.due {
      border-left: 4px solid #b91c1c;
  }
  .debt-item.advance {
      border-left: 4px solid #166534;
  }
  .debt-item header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
  }
  .debt-item h3 {
      margin: 0;
      font-size: 18px;
      color: #0f172a;
  }
  .debt-item p {
      margin: 0;
      font-size: 13px;
      color: #64748b;
  }
  .debt-badges {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
  }
  .debt-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-weight: 600;
  }
  .debt-badge.due {
      background: #fee2e2;
      color: #b91c1c;
  }
  .debt-badge.advance {
      background: #dcfce7;
      color: #166534;
  }
  .debt-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 8px;
      font-size: 13px;
      color: #475569;
  }
  .debt-stats span strong {
      color: #0f172a;
  }
  .debt-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
  }
  .debt-actions .btn-modern {
      padding: 10px 14px;
      font-size: 14px;
  }
</style>

<section id="screen-depots-fournisseurs" class="screen">
  <ion-app>
    <div id="fournisseurs-hub-list">
      <ion-header class="ion-no-border">
        <ion-toolbar>
          <ion-buttons slot="start">
            <ion-button onclick="window.location.hash='menu'">
              <ion-icon name="arrow-back-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
          <ion-title>Hub Fournisseurs</ion-title>
          <ion-buttons slot="end">
            <ion-button>
              <ion-icon name="search-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content fullscreen>
        <ion-list id="fournisseursHubListContainer" lines="full">
          <ion-item>
            <ion-label style="text-align:center; padding: 20px; color: #888;">
              <ion-spinner name="crescent"></ion-spinner><br>
              Analyse des données fournisseurs...
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-content>
    </div>

    <div id="fournisseur-detail-view" style="display: none;">
      <ion-header class="ion-no-border">
        <ion-toolbar>
          <ion-buttons slot="start">
            <ion-button id="backToHubListBtn">
              <ion-icon name="arrow-back-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
          <ion-title id="supplierDetailNameHeader">Détails</ion-title>
        </ion-toolbar>
      </ion-header>

      <ion-content fullscreen>
        <ion-segment value="resume" id="supplier-detail-tabs">
          <ion-segment-button value="resume">
            <ion-label>Résumé</ion-label>
          </ion-segment-button>
          <ion-segment-button value="stock">
            <ion-label>Stock Fourni</ion-label>
          </ion-segment-button>
          <ion-segment-button value="history">
            <ion-label>Historique</ion-label>
          </ion-segment-button>
        </ion-segment>

        <div id="supplier-detail-content" class="ion-padding">
          </div>
      </ion-content>
    </div>
  </ion-app>

  <style>
    /* Add this or adjust your existing ion-content style for this screen */
    #screen-depots-fournisseurs ion-content {
      /* Ensure this specific screen's content has enough bottom padding */
      /* The bottom-nav-pro is ~60px tall, add a bit more for safe measure */
      --padding-bottom: 80px; /* Adjust as needed */
      /* Also ensure fullscreen is handled, Ionic usually does this well */
      padding-bottom: calc(var(--ion-safe-area-bottom) + 80px) !important; /* Combines with safe area */
    }

    /* Other styles specific to screen-depots-fournisseurs can remain here */
  </style>

  <script>
 // Variable globale pour stocker les données du fournisseur actuellement consulté
let currentSupplierDetailData = null;
let currentSupplierBalanceData = null;
let currentSupplierDebts = [];
let supplierDebtSearchInitialized = false;
let pendingSupplierPaymentFocus = null;

/**
 * Gère l'affichage principal du Hub Dépôts.
 */
function setupSupplierHub() {
    const listContainer = document.getElementById('fournisseurs-hub-list');
    const detailContainer = document.getElementById('fournisseur-detail-view');

    if (!listContainer || !detailContainer) return;

    // Affiche la liste et cache les détails par défaut
    listContainer.style.display = 'block';
    detailContainer.style.display = 'none';

    chargerHubDepots(); // La fonction est renommée pour plus de clarté

    // Logique du bouton retour et des onglets
    document.getElementById('backToHubListBtn').addEventListener('click', () => {
        listContainer.style.display = 'block';
        detailContainer.style.display = 'none';
    });

    const tabs = document.getElementById('supplier-detail-tabs');
    tabs.addEventListener('ionChange', (event) => {
        if (currentSupplierDetailData) {
            renderSupplierDetailContent(event.detail.value, currentSupplierDetailData);
        }
    });
}

/**
 * Récupère et agrège les données des fournisseurs ayant des dépôts actifs.
 */
async function chargerHubDepots() {
    const listContainer = document.getElementById("fournisseursHubListContainer");
    listContainer.innerHTML = `<ion-item><ion-label style="text-align:center;"><ion-spinner name="crescent"></ion-spinner></ion-label></ion-item>`;

    try {
        const suppliersWithDeposits = {};

        // 1. Récupérer UNIQUEMENT les approvisionnements de type 'dépôt'
        const approSnapshot = await dbFirestore.collection("approvisionnement")
            .where('typeAchat', '==', 'depot')
            .where('status', '!=', 'annulé')
            .get();

        approSnapshot.forEach(doc => {
            const appro = { id: doc.id, ...doc.data() };
            const name = appro.fournisseur || 'Inconnu';

            if (!suppliersWithDeposits[name]) {
                suppliersWithDeposits[name] = { name: name, initialValue: 0, soldValue: 0, procurements: [] };
            }
            suppliersWithDeposits[name].initialValue += parseFloat(appro.totalCost || 0);
            suppliersWithDeposits[name].procurements.push(appro);
        });

        // 2. Récupérer les dettes de consignation pour calculer la valeur vendue
        const dettesSnapshot = await dbFirestore.collection("dettesConsignation").get();
        dettesSnapshot.forEach(doc => {
            const dette = doc.data();
            const name = dette.fournisseur;
            if (suppliersWithDeposits[name]) {
                // On somme la valeur de tous les articles vendus (payés ou non)
                suppliersWithDeposits[name].soldValue += parseFloat(dette.montantDu || 0);
            }
        });

        // Vider la liste
        listContainer.innerHTML = "";
        
        // Filtrer pour ne garder que les fournisseurs avec un stock de dépôt restant
        const activeDepositSuppliers = Object.values(suppliersWithDeposits)
            .filter(s => (s.initialValue - s.soldValue) > 1); // Garde une marge pour les erreurs de calcul

        if (activeDepositSuppliers.length === 0) {
            listContainer.innerHTML = `<ion-item><ion-label style="text-align:center; color: #888;">Aucun dépôt fournisseur actif trouvé.</ion-label></ion-item>`;
            return;
        }

        // 3. Afficher chaque fournisseur
        for (const data of activeDepositSuppliers) {
            const remainingValue = data.initialValue - data.soldValue;
            const initials = data.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            const avatarBgColor = getAvatarColor(data.name);

            const ionItem = document.createElement('ion-item');
            ionItem.button = true;
            ionItem.innerHTML = `
                <div class="avatar-circle" slot="start" style="background-color: ${avatarBgColor};">${initials}</div>
                <ion-label>
                    <h2>${data.name}</h2>
                    <p>Dépôt initial: ${data.initialValue.toLocaleString('fr-FR')} FCFA</p>
                </ion-label>
                <div class="right-info" slot="end">
                    <div class="total-amount" style="color: #28a745;">
                        ${remainingValue.toLocaleString('fr-FR')} FCFA
                    </div>
                    <div class="payment-method">STOCK RESTANT</div>
                </div>
            `;
            ionItem.addEventListener('click', () => afficherVueDetailleeFournisseur(data));
            listContainer.appendChild(ionItem);
        }

    } catch (error) {
        console.error("Erreur chargement Hub Dépôts:", error);
        listContainer.innerHTML = `<ion-item><ion-label style="color:red; text-align:center;">Erreur de chargement.</ion-label></ion-item>`;
    }
}

/**
 * Affiche la vue détaillée pour un fournisseur spécifique.
 */
function afficherVueDetailleeFournisseur(supplierData) {
    currentSupplierDetailData = supplierData;
    document.getElementById('fournisseurs-hub-list').style.display = 'none';
    document.getElementById('fournisseur-detail-view').style.display = 'block';
    document.getElementById('supplierDetailNameHeader').textContent = `Dépôt - ${supplierData.name}`;

    document.getElementById('supplier-detail-tabs').value = 'resume';
    renderSupplierDetailContent('resume', supplierData);
}

/**
 * Génère le contenu HTML pour l'onglet sélectionné dans la vue de détail.
 */
/**
 * Génère le contenu HTML pour l'onglet sélectionné dans la vue de détail.
 * VERSION MISE À JOUR pour inclure les ventes dans l'historique.
 */
/**
 * Génère le contenu HTML pour l'onglet sélectionné dans la vue de détail.
 * VERSION AVEC DÉBOGAGE pour vérifier pourquoi les ventes ne s'affichent pas.
 */
async function renderSupplierDetailContent(tabName, supplierData) {
    const contentEl = document.getElementById('supplier-detail-content');
    contentEl.innerHTML = `<div class="ion-text-center ion-padding"><ion-spinner name="crescent"></ion-spinner></div>`;

    let html = '';
    switch (tabName) {
        // ... les cas 'resume' et 'stock' restent inchangés ...
        case 'resume':
            const initialValue = supplierData.initialValue || 0;
            const soldValue = supplierData.soldValue || 0;
            const remainingValue = initialValue - soldValue;

            html = `
                <ion-card>
                    <ion-card-header><ion-card-title>Résumé du Dépôt</ion-card-title></ion-card-header>
                    <ion-card-content>
                        <ion-list lines="none">
                            <ion-item>
                                <ion-label>Valeur initiale totale déposée:</ion-label>
                                <ion-note slot="end">${initialValue.toLocaleString('fr-FR')} FCFA</ion-note>
                            </ion-item>
                            <ion-item>
                                <ion-label>Valeur des articles vendus (dette):</ion-label>
                                <ion-note slot="end" color="danger">${soldValue.toLocaleString('fr-FR')} FCFA</ion-note>
                            </ion-item>
                            <ion-item>
                                <ion-label><h2>Valeur du stock restant:</h2></ion-label>
                                <ion-note slot="end" color="primary"><h2>${remainingValue.toLocaleString('fr-FR')} FCFA</h2></ion-note>
                            </ion-item>
                        </ion-list>
                    </ion-card-content>
                </ion-card>
            `;
            contentEl.innerHTML = html;
            break;

        case 'stock':
             html = `<ion-card>
                        <ion-card-header><ion-card-title>Articles en Dépôt (Liste Initiale)</ion-card-title></ion-card-header>
                        <ion-card-content><ion-list lines="full">`;
            supplierData.procurements.forEach(appro => {
                 (appro.items || []).forEach(item => {
                    html += `<ion-item><ion-label>${item.produit}</ion-label><ion-note slot="end">Qté initial: ${item.quantite}</ion-note></ion-item>`;
                });
            });
            html += `</ion-list></ion-card-content></ion-card>`;
            contentEl.innerHTML = html;
            break;

        case 'history':
            try {
                // --- DÉBUT DU DÉBOGAGE ---
                console.log("Chargement de l'historique pour le fournisseur :", supplierData.name);
                // --- FIN DU DÉBOGAGE ---

                let historyEvents = [];

                supplierData.procurements.forEach(appro => {
                    historyEvents.push({
                        type: 'depot',
                        timestamp: appro.timestamp.toDate(),
                        data: appro
                    });
                });

                const dettesSnapshot = await dbFirestore.collection("dettesConsignation")
                    .where("fournisseur", "==", supplierData.name)
                    .get();
                
                // --- DÉBUT DU DÉBOGAGE ---
                console.log(`Résultat de la requête 'dettesConsignation': ${dettesSnapshot.size} document(s) trouvé(s).`);
                if (dettesSnapshot.size > 0) {
                    dettesSnapshot.forEach(doc => {
                        console.log("  -> Vente trouvée :", doc.data());
                    });
                }
                // --- FIN DU DÉBOGAGE ---

                dettesSnapshot.forEach(doc => {
                    const dette = doc.data();
                    historyEvents.push({
                        type: 'vente',
                        timestamp: dette.dateVente.toDate(),
                        data: dette
                    });
                });

                historyEvents.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());
                
                // --- DÉBUT DU DÉBOGAGE ---
                console.log("Historique complet avant affichage :", historyEvents);
                // --- FIN DU DÉBOGAGE ---

                html = `<ion-card>
                            <ion-card-header><ion-card-title>Historique des Mouvements</ion-card-title></ion-card-header>
                            <ion-card-content><ion-list>`;

                if (historyEvents.length === 0) {
                    html += `<ion-item><ion-label class="ion-text-center">Aucun mouvement pour ce fournisseur.</ion-label></ion-item>`;
                } else {
                    historyEvents.forEach(event => {
                        const eventDate = event.timestamp.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' });
                        if (event.type === 'depot') {
                            html += `
                                <ion-item>
                                    <ion-icon name="arrow-down-circle-outline" slot="start" color="primary"></ion-icon>
                                    <ion-label>
                                        <h2>Dépôt du ${eventDate}</h2>
                                        <p>Total: ${parseFloat(event.data.totalCost || 0).toLocaleString('fr-FR')} FCFA</p>
                                        <p>${(event.data.items || []).map(i => i.quantite + 'x ' + i.produit).join(', ')}</p>
                                    </ion-label>
                                </ion-item>
                            `;
                        } else {
                            html += `
                                <ion-item>
                                    <ion-icon name="arrow-up-circle-outline" slot="start" color="danger"></ion-icon>
                                    <ion-label>
                                        <h2>Vente du ${eventDate}</h2>
                                        <p>Article: ${event.data.quantite}x ${event.data.produit}</p>
                                        <p>Dette créée: <strong>${parseFloat(event.data.montantDu || 0).toLocaleString('fr-FR')} FCFA</strong></p>
                                    </ion-label>
                                </ion-item>
                            `;
                        }
                    });
                }
                
                html += `</ion-list></ion-card-content></ion-card>`;
                contentEl.innerHTML = html;

            } catch (error) {
                console.error("Erreur lors de la construction de l'historique :", error);
                contentEl.innerHTML = `<ion-card><ion-card-content class="ion-text-center" color="danger">Erreur de chargement de l'historique.</ion-card-content></ion-card>`;
            }
            break;
    }
}
  </script>
</section>
<script>
/* ====================================================================
   LOGIQUE DE SCAN - VERSION FINALE, FIDÈLE AU HELLO WORLD
   ==================================================================== */

// --- Variables globales pour le scan ---
let currentApproItemForScan = null;
let tempScannedImeis = [];

// --- 1. Fonction principale pour démarrer le processus ---
function lancerScanDynamsoft(item, options = {}) {
  scanUsageMode = options.mode || 'appro';
  currentReceptionScanIndex = typeof options.receptionIndex === 'number' ? options.receptionIndex : null;
  const targetQuantity = options.quantiteCible != null ? options.quantiteCible : item.quantite;
  currentApproItemForScan = { ...item, quantite: targetQuantity };
  tempScannedImeis = [];

  // Mettre à jour l'interface
  document.getElementById('scanProductNameDynamsoft').textContent = item.produit;
  document.getElementById('scanTargetCountDynamsoft').textContent = item.quantite;
  document.getElementById('scanCurrentCountDynamsoft').textContent = '0';
  document.getElementById('scannedImeiListDynamsoft').innerHTML = '';
  document.getElementById('manualImeiInputDynamsoft').value = '';
  document.getElementById('btnConfirmerScanDynamsoft').disabled = true;
  setupManualImeiInputListeners();

  // Naviguer vers le nouvel écran de scan
  window.location.hash = 'scan-dynamsoft';

  // Afficher le bouton pour lancer le premier scan
  afficherBoutonDeScan();
  refreshLucideIcons(); // Pour l'icône dans le bouton de saisie manuelle
}

function lancerScanDynamsoftReception(item, index) {
  if (!item || typeof index !== 'number') {
      return;
  }
  lancerScanDynamsoft(
      {
          produit: item.produit,
          quantite: item.restant,
          category: item.category || 'telephones'
      },
      { mode: 'reception', receptionIndex: index, quantiteCible: item.restant }
  );
}

// --- 2. Affiche le bouton "Scanner le prochain IMEI" ---
function afficherBoutonDeScan() {
    updateEtatScanDynamsoft(true);
}

function updateEtatScanDynamsoft(promptNext = true) {
    if (!currentApproItemForScan) {
        return;
    }
    const targetCount = Number(currentApproItemForScan.quantite) || 0;
    const currentCount = tempScannedImeis.length;
    const remaining = Math.max(targetCount - currentCount, 0);
    const container = document.getElementById('scan-container');
    const feedbackEl = document.getElementById('scanFeedbackDynamsoft');
    const confirmBtn = document.getElementById('btnConfirmerScanDynamsoft');

    if (confirmBtn) {
        confirmBtn.disabled = !(currentCount === targetCount && targetCount > 0);
    }

    if (currentCount === targetCount && targetCount > 0) {
        if (feedbackEl) {
            feedbackEl.textContent = "Tous les IMEI ont été ajoutés !";
        }
        if (container) {
            container.innerHTML = '<p style="color: green; font-weight: bold;">Terminé ! Vous pouvez confirmer.</p>';
        }
        return;
    }

    if (feedbackEl) {
        feedbackEl.textContent = promptNext
            ? 'Prêt pour le prochain scan.'
            : (remaining > 0 ? `${remaining} IMEI restant(s) à ajouter.` : '');
    }

    if (promptNext && container) {
        container.innerHTML = `<button class="btn-modern" onclick="demarrerUnScan()">Scanner IMEI (${remaining} restant(s))</button>`;
    }
}

// --- 3. Démarre UN SEUL scan (LOGIQUE HELLO WORLD EXACTE) ---
function demarrerUnScan() {
    // On vide le conteneur pour que le scanner puisse s'y attacher
    document.getElementById('scan-container').innerHTML = '';
    document.getElementById('scanFeedbackDynamsoft').textContent = 'Lancement de la caméra...';
    
    // Configuration de l'instance du scanner
    let config = {
        license: "DLS2eyJoYW5kc2hha2VDb2RlIjoiMTA0MTIyNDk4LVRYbFhaV0pRY205cSIsIm1haW5TZXJ2ZXJVUkwiOiJodHRwczovL21kbHMuZHluYW1zb2Z0b25saW5lLmNvbSIsIm9yZ2FuaXphdGlvbklEIjoiMTA0MTIyNDk4Iiwic3RhbmRieVNlcnZlclVSTCI6Imh0dHBzOi8vc2Rscy5keW5hbXNvZnRvbmxpbmUuY29tIiwiY2hlY2tDb2RlIjotMTYyMTI2MTU4OH0=",
        container: "#scan-container", // On dit au scanner de s'afficher dans notre div
    };

    // Création d'une nouvelle instance, comme dans l'exemple
    const barcodeScanner = new Dynamsoft.BarcodeScanner(config);

    // Lancement du scanner, comme dans l'exemple
    barcodeScanner.launch().then((result) => {
        // Le scanner a terminé, on traite le résultat
        if (result.barcodeResults.length > 0) {
            console.log(result.barcodeResults[0]);
            processImei(result.barcodeResults[0].text);
        } else {
            showToast("Scan annulé ou aucun code-barres trouvé.");
            // Si on n'a rien trouvé, on affiche de nouveau le bouton pour réessayer
            afficherBoutonDeScan();
        }
    }).catch((error) => {
        console.error(error);
        alert("Erreur: " + error.message);
        // En cas d'erreur, on affiche de nouveau le bouton
        afficherBoutonDeScan();
    });
}


// --- 4. Fonction qui traite chaque IMEI (logique métier) ---
function processImei(rawInput, options = {}) {
  const { promptNext = true, silent = false } = options;
  if (!currentApproItemForScan) {
    return { status: 'no-context' };
  }

  const value = typeof rawInput === 'string' ? rawInput : String(rawInput || '');
  const cleaned = value.replace(/\D/g, '').slice(0, 15);
  const targetCount = Number(currentApproItemForScan.quantite) || 0;

  if (cleaned.length !== 15) {
    if (!silent) {
      showToast("IMEI invalide.");
    }
    updateEtatScanDynamsoft(promptNext);
    return { status: 'invalid', imei: cleaned };
  }

  if (tempScannedImeis.includes(cleaned)) {
    if (!silent) {
      showToast("IMEI déjà scanné.");
    }
    updateEtatScanDynamsoft(promptNext);
    return { status: 'duplicate', imei: cleaned };
  }

  if (tempScannedImeis.length >= targetCount) {
    if (!silent) {
      showToast("Quantité requise déjà atteinte.");
    }
    updateEtatScanDynamsoft(false);
    return { status: 'full', imei: cleaned };
  }

  tempScannedImeis.push(cleaned);

  const list = document.getElementById('scannedImeiListDynamsoft');
  if (list) {
    const listItem = document.createElement('li');
    listItem.textContent = cleaned;
    list.appendChild(listItem);
  }
  const countEl = document.getElementById('scanCurrentCountDynamsoft');
  if (countEl) {
    countEl.textContent = tempScannedImeis.length;
  }
  if (!silent) {
    showToast(`IMEI ${cleaned} ajouté !`);
    if (typeof navigator !== 'undefined' && navigator.vibrate) {
      navigator.vibrate(100);
    }
  }

  updateEtatScanDynamsoft(promptNext);

  return { status: 'added', imei: cleaned };
}

// --- 5. Fonctions des boutons de l'interface (confirm, manual, cancel) ---
function ajouterImeiManuellementDynamsoft() {
  const input = document.getElementById('manualImeiInputDynamsoft');
  if (!input) return;

  const imei = input.value.trim();
  if (!imei) {
    showToast("Saisissez ou collez au moins un IMEI.");
    return;
  }

  const result = processImei(imei, { promptNext: true, silent: false });
  if (result && result.status === 'added') {
    input.value = '';
  }
}

function ajouterListeImeisDynamsoft() {
  const textarea = document.getElementById('manualImeiInputDynamsoft');
  if (!textarea) return;

  const rawText = textarea.value || '';
  if (!rawText.trim()) {
    showToast("Collez vos IMEI avant d'ajouter la liste.");
    return;
  }

  const stats = traiterListeImeisColles(rawText);
  afficherResumeAjoutImeis(stats);
  if (stats.added > 0) {
    textarea.value = '';
  }
}

function traiterListeImeisColles(rawText) {
  const stats = {
    added: 0,
    duplicates: 0,
    invalid: 0,
    overflow: 0
  };

  if (!currentApproItemForScan || !rawText) {
    return stats;
  }

  const sequences = rawText.match(/\d+/g) || [];
  if (!sequences.length) {
    updateEtatScanDynamsoft(false);
    return stats;
  }

  const targetCount = Number(currentApproItemForScan.quantite) || 0;
  let stopProcessing = false;

  for (const sequence of sequences) {
    if (stopProcessing) {
      break;
    }
    if (sequence.length < 12) {
      continue;
    }
    const { chunks, leftover } = decouperSequenceEnImeis(sequence);
    if (!chunks.length) {
      if (leftover) {
        stats.invalid += 1;
      }
      continue;
    }

    for (const chunk of chunks) {
      if (stopProcessing || tempScannedImeis.length >= targetCount) {
        stats.overflow += 1;
        stopProcessing = true;
        break;
      }
      const result = processImei(chunk, { promptNext: false, silent: true });
      switch (result.status) {
        case 'added':
          stats.added += 1;
          break;
        case 'duplicate':
          stats.duplicates += 1;
          break;
        case 'invalid':
          stats.invalid += 1;
          break;
        case 'full':
          stats.overflow += 1;
          stopProcessing = true;
          break;
        default:
          break;
      }
    }

    if (leftover && !stopProcessing) {
      stats.invalid += 1;
    }
  }

  updateEtatScanDynamsoft(false);
  return stats;
}

function decouperSequenceEnImeis(sequence) {
  const digits = sequence.replace(/\D/g, '');
  if (digits.length < 15) {
    return { chunks: [], leftover: digits.length > 0 };
  }

  const chunks = [];
  for (let i = 0; i + 15 <= digits.length; i += 15) {
    const chunk = digits.slice(i, i + 15);
    if (chunk.length === 15) {
      chunks.push(chunk);
    }
  }

  const leftover = digits.length % 15 !== 0;
  return { chunks, leftover };
}

function afficherResumeAjoutImeis(stats) {
  if (!stats) return;
  const parts = [];
  if (stats.added) parts.push(`${stats.added} IMEI ajouté(s)`);
  if (stats.duplicates) parts.push(`${stats.duplicates} doublon(s) ignoré(s)`);
  if (stats.overflow) parts.push(`${stats.overflow} au-delà de la quantité`);
  if (stats.invalid) parts.push(`${stats.invalid} entrée(s) invalide(s)`);

  const message = parts.length ? parts.join(' · ') : "Aucun IMEI détecté.";
  showToast(message);
  const allAdded = currentApproItemForScan && tempScannedImeis.length === Number(currentApproItemForScan.quantite || 0);
  if (!allAdded) {
    const feedbackEl = document.getElementById('scanFeedbackDynamsoft');
    if (feedbackEl) {
      feedbackEl.textContent = message;
    }
  }
}

function setupManualImeiInputListeners() {
  const textarea = document.getElementById('manualImeiInputDynamsoft');
  if (!textarea || textarea.dataset.bulkListenerAttached === 'true') {
    return;
  }
  textarea.addEventListener('paste', handleImeiTextareaPaste);
  textarea.dataset.bulkListenerAttached = 'true';
}

function handleImeiTextareaPaste(event) {
  const textarea = event.currentTarget;
  setTimeout(() => {
    if (!textarea.value.trim()) {
      return;
    }
    const stats = traiterListeImeisColles(textarea.value);
    if (stats.added || stats.duplicates || stats.invalid || stats.overflow) {
      afficherResumeAjoutImeis(stats);
      if (stats.added > 0) {
        textarea.value = '';
      }
    }
  }, 0);
}

document.addEventListener('DOMContentLoaded', setupManualImeiInputListeners);

function ouvrirClotureVendeurDepuisHistorique() {
  const dateInput = document.getElementById('filterHistoryDate');
  const vendorSelect = document.getElementById('filterSalesByUser');
  const dateValue = dateInput && dateInput.value ? dateInput.value : '';
  const vendorValue = vendorSelect && vendorSelect.value && vendorSelect.value !== 'all'
    ? vendorSelect.value
    : '';
  if (dateValue) {
    clotureVendeurState.date = dateValue;
  }
  if (vendorValue) {
    clotureVendeurState.vendeur = vendorValue;
  }
  window.location.hash = 'cloture-vendeur';
}

async function initClotureVendeurScreen() {
  const dateInput = document.getElementById('clotureVendeurDate');
  const selectEl = document.getElementById('clotureVendeurSelect');
  if (!dateInput || !selectEl) {
    return;
  }
  const context = getClotureUserContext();

  if (!clotureVendeurState.listenersReady) {
    dateInput.addEventListener('change', () => {
      clotureVendeurState.date = dateInput.value;
      rafraichirClotureVendeur();
    });
    selectEl.addEventListener('change', () => {
      const selectedName = selectEl.value ? selectEl.value.trim() : '';
      clotureVendeurState.vendeur = selectedName;
      const latestContext = getClotureUserContext();
      clotureVendeurState.vendeurUid = latestContext.canViewAll ? null : latestContext.vendorUid || null;
      rafraichirClotureVendeur();
    });
    clotureVendeurState.listenersReady = true;
  }

  const todayString = new Date().toISOString().split('T')[0];
  if (!clotureVendeurState.date) {
    const historiqueDate = document.getElementById('filterHistoryDate');
    clotureVendeurState.date = (historiqueDate && historiqueDate.value) || todayString;
  }
  dateInput.value = clotureVendeurState.date;

  const vendors = await chargerListeVendeursPourCloture();
  peuplerSelectCloture(vendors, context);
  if (context.canViewAll) {
    if (clotureVendeurState.vendeur && vendors.includes(clotureVendeurState.vendeur)) {
      selectEl.value = clotureVendeurState.vendeur;
    } else {
      selectEl.value = '';
      clotureVendeurState.vendeur = '';
    }
    clotureVendeurState.vendeurUid = null;
  } else {
    const preferredName = (clotureVendeurState.vendeur && clotureVendeurState.vendeur.trim()) ||
      (context.vendorName || (vendors[0] || '')).trim();
    if (preferredName) {
      selectEl.value = preferredName;
      clotureVendeurState.vendeur = preferredName;
    } else {
      selectEl.value = '';
      clotureVendeurState.vendeur = '';
    }
    clotureVendeurState.vendeurUid = context.vendorUid || null;
  }

  if (clotureVendeurState.date && selectEl.value) {
    await rafraichirClotureVendeur();
  } else {
    const message = context.canViewAll
      ? 'Selectionnez un vendeur et une date pour lancer la cloture.'
      : (selectEl.value
        ? 'Selectionnez une date pour lancer la cloture.'
        : 'Profil vendeur introuvable. Contactez un administrateur.');
    afficherMessageCloture(message);
  }

  if (typeof lucide !== 'undefined') {
    refreshLucideIcons();
  }
}

async function chargerListeVendeursPourCloture(force = false) {
  const context = getClotureUserContext();
  if (!context.canViewAll) {
    const singleName = context.vendorName ? [context.vendorName] : [];
    clotureVendeurState.users = singleName;
    clotureVendeurState.vendeurUid = context.vendorUid || null;
    return clotureVendeurState.users;
  }
  clotureVendeurState.vendeurUid = null;
  if (!force && Array.isArray(clotureVendeurState.users) && clotureVendeurState.users.length) {
    return clotureVendeurState.users;
  }
  try {
    const snapshot = await dbFirestore.collection('users').orderBy('name').get();
    const names = new Set();
    snapshot.forEach(doc => {
      const data = doc.data() || {};
      if (data.name) {
        names.add(data.name);
      }
    });
    clotureVendeurState.users = Array.from(names);
    return clotureVendeurState.users;
  } catch (err) {
    console.error('Erreur lors du chargement des vendeurs pour la cloture:', err);
    return clotureVendeurState.users || [];
  }
}

function peuplerSelectCloture(vendorNames, context = getClotureUserContext()) {
  const selectEl = document.getElementById('clotureVendeurSelect');
  if (!selectEl) {
    return;
  }
  const currentValue = selectEl.value;
  const canViewAll = context && context.canViewAll;
  const cleanedNames = Array.isArray(vendorNames) ? vendorNames.filter(name => typeof name === 'string' && name.trim()) : [];
  if (canViewAll) {
    selectEl.innerHTML = '<option value=\"\">Selectionnez un vendeur</option>';
  } else {
    selectEl.innerHTML = '';
  }
  if (!cleanedNames.length && !canViewAll) {
    const option = document.createElement('option');
    option.value = '';
    option.textContent = 'Vendeur introuvable';
    selectEl.appendChild(option);
  } else {
    cleanedNames.forEach(name => {
      const option = document.createElement('option');
      option.value = name;
      option.textContent = name;
      selectEl.appendChild(option);
    });
  }
  selectEl.disabled = !canViewAll;
  selectEl.classList.toggle('cloture-select-locked', !canViewAll);
  if (!canViewAll) {
    selectEl.setAttribute('aria-disabled', 'true');
  } else {
    selectEl.removeAttribute('aria-disabled');
  }
  if (currentValue && cleanedNames.includes(currentValue)) {
    selectEl.value = currentValue;
  }
}

function afficherMessageCloture(message) {
  const messageEl = document.getElementById('clotureVendeurMessage');
  const summaryEl = document.getElementById('clotureVendeurSummary');
  const loaderEl = document.getElementById('clotureVendeurLoader');
  if (loaderEl) {
    loaderEl.style.display = 'none';
  }
  if (messageEl) {
    messageEl.textContent = message;
    messageEl.style.display = 'block';
  }
  if (summaryEl) {
    summaryEl.style.display = 'none';
  }
}

function afficherLoaderCloture(visible) {
  const loaderEl = document.getElementById('clotureVendeurLoader');
  const messageEl = document.getElementById('clotureVendeurMessage');
  const summaryEl = document.getElementById('clotureVendeurSummary');
  if (!loaderEl || !messageEl || !summaryEl) {
    return;
  }
  loaderEl.style.display = visible ? 'block' : 'none';
  if (visible) {
    messageEl.style.display = 'none';
    summaryEl.style.display = 'none';
  }
}

async function rafraichirClotureVendeur() {
  const dateInput = document.getElementById('clotureVendeurDate');
  const selectEl = document.getElementById('clotureVendeurSelect');
  if (!dateInput || !selectEl) {
    return;
  }
  const context = getClotureUserContext();
  const dateValue = dateInput.value;
  let vendorValue = selectEl.value;
  let vendorUid = context.canViewAll ? null : context.vendorUid || null;
  clotureVendeurState.date = dateValue;
  if (!context.canViewAll) {
    const enforcedName = (clotureVendeurState.vendeur && clotureVendeurState.vendeur.trim()) ||
      (context.vendorName || '').trim();
    if (enforcedName) {
      vendorValue = enforcedName;
      if (selectEl.value !== enforcedName) {
        selectEl.value = enforcedName;
      }
    } else {
      vendorValue = '';
    }
  }
  vendorValue = vendorValue ? vendorValue.trim() : '';
  clotureVendeurState.vendeur = vendorValue;
  clotureVendeurState.vendeurUid = vendorUid;

  if (!dateValue || !vendorValue) {
    let message;
    if (!dateValue && !vendorValue) {
      message = context.canViewAll
        ? 'Selectionnez un vendeur et une date pour lancer la cloture.'
        : 'Selectionnez une date pour lancer la cloture.';
    } else if (!dateValue) {
      message = 'Selectionnez une date pour lancer la cloture.';
    } else {
      message = context.canViewAll
        ? 'Selectionnez un vendeur pour lancer la cloture.'
        : 'Profil vendeur introuvable. Contactez un administrateur.';
    }
    afficherMessageCloture(message);
    return;
  }

  afficherLoaderCloture(true);
  clotureVendeurLoading = true;
  try {
    const result = await calculerClotureVendeur(new Date(dateValue), vendorValue, vendorUid);
    clotureVendeurState.totals = result.totals;
    clotureVendeurState.history = result.history || [];
    clotureVendeurState.existing = result.existing || null;
    if (clotureVendeurState.existing && clotureVendeurState.existing.cashRemis != null) {
      clotureVendeurState.cashRemis = String(clotureVendeurState.existing.cashRemis);
    } else if (clotureVendeurState.cashRemis === '' || clotureVendeurState.cashRemis == null) {
      clotureVendeurState.cashRemis = String(result.totals.cashAttendu || '');
    }
    rendreClotureVendeur();
  } catch (err) {
    console.error('Erreur pendant le calcul de la cloture vendeur:', err);
    afficherMessageCloture('Impossible de calculer la cloture. Reessayez dans un instant.');
  } finally {
    clotureVendeurLoading = false;
    afficherLoaderCloture(false);
  }
}

function rendreClotureVendeur() {
  const summaryEl = document.getElementById('clotureVendeurSummary');
  const messageEl = document.getElementById('clotureVendeurMessage');
  const totals = clotureVendeurState.totals;
  if (!summaryEl || !messageEl) {
    return;
  }
  if (!totals) {
    afficherMessageCloture('Aucune vente trouvee pour cette selection.');
    return;
  }
  messageEl.style.display = 'none';
  summaryEl.style.display = 'flex';

  setText('clotureTotalVentes', formatXof(totals.totalVentes || 0));
  setText('clotureTotalVentesCount', `${totals.ventesCount || 0} vente${totals.ventesCount === 1 ? '' : 's'}`);
  setText('clotureCashAttendu', formatXof(totals.cashAttendu || 0));
  setText('clotureMomoEncaisse', formatXof(totals.momoEncaisse || 0));
  setText('clotureMomoMonnaie', formatXof(totals.momoMonnaie || 0));
  setText('clotureCashAttenduLabel', formatXof(totals.cashAttendu || 0));

  const cashInput = document.getElementById('clotureCashRemisInput');
  if (cashInput && cashInput !== document.activeElement) {
    cashInput.value = clotureVendeurState.cashRemis != null ? clotureVendeurState.cashRemis : '';
  }
  mettreAJourClotureCalculs();
  renderClotureAccounts(totals.accounts || []);
  renderClotureSales(totals.sales || []);
  renderClotureHistory(clotureVendeurState.history || []);
  const notesEl = document.getElementById('clotureNotes');
  if (notesEl && clotureVendeurState.existing && typeof clotureVendeurState.existing.notes === 'string') {
    notesEl.value = clotureVendeurState.existing.notes;
  }
}

function setText(elementId, text) {
  const el = document.getElementById(elementId);
  if (el) {
    el.textContent = text;
  }
}

function mettreAJourClotureCalculs() {
  const totals = clotureVendeurState.totals;
  const cashInput = document.getElementById('clotureCashRemisInput');
  if (!totals || !cashInput) {
    return;
  }
  const cashValue = parseFloat(cashInput.value || '0');
  clotureVendeurState.cashRemis = cashInput.value;
  const momoEncaisse = Number(totals.momoEncaisse || 0);
  const momoMonnaie = Number(totals.momoMonnaie || 0);
  const actualTotal = (Number.isFinite(cashValue) ? cashValue : 0) + momoEncaisse - momoMonnaie;
  const difference = actualTotal - Number(totals.totalVentes || 0);

  setText('clotureCalculTotal', formatXof(actualTotal));
  const diffEl = document.getElementById('clotureDifference');
  if (diffEl) {
    diffEl.textContent = formatXof(difference);
    diffEl.classList.remove('positive', 'negative');
    if (difference > 0.5) {
      diffEl.classList.add('positive');
    } else if (difference < -0.5) {
      diffEl.classList.add('negative');
    }
  }
  const diffLabel = document.getElementById('clotureDifferenceLabel');
  if (diffLabel) {
    if (Math.abs(difference) < 0.5) {
      diffLabel.textContent = 'Cloture equilibree';
    } else if (difference > 0) {
      diffLabel.textContent = 'Surplus a expliquer';
    } else {
      diffLabel.textContent = 'Manque a justifier';
    }
  }
}

function renderClotureAccounts(accounts) {
  const container = document.getElementById('clotureAccountsContainer');
  if (!container) {
    return;
  }
  if (!Array.isArray(accounts) || !accounts.length) {
    container.innerHTML = '<p class="cloture-empty-state" style="margin:0;">Aucun paiement enregistré.</p>';
    return;
  }
  const rows = accounts.map(acc => {
    const name = acc.compteNom || acc.compteId || 'Compte';
    return `<tr>
      <td>${aideCommandeEscapeHtml(name)}</td>
      <td>${formatXof(acc.encaisse || 0)}</td>
      <td>${formatXof(acc.monnaie || 0)}</td>
      <td>${formatXof(acc.net || 0)}</td>
    </tr>`;
  }).join('');
  container.innerHTML = `<table class="cloture-accounts-table">
    <thead>
      <tr>
        <th>Compte</th>
        <th>Encaissements</th>
        <th>Monnaie</th>
        <th>Net</th>
      </tr>
    </thead>
    <tbody>${rows}</tbody>
  </table>`;
}

function renderClotureSales(sales) {
  const container = document.getElementById('clotureSalesList');
  if (!container) {
    return;
  }
  if (!Array.isArray(sales) || !sales.length) {
    container.innerHTML = '<p class="cloture-empty-state" style="margin:0;">Aucune vente trouvée pour cette journée.</p>';
    return;
  }
  const entries = sales.map(sale => {
    const heure = sale.heure || (sale.timestamp ? new Date(sale.timestamp).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) : '');
    const paymentsHtml = Array.isArray(sale.payments) && sale.payments.length
      ? sale.payments.map(p => {
          const montant = formatXof(p.net != null ? p.net : (p.encaisse || 0));
          const monnaieText = p.monnaie ? ` (monnaie ${formatXof(p.monnaie)})` : '';
          const proofs = [];
          const encaisseCollection = Array.isArray(p.encaissePhotos) ? p.encaissePhotos.slice() : [];
          if (p.encaissePhoto) {
            encaisseCollection.push(p.encaissePhoto);
          }
          encaisseCollection.forEach(photo => {
            if (!photo) return;
            proofs.push(`<div class="cloture-payment-proof"><span>Encaissement</span><img class="cloture-proof-image" src="${photo}" alt="Preuve encaissement" onclick="ouvrirPreuvePaiement(this.src)"></div>`);
          });
          const monnaieCollection = Array.isArray(p.monnaiePhotos) ? p.monnaiePhotos.slice() : [];
          if (p.monnaiePhoto) {
            monnaieCollection.push(p.monnaiePhoto);
          }
          monnaieCollection.forEach(photo => {
            if (!photo) return;
            proofs.push(`<div class="cloture-payment-proof"><span>Monnaie</span><img class="cloture-proof-image" src="${photo}" alt="Preuve monnaie" onclick="ouvrirPreuvePaiement(this.src)"></div>`);
          });
          return `<div class="cloture-payment-entry">
            <div class="cloture-payment-amount">${aideCommandeEscapeHtml(p.label || 'Compte')} : ${montant}${monnaieText}</div>
            ${proofs.join('')}
          </div>`;
        }).join('')
      : '<div class="cloture-payment-entry">Paiements non detailles</div>';
    return `<div class="cloture-history-item">
      <div><strong>${heure || '--:--'}</strong></div>
      <div>${aideCommandeEscapeHtml(sale.client || 'Client')}</div>
      <div>${formatXof(sale.total || 0)}</div>
      <div>${paymentsHtml}</div>
    </div>`;
  }).join('');
  container.innerHTML = entries;
}

function renderClotureHistory(history) {
  const listEl = document.getElementById('clotureHistoryList');
  const feedbackEl = document.getElementById('clotureSaveFeedback');
  if (!listEl || !feedbackEl) {
    return;
  }
  if (!Array.isArray(history) || !history.length) {
    listEl.innerHTML = '<li class="cloture-empty-state" style="margin:0;">Aucune cloture enregistree pour ce vendeur.</li>';
  } else {
    listEl.innerHTML = history.map(item => {
      const date = item.dateString || '';
      const diff = formatXof(item.difference || 0);
      return `<li class="cloture-history-item">
        <span><strong>Date :</strong> ${aideCommandeEscapeHtml(date)}</span>
        <span><strong>Cash remis :</strong> ${formatXof(item.cashRemis || 0)}</span>
        <span><strong>Différence :</strong> ${diff}</span>
      </li>`;
    }).join('');
  }
  if (clotureVendeurState.existing) {
    const savedBy = clotureVendeurState.existing.createdByNom || 'Enregistré';
    feedbackEl.textContent = `Cloture enregistree par ${savedBy} le ${clotureVendeurState.existing.dateString || ''}.`;
  } else {
    feedbackEl.textContent = '';
  }
}

async function enregistrerClotureVendeur() {
  if (clotureVendeurLoading) {
    return;
  }
  const totals = clotureVendeurState.totals;
  const dateValue = clotureVendeurState.date;
  const vendorValue = clotureVendeurState.vendeur;
  const notesEl = document.getElementById('clotureNotes');
  const feedbackEl = document.getElementById('clotureSaveFeedback');
  const cashValue = parseFloat(clotureVendeurState.cashRemis || '0');
  if (!totals || !dateValue || !vendorValue || !Number.isFinite(cashValue)) {
    showToast('Selectionnez un vendeur, une date et remplissez le cash remis.');
    return;
  }
  const momoEncaisse = Number(totals.momoEncaisse || 0);
  const momoMonnaie = Number(totals.momoMonnaie || 0);
  const actualTotal = cashValue + momoEncaisse - momoMonnaie;
  const difference = actualTotal - Number(totals.totalVentes || 0);
  const user = firebase.auth().currentUser;
  const dateString = dateValue;
  const docId = `${dateString}_${normaliserCleCloture(vendorValue)}`;
  const payload = {
    vendeur: vendorValue,
    vendeurUid: clotureVendeurState.vendeurUid || null,
    dateString,
    totalVentes: Number(totals.totalVentes || 0),
    ventesCount: Number(totals.ventesCount || 0),
    cashAttendu: Number(totals.cashAttendu || 0),
    momoEncaisse,
    momoMonnaie,
    cashRemis: cashValue,
    calculTotal: actualTotal,
    difference,
    notes: notesEl ? notesEl.value.trim() : '',
    comptes: totals.accounts || [],
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedByUid: user ? user.uid : null,
    updatedByNom: user ? (user.displayName || user.email || '') : null
  };
  if (!clotureVendeurState.existing) {
    payload.createdAt = firebase.firestore.FieldValue.serverTimestamp();
    payload.createdByUid = payload.updatedByUid;
    payload.createdByNom = payload.updatedByNom;
  }
  try {
    await dbFirestore.collection('cloturesVendeurs').doc(docId).set(payload, { merge: true });
    clotureVendeurState.existing = {
      ...payload,
      id: docId
    };
    feedbackEl.textContent = 'Cloture sauvegardee avec succes.';
    showToast('Cloture sauvegardee.');
    clotureVendeurState.history = await chargerHistoriqueCloture(vendorValue);
    renderClotureHistory(clotureVendeurState.history);
  } catch (err) {
    console.error('Erreur lors de la sauvegarde de la cloture vendeur:', err);
    showToast("Erreur pendant l'enregistrement de la cloture.");
  }
}

async function chargerHistoriqueCloture(vendor) {
  if (!vendor) {
    return [];
  }
  try {
    const snapshot = await dbFirestore.collection('cloturesVendeurs')
      .where('vendeur', '==', vendor)
      .orderBy('dateString', 'desc')
      .limit(5)
      .get();
    const history = [];
    snapshot.forEach(doc => {
      history.push({ id: doc.id, ...doc.data() });
    });
    return history;
  } catch (err) {
    console.warn('Impossible de charger l historique de cloture:', err);
    return [];
  }
}

function classifyClotureAccount(compteId, compteNom) {
  const value = (compteId || compteNom || '').toString().toLowerCase();
  if (!value) {
    return 'autre';
  }
  if (value.includes('momo') || value.includes('mobile')) {
    return 'momo';
  }
  if (value.includes('caisse') || value.includes('cash') || value.includes('espece')) {
    return 'cash';
  }
  return 'autre';
}

function normaliserCleCloture(value) {
  return (value || 'inconnu')
    .toString()
    .trim()
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '') || 'inconnu';
}

function ouvrirPreuvePaiement(src) {
  if (!src) return;
  const win = window.open();
  if (win) {
    win.document.write('<title>Preuve de paiement</title>');
    win.document.write('<img src="' + src + '" style="max-width:100%; height:auto; display:block; margin:0 auto;">');
  }
}

async function calculerClotureVendeur(dateObj, vendor, vendorUid) {
  const start = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), 0, 0, 0, 0);
  const end = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), 23, 59, 59, 999);
  const startTs = firebase.firestore.Timestamp.fromDate(start);
  const endTs = firebase.firestore.Timestamp.fromDate(end);

  let query = dbFirestore.collection('ventes')
    .where('timestamp', '>=', startTs)
    .where('timestamp', '<=', endTs)
    .orderBy('timestamp', 'asc');

  if (vendorUid) {
    query = query.where('enregistreParUid', '==', vendorUid);
  } else if (vendor) {
    query = query.where('enregistreParNom', '==', vendor);
  }

  const snapshot = await query.get();
  const accountsMap = new Map();
  const sales = [];
  let totalVentes = 0;
  let ventesCount = 0;

  snapshot.forEach(doc => {
    const data = doc.data() || {};
    if ((data.status || '').toString().toLowerCase().startsWith('annul')) {
      return;
    }
    const total = Number(data.overallTotal || 0);
    totalVentes += total;
    ventesCount += 1;
    const payments = Array.isArray(data.paymentsDetails) ? data.paymentsDetails : [];
    const salePayments = [];
    if (payments.length) {
      payments.forEach(payment => {
        const compteId = payment.compteId || '';
        const compteNom = payment.compteNom || compteId || 'Compte';
        const key = (compteId || compteNom).toString().toLowerCase();
        const encaisse = Number(payment.montantEncaisse || 0);
        const monnaie = Number(payment.monnaieRendue || 0);
        let net = payment.netEncaisse != null ? Number(payment.netEncaisse) : encaisse - monnaie;
        if (!Number.isFinite(net)) {
          net = encaisse - monnaie;
        }
        const type = classifyClotureAccount(compteId, compteNom);
        if (!accountsMap.has(key)) {
          accountsMap.set(key, {
            compteId: compteId || null,
            compteNom: compteNom || 'Compte',
            encaisse: 0,
            monnaie: 0,
            net: 0,
            type
          });
        }
        const entry = accountsMap.get(key);
        entry.encaisse += encaisse;
        entry.monnaie += monnaie;
        entry.net += net;
        const encaissePhotos = [];
        if (Array.isArray(payment.encaissePhotos)) {
          payment.encaissePhotos.forEach(p => p && encaissePhotos.push(p));
        }
        if (payment.encaissePhoto) {
          encaissePhotos.push(payment.encaissePhoto);
        }
        const monnaiePhotos = [];
        if (Array.isArray(payment.monnaiePhotos)) {
          payment.monnaiePhotos.forEach(p => p && monnaiePhotos.push(p));
        }
        if (payment.monnaiePhoto) {
          monnaiePhotos.push(payment.monnaiePhoto);
        }
        salePayments.push({
          label: compteNom || compteId || 'Compte',
          encaisse,
          monnaie,
          net,
          encaissePhotos,
          monnaiePhotos
        });
      });
    } else {
      const fallbackKey = 'sans-compte';
      if (!accountsMap.has(fallbackKey)) {
        accountsMap.set(fallbackKey, {
          compteId: null,
          compteNom: 'Sans detail',
          encaisse: 0,
          monnaie: 0,
          net: 0,
          type: 'cash'
        });
      }
      const entry = accountsMap.get(fallbackKey);
      entry.encaisse += total;
      entry.net += total;
      salePayments.push({
        label: 'Sans detail',
        encaisse: total,
        monnaie: 0,
        net: total,
        encaissePhotos: [],
        monnaiePhotos: []
      });
    }

    const saleTimestamp = data.timestamp && typeof data.timestamp.toDate === 'function'
      ? data.timestamp.toDate()
      : (data.dateVente ? new Date(data.dateVente) : null);

    sales.push({
      id: doc.id,
      client: data.clientNom || 'Client',
      total,
      heure: data.heureVente || (saleTimestamp ? saleTimestamp.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) : ''),
      timestamp: saleTimestamp ? saleTimestamp.toISOString() : null,
      payments: salePayments
    });
  });

  const accounts = Array.from(accountsMap.values()).sort((a, b) => (b.net || 0) - (a.net || 0));
  let cashAttendu = 0;
  let momoEncaisse = 0;
  let momoMonnaie = 0;
  accounts.forEach(acc => {
    if (acc.type === 'cash') {
      cashAttendu += acc.net || 0;
    } else if (acc.type === 'momo') {
      momoEncaisse += acc.encaisse || 0;
      momoMonnaie += acc.monnaie || 0;
    }
  });

  const dateString = start.toISOString().split('T')[0];
  const docId = `${dateString}_${normaliserCleCloture(vendor)}`;
  const docRef = dbFirestore.collection('cloturesVendeurs').doc(docId);
  let existingData = null;
  const existingSnap = await docRef.get();
  if (existingSnap.exists) {
    existingData = existingSnap.data() || {};
    existingData.id = docId;
  }

  let history = [];
  if (vendor) {
    history = await chargerHistoriqueCloture(vendor);
  }

  return {
    totals: {
      totalVentes,
      ventesCount,
      cashAttendu,
      momoEncaisse,
      momoMonnaie,
      accounts,
      sales
    },
    existing: existingData,
    history
  };
}

function confirmerScanApprovisionnementDynamsoft() {
  if (scanUsageMode === 'appro') {
      if (tempScannedImeis.length !== currentApproItemForScan.quantite) {
        alert("Le nombre d'IMEI ne correspond pas à la quantité !");
        return;
      }
      currentApproItemForScan.imeis = tempScannedImeis;
      currentApproItems.push(currentApproItemForScan);
      updatePanierApprovisionnement();
      annulerScan(); // Quitte l'écran de scan
  } else if (scanUsageMode === 'reception') {
      if (tempScannedImeis.length === 0) {
          alert("Aucun IMEI scanné pour cette réception.");
          return;
      }
      if (!currentReceptionDraft || currentReceptionScanIndex === null || !currentReceptionDraft.items[currentReceptionScanIndex]) {
          alert("Impossible d'associer les IMEI scannés à la commande.");
          return;
      }
      const targetItem = currentReceptionDraft.items[currentReceptionScanIndex];
      targetItem.imeis = [...tempScannedImeis];
      targetItem.qtyToReceive = tempScannedImeis.length;
      renderCommandeReceptionItems();
      annulerScan();
  }
}

function annulerScan() {
    if (scanUsageMode === 'reception') {
        window.location.hash = 'commande-reception';
    } else {
        window.location.hash = 'approvisionnement';
    }
    scanUsageMode = 'appro';
    currentReceptionScanIndex = null;
}

async function ouvrirReceptionCommande(approId, event) {
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    if (!approId) {
        return;
    }
    try {
        showSaleLoader();
        const approRef = dbFirestore.collection("approvisionnement").doc(approId);
        const approSnap = await approRef.get();
        if (!approSnap.exists) {
            alert("Commande introuvable.");
            return;
        }
        const data = approSnap.data();
        if (data.status !== 'commande' && data.status !== 'reception_partielle') {
            alert("Cette commande est déjà réceptionnée.");
            return;
        }
        currentCommandeReception = { id: approId, ref: approRef, data };
        const itemsSource = Array.isArray(data.items) ? data.items : [];
        const itemsDraft = itemsSource.map((item, index) => {
            const receivedQty = parseFloat(item.receivedQty || 0);
            const baseRemaining = item.remainingQty != null
                ? parseFloat(item.remainingQty)
                : Math.max(0, (parseFloat(item.quantite) || 0) - receivedQty);
            return {
                index,
                produit: item.produit || `Article ${index + 1}`,
                category: item.category || '',
                quantiteCommandee: parseFloat(item.quantite) || 0,
                dejaRecu: receivedQty,
                restant: baseRemaining,
                qtyToReceive: 0,
                unitCost: parseFloat(item.adjustedPrixAchat || item.prixAchat || 0),
                imeis: [],
                existingImeis: Array.isArray(item.imeis) ? item.imeis : []
            };
        }).filter(item => item.restant > 0);

        currentReceptionDraft = {
            id: approId,
            fournisseur: data.fournisseur || 'Fournisseur',
            orderTotalCost: parseFloat(data.orderTotalCost || data.totalCost || 0),
            paymentsTotalPaid: parseFloat(data.paymentsTotalPaid || 0),
            remainingAmount: parseFloat(data.remainingAmount || 0),
            commandeMeta: data.commandeMeta || {},
            receptionStats: data.receptionStats || {},
            receivedTotalCost: parseFloat(data.receivedTotalCost || 0),
            items: itemsDraft
        };

        const transportField = document.getElementById("commandeReceptionTransport");
        if (transportField) transportField.value = '';
        const notesField = document.getElementById("commandeReceptionNotes");
        if (notesField) notesField.value = '';

        renderCommandeReceptionSummary();
        renderCommandeReceptionItems();
        actualiserTotalReception();
        const receptionTransportSelect = document.getElementById("compteSelectCommandeReceptionTransport");
        if (receptionTransportSelect) {
            remplirTousSelectComptes(receptionTransportSelect);
        }
        window.location.hash = 'commande-reception';
    } catch (error) {
        console.error("Erreur lors de l'ouverture de la réception :", error);
        alert("Impossible de charger la commande : " + error.message);
    } finally {
        hideSaleLoader();
    }
}

function renderCommandeReceptionSummary() {
    const summaryEl = document.getElementById("commandeReceptionSummary");
    if (!summaryEl) {
        return;
    }
    if (!currentReceptionDraft) {
        summaryEl.innerHTML = "<p>Aucune commande sélectionnée.</p>";
        return;
    }
    const draft = currentReceptionDraft;
    const stats = draft.receptionStats || {};
    const totalOrdered = stats.totalOrdered || draft.items.reduce((sum, item) => sum + (parseFloat(item.quantiteCommandee) || 0), 0);
    const totalReceived = stats.totalReceived || 0;
    const deposit = parseFloat(draft.paymentsTotalPaid || 0);
    const receivedValue = parseFloat(draft.receivedTotalCost || 0);
    const orderValue = parseFloat(draft.orderTotalCost || receivedValue || 0);
    const goodsRemainingValue = Math.max(0, orderValue - receivedValue);
    const advanceValue = Math.max(0, deposit - receivedValue);
    const paymentDue = Math.max(0, receivedValue - deposit);
    const expectedDate = draft.commandeMeta && draft.commandeMeta.expectedDate
        ? new Date(draft.commandeMeta.expectedDate).toLocaleDateString('fr-FR')
        : 'Non défini';

    summaryEl.innerHTML = `
        <p><strong>Fournisseur :</strong> ${draft.fournisseur}</p>
        <p><strong>Commande :</strong> ${totalOrdered} article(s) — Reçu : ${totalReceived}</p>
        <p><strong>Valeur reçue :</strong> ${receivedValue.toLocaleString('fr-FR')} FCFA</p>
        <p><strong>Valeur restante :</strong> ${goodsRemainingValue.toLocaleString('fr-FR')} FCFA</p>
        <p><strong>Acompte versé :</strong> ${deposit.toLocaleString('fr-FR')} FCFA</p>
        <p><strong>Avance fournisseur :</strong> ${advanceValue.toLocaleString('fr-FR')} FCFA</p>
        <p><strong>Solde à payer :</strong> ${paymentDue.toLocaleString('fr-FR')} FCFA</p>
        <p><strong>Réception prévue :</strong> ${expectedDate}</p>
    `;
}

function renderCommandeReceptionItems() {
    const container = document.getElementById("commandeReceptionItemsContainer");
    if (!container) {
        return;
    }
    if (!currentReceptionDraft || currentReceptionDraft.items.length === 0) {
        container.innerHTML = "<p>Aucun article restant à réceptionner.</p>";
        const submitBtn = document.getElementById("commandeReceptionSubmitBtn");
        if (submitBtn) submitBtn.disabled = true;
        actualiserTotalReception();
        return;
    }

    let html = '';
    currentReceptionDraft.items.forEach((item, index) => {
        const disableInputs = item.restant <= 0;
        const scanButton = item.category === 'telephones'
            ? `<button type="button" class="btn-modern secondary" onclick="lancerScanDynamsoftReception(currentReceptionDraft.items[${index}], ${index})"><i data-lucide="smartphone"></i> Scanner IMEI</button>`
            : '';
        const imeiInfo = item.category === 'telephones' && item.imeis.length
            ? `<div class="reception-item-imeis">IMEI : ${item.imeis.join(', ')} <button type="button" onclick="viderImeisReception(${index})">Effacer</button></div>`
            : '';

        html += `
        <div class="reception-item" data-index="${index}">
            <h3>${item.produit}</h3>
            <div class="reception-item-meta">
                <span>Commandé : ${item.quantiteCommandee}</span>
                <span>Déjà reçu : ${item.dejaRecu}</span>
                <span>Restant : ${item.restant}</span>
            </div>
            <div class="reception-item-inputs">
                <div>
                    <label>Quantité à réceptionner</label>
                    <input type="number" min="0" max="${item.restant}" value="${item.qtyToReceive || 0}" ${disableInputs ? 'disabled' : ''} oninput="majQuantiteReception(${index}, this.value)" />
                </div>
                <div>
                    <label>Coût unitaire (FCFA)</label>
                    <input type="number" min="0" step="100" value="${item.unitCost || 0}" oninput="majPrixReception(${index}, this.value)" />
                </div>
            </div>
            <div class="reception-item-actions">
                ${scanButton}
                ${item.category === 'telephones' ? `<span>${item.imeis.length} IMEI scanné(s)</span>` : ''}
            </div>
            ${imeiInfo}
        </div>
        `;
    });

    container.innerHTML = html;
    if (typeof lucide !== 'undefined' && lucide.createIcons) {
        refreshLucideIcons();
    }
    actualiserTotalReception();
}

function majQuantiteReception(index, rawValue) {
    if (!currentReceptionDraft || !currentReceptionDraft.items[index]) {
        return;
    }
    const item = currentReceptionDraft.items[index];
    const max = item.restant;
    let value = parseFloat(rawValue);
    if (isNaN(value) || value < 0) value = 0;
    if (value > max) value = max;
    item.qtyToReceive = value;
    if (item.category === 'telephones' && Array.isArray(item.imeis) && item.imeis.length > value) {
        item.imeis = item.imeis.slice(0, value);
        renderCommandeReceptionItems();
        return;
    }
    actualiserTotalReception();
}

function majPrixReception(index, rawValue) {
    if (!currentReceptionDraft || !currentReceptionDraft.items[index]) {
        return;
    }
    const value = parseFloat(rawValue);
    currentReceptionDraft.items[index].unitCost = isNaN(value) || value < 0 ? 0 : value;
    actualiserTotalReception();
}

function viderImeisReception(index) {
    if (!currentReceptionDraft || !currentReceptionDraft.items[index]) {
        return;
    }
    const item = currentReceptionDraft.items[index];
    item.imeis = [];
    if (item.category === 'telephones') {
        item.qtyToReceive = 0;
    }
    renderCommandeReceptionItems();
}

function actualiserTotalReception() {
    const totalEl = document.getElementById("commandeReceptionTotal");
    const submitBtn = document.getElementById("commandeReceptionSubmitBtn");
    if (!currentReceptionDraft || !totalEl) {
        if (totalEl) totalEl.textContent = "0 FCFA";
        if (submitBtn) submitBtn.disabled = true;
        return;
    }
    let total = 0;
    let hasQuantity = false;
    currentReceptionDraft.items.forEach(item => {
        const qty = parseFloat(item.qtyToReceive) || 0;
        const unitCost = parseFloat(item.unitCost) || 0;
        if (qty > 0) {
            hasQuantity = true;
        }
        total += qty * unitCost;
    });
    totalEl.textContent = `${total.toLocaleString('fr-FR')} FCFA`;
    if (submitBtn) submitBtn.disabled = !hasQuantity;
}

function resetCommandeReceptionUI() {
    const summaryEl = document.getElementById("commandeReceptionSummary");
    const itemsEl = document.getElementById("commandeReceptionItemsContainer");
    const totalEl = document.getElementById("commandeReceptionTotal");
    const submitBtn = document.getElementById("commandeReceptionSubmitBtn");
    if (summaryEl) summaryEl.innerHTML = "<p>Aucune commande sélectionnée.</p>";
    if (itemsEl) itemsEl.innerHTML = "";
    if (totalEl) totalEl.textContent = "0 FCFA";
    if (submitBtn) submitBtn.disabled = true;
    const transportInput = document.getElementById("commandeReceptionTransport");
    if (transportInput) transportInput.value = "";
    const transportAccount = document.getElementById("compteSelectCommandeReceptionTransport");
    if (transportAccount) transportAccount.value = "";
    const notesField = document.getElementById("commandeReceptionNotes");
    if (notesField) notesField.value = "";
    currentReceptionDraft = null;
    currentCommandeReception = null;
}

function fermerReceptionCommande() {
    resetCommandeReceptionUI();
    window.location.hash = 'approvisionnement-historique';
}

async function soumettreReceptionCommande() {
    if (!currentReceptionDraft || !currentCommandeReception) {
        alert("Aucune commande à réceptionner.");
        return;
    }
    const itemsToReceive = currentReceptionDraft.items
        .filter(item => (parseFloat(item.qtyToReceive) || 0) > 0)
        .map(item => ({ ...item, qtyToReceive: parseFloat(item.qtyToReceive) || 0 }));

    if (itemsToReceive.length === 0) {
        alert("Sélectionnez au moins un article à réceptionner.");
        return;
    }

    const missingImeis = itemsToReceive.some(item => item.category === 'telephones' && (!item.imeis || item.imeis.length !== item.qtyToReceive));
    if (missingImeis) {
        alert("Assurez-vous d'avoir scanné les IMEI pour tous les téléphones réceptionnés.");
        return;
    }

    const user = firebase.auth().currentUser;
    if (!user) {
        alert("Votre session a expiré. Merci de vous reconnecter.");
        return;
    }

    const transportCost = parseFloat(document.getElementById("commandeReceptionTransport").value) || 0;
    const transportAccountSelect = document.getElementById("compteSelectCommandeReceptionTransport");
    const transportAccountId = transportAccountSelect ? transportAccountSelect.value : '';
    const notes = document.getElementById("commandeReceptionNotes").value.trim();

    if (transportCost > 0 && !transportAccountId) {
        alert("Sélectionnez le compte utilisé pour régler les frais de transport de la réception.");
        return;
    }

    const receptionMap = new Map(itemsToReceive.map(item => [item.index, item]));
    const stockOperations = new Map();
    try {
        showSaleLoader();
        for (const item of itemsToReceive) {
            const stockQuery = await dbFirestore.collection("stock")
                .where("name", "==", item.produit)
                .limit(1)
                .get();
            if (stockQuery.empty) {
                stockOperations.set(item.index, {
                    docRef: dbFirestore.collection("stock").doc(),
                    existingData: null,
                    isNew: true,
                    produit: item.produit,
                    category: item.category
                });
            } else {
                const doc = stockQuery.docs[0];
                stockOperations.set(item.index, {
                    docRef: doc.ref,
                    existingData: doc.data(),
                    isNew: false,
                    produit: item.produit,
                    category: item.category
                });
            }
        }

        await dbFirestore.runTransaction(async tx => {
            const approRef = currentCommandeReception.ref || dbFirestore.collection("approvisionnement").doc(currentReceptionDraft.id);
            const approSnap = await tx.get(approRef);
            if (!approSnap.exists) {
                throw new Error("Commande introuvable en base.");
            }
            const approData = approSnap.data();
            if (approData.status === 'reçu') {
                throw new Error("Cette commande est déjà enregistrée comme reçue.");
            }

            const updatedItems = Array.isArray(approData.items) ? approData.items.map(item => ({ ...item })) : [];
            const stats = approData.receptionStats || {};
            let totalRemainingAfter = 0;
            let totalReceivedThisRun = 0;
            let receptionValue = 0;
            const orderTotalCost = parseFloat(approData.orderTotalCost || approData.totalCost || 0);
            const paymentsTotal = parseFloat(approData.paymentsTotalPaid || 0);
            const existingReceivedTotalCost = parseFloat(approData.receivedTotalCost || 0);
            let totalCostValue = parseFloat(approData.totalCost || 0);
            const serverTs = firebase.firestore.FieldValue.serverTimestamp();
            const receptionRecord = {
                timestamp: serverTs,
                utilisateurUid: user.uid,
                utilisateurNom: user.displayName || user.email || 'Utilisateur',
                totalValue: 0,
                transportCost: transportCost,
                notes: notes || '',
                lignes: []
            };

            updatedItems.forEach((orderItem, idx) => {
                const draftItem = receptionMap.get(idx);
                const previousReceived = parseFloat(orderItem.receivedQty || 0);
                const previousRemaining = orderItem.remainingQty != null
                    ? parseFloat(orderItem.remainingQty)
                    : Math.max(0, (parseFloat(orderItem.quantite) || 0) - previousReceived);
                let newRemaining = previousRemaining;

                if (draftItem && draftItem.qtyToReceive > 0) {
                    const receptionQty = draftItem.qtyToReceive;
                    const unitCost = parseFloat(draftItem.unitCost) || 0;
                    newRemaining = Math.max(0, previousRemaining - receptionQty);
                    const newReceived = previousReceived + receptionQty;

                    orderItem.receivedQty = newReceived;
                    orderItem.remainingQty = newRemaining;
                    orderItem.adjustedPrixAchat = unitCost;
                    if (!Array.isArray(orderItem.imeis)) {
                        orderItem.imeis = [];
                    }
                    if (draftItem.imeis && draftItem.imeis.length > 0) {
                        orderItem.imeis = Array.from(new Set([...orderItem.imeis, ...draftItem.imeis]));
                    }

                    totalReceivedThisRun += receptionQty;
                    receptionValue += receptionQty * unitCost;
                    receptionRecord.lignes.push({
                        produit: draftItem.produit,
                        quantite: receptionQty,
                        unitCost: unitCost,
                        imeis: draftItem.imeis || []
                    });

                    const stockOp = stockOperations.get(idx);
                    if (stockOp) {
                        const stockDocRef = stockOp.docRef;
                        const stockData = stockOp.existingData || {
                            stock: 0,
                            price: unitCost,
                            category: orderItem.category || stockOp.category || 'telephones',
                            name: draftItem.produit
                        };
                        const oldStock = parseFloat(stockData.stock || 0);
                        const oldPrice = parseFloat(stockData.price || 0);
                        const newStock = oldStock + receptionQty;
                        const newAveragePrice = newStock > 0 ? ((oldStock * oldPrice) + (receptionQty * unitCost)) / newStock : unitCost;

                        if (stockOp.isNew) {
                            tx.set(stockDocRef, {
                                name: draftItem.produit,
                                category: stockData.category,
                                stock: newStock,
                                price: newAveragePrice,
                                createdAt: serverTs
                            });
                        } else {
                            tx.update(stockDocRef, {
                                stock: newStock,
                                price: newAveragePrice
                            });
                        }

                        const historyRef = stockDocRef.collection("history").doc();
                        tx.set(historyRef, {
                            timestamp: serverTs,
                            change: receptionQty,
                            newStock: newStock,
                            type: 'approvisionnement-reception',
                            costOfChange: receptionQty * unitCost,
                            sourceApproId: approRef.id,
                            sourceApproItemName: (draftItem && draftItem.produit) || orderItem.produit || stockData.name || ''
                        });

                        if ((draftItem.category === 'telephones' || orderItem.category === 'telephones') && draftItem.imeis && draftItem.imeis.length > 0) {
                            draftItem.imeis.forEach(imei => {
                                const imeiDocRef = stockDocRef.collection("imeis").doc(imei);
                                tx.set(imeiDocRef, {
                                    status: "disponible",
                                    dateEntree: serverTs,
                                    source: approRef.id
                                });
                            });
                        }
                    }
                }

                totalRemainingAfter += newRemaining;
            });

            if (totalReceivedThisRun <= 0) {
                throw new Error("Aucune quantité valide à réceptionner.");
            }

            receptionRecord.totalValue = receptionValue;

            const totalOrdered = stats.totalOrdered || updatedItems.reduce((sum, itm) => sum + (parseFloat(itm.quantite) || 0), 0);
            const newTotalReceived = (stats.totalReceived || 0) + totalReceivedThisRun;
            const newStats = {
                totalOrdered,
                totalReceived: newTotalReceived,
                totalRemaining: totalRemainingAfter
            };
            const newStatus = totalRemainingAfter > 0 ? 'reception_partielle' : 'reçu';
            const newReceivedTotalCost = existingReceivedTotalCost + receptionValue;
            const newTotalCostValue = totalCostValue + receptionValue;
            const newRemainingAmount = Math.max(0, newReceivedTotalCost - paymentsTotal);
            const paymentMethodResolved = newRemainingAmount > 0 ? 'credit' : 'paid';
            receptionRecord.balanceAfter = paymentsTotal - newReceivedTotalCost;

            tx.update(approRef, {
                items: updatedItems,
                receptionStats: newStats,
                status: newStatus,
                receivedTotalCost: newReceivedTotalCost,
                totalCost: newTotalCostValue,
                remainingAmount: newRemainingAmount,
                paymentMethod: paymentMethodResolved,
                isPaid: newRemainingAmount <= 0,
                netSupplierBalance: (approData.paymentsTotalPaid || 0) - newReceivedTotalCost
            });

            const receptionsRef = approRef.collection("receptions").doc();
            tx.set(receptionsRef, receptionRecord);
        });

        if (transportCost > 0) {
            const transportExpenseCompteId = transportAccountId;
            const transportCompteNom = getCompteNomById(transportExpenseCompteId);
            const now = new Date();
            await dbFirestore.collection("depenses").doc().set({
                montant: transportCost,
                description: `Frais transport réception ${currentReceptionDraft.fournisseur}`,
                type: "depense fonctionnelle",
                timestamp: now.getTime(),
                date: now.toISOString(),
                compteId: transportExpenseCompteId,
                compteNom: transportCompteNom,
                refId: currentReceptionDraft.id
            });
            await enregistrerMouvementTresorerie({
                compteId: transportExpenseCompteId,
                type: 'frais_transport_appro',
                sens: 'out',
                montant: transportCost,
                description: `Frais transport réception ${currentReceptionDraft.fournisseur}`,
                refId: currentReceptionDraft.id
            });
        }

        alert("Réception enregistrée avec succès.");
        const activeTab = document.getElementById('purchase-tabs');
        chargerApprovisionnements(activeTab ? (activeTab.value || 'all') : 'all');
        updateStockSummary();
        updateBalanceDisplay();
        resetCommandeReceptionUI();
        window.location.hash = 'approvisionnement-historique';
    } catch (error) {
        console.error("Erreur lors de la réception :", error);
        alert("Erreur lors de la réception : " + error.message);
    } finally {
        hideSaleLoader();
    }
}

async function ouvrirFournisseurBalance(supplierName, event) {
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    if (!supplierName) {
        return;
    }
    try {
        showSaleLoader();
        const snapshot = await dbFirestore.collection("approvisionnement").where("fournisseur", "==", supplierName).get();
        const orders = [];
        let totalPaid = 0;
        let totalReceived = 0;
        let totalOrderExpected = 0;
        let totalAdvance = 0;
        let totalDue = 0;

        snapshot.forEach(doc => {
            const data = doc.data();
            if (data.status === 'annulé') {
                return;
            }
            const orderValue = parseFloat(data.orderTotalCost || data.totalCost || 0);
            const receivedValue = parseFloat(data.receivedTotalCost || data.totalCost || 0);
            const paidValue = parseFloat(data.paymentsTotalPaid || 0);
            const goodsRemaining = Math.max(0, orderValue - receivedValue);
            const advanceValue = Math.max(0, paidValue - receivedValue);
            const paymentDue = Math.max(0, receivedValue - paidValue);
            totalOrderExpected += orderValue;
            totalReceived += receivedValue;
            totalPaid += paidValue;
            totalAdvance += advanceValue;
            totalDue += paymentDue;
            const timestamp = data.timestamp instanceof firebase.firestore.Timestamp
                ? data.timestamp.toDate()
                : (data.timestamp ? new Date(data.timestamp) : new Date());
            const expectedDate = data.commandeMeta && data.commandeMeta.expectedDate ? data.commandeMeta.expectedDate : null;
            orders.push({
                id: doc.id,
                status: data.status || 'commande',
                typeAchat: data.typeAchat || 'commande',
                orderValue,
                receivedValue,
                goodsRemaining,
                paidValue,
                advanceValue,
                paymentDue,
                remainingAmount: data.remainingAmount !== undefined ? Math.max(0, parseFloat(data.remainingAmount)) : paymentDue,
                expectedDate,
                timestamp,
                paymentMethod: data.paymentMethod || 'credit',
                reference: data.commandeMeta && data.commandeMeta.reference ? data.commandeMeta.reference : doc.id.substring(0, 6).toUpperCase(),
                receptionStats: data.receptionStats || {}
            });
        });

        orders.sort((a, b) => b.timestamp - a.timestamp);
        const goodsRemainingValue = Math.max(0, totalOrderExpected - totalReceived);
        currentSupplierBalanceData = {
            name: supplierName,
            totalPaid,
            totalReceived,
            totalOrderExpected,
            goodsRemainingValue,
            advanceBalance: totalAdvance,
            totalDue,
            orders
        };
        renderSupplierBalanceScreen();
        window.location.hash = 'fournisseur-balance';
    } catch (error) {
        console.error("Erreur chargement balance fournisseur :", error);
        alert("Impossible de charger la balance fournisseur : " + error.message);
    } finally {
        hideSaleLoader();
    }
}

function renderSupplierBalanceScreen() {
    const titleEl = document.getElementById('supplierBalanceTitle');
    const totalPaidEl = document.getElementById('supplierBalanceTotalPaid');
    const totalReceivedEl = document.getElementById('supplierBalanceReceived');
    const toReceiveEl = document.getElementById('supplierBalanceToReceive');
    const advanceEl = document.getElementById('supplierBalanceAdvance');
    const dueEl = document.getElementById('supplierBalanceDue');
    const ordersContainer = document.getElementById('supplierBalanceOrders');
    const paymentAccountSelect = document.getElementById('supplierPaymentAccount');
    const paymentAmountInput = document.getElementById('supplierPaymentAmount');
    const paymentWarningEl = document.getElementById('supplierPaymentWarning');

    if (!titleEl || !totalPaidEl || !totalReceivedEl || !toReceiveEl || !advanceEl || !dueEl || !ordersContainer) {
        return;
    }
    const formatValue = (value) => (Math.round(value || 0)).toLocaleString('fr-FR');

    if (!currentSupplierBalanceData) {
        titleEl.textContent = 'Fournisseur';
        if (paymentAccountSelect) {
            paymentAccountSelect.innerHTML = '<option value=>-- Sélectionner un compte --</option>';
        }
        if (paymentAmountInput) {
            paymentAmountInput.value = '';
        }
        if (paymentWarningEl) {
            paymentWarningEl.textContent = '';
        }
        totalPaidEl.textContent = `${formatValue(0)} FCFA`;
        totalReceivedEl.textContent = `${formatValue(0)} FCFA`;
        toReceiveEl.textContent = `${formatValue(0)} FCFA`;
        advanceEl.textContent = `${formatValue(0)} FCFA`;
        dueEl.textContent = `${formatValue(0)} FCFA`;
        ordersContainer.innerHTML = '<p class="placeholder">Aucun historique.</p>';
        return;
    }

    const data = currentSupplierBalanceData;
    titleEl.textContent = data.name;
    if (paymentAccountSelect) {
        remplirTousSelectComptes(paymentAccountSelect);
        paymentAccountSelect.value = '';
    }
    if (paymentAmountInput) {
        paymentAmountInput.value = '';
    }
    if (paymentWarningEl) {
        paymentWarningEl.textContent = '';
    }
    if (pendingSupplierPaymentFocus && pendingSupplierPaymentFocus === data.name && paymentAmountInput) {
        setTimeout(() => paymentAmountInput.focus(), 0);
        pendingSupplierPaymentFocus = null;
    }
    totalPaidEl.textContent = `${formatValue(data.totalPaid)} FCFA`;
    totalReceivedEl.textContent = `${formatValue(data.totalReceived)} FCFA`;
    toReceiveEl.textContent = `${formatValue(data.goodsRemainingValue)} FCFA`;
    advanceEl.textContent = `${formatValue(data.advanceBalance)} FCFA`;
    dueEl.textContent = `${formatValue(data.totalDue)} FCFA`;

    if (data.orders.length === 0) {
        ordersContainer.innerHTML = '<p class="placeholder">Aucune commande enregistrée pour ce fournisseur.</p>';
        return;
    }

    ordersContainer.innerHTML = '';
    data.orders.forEach(order => {
        const card = document.createElement('div');
        card.className = 'supplier-order-card';
        const statusLabel = order.status === 'reçu'
            ? 'Réception terminée'
            : (order.status === 'reception_partielle' ? 'Réception partielle' : 'Commande en attente');
        const chipClass = order.status === 'reçu'
            ? 'supplier-order-chip completed'
            : (order.status === 'reception_partielle' ? 'supplier-order-chip partial' : 'supplier-order-chip');
        const expectedDisplay = order.expectedDate ? new Date(order.expectedDate).toLocaleDateString('fr-FR') : 'Non défini';
        const receptionStats = order.receptionStats || {};
        const totalOrdered = receptionStats.totalOrdered || 0;
        const totalReceivedUnits = receptionStats.totalReceived || 0;

        card.innerHTML = `
            <header>
                <h3>Commande #${order.reference}</h3>
                <span>${order.timestamp.toLocaleString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</span>
            </header>
            <div class="${chipClass}">${statusLabel}</div>
            <div class="order-meta">
                <span>Articles : ${totalOrdered} &bull; Réceptionnés : ${totalReceivedUnits}</span>
                <span>Livraison prévue : ${expectedDisplay}</span>
            </div>
            <div class="order-amounts">
                <span>Valeur commandée : <strong>${order.orderValue.toLocaleString('fr-FR')} FCFA</strong></span>
                <span>Valeur reçue : <strong>${order.receivedValue.toLocaleString('fr-FR')} FCFA</strong></span>
                <span>Valeur restante : <strong>${order.goodsRemaining.toLocaleString('fr-FR')} FCFA</strong></span>
                <span>Montant payé : <strong>${order.paidValue.toLocaleString('fr-FR')} FCFA</strong></span>
                <span>Avance fournisseur : <strong style="color:${order.advanceValue > 0 ? '#2e7d32' : '#6b7280'}">${order.advanceValue.toLocaleString('fr-FR')} FCFA</strong></span>
                <span>Solde à payer : <strong style="color:${order.paymentDue > 0 ? '#f04141' : '#6b7280'}">${order.paymentDue.toLocaleString('fr-FR')} FCFA</strong></span>
            </div>
        `;
        ordersContainer.appendChild(card);
    });
}


async function chargerDettesFournisseurs() {
    const listEl = document.getElementById('supplierDebtsList');
    const totalDueEl = document.getElementById('supplierDebtsTotalDue');
    const totalAdvanceEl = document.getElementById('supplierDebtsTotalAdvance');
    const dueCountEl = document.getElementById('supplierDebtsDueSuppliers');
    const advanceCountEl = document.getElementById('supplierDebtsAdvanceSuppliers');
    if (!listEl || !totalDueEl || !totalAdvanceEl || !dueCountEl || !advanceCountEl) {
        return;
    }

    listEl.innerHTML = '<p class="placeholder">Chargement des dettes fournisseurs...</p>';

    try {
        const snapshot = await dbFirestore
            .collection("approvisionnement")
            .where("status", "in", ['validé', 'reception_partielle', 'reçu'])
            .get();

        const aggregates = new Map();

        snapshot.forEach(doc => {
            const data = doc.data();
            const received = parseFloat(
                data.receivedTotalCost !== undefined ? data.receivedTotalCost : (data.totalCost || 0)
            );
            if (!(received > 0)) {
                return;
            }
            const paid = parseFloat(data.paymentsTotalPaid || 0);
            const supplier = data.fournisseur || 'Fournisseur Inconnu';

            const entry = aggregates.get(supplier) || {
                totalReceived: 0,
                totalPaid: 0,
                ordersCount: 0,
                lastActivity: null
            };

            entry.totalReceived += received;
            entry.totalPaid += paid;
            entry.ordersCount += 1;

            let timestamp = null;
            if (data.updatedAt && typeof data.updatedAt.toDate === 'function') {
                timestamp = data.updatedAt.toDate();
            } else if (data.timestamp && typeof data.timestamp.toDate === 'function') {
                timestamp = data.timestamp.toDate();
            } else if (data.timestamp) {
                timestamp = new Date(data.timestamp);
            }
            if (timestamp && (!entry.lastActivity || timestamp > entry.lastActivity)) {
                entry.lastActivity = timestamp;
            }

            aggregates.set(supplier, entry);
        });

        currentSupplierDebts = Array.from(aggregates.entries()).map(([name, entry]) => {
            const totalDue = Math.max(0, entry.totalReceived - entry.totalPaid);
            const totalAdvance = Math.max(0, entry.totalPaid - entry.totalReceived);
            if (totalDue === 0 && totalAdvance === 0) {
                return null;
            }
            return {
                name,
                totalDue,
                totalAdvance,
                totalReceived: entry.totalReceived,
                totalPaid: entry.totalPaid,
                ordersCount: entry.ordersCount,
                lastActivity: entry.lastActivity
            };
        }).filter(Boolean);

        currentSupplierDebts.sort((a, b) => {
            const dueDiff = b.totalDue - a.totalDue;
            if (dueDiff !== 0) return dueDiff;
            const advanceDiff = b.totalAdvance - a.totalAdvance;
            if (advanceDiff !== 0) return advanceDiff;
            return a.name.localeCompare(b.name, 'fr');
        });

        const totalDue = currentSupplierDebts.reduce((sum, item) => sum + item.totalDue, 0);
        const totalAdvance = currentSupplierDebts.reduce((sum, item) => sum + item.totalAdvance, 0);
        const suppliersWithDue = currentSupplierDebts.filter(item => item.totalDue > 0).length;
        const suppliersWithAdvance = currentSupplierDebts.filter(item => item.totalAdvance > 0).length;

        totalDueEl.textContent = `${fmt(totalDue)} FCFA`;
        totalAdvanceEl.textContent = `${fmt(totalAdvance)} FCFA`;
        dueCountEl.textContent = `${suppliersWithDue} fournisseur(s)`;
        advanceCountEl.textContent = `${suppliersWithAdvance} fournisseur(s)`;

        const searchInput = document.getElementById('supplierDebtSearch');
        const initialTerm = searchInput ? searchInput.value : '';

        if (currentSupplierDebts.length === 0) {
            listEl.innerHTML = '<p class="placeholder">Aucune dette ni avance fournisseur pour le moment.</p>';
        } else {
            renderSupplierDebtList(initialTerm);
        }

        if (searchInput && !supplierDebtSearchInitialized) {
            searchInput.addEventListener('input', () => renderSupplierDebtList(searchInput.value));
            supplierDebtSearchInitialized = true;
        }
    } catch (error) {
        console.error("Erreur lors du chargement des dettes fournisseurs :", error);
        listEl.innerHTML = '<p class="placeholder">Impossible de charger les dettes fournisseurs.</p>';
    } finally {
        if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
            refreshLucideIcons();
        }
    }
}

function renderSupplierDebtList(searchTerm = '') {
    const listEl = document.getElementById('supplierDebtsList');
    if (!listEl) {
        return;
    }

    const normalized = (searchTerm || '').trim().toLowerCase();
    const rows = normalized
        ? currentSupplierDebts.filter(item => item.name.toLowerCase().includes(normalized))
        : currentSupplierDebts;

    if (rows.length === 0) {
        listEl.innerHTML = normalized
            ? '<p class="placeholder">Aucun fournisseur ne correspond à votre recherche.</p>'
            : '<p class="placeholder">Aucune dette ni avance fournisseur pour le moment.</p>';
        return;
    }

    const html = rows.map(item => {
        const lastActivity = item.lastActivity
            ? item.lastActivity.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' })
            : 'N/A';
        const encodedName = encodeURIComponent(item.name);
        const badges = [
            item.totalDue > 0 ? `<span class="debt-badge due"><i data-lucide="alert-triangle"></i>${fmt(item.totalDue)} FCFA dû</span>` : '',
            item.totalAdvance > 0 ? `<span class="debt-badge advance"><i data-lucide="coins"></i>${fmt(item.totalAdvance)} FCFA en avance</span>` : ''
        ].filter(Boolean).join('');

        return `
        <div class="debt-item ${item.totalDue > 0 ? 'due' : 'advance'}">
          <header>
            <div>
              <h3>${item.name}</h3>
              <p>${item.ordersCount} approvisionnement(s) — Dernière activité : ${lastActivity}</p>
            </div>
            <div class="debt-badges">
              ${badges || '<span class=\"debt-badge advance\"><i data-lucide=\"check-circle\"></i>Aucun solde</span>'}
            </div>
          </header>
          <div class="debt-stats">
            <span>Valeur reçue : <strong>${fmt(item.totalReceived)} FCFA</strong></span>
            <span>Montant payé : <strong>${fmt(item.totalPaid)} FCFA</strong></span>
          </div>
          <div class="debt-actions">
            <button class="btn-modern secondary" onclick="ouvrirFournisseurBalance(decodeURIComponent('${encodedName}'), event)">
              <i data-lucide="list-check"></i> Détails
            </button>
            <button class="btn-modern" onclick="ouvrirPaiementFournisseur(decodeURIComponent('${encodedName}'), event)">
              <i data-lucide="wallet"></i> Payer
            </button>
          </div>
        </div>`;
    }).join('');

    listEl.innerHTML = html;
    if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
        refreshLucideIcons();
    }
}
async function enregistrerPaiementFournisseur() {
    const amountInput = document.getElementById('supplierPaymentAmount');
    const accountSelect = document.getElementById('supplierPaymentAccount');
    const warningEl = document.getElementById('supplierPaymentWarning');

    if (warningEl) {
        warningEl.textContent = '';
    }

    if (!currentSupplierBalanceData) {
        alert("Sélectionnez d'abord un fournisseur.");
        return;
    }

    const amount = amountInput ? parseFloat(amountInput.value) : NaN;
    if (!amountInput || Number.isNaN(amount) || amount <= 0) {
        if (warningEl) {
            warningEl.textContent = 'Saisissez un montant valide.';
        }
        if (amountInput) {
            amountInput.focus();
        }
        return;
    }

    const accountId = accountSelect ? accountSelect.value : '';
    if (!accountId) {
        if (warningEl) {
            warningEl.textContent = 'Sélectionnez un compte de trésorerie.';
        }
        if (accountSelect) {
            accountSelect.focus();
        }
        return;
    }

    const orders = (currentSupplierBalanceData.orders || [])
        .map(order => {
            const outstanding = order.remainingAmount !== undefined
                ? Math.max(0, parseFloat(order.remainingAmount))
                : Math.max(0, (parseFloat(order.receivedValue || 0) - parseFloat(order.paidValue || 0)));
            return { ...order, __outstandingDue: outstanding };
        })
        .filter(order => order.__outstandingDue > 0)
        .sort((a, b) => {
            const dateA = a.timestamp instanceof Date ? a.timestamp.getTime() : 0;
            const dateB = b.timestamp instanceof Date ? b.timestamp.getTime() : 0;
            return dateA - dateB;
        });

    if (!orders.length) {
        alert(`Le fournisseur ${currentSupplierBalanceData.name} n'a pas de dette en cours.`);
        return;
    }

    showSaleLoader();

    try {
        let remaining = amount;
        let totalApplied = 0;
        const batch = dbFirestore.batch();
        const paymentTimestamp = firebase.firestore.Timestamp.now();

        for (const order of orders) {
            if (remaining <= 0) break;
            const due = Math.max(0, order.__outstandingDue || 0);
            if (due <= 0) continue;

            const applied = Math.min(remaining, due);
            const orderRef = dbFirestore.collection('approvisionnement').doc(order.id);
            const newPaid = (parseFloat(order.paidValue || 0) + applied);
            const newReceived = parseFloat(order.receivedValue || 0);
            const newRemaining = Math.max(0, due - applied);
            const newIsPaid = newRemaining <= 0.0001;
            const newAdvance = Math.max(0, newPaid - newReceived);

            batch.update(orderRef, {
                paymentsTotalPaid: newPaid,
                remainingAmount: newRemaining,
                isPaid: newIsPaid,
                paymentMethod: newIsPaid ? 'paid' : 'credit',
                netSupplierBalance: newPaid - newReceived
            });

            const paymentRecordRef = orderRef.collection('payments').doc();
            batch.set(paymentRecordRef, {
                amount: applied,
                date: paymentTimestamp,
                account: accountId,
                refApproId: order.id
            });

            order.paidValue = newPaid;
            order.remainingAmount = newRemaining;
            order.paymentDue = Math.max(0, newReceived - newPaid);
            order.advanceValue = newAdvance;
            order.__outstandingDue = newRemaining;
            order.status = newIsPaid ? 'reçu' : order.status;

            remaining -= applied;
            totalApplied += applied;
        }

        if (totalApplied <= 0) {
            hideSaleLoader();
            if (warningEl) {
                warningEl.textContent = "Aucune dette n'a été trouvée pour ce paiement.";
            }
            return;
        }

        await batch.commit();

        currentSupplierBalanceData.orders = currentSupplierBalanceData.orders.map(original => {
            const updated = orders.find(o => o.id === original.id);
            return updated ? { ...original, ...updated } : original;
        });

        await enregistrerMouvementTresorerie({
            compteId: accountId,
            type: 'paiement_fournisseur',
            sens: 'out',
            montant: totalApplied,
            description: `Paiement fournisseur ${currentSupplierBalanceData.name}`,
            refId: currentSupplierBalanceData.name
        });

        const totals = currentSupplierBalanceData.orders.reduce((acc, order) => {
            const received = parseFloat(order.receivedValue || 0);
            const paid = parseFloat(order.paidValue || 0);
            acc.totalReceived += received;
            acc.totalPaid += paid;
            acc.totalDue += Math.max(0, received - paid);
            acc.totalAdvance += Math.max(0, paid - received);
            return acc;
        }, { totalReceived: 0, totalPaid: 0, totalDue: 0, totalAdvance: 0 });

        currentSupplierBalanceData.totalReceived = totals.totalReceived;
        currentSupplierBalanceData.totalPaid = totals.totalPaid;
        currentSupplierBalanceData.totalDue = totals.totalDue;
        currentSupplierBalanceData.advanceBalance = totals.totalAdvance;

        if (amountInput) {
            amountInput.value = '';
        }
        if (warningEl) {
            const formatCurrency = value => Math.round(value || 0).toLocaleString('fr-FR');
            const leftover = Math.max(0, Math.round(remaining || 0));
            warningEl.textContent = leftover > 0
                ? `Paiement enregistré (${formatCurrency(totalApplied)} FCFA). ${formatCurrency(leftover)} FCFA n'ont pas été appliqués (dettes soldées).`
                : '';
        }

        renderSupplierBalanceScreen();
        chargerDettesFournisseurs();
        updateBalanceDisplay();

    } catch (error) {
        console.error("Erreur lors de l'enregistrement du paiement fournisseur :", error);
        if (warningEl) {
            warningEl.textContent = "Erreur lors de l'enregistrement du paiement.";
        }
        alert("Erreur lors de l'enregistrement du paiement : " + error.message);
    } finally {
        hideSaleLoader();
    }
}


function ouvrirPaiementFournisseur(supplierName, event) {
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    if (!supplierName) {
        return;
    }
    pendingSupplierPaymentFocus = supplierName;
    ouvrirFournisseurBalance(supplierName);
}
async function annulerCommandeFournisseur(approId, event) {
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    if (!approId) {
        return;
    }
    const confirmation = confirm("Êtes-vous sûr de vouloir annuler cette commande ?\n\nLes acomptes enregistrés seront restitués dans la trésorerie.");
    if (!confirmation) {
        return;
    }
    try {
        showSaleLoader();
        const approRef = dbFirestore.collection("approvisionnement").doc(approId);
        const approSnap = await approRef.get();
        if (!approSnap.exists) {
            throw new Error("Cette commande n'existe pas.");
        }
        const approData = approSnap.data();
        if (approData.status !== 'commande' && approData.status !== 'reception_partielle') {
            throw new Error("Seules les commandes en attente peuvent être annulées.");
        }
        const receivedValue = parseFloat(approData.receivedTotalCost || 0);
        if (receivedValue > 0) {
            throw new Error("Impossible d'annuler : cette commande a déjà été réceptionnée. Annulez d'abord la réception pour ces articles.");
        }
        const paymentDetails = Array.isArray(approData.paymentsDetails) ? approData.paymentsDetails.filter(detail => (parseFloat(detail.amount || 0) > 0)) : [];
        const totalRefundAmount = paymentDetails.reduce((sum, detail) => sum + (parseFloat(detail.amount) || 0), 0);
        await dbFirestore.runTransaction(async tx => {
            tx.update(approRef, {
                status: 'annulé',
                cancelledAt: firebase.firestore.FieldValue.serverTimestamp(),
                remainingAmount: 0,
                paymentsTotalPaid: 0,
                paymentsDetails: [],
                netSupplierBalance: 0,
                refundsHistory: firebase.firestore.FieldValue.arrayUnion({
                    at: firebase.firestore.FieldValue.serverTimestamp(),
                    amount: totalRefundAmount,
                    details: paymentDetails
                })
            });
        });
        if (paymentDetails.length > 0) {
            for (const detail of paymentDetails) {
                const montant = parseFloat(detail.amount) || 0;
                if (montant <= 0) continue;
                await enregistrerMouvementTresorerie({
                    compteId: detail.compteId,
                    type: 'annulation_commande',
                    sens: 'in',
                    montant,
                    description: `Annulation commande fournisseur ${approData.fournisseur}`,
                    refId: approId
                });
            }
        }
        const paymentsSnapshot = await approRef.collection("payments").get();
        if (!paymentsSnapshot.empty) {
            const batch = dbFirestore.batch();
            paymentsSnapshot.forEach(paymentDoc => {
                batch.update(paymentDoc.ref, {
                    status: 'annulé',
                    refundedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
            await batch.commit();
        }
        alert("Commande annulée et acomptes remboursés.");
        const activeTab = document.getElementById('purchase-tabs');
        chargerApprovisionnements(activeTab ? (activeTab.value || 'all') : 'all');
        updateBalanceDisplay();
    } catch (error) {
        console.error("Erreur lors de l'annulation de la commande :", error);
        alert("Impossible d'annuler cette commande : " + error.message);
    } finally {
        hideSaleLoader();
    }
}

</script>


    <!--Dépense Fonctionnelle -->
    <section id="screen-depense-fonctionnelle" class="screen">
      <style>
        .form-container {
          padding: 15px;
        }
        .form-section {
          background: var(--white);
          border-radius: var(--border-radius);
          padding: 20px;
          margin-bottom: 15px;
          box-shadow: var(--shadow);
        }
        .form-section h2 {
          text-align: center;
          color: var(--primary-color);
        }
        #formDepenseFonctionnelle input,
        #formDepenseFonctionnelle textarea {
          width: 100%;
          padding: 12px;
          font-size: 16px;
          border: none;
          border-radius: 50px;
          background: #E4E6EB;
          color: #333;
          margin-bottom: 10px;
          box-sizing: border-box;
          outline: none;
        }
        .btn-modern.primary {
          background: var(--primary-color);
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
        }
        .btn-modern.primary i {
          font-size: 20px;
        }
        .back-btn-fb {
          width: 40px;
          height: 40px;
          border: none;
          background: none;
          display: flex;
          align-items: center;
          justify-content: center;
          position: relative;
          border-radius: 50%;
          cursor: pointer;
          overflow: hidden;
          outline: none;
        }
        .back-btn-fb i {
          font-size: 24px;
          color: var(--primary-color);
        }
        .back-btn-fb::after {
          content: '';
          position: absolute;
          top: 50%;
          left: 50%;
          width: 200%;
          height: 200%;
          background: rgba(0, 0, 0, 0.1);
          border-radius: 50%;
          transform: translate(-50%, -50%) scale(0);
          transition: transform 0.3s ease-out;
          pointer-events: none;
        }
        .back-btn-fb:active::after {
          transform: translate(-50%, -50%) scale(1);
        }
      </style>

      <header>
        <button class="back-btn-fb" onclick="window.location.hash='depenses'">
          <i data-lucide="arrow-left"></i>
        </button>
        <h1>Nouvelle Dépense Fonctionnelle</h1>
      </header>

      <div class="form-container">
        <div class="form-section">
          <h2>Ajouter une Dépense</h2>
          <form id="formDepenseFonctionnelle">
            <label for="montantDepense">Montant (FCFA)</label>
            <input type="number" id="montantDepense" placeholder="Montant" required>

            <label for="descriptionDepense">Description</label>
            <textarea id="descriptionDepense" placeholder="Ex: Achat matériel de bureau" required></textarea>

            <label for="compteSelectDepenseFonctionnelle">Compte de trésorerie</label>
            <select id="compteSelectDepenseFonctionnelle"></select>
            <button type="submit" class="btn-modern primary">
              <i data-lucide="plus"></i> Enregistrer Dépense
            </button>
          </form>
        </div>
      </div>

      <script>
        document.getElementById("formDepenseFonctionnelle")
          .addEventListener("submit", function (e) {
            e.preventDefault();
        
            const montant     = parseFloat(document.getElementById("montantDepense").value.trim());
            const description = document.getElementById("descriptionDepense").value.trim();
            const compteId    = document.getElementById("compteSelectDepenseFonctionnelle").value;
        
            if (!montant || montant <= 0 || !description) {
              alert("Montant ou description invalide.");
              return;
            }
        
            enregistrerMouvementTresorerie({
              compteId,
              type   : "depense",
              sens   : "out",
              montant,
              description
            })
            /* ➜ on consigne la dépense pour l'historique */
            .then(() => logDepenseRemboursement({
              collection  : "depenses",
              montant,
              description,
              type        : "depense fonctionnelle"
            }))
            .then(() => {
              alert("Dépense Fonctionnelle enregistrée !");
              document.getElementById("montantDepense").value     = "";
              document.getElementById("descriptionDepense").value = "";
              updateBalanceDisplay();
            })
            .catch(err => alert("Erreur : " + err.message));
        });
        </script>
        
    </section>
    <!-- Screen: Dépense Papa -->
    <section id="screen-depense-papa" class="screen">
      <style>
        .form-container {
          padding: 15px;
        }
        .form-section {
          background: var(--white);
          border-radius: var(--border-radius);
          padding: 20px;
          margin-bottom: 15px;
          box-shadow: var(--shadow);
        }
        .form-section h2 {
          text-align: center;
          color: var(--primary-color);
        }
        /* Même style pour les inputs que pour l'écran Dépense Fonctionnelle */
        #formDepensePapa input,
        #formDepensePapa textarea {
          width: 100%;
          padding: 12px;
          font-size: 16px;
          border: none;
          border-radius: 50px;
          background: #E4E6EB;
          color: #333;
          margin-bottom: 10px;
          box-sizing: border-box;
          outline: none;
        }
        .btn-modern.primary {
          background: var(--primary-color);
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
        }
        .btn-modern.primary i {
          font-size: 20px;
        }
        .back-btn-fb {
          width: 40px;
          height: 40px;
          border: none;
          background: none;
          display: flex;
          align-items: center;
          justify-content: center;
          position: relative;
          border-radius: 50%;
          cursor: pointer;
          overflow: hidden;
          outline: none;
        }
        .back-btn-fb i {
          font-size: 24px;
          color: var(--primary-color);
        }
        .back-btn-fb::after {
          content: '';
          position: absolute;
          top: 50%;
          left: 50%;
          width: 200%;
          height: 200%;
          background: rgba(0, 0, 0, 0.1);
          border-radius: 50%;
          transform: translate(-50%, -50%) scale(0);
          transition: transform 0.3s ease-out;
          pointer-events: none;
        }
        .back-btn-fb:active::after {
          transform: translate(-50%, -50%) scale(1);
        }
      </style>

      <header>
        <button class="back-btn-fb" onclick="window.location.hash='depenses'">
          <i data-lucide="arrow-left"></i>
        </button>
        <h1>Nouvelle Dépense Papa</h1>
      </header>

      <div class="form-container">
        <div class="form-section">
          <h2>Ajouter une Dépense Papa</h2>
          <form id="formDepensePapa">
            <label for="montantDepensePapa">Montant (FCFA)</label>
            <input type="number" id="montantDepensePapa" placeholder="Montant" required>
            <label for="descriptionDepensePapa">Description</label>
            <textarea id="descriptionDepensePapa" placeholder="Ex: Description de la dépense" required></textarea>

            <label for="compteSelectDepensePapa">Compte de trésorerie</label>
            <select id="compteSelectDepensePapa"></select>

            <button type="submit" class="btn-modern primary">
              <i data-lucide="plus"></i> Enregistrer Dépense Papa
            </button>
          </form>
        </div>
      </div>

      <script>
        document.getElementById("formDepensePapa")
          .addEventListener("submit", function (e) {
            e.preventDefault();
        
            const montant     = parseFloat(document.getElementById("montantDepensePapa").value.trim());
            const description = document.getElementById("descriptionDepensePapa").value.trim();
            const compteId    = document.getElementById("compteSelectDepensePapa").value;
        
            if (!montant || montant <= 0 || !description) {
              alert("Montant ou description invalide.");
              return;
            }
        
            enregistrerMouvementTresorerie({
              compteId,
              type   : "papa",
              sens   : "out",
              montant,
              description
            })
            /* ➜ on consigne la dépense pour l'historique */
            .then(() => logDepenseRemboursement({
              collection  : "depenses",
              montant,
              description,
              type        : "papa"
            }))
            .then(() => {
              alert("Dépense Papa enregistrée !");
              document.getElementById("montantDepensePapa").value     = "";
              document.getElementById("descriptionDepensePapa").value = "";
              updateDepensePapaBalance();
              updateBalanceDisplay();
            })
            .catch(err => alert("Erreur : " + err.message));
        });
        </script>
        
          </section>


<!-- Screen X : Panier -->
<section id="screen-panier" class="screen">
  <header>
    <button class="btn-back-panier" onclick="retourAccueilDepuisPanier()">
      <i data-lucide="arrow-left"></i>
      <span>Accueil</span>
    </button>
    <h1>Panier</h1>
    <div class="header-icons">
      <i data-lucide="list"></i>
      <button class="btn-search">
        <i data-lucide="search"></i>
      </button>
    </div>
  </header>

  <div style="padding: 15px;">
    <div id="panierSaleTypeBadge" class="sale-type-badge badge-direct">
      <i data-lucide="shopping-cart"></i>
      <span>Vente directe</span>
    </div>
    <!-- articles injectés par JS -->
    <div id="panierContainer" class="list-container"></div>



  </div>

    <!-- Fixed Cart Footer -->
    <div id="cartFooter" class="cart-footer">
      <div class="footer-info">
        <span class="footer-label">Articles</span>
        <span id="footerQuantity">0</span>
      </div>
      <div class="footer-total">
        <span class="footer-label">Total :</span>
        <span id="footerTotal">0 FCFA</span>
      </div>
      <button id="footerCheckout" class="btn-modern">
        Suivant <i data-lucide="arrow-right"></i>
      </button>
    </div>

    <script>
      document.querySelectorAll('.btn-search').forEach(btn => {
  btn.addEventListener('click', function(e) {
    const circle = document.createElement('span');
    circle.classList.add('ripple');
    const d = Math.max(this.clientWidth, this.clientHeight);
    circle.style.width  = circle.style.height = d + 'px';
    const rect = this.getBoundingClientRect();
    circle.style.left = `${e.clientX - rect.left - d/2}px`;
    circle.style.top  = `${e.clientY - rect.top  - d/2}px`;
    this.appendChild(circle);

    // Au lieu de tout casser de suite, on attend la fin de l'anim :
    circle.addEventListener('animationend', () => {
      circle.remove();
      window.location.hash = 'search-article';
      updateSearchCartBadge();
    });
  });
});

      </script>
      
</section>


<!-- Screen: Remboursement Papa -->
<section id="screen-remboursement-papa" class="screen">
  <style>
    .form-container {
      padding: 15px;
    }
    .form-section {
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: var(--shadow);
    }
    .form-section h2 {
      text-align: center;
      color: var(--primary-color);
    }
    /* Styles pour les inputs */
    #formRemboursementPapa input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 50px;
      background: #E4E6EB;
      color: #333;
      margin-bottom: 10px;
      box-sizing: border-box;
      outline: none;
    }
    .btn-modern.primary {
      background: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-modern.primary i {
      font-size: 20px;
    }
    .back-btn-fb {
      width: 40px;
      height: 40px;
      border: none;
      background: none;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      border-radius: 50%;
      cursor: pointer;
      overflow: hidden;
      outline: none;
    }
    .back-btn-fb i {
      font-size: 24px;
      color: var(--primary-color);
    }
    .back-btn-fb::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 200%;
      height: 200%;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      transform: translate(-50%, -50%) scale(0);
      transition: transform 0.3s ease-out;
      pointer-events: none;
    }
    .back-btn-fb:active::after {
      transform: translate(-50%, -50%) scale(1);
    }
  </style>

  <header>
    <button class="back-btn-fb" onclick="window.location.hash='depenses'">
      <i data-lucide="arrow-left"></i>
    </button>
    <h1>Nouveau Remboursement Papa</h1>
  </header>

  <div class="form-container">
    <div class="form-section">
      <h2>Ajouter un Remboursement Papa</h2>
      <form id="formRemboursementPapa">
         <label for="montantRemboursementPapa">Montant (FCFA)</label>
         <input type="number" id="montantRemboursementPapa" placeholder="Montant" required>

         <label for="compteSelectRemboursementPapa">Compte de trésorerie</label>
        <select id="compteSelectRemboursementPapa"></select>

         <button type="submit" class="btn-modern primary">
           <i data-lucide="plus"></i> Enregistrer Remboursement Papa
         </button>
      </form>
    </div>
  </div>

  <script>
    document.getElementById("formRemboursementPapa")
      .addEventListener("submit", function (e) {
        e.preventDefault();
    
        const montant  = parseFloat(document.getElementById("montantRemboursementPapa").value.trim());
        const compteId = document.getElementById("compteSelectRemboursementPapa").value;
    
        if (!montant || montant <= 0) {
          alert("Montant invalide.");
          return;
        }
    
        enregistrerMouvementTresorerie({
          compteId,
          type   : "remboursement",
          sens   : "in",
          montant,
          description : "Remboursement Papa"
        })
        /* ➜ on consigne le remboursement pour l'historique */
        .then(() => logDepenseRemboursement({
          collection  : "remboursements",
          montant,
          description : "Remboursement Papa"
        }))
        .then(() => {
          alert("Remboursement enregistré !");
          document.getElementById("montantRemboursementPapa").value = "";
          updateDepensePapaBalance();
          updateBalanceDisplay();
        })
        .catch(err => alert("Erreur : " + err.message));
    });
    </script>
    
</section>

<section id="screen-aide-commande" class="screen">
  <div class="aide-commande-wrapper">
    <div class="aide-commande-header">
      <div>
        <h1>Aide commande</h1>
        <p id="aideCommandeRange">Analyse de la semaine en cours.</p>
      </div>
      <p class="aide-commande-helper">
        Identifie les articles vendus récemment et hiérarchisés du plus demandé au moins demandé.
      </p>
    </div>

    <div class="aide-commande-controls">
      <div class="control-group">
        <label for="aideCommandeTimeframe">Période analysée</label>
        <select id="aideCommandeTimeframe" class="aide-commande-select">
          <option value="semaine">Cette semaine</option>
          <option value="deux_semaines">Deux dernières semaines</option>
        </select>
      </div>
    </div>

    <div class="aide-commande-summary">
      <div class="aide-commande-card">
        <span>Articles suivis</span>
        <strong id="aideCommandeSummaryArticles">0</strong>
        <small>Nombre d'articles vendus sur la période</small>
      </div>
      <div class="aide-commande-card">
        <span>Unités vendues</span>
        <strong id="aideCommandeSummaryQuantities">0</strong>
        <small>Total des quantités vendues</small>
      </div>
      <div class="aide-commande-card">
        <span>Alertes stock</span>
        <strong id="aideCommandeSummaryAlerts">0</strong>
        <small>Articles en rupture ou stock ≤ 1</small>
      </div>
    </div>

    <div class="aide-commande-section">
      <h2>Classement des articles vendus</h2>
      <div id="aideCommandeTopList" class="aide-commande-empty">Analyse en cours...</div>
    </div>

    <div class="aide-commande-section">
      <h2>Alertes de réapprovisionnement</h2>
      <div class="aide-commande-filters">
        <div class="control-group">
          <label for="aideCommandeSupplierFilter">Filtrer par fournisseur</label>
          <select id="aideCommandeSupplierFilter" class="aide-commande-select">
            <option value="all">Tous les fournisseurs</option>
          </select>
        </div>
      </div>
      <div id="aideCommandeAlertsList" class="aide-commande-empty">Analyse en cours...</div>
    </div>
  </div>
</section>

    <button id="livraisonsQuickButton" class="livraison-count-btn" onclick="ouvrirLivraisonsDepuisBadge()">
      <i data-lucide="truck"></i>
      <span>Livraisons en cours : <strong id="livraisonsEnCoursBadge">0</strong></span>
    </button>

    <!-- Bottom Navigation Modernisée (Navigation par hash) -->
    <nav class="bottom-nav-pro">
      <div class="nav-item" id="nav-accueil" onclick="window.location.hash='accueil'">
        <i data-lucide="layout-dashboard"></i>
        <span>Accueil</span>
      </div>
      <div class="nav-item" id="nav-tresorerie" onclick="window.location.hash='tresorerie'">
  <i data-lucide="dollar-sign"></i> <span>Trésorerie</span>
</div>
      <div class="nav-item" id="nav-historique" onclick="window.location.hash='historique'">
        <i data-lucide="clock"></i>
        <span>Historique</span>
      </div>
      <div class="nav-item" id="nav-appro-hist" onclick="window.location.hash='approvisionnement-historique'">
        <i data-lucide="archive"></i> <span>Achats</span>
    </div>
      <div class="nav-item" id="nav-aide-commande" onclick="window.location.hash='aide-commande'">
        <i data-lucide="life-buoy"></i>
        <span>Aide commande</span>
      </div>
      <div class="nav-item" id="nav-dettes-fournisseurs" onclick="window.location.hash='dettes-fournisseurs'">
        <i data-lucide="receipt-text"></i>
        <span>Dettes</span>
      </div>
      <div class="nav-item" id="nav-menu" onclick="window.location.hash='menu'">
        <i data-lucide="menu"></i>
        <span>Menu</span>
  </div>
    </nav>
  </div>

  <!-- Modal: Choix du type de vente -->
  <div id="modalSaleType" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fermerModalTypeVente()">&times;</span>
      <h2>Quel type de vente ?</h2>
      <p style="text-align:center; color: var(--text-color); margin-bottom: 10px;">
        Choisissez le mode d'enregistrement.
      </p>
      <div class="sale-type-options">
        <button type="button" class="btn-modal-option direct" onclick="selectionnerTypeVente('direct')">
          <i data-lucide="shopping-cart"></i>
          Vente directe
        </button>
        <button type="button" class="btn-modal-option delivery" onclick="selectionnerTypeVente('delivery')">
          <i data-lucide="truck"></i>
          Livraison
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Encaissement livraison -->
  <div id="modalLivraisonEncaissement" class="modal">
    <div class="modal-content modal-livraison">
      <span class="close" onclick="fermerModalLivraisonEncaissement()">&times;</span>
      <h2>Encaisser la livraison</h2>
      <p class="modal-subtitle">Ajustez les encaissements avant de clôturer la livraison.</p>
      <div class="vente-payments-block livraison-payments-block">

        <div class="vente-payments-header">
          <span>Encaissements</span>
          <button type="button" class="btn-modern secondary" onclick="ajouterLignePaiementLivraison()">
            <i data-lucide="plus-circle"></i> Ajouter un encaissement
          </button>
        </div>

        <div id="livraisonPaymentsContainer" class="vente-payments-container"></div>

        <div class="vente-payments-summary">
          <p>Montant à encaisser : <strong id="livraison-summary-total-due">0 FCFA</strong></p>
          <p>Total encaissé : <strong id="livraison-summary-total-paid">0 FCFA</strong></p>
          <p>Monnaie rendue : <strong id="livraison-summary-total-change">0 FCFA</strong></p>
          <p>Net encaissé : <strong id="livraison-summary-net">0 FCFA</strong></p>
          <p id="livraison-payment-warning" class="vente-payment-warning"></p>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn-modern secondary" onclick="fermerModalLivraisonEncaissement()">Annuler</button>
        <button class="btn-modern" onclick="validerEncaissementLivraison()">
          <i data-lucide="check-circle"></i> Valider l'encaissement
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Détail d'un mouvement d'achat -->
  <div id="modalStockPurchase" class="modal">
    <div class="modal-content purchase-modal-content">
      <span class="close" onclick="fermerModalStockPurchase()">&times;</span>
      <div id="modalStockPurchaseBody" class="purchase-modal-body">
        <p style="text-align:center; color:#6b7280;">Chargement du detail d'achat...</p>
      </div>
    </div>
  </div>

  <!-- Modal: Ajustement de stock -->
  <div id="modalStockAdjustment" class="modal">
    <div class="modal-content stock-adjust-modal">
      <span class="close" onclick="fermerModalAjustementStock()">&times;</span>
      <h2>Ajustement de stock</h2>
      <p class="stock-adjust-hint">
        Indiquez la variation souhaitée. Utilisez un nombre positif pour augmenter et un nombre négatif pour diminuer.
      </p>
      <form id="formStockAdjustment" class="stock-adjust-form" onsubmit="event.preventDefault(); soumettreAjustementStock();">
        <label for="adjustStockQuantity">Quantité à ajuster</label>
        <input type="number" id="adjustStockQuantity" step="1" placeholder="+5 ou -2" required>

        <label for="adjustStockReason">Commentaire</label>
        <textarea id="adjustStockReason" rows="3" placeholder="Expliquez la raison de l'ajustement" required></textarea>

        <p id="adjustStockError" class="stock-adjust-error" style="display:none;"></p>

        <div class="stock-adjust-actions">
          <button type="button" class="btn-modern secondary" onclick="fermerModalAjustementStock()">Annuler</button>
          <button type="submit" class="btn-modern">Valider l'ajustement</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Modal: Performance utilisateur -->
  <div id="modalPerformance" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fermerModalPerformance()">&times;</span>
      <h2>Ma performance</h2>
      <div id="performanceLoader" class="performance-loader">Calcul en cours...</div>
      <div id="performanceMetrics" class="performance-metrics"></div>
      <p id="performanceSummary" class="performance-empty"></p>
    </div>
  </div>

  <!-- Modal: Confirmation clôture -->
  <div id="modalCloseDay" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fermerModalCloseDay()">&times;</span>
      <h2>Clôturer la journée</h2>
      <p style="color: var(--secondary-color); margin-bottom: 12px;">
        Cette action va exécuter plusieurs opérations irréversibles :
      </p>
      <ul class="modal-warning-list">
        <li>Enregistrer le snapshot de trésorerie avec les soldes du jour.</li>
        <li>Préparer les soldes d’ouverture du lendemain.</li>
        <li>Capturer l’inventaire des téléphones pour l’ouverture de demain.</li>
        <li>Générer et lancer l’impression du rapport PDF de clôture.</li>
      </ul>
      <p style="color: var(--text-color); font-size: 14px;">
        Assurez-vous d’avoir saisi toutes les ventes, dépenses et mouvements avant de valider.
      </p>
      <div class="modal-actions">
        <button class="btn-modern secondary" onclick="fermerModalCloseDay()">Annuler</button>
        <button class="btn-modern" onclick="validerClotureJournee()">Valider maintenant</button>
      </div>
    </div>
  </div>
  
  <!-- Modal: Détails d'une vente -->
  <div id="modalDetail" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fermerModal()">&times;</span>
      <h2>Détails de la Vente</h2>
      <div id="detailContent"></div>
    </div>
  </div>
  
<ion-modal id="editClientNameModal">
  <ion-header class="ion-no-border">
    <ion-toolbar>
      <ion-buttons slot="start">
        <ion-button onclick="fermerModalModifierClientNom()">
          <ion-icon name="close-outline"></ion-icon>
        </ion-button>
      </ion-buttons>
      <ion-title>Nouveau vendeur</ion-title> <ion-buttons slot="end">
        <ion-button onclick="enregistrerNouveauVendeur()"> Enregistrer
        </ion-button>
      </ion-buttons>
    </ion-toolbar>
  </ion-header>
  <ion-content class="ion-padding">
    <form id="formModifierClientNomIonic" onsubmit="event.preventDefault();">
      <ion-item>
        <ion-input label="Nom *" label-placement="floating" type="text" id="inputClientNomEditIonic" required></ion-input>
      </ion-item>

      <ion-item>
        <ion-input label="Email" label-placement="floating" type="email" id="inputClientEmailEditIonic" placeholder="(facultatif)"></ion-input>
      </ion-item>

      </form>
  </ion-content>
</ion-modal>
<style>
  /* Styles spécifiques pour la modale de modification du client (Ionic) */
#editClientNameModal ion-header {
  /* Assure que le header est plat comme dans l'exemple Ionic par défaut */
  box-shadow: none !important;
  border-bottom: 1px solid #e0e0e0; /* Une fine ligne pour séparer du contenu */
}

#editClientNameModal ion-toolbar {
  /* Fond blanc pour la toolbar */
  --background: #ffffff;
  /* Assure qu'il n'y a pas d'ombre par défaut si votre thème en ajoute */
  --box-shadow: none;
  --border-width: 0;
}

#editClientNameModal ion-title {
  /* Centre le titre par défaut */
  text-align: center;
  font-weight: 600; /* Plus gras pour le titre */
  color: #333; /* Couleur de texte sombre */
}

#editClientNameModal ion-buttons {
  /* Assure un espacement correct pour les boutons */
  padding-right: 8px; /* Pour le bouton "Enregistrer" */
  padding-left: 8px; /* Pour le bouton "Fermer" */
}

#editClientNameModal ion-button {
  /* Styles pour les boutons dans la toolbar */
  --color: var(--primary-color, #006064); /* Couleur bleue/verte pour les icônes/texte des boutons */
  font-weight: 500;
  text-transform: none; /* Ne pas mettre en majuscules pour le texte "Enregistrer" */
}

#editClientNameModal ion-button ion-icon {
  font-size: 24px; /* Taille de l'icône de fermeture */
}

#editClientNameModal ion-content {
  --background: #f5f7fa; /* Un fond légèrement gris pour le contenu de la modale */
}

#editClientNameModal ion-item {
  /* Arrière-plan blanc pour les éléments de liste (inputs) */
  --background: #ffffff;
  /* Enlève la bordure inférieure par défaut des ion-item si elle n'est pas souhaitée,
     ou ajustez-la pour correspondre au design de l'image (pas de ligne visible entre Nom et Email). */
  --border-width: 0;
  border-radius: 8px; /* Coins légèrement arrondis pour les inputs */
  margin-bottom: 10px; /* Espace entre les champs */
  box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* Une ombre légère pour la profondeur */
}
/* Style pour le bouton Modifier sur les cartes de vente */
/* Style pour le bouton Modifier sur les cartes de vente */
.edit-client-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  background-color: rgba(128, 128, 128, 0.15); /* Gris semi-transparent */
  border: none;
  color: #333; /* Couleur de l'icône par défaut du bouton */
  cursor: pointer;
  width: 36px; /* Taille plus grande pour le bouton (cercle) */
  height: 36px; /* Taille plus grande pour le bouton (cercle) */
  display: flex; /* Pour centrer l'icône */
  align-items: center; /* Pour centrer l'icône */
  justify-content: center; /* Pour centrer l'icône */
  border-radius: 50%; /* Pour un cercle parfait */
  transition: background-color 0.2s ease, color 0.2s ease;
  z-index: 10;
}

/* Cibler spécifiquement l'icône Lucide à l'intérieur du bouton */
.edit-client-btn i[data-lucide] {
  font-size: 20px; /* Taille légèrement plus grande pour l'icône */
  color: #333; /* S'assurer que l'icône est sombre */
  /* Supprimez margin-right ou d'autres styles qui pourraient être hérités et qui décalent l'icône */
  margin-right: 0;
}

.edit-client-btn:hover {
  background-color: rgba(128, 128, 128, 0.25); /* Effet plus prononcé au survol */
  /* La couleur de l'icône au survol peut être ajustée ici si nécessaire */
  color: #000;
}

.edit-client-btn:hover i[data-lucide] { /* S'assurer que l'icône change de couleur au survol */
    color: #000;
}

.edit-client-btn:active {
  background-color: rgba(128, 128, 128, 0.35); /* Effet au clic */
  /* La couleur de l'icône au clic peut être ajustée ici si nécessaire */
  color: #000;
}

.edit-client-btn:active i[data-lucide] { /* S'assurer que l'icône change de couleur au clic */
    color: #000;
}
</style>
<script>
  /**
 * Ouvre la modale Ionic pour modifier les informations du client/vendeur.
 * Pré-remplit les champs avec les données existantes si fournies.
 * @param {object} [data=null] - Objet contenant les données à pré-remplir (ex: { nom: '...', email: '...' }).
 */
async function ouvrirModalModifierClientNom(data = null) {
  const modal = document.getElementById('editClientNameModal');
  if (modal) {
    if (data) {
      // Pré-remplir les champs si des données sont passées
      document.getElementById('inputClientNomEditIonic').value = data.nom || '';
      document.getElementById('inputClientEmailEditIonic').value = data.email || '';
    } else {
      // Vider les champs si aucune donnée n'est passée (pour un "Nouveau Vendeur" par exemple)
      document.getElementById('inputClientNomEditIonic').value = '';
      document.getElementById('inputClientEmailEditIonic').value = '';
    }
    await modal.present(); // Utilise la méthode 'present()' d'Ionic pour afficher la modale
  }
}

/**
 * Ferme la modale Ionic de modification du client/vendeur.
 */
async function fermerModalModifierClientNom() {
  const modal = document.getElementById('editClientNameModal');
  if (modal) {
    await modal.dismiss(); // Utilise la méthode 'dismiss()' d'Ionic pour fermer la modale
  }
}

/**
 * Fonction placeholder pour l'enregistrement du nouveau vendeur.
 * Sera implémentée dans une étape ultérieure.
 */
function enregistrerNouveauVendeur() {
  const nom = document.getElementById('inputClientNomEditIonic').value;
  const email = document.getElementById('inputClientEmailEditIonic').value;
  console.log(`Enregistrer: Nom = ${nom}, Email = ${email}`);
  showToast("Fonction d'enregistrement à implémenter."); // Utilise votre fonction showToast existante
  fermerModalModifierClientNom();
}

let currentSaleIdForClientEdit = null; // Variable pour stocker l'ID de la vente en cours de modification

/**
 * Prépare les données du client et ouvre la modale de modification.
 * @param {string} saleId - L'ID de la vente dont le client doit être modifié.
 * @param {string} clientNom - Le nom actuel du client.
 * @param {string} clientNumero - Le numéro de téléphone/WhatsApp actuel du client.
 */
function preparerModificationClient(saleId, clientNom, clientNumero) {
  currentSaleIdForClientEdit = saleId; // Stocke l'ID de la vente
  ouvrirModalModifierClientNom({
    nom: clientNom,
    email: clientNumero // On utilise le champ "email" de la modale pour le numéro WhatsApp temporairement
  });
  // Mettez à jour le titre de la modale pour indiquer "Modifier client" au lieu de "Nouveau vendeur"
  const modalTitle = document.querySelector('#editClientNameModal ion-title');
  if (modalTitle) {
      modalTitle.textContent = 'Modifier le client';
  }
  // On va aussi changer le texte du bouton "Enregistrer" en "Modifier"
  const saveButton = document.querySelector('#editClientNameModal ion-buttons[slot="end"] ion-button');
  if (saveButton) {
      saveButton.textContent = 'Modifier';
      // Et on va changer son action pour appeler une nouvelle fonction de mise à jour
      saveButton.onclick = enregistrerModificationClient; // Nouvelle fonction pour la mise à jour
  }
}

/**
 * Enregistre la modification du nom et/ou du numéro du client dans Firestore.
 */
async function enregistrerModificationClient() {
  if (!currentSaleIdForClientEdit) {
    showToast("Erreur: ID de vente non défini pour la modification.");
    return;
  }

  const nouveauNom = document.getElementById('inputClientNomEditIonic').value.trim();
  const nouveauNumero = document.getElementById('inputClientEmailEditIonic').value.trim(); // Utilisé pour le numéro WhatsApp

  if (!nouveauNom) {
    showToast("Le nom du client ne peut pas être vide.", "error");
    return;
  }

  showSaleLoader(); // Afficher le loader

  try {
    // Mettre à jour le document de vente dans Firestore
    await dbFirestore.collection("ventes").doc(currentSaleIdForClientEdit).update({
      clientNom: nouveauNom,
      clientNumero: nouveauNumero // Mettre à jour le numéro WhatsApp
    });

    // Fermer la modale
    fermerModalModifierClientNom();
    // Afficher un message de succès
    showToast("Nom et numéro du client mis à jour avec succès !");
    // Recharger l'historique des ventes pour que les changements soient visibles
    filterSalesHistory(document.getElementById('sales-tabs').value); // Recharger le filtre actuel
  } catch (error) {
    console.error("Erreur lors de la mise à jour du client:", error);
    showToast("Erreur lors de la mise à jour du client: " + error.message, "error");
  } finally {
    hideSaleLoader(); // Cacher le loader
    currentSaleIdForClientEdit = null; // Réinitialiser l'ID de la vente en cours de modification
  }
}
</script>
  
  <!-- Modal pour ajouter une opération -->
  <div id="modalAjoutOperation" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fermerModalTresorerie()">&times;</span>
      <h2>Ajouter une Opération</h2>
      <form class="vente-form">
        <label for="typeOperation">Type d'opération</label>
        <select id="typeOperation">
          <option value="entree">Entrée (Vente)</option>
          <option value="sortie">Dépense</option>
        </select>

        <label for="montantOperation">Montant</label>
        <input type="number" id="montantOperation" placeholder="Montant en FCFA" required>

        <label for="descriptionOperation">Observations</label>
        <textarea id="descriptionOperation" placeholder="Observations (facultatif)"></textarea>

        <button type="button" class="btn-modern" onclick="ajouterOperationTresorerie()">Ajouter</button>
      </form>
    </div>
  </div>


  <!-- Modal pour effectuer un virement entre comptes -->
  <div id="modalVirementTresorerie" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fermerModalVirementTresorerie()">&times;</span>
      <h2>Virement entre comptes</h2>
      <form class="vente-form" id="formVirementTresorerie" onsubmit="soumettreVirementTresorerie(event)">
        <label for="compteSelectSource">Depuis le compte</label>
        <select id="compteSelectSource" required></select>

        <label for="compteSelectDestination">Vers le compte</label>
        <select id="compteSelectDestination" required></select>

        <label for="montantVirement">Montant (FCFA)</label>
        <input type="number" id="montantVirement" min="1" step="1" placeholder="Montant a transferer" required>

        <label for="descriptionVirement">Observations</label>
        <textarea id="descriptionVirement" placeholder="Note (facultatif)"></textarea>

        <button type="submit" class="btn-modern">Valider le virement</button>
      </form>
    </div>
  </div>

  <!-- Overlay affiche lorsqu'on est hors ligne -->
  <div id="offlineOverlay" style="
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6);
  color: white;
  font-size: 18px;
  align-items: center;
  justify-content: center;
  z-index: 10000;
">
  Pas de connexion. Veuillez vous reconnecter.
</div>


  
  <script>
    // Préloader
    window.addEventListener('load', function() {
      const preloader = document.getElementById('preloader');
      preloader.style.opacity = '0';
      setTimeout(() => { preloader.style.display = 'none'; }, 500);
    });

    // Toast Notification
    function showToast(message) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.style.display = "block";
      setTimeout(() => { toast.style.display = "none"; }, 3000);
    }

    // Gestion des clients (étape vente)
    let clientsCache = [];
    let clientsCacheLoaded = false;
    let clientsLoadingPromise = null;
    let clientSearchMode = 'nom';
    let selectedClientId = null;
    let currentClientType = '';

    function normalizeClientType(value, fallback = '') {
      if (typeof value !== 'string') return fallback;
      const normalized = value.trim().toLowerCase();
      if (normalized === 'revendeur') return 'revendeur';
      if (normalized === 'ordinaire' || normalized === 'client' || normalized === 'standard') return 'ordinaire';
      return fallback;
    }

    function setClientType(type) {
      const normalizedType = type ? normalizeClientType(type, '') : '';
      currentClientType = normalizedType;
      const hiddenInput = document.getElementById('clientType');
      if (hiddenInput) {
        hiddenInput.value = normalizedType;
      }
      const chips = document.querySelectorAll('#clientCard .client-type-chip');
      chips.forEach(chip => {
        chip.classList.toggle('active', chip.dataset.type === normalizedType);
      });
      updateClientSelectedSummary();
    }

    function openClientSelection() {
      ensureClientsCache();
      window.location.hash = 'choisir-client';
    }

    function openCreateClientPage() {
      resetCreateClientForm();
      window.location.hash = 'ajouter-client';
    }

    function openClientSelectionFromCreate() {
      resetCreateClientForm();
      window.location.hash = 'choisir-client';
    }

    function openLivreurSelection() {
      ensureLivreursCache();
      window.location.hash = 'choisir-livreur';
    }

    function openCreateLivreurPage() {
      resetCreateLivreurForm();
      window.location.hash = 'ajouter-livreur';
    }

    function openLivreurSelectionFromCreate() {
      resetCreateLivreurForm();
      window.location.hash = 'choisir-livreur';
    }

    function returnToSaleFromSelection() {
      window.location.hash = 'vendre';
      setTimeout(() => {
        if (typeof showStep === 'function') {
          showStep(currentStep);
        }
        if (typeof lucide !== 'undefined') {
          refreshLucideIcons();
        }
      }, 60);
    }

    function resetCreateClientForm() {
      const nameInput = document.getElementById('newClientName');
      const phoneInput = document.getElementById('newClientPhone');
      const feedback = document.getElementById('clientCreateFeedback');
      const submitBtn = document.getElementById('createClientSubmitBtn');
      if (nameInput) nameInput.value = '';
      if (phoneInput) phoneInput.value = '';
      document.querySelectorAll('input[name="newClientType"]').forEach(radio => {
        radio.checked = false;
      });
      if (feedback) {
        feedback.style.display = 'none';
        feedback.textContent = '';
      }
      if (submitBtn) submitBtn.disabled = false;
    }

    function resetCreateLivreurForm() {
      const nameInput = document.getElementById('newLivreurName');
      const phoneInput = document.getElementById('newLivreurPhone');
      const feedback = document.getElementById('livreurCreateFeedback');
      const submitBtn = document.getElementById('createLivreurSubmitBtn');
      if (nameInput) nameInput.value = '';
      if (phoneInput) phoneInput.value = '';
      if (feedback) {
        feedback.style.display = 'none';
        feedback.textContent = '';
      }
      if (submitBtn) submitBtn.disabled = false;
    }

    function setupClientSelectionScreen() {
      ensureClientsCache();
      setClientSearchMode(clientSearchMode, { keepValue: true, preserveFeedback: true });
      const input = document.getElementById('clientSearchInput');
      if (input && !input.dataset.bound) {
        input.dataset.bound = 'true';
        input.addEventListener('input', () => searchClientsVente());
      }
      searchClientsVente();
      if (typeof lucide !== 'undefined') {
        refreshLucideIcons();
      }
    }

    function setupLivreurSelectionScreen() {
      ensureLivreursCache();
      setLivreurSearchMode(livreurSearchMode, { keepValue: true, preserveFeedback: true });
      const input = document.getElementById('livreurSearchInput');
      if (input && !input.dataset.bound) {
        input.dataset.bound = 'true';
        input.addEventListener('input', () => searchLivreurs());
      }
      searchLivreurs();
      if (typeof lucide !== 'undefined') {
        refreshLucideIcons();
      }
    }

    function ensureClientsCache() {
      if (clientsCacheLoaded) return Promise.resolve(clientsCache);
      if (clientsLoadingPromise) return clientsLoadingPromise;
      clientsLoadingPromise = dbFirestore.collection('clients')
        .get()
        .then(snapshot => {
          clientsCache = [];
          snapshot.forEach(doc => {
            const data = doc.data() || {};
            clientsCache.push({
              id: doc.id,
              nom: data.nom || data.name || '',
              numero: data.numero || data.telephone || data.phone || '',
              ...data
            });
          });
          clientsCacheLoaded = true;
          return clientsCache;
        })
        .catch(error => {
          console.error('Erreur lors du chargement des clients :', error);
          clientsCacheLoaded = true;
          clientsCache = [];
          return clientsCache;
        })
        .finally(() => {
          clientsLoadingPromise = null;
        });
      return clientsLoadingPromise;
    }

    function setClientSearchMode(mode, options = {}) {
      if (mode !== 'nom' && mode !== 'numero') return;
      clientSearchMode = mode;
      const chips = document.querySelectorAll('#screen-choisir-client .client-search-chip');
      if (chips.length) {
        chips.forEach(chip => {
          chip.classList.toggle('active', chip.dataset.mode === mode);
        });
      }
      const input = document.getElementById('clientSearchInput');
      if (input) {
        input.placeholder = mode === 'nom'
          ? 'Rechercher un client par nom'
          : 'Rechercher un client par numéro';
        if (!options.keepValue) {
          input.value = '';
        }
        if (!options.skipFocus) {
          input.focus();
        }
        if (!options.keepValue) {
          searchClientsVente();
        }
      }
      const feedback = document.getElementById('clientSearchFeedback');
      if (feedback && !options.preserveFeedback) {
        feedback.textContent = 'Tapez pour lancer la recherche.';
        feedback.style.color = '#6b7280';
      }
    }

    function initClientSearchStep() {
      ensureClientsCache();
      selectedClientId = document.getElementById('clientId')?.value || null;
      setClientType(document.getElementById('clientType')?.value || currentClientType || '');
      updateClientSelectedSummary();
      if (typeof lucide !== 'undefined') {
        refreshLucideIcons();
      }
    }

    function searchClientsVente() {
      const input = document.getElementById('clientSearchInput');
      const feedback = document.getElementById('clientSearchFeedback');
      const resultsContainer = document.getElementById('clientSearchResults');
      if (!input || !resultsContainer) return;

      const query = input.value.trim();
      if (query.length === 0) {
        if (feedback) {
          feedback.textContent = 'Tapez pour lancer la recherche.';
          feedback.style.color = '#6b7280';
        }
        resultsContainer.innerHTML = '';
        return;
      }

      ensureClientsCache().then(list => {
        const normalized = clientSearchMode === 'numero'
          ? query.replace(/\s+/g, '').toLowerCase()
          : query.toLowerCase();

        const filtered = list.filter(client => {
          if (clientSearchMode === 'nom') {
            return (client.nom || '').toLowerCase().includes(normalized);
          }
          const numero = (client.numero || '').replace(/\s+/g, '').toLowerCase();
          return numero.includes(normalized);
        }).slice(0, 30);

        renderClientResults(filtered);
        if (feedback) {
          if (filtered.length === 0) {
            feedback.textContent = 'Aucun client trouvé. Utilisez le bouton + pour en créer un.';
            feedback.style.color = '#b91c1c';
          } else {
            feedback.textContent = `${filtered.length} client(s) trouvé(s).`;
            feedback.style.color = '#2563eb';
          }
        }
      });
    }

    function renderClientResults(results) {
      const container = document.getElementById('clientSearchResults');
      if (!container) return;
      container.innerHTML = '';
      if (!Array.isArray(results) || results.length === 0) return;

      results.forEach(client => {
        const item = document.createElement('div');
        item.className = 'client-search-result';
        item.dataset.clientId = client.id || '';
        if (client.id && client.id === selectedClientId) {
          item.classList.add('selected');
        }
        const numeroDisplay = client.numero ? client.numero : 'Numéro non renseigné';
        const typeValue = normalizeClientType(client.typeClient || client.clientType || client.type, '');
        const typeLabel = typeValue === 'revendeur' ? 'Revendeur' : typeValue === 'ordinaire' ? 'Client ordinaire' : '';
        const typeBadge = typeLabel ? `<span class="client-type-tag ${typeValue}">${typeLabel}</span>` : '';
        item.innerHTML = `
          <div>
            <h4>${client.nom || 'Client sans nom'}</h4>
            <span>${numeroDisplay}</span>
            ${typeBadge}
          </div>
        `;
        item.addEventListener('click', () => {
          selectClientForSale(client);
        });
        container.appendChild(item);
      });
    }

    function selectClientForSale(client) {
      if (!client) return;
      selectedClientId = client.id || null;
      const nomInput = document.getElementById('clientNom');
      const numeroInput = document.getElementById('clientNumero');
      const idInput = document.getElementById('clientId');
      if (nomInput) nomInput.value = client.nom || '';
      if (numeroInput) numeroInput.value = client.numero || '';
      if (idInput) idInput.value = client.id || '';
      const detectedType = normalizeClientType(client.typeClient || client.clientType || client.type, '');
      if (detectedType) {
        setClientType(detectedType);
      } else {
        setClientType('');
      }
      const items = document.querySelectorAll('#clientSearchResults .client-search-result');
      items.forEach(item => {
        item.classList.toggle('selected', item.dataset.clientId === (client.id || ''));
      });
      if (typeof lucide !== 'undefined') {
        refreshLucideIcons();
      }
      if (typeof showToast === 'function' && client.nom) {
        showToast(`Client ${client.nom} sélectionné.`);
      }
      if (window.location.hash === '#choisir-client' || window.location.hash === '#ajouter-client') {
        setTimeout(() => returnToSaleFromSelection(), 50);
      }
    }

    function updateClientSelectedSummary() {
      const summary = document.getElementById('clientSelectedSummary');
      const textEl = document.getElementById('clientSelectedText');
      const nom = document.getElementById('clientNom')?.value.trim() || '';
      const numero = document.getElementById('clientNumero')?.value.trim() || '';
      const typeValue = document.getElementById('clientType')?.value || currentClientType || '';
      const typeLabel = typeValue === 'revendeur' ? 'Revendeur' : typeValue === 'ordinaire' ? 'Client ordinaire' : 'Type à préciser';
      if (!summary || !textEl) return;
      if (nom) {
        const base = numero ? `${nom} (${numero})` : nom;
        textEl.textContent = `${base} - ${typeLabel}`;
      } else {
        textEl.textContent = 'Aucun client sélectionné.';
      }
    }

    function clearSelectedClient() {
      selectedClientId = null;
      const nomInput = document.getElementById('clientNom');
      const numeroInput = document.getElementById('clientNumero');
      const idInput = document.getElementById('clientId');
      if (nomInput) nomInput.value = '';
      if (numeroInput) numeroInput.value = '';
      if (idInput) idInput.value = '';
      setClientType('');
      updateClientSelectedSummary();
      const items = document.querySelectorAll('#clientSearchResults .client-search-result');
      items.forEach(item => item.classList.remove('selected'));
      const input = document.getElementById('clientSearchInput');
      if (input) {
        input.value = '';
        input.focus();
      }
      const feedback = document.getElementById('clientSearchFeedback');
      if (feedback) {
        feedback.textContent = 'Tapez pour lancer la recherche.';
        feedback.style.color = '#6b7280';
      }
      const results = document.getElementById('clientSearchResults');
      if (results) results.innerHTML = '';
    }

function createClientFromSale() {
      const nameInput = document.getElementById('newClientName');
      const phoneInput = document.getElementById('newClientPhone');
      const feedback = document.getElementById('clientCreateFeedback');
      const submitBtn = document.getElementById('createClientSubmitBtn');
      if (!nameInput || !phoneInput) return;

      const nom = nameInput.value.trim();
      const numero = phoneInput.value.trim();
      const typeChoice = document.querySelector('input[name="newClientType"]:checked');
      const typeValue = typeChoice ? normalizeClientType(typeChoice.value, '') : '';

      if (feedback) {
        feedback.style.display = 'none';
        feedback.textContent = '';
      }

      if (!nom) {
        if (feedback) {
          feedback.style.display = 'block';
          feedback.style.color = '#b91c1c';
          feedback.textContent = 'Le nom du client est obligatoire.';
        }
        return;
      }
      if (!numero) {
        if (feedback) {
          feedback.style.display = 'block';
          feedback.style.color = '#b91c1c';
          feedback.textContent = 'Le numéro du client est obligatoire.';
        }
        return;
      }
      if (!typeValue) {
        if (feedback) {
          feedback.style.display = 'block';
          feedback.style.color = '#b91c1c';
          feedback.textContent = 'Sélectionnez le type du client.';
        }
        return;
      }

      if (submitBtn) submitBtn.disabled = true;

      ensureClientsCache().then(() => {
        if (typeof dbFirestore === 'undefined' || !dbFirestore || typeof dbFirestore.collection !== 'function') {
          throw new Error('Base de données indisponible');
        }
        return dbFirestore.collection('clients').add({
          nom,
          numero,
          typeClient: typeValue,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }).then(docRef => {
        const newClient = { id: docRef.id, nom, numero, typeClient: typeValue };
        clientsCache.push(newClient);
        clientsCacheLoaded = true;
        setClientType(typeValue);
        selectClientForSale(newClient);
        if (typeof showToast === 'function') {
          showToast('Client créé avec succès.');
        }
        nameInput.value = '';
        phoneInput.value = '';
        const checked = document.querySelector('input[name="newClientType"]:checked');
        if (checked) checked.checked = false;
        searchClientsVente();
      }).catch(error => {
        console.error('Erreur lors de la création du client :', error);
        if (feedback) {
          feedback.style.display = 'block';
          feedback.style.color = '#b91c1c';
          feedback.textContent = 'Impossible de créer le client : ' + error.message;
        }
      }).finally(() => {
        if (submitBtn) submitBtn.disabled = false;
      });
    }

function setLivraisonDetailAlert(message = '', variant = 'info') {
  const alertEl = document.getElementById('livraisonDetailAlert');
  if (!alertEl) return;
  alertEl.classList.remove('success', 'danger', 'info');
  if (!message) {
    alertEl.style.display = 'none';
    alertEl.textContent = '';
    return;
  }
  if (variant === 'success') {
    alertEl.classList.add('success');
  } else if (variant === 'danger') {
    alertEl.classList.add('danger');
  } else if (variant === 'info') {
    alertEl.classList.add('info');
  }
  alertEl.style.display = 'block';
  alertEl.textContent = message;
}

function showLivraisonDetailLoader(show) {
  const loader = document.getElementById('livraisonDetailLoader');
  if (!loader) return;
  loader.style.display = show ? 'flex' : 'none';
}

function resetLivraisonDetailScreen() {
  const defaults = {
    livraisonDetailTitle: 'Livraison',
    livraisonDetailSubtitle: 'Sélectionnez une livraison dans la liste.',
    livraisonDetailClientName: '—',
    livraisonDetailClientPhone: '—',
    livraisonDetailLivreur: '—',
    livraisonDetailLivreurPhone: '—',
    livraisonDetailLieu: '—',
    livraisonDetailDate: '—',
    livraisonDetailHeure: '—',
    livraisonDetailReferenceBadge: 'Référence —',
    livraisonItemsCountBadge: 'Aucun article',
    livraisonDetailPreparedAt: '—',
    livraisonDetailClosedAt: '—',
    livraisonDetailTotalAmount: '0 FCFA',
    livraisonDetailTotalPaid: '0 FCFA',
    livraisonDetailOutstanding: '0 FCFA',
    livraisonDetailStatusDescription: 'Sélectionnez une action pour mettre à jour la livraison.'
  };
  Object.entries(defaults).forEach(([id, value]) => {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  });
  const statusPill = document.getElementById('livraisonDetailStatusPill');
  if (statusPill) {
    statusPill.textContent = '--';
    statusPill.classList.remove('success', 'danger', 'warning');
  }
  const itemsBody = document.getElementById('livraisonDetailItems');
  if (itemsBody) {
    itemsBody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#94a3b8;">Aucun article</td></tr>';
  }
  const paymentsHistory = document.getElementById('livraisonPaymentsHistory');
  if (paymentsHistory) {
    paymentsHistory.innerHTML = '<p style="color:#94a3b8;">Aucun encaissement enregistré pour cette livraison.</p>';
  }
  const successBtn = document.getElementById('livraisonMarkSuccessBtn');
  const failBtn = document.getElementById('livraisonMarkFailedBtn');
  if (successBtn) {
    successBtn.disabled = true;
    successBtn.classList.remove('primary');
    successBtn.classList.add('success');
    successBtn.style.display = '';
    const label = successBtn.querySelector('.btn-label');
    if (label) label.textContent = 'Marquer comme réussie';
  }
  if (failBtn) {
    failBtn.disabled = true;
    failBtn.style.display = '';
    const label = failBtn.querySelector('.btn-label');
    if (label) label.textContent = 'Marquer comme échouée';
  }
  setLivraisonQuickAction('livraisonCallClientBtn', null, 'phone');
  setLivraisonQuickAction('livraisonWhatsappClientBtn', null, 'whatsapp');
  setLivraisonQuickAction('livraisonCallLivreurBtn', null, 'phone');
  const failureEl = document.getElementById('livraisonDetailFailureReason');
  if (failureEl) {
    failureEl.style.display = 'none';
    failureEl.textContent = '';
  }
  const addPaymentBtn = document.querySelector('.delivery-add-payment-btn');
  if (addPaymentBtn) {
    addPaymentBtn.disabled = true;
  }
}


function prepareLivraisonDetailScreen() {
  if (currentLivraisonData) {
    populateLivraisonDetailView(currentLivraisonData);
    setLivraisonDetailAlert('Gestion de la livraison en cours.', 'info');
  } else {
    resetLivraisonDetailScreen();
    setLivraisonDetailAlert("Sélectionnez une livraison dans l'historique pour la gérer.", 'info');
  }
}

async function ouvrirLivraisonDetail(saleId) {
  if (!saleId) return;
  currentLivraisonId = saleId;
  window.location.hash = 'livraison-detail';
  showLivraisonDetailLoader(true);
  try {
    const sale = await getSaleByIdFirestore(saleId);
    if (!sale.isDelivery) {
      showLivraisonDetailLoader(false);
      setLivraisonDetailAlert("Cette vente n'est pas une livraison.", 'danger');
      ouvrirDetails(saleId);
      return;
    }
    currentLivraisonData = { id: saleId, ...sale };
    populateLivraisonDetailView(currentLivraisonData);
    setLivraisonDetailAlert('Gestion de la livraison en cours.', 'info');
  } catch (error) {
    console.error('Erreur lors du chargement de la livraison :', error);
    setLivraisonDetailAlert("Impossible de charger la livraison : " + error.message, 'danger');
  } finally {
    showLivraisonDetailLoader(false);
  }
}

function computeLivraisonTotals(sale) {
  const due = parseFloat(sale.overallTotal) || 0;
  let totalEncaisse = 0;
  let totalChange = 0;
  if (Array.isArray(sale.paymentsDetails)) {
    sale.paymentsDetails.forEach(p => {
      totalEncaisse += parseFloat(p.montantEncaisse) || 0;
      totalChange += parseFloat(p.monnaieRendue) || 0;
    });
  }
  const net = totalEncaisse - totalChange;
  const outstanding = Math.max(0, due - net);
  return { due, totalEncaisse, totalChange, net, outstanding };
}

function formatXofAmount(value) {
  return `${(Number(value) || 0).toLocaleString('fr-FR')} FCFA`;
}

function formatLivraisonDateTime(value) {
  if (!value) return '—';
  try {
    let dateValue = value;
    if (typeof value?.toDate === 'function') {
      dateValue = value.toDate();
    } else if (typeof value === 'object' && typeof value.seconds === 'number') {
      dateValue = new Date(value.seconds * 1000);
    } else if (typeof value === 'string') {
      const parsed = new Date(value);
      if (!Number.isNaN(parsed.getTime())) {
        dateValue = parsed;
      }
    }
    if (dateValue instanceof Date && !Number.isNaN(dateValue.getTime())) {
      return dateValue.toLocaleString('fr-FR', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
  } catch (error) {
    console.warn('formatLivraisonDateTime error:', error);
  }
  return typeof value === 'string' && value.trim() ? value : '—';
}

function setLivraisonQuickAction(id, value, mode = 'phone') {
  const anchor = document.getElementById(id);
  if (!anchor) return;

  const disableAnchor = () => {
    anchor.href = '#';
    anchor.classList.add('is-disabled');
    anchor.setAttribute('aria-disabled', 'true');
    anchor.removeAttribute('title');
    if (mode === 'phone') {
      anchor.target = '_self';
    }
  };

  if (!value) {
    disableAnchor();
    return;
  }

  const cleaned = String(value).replace(/\D+/g, '');
  if (!cleaned) {
    disableAnchor();
    return;
  }

  if (mode === 'whatsapp') {
    anchor.href = `https://wa.me/${cleaned}`;
    anchor.target = '_blank';
  } else {
    anchor.href = `tel:${cleaned}`;
    anchor.target = '_self';
  }
  anchor.classList.remove('is-disabled');
  anchor.setAttribute('aria-disabled', 'false');
  anchor.setAttribute('title', String(value));
}

function populateLivraisonDetailView(sale) {
  if (!sale) {
    resetLivraisonDetailScreen();
    return;
  }

  const title = document.getElementById('livraisonDetailTitle');
  const subtitle = document.getElementById('livraisonDetailSubtitle');
  if (title) title.textContent = sale.clientNom ? 'Livraison · ' + sale.clientNom : 'Livraison';
  if (subtitle) subtitle.textContent = sale.id ? 'Référence ' + sale.id : '';

  const refBadge = document.getElementById('livraisonDetailReferenceBadge');
  if (refBadge) {
    if (sale.id) {
      const shortRef = sale.id.length > 12 ? `${sale.id.slice(0, 4)}…${sale.id.slice(-4)}` : sale.id;
      refBadge.textContent = 'Réf. ' + shortRef;
      refBadge.setAttribute('title', sale.id);
    } else {
      refBadge.textContent = 'Référence —';
      refBadge.removeAttribute('title');
    }
  }

  const fields = {
    livraisonDetailClientName: sale.clientNom || '—',
    livraisonDetailClientPhone: sale.clientNumero || '—',
    livraisonDetailLivreur: sale.livreurNom || '—',
    livraisonDetailLivreurPhone: sale.livreurNumero || '—',
    livraisonDetailLieu: sale.lieuLivraison || '—',
    livraisonDetailDate: sale.dateVente || '—',
    livraisonDetailHeure: sale.heureVente || '—'
  };
  Object.entries(fields).forEach(([id, value]) => {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  });

  const preparedAtEl = document.getElementById('livraisonDetailPreparedAt');
  if (preparedAtEl) {
    const preparedText = [
      sale.dateVente || "",
      sale.heureVente || ""
    ].filter(Boolean).join(' · ');
    preparedAtEl.textContent = preparedText || '—';
  }
  const closedAtEl = document.getElementById('livraisonDetailClosedAt');
  if (closedAtEl) {
    closedAtEl.textContent = sale.deliveryClosedAt ? formatLivraisonDateTime(sale.deliveryClosedAt) : '—';
  }

  setLivraisonQuickAction('livraisonCallClientBtn', sale.clientNumero, 'phone');
  setLivraisonQuickAction('livraisonWhatsappClientBtn', sale.clientNumero, 'whatsapp');
  setLivraisonQuickAction('livraisonCallLivreurBtn', sale.livreurNumero, 'phone');

  const statusPill = document.getElementById('livraisonDetailStatusPill');
  if (statusPill) {
    statusPill.classList.remove('success', 'danger', 'warning');
    let label = 'Livraison en cours';
    if (sale.deliveryStatus === 'réussie') {
      label = 'Livraison réussie';
      statusPill.classList.add('success');
    } else if (sale.deliveryStatus === 'échouée') {
      label = 'Livraison échouée';
      statusPill.classList.add('danger');
    } else {
      statusPill.classList.add('warning');
    }
    statusPill.textContent = label;
  }

  const itemsBody = document.getElementById('livraisonDetailItems');
  if (itemsBody) {
    if (Array.isArray(sale.items) && sale.items.length) {
      itemsBody.innerHTML = sale.items.map(item => {
        const total = (parseFloat(item.total) || 0).toLocaleString('fr-FR');
        const prix = (parseFloat(item.prix) || 0).toLocaleString('fr-FR');
        const row = `<tr>
          <td>${item.produit || 'Article'}</td>
          <td>${item.quantite || 0}</td>
          <td>${prix} FCFA</td>
          <td>${total} FCFA</td>
        </tr>`;
        return row;
      }).join('');
    } else {
      itemsBody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#94a3b8;">Aucun article</td></tr>';
    }
  }
  const itemsBadge = document.getElementById('livraisonItemsCountBadge');
  if (itemsBadge) {
    const items = Array.isArray(sale.items) ? sale.items : [];
    if (items.length) {
      const totalQuantity = items.reduce((sum, item) => sum + (parseFloat(item.quantite) || 0), 0);
      const baseLabel = `${items.length} article${items.length > 1 ? 's' : ''}`;
      itemsBadge.textContent = baseLabel;
      itemsBadge.setAttribute('title', `Quantité totale : ${totalQuantity.toLocaleString('fr-FR')}`);
    } else {
      itemsBadge.textContent = 'Aucun article';
      itemsBadge.removeAttribute('title');
    }
  }

  const paymentsHistory = document.getElementById('livraisonPaymentsHistory');
  if (paymentsHistory) {
    if (Array.isArray(sale.paymentsDetails) && sale.paymentsDetails.length) {
      paymentsHistory.innerHTML = sale.paymentsDetails.map(p => {
        const montant = (parseFloat(p.montantEncaisse) || 0).toLocaleString('fr-FR');
        const monnaie = parseFloat(p.monnaieRendue) || 0;
        const changeText = monnaie > 0 ? ` (monnaie ${monnaie.toLocaleString('fr-FR')} FCFA)` : '';
        const compte = p.compteNom || p.compteId || 'Compte';
        return `<p><strong>${compte} :</strong> ${montant} FCFA${changeText}</p>`;
      }).join('');
    } else {
      paymentsHistory.innerHTML = '<p style="color:#94a3b8;">Aucun encaissement enregistré pour cette livraison.</p>';
    }
  }

  const failureEl = document.getElementById('livraisonDetailFailureReason');
  if (failureEl) {
    const failureReason = sale.deliveryFailureReason || sale.deliveryNotes || '';
    if (failureReason) {
      failureEl.style.display = 'block';
      failureEl.textContent = `Raison : ${failureReason}`;
    } else {
      failureEl.style.display = 'none';
      failureEl.textContent = '';
    }
  }

  const totals = computeLivraisonTotals(sale);
  const totalEl = document.getElementById('livraisonDetailTotalAmount');
  const paidEl = document.getElementById('livraisonDetailTotalPaid');
  const outstandingEl = document.getElementById('livraisonDetailOutstanding');
  if (totalEl) totalEl.textContent = formatXofAmount(totals.due);
  if (paidEl) paidEl.textContent = formatXofAmount(totals.net);
  if (outstandingEl) outstandingEl.textContent = formatXofAmount(totals.outstanding);

  const addPaymentBtn = document.querySelector('.delivery-add-payment-btn');
  if (addPaymentBtn) {
    addPaymentBtn.disabled = totals.outstanding <= 0.5;
  }

  updateLivraisonActionButtons(sale, totals);

  if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
    refreshLucideIcons();
  }
}

function normalizeLivraisonStatus(status) {
  if (!status) return '';
  const value = status.toString().toLowerCase();
  const normalized = typeof value.normalize === 'function' ? value.normalize('NFD') : value;
  return normalized.replace(/[\u0300-\u036f]/g, '').replace(/[^a-z]/g, '');
}


function updateLivraisonActionButtons(sale, totals) {
  const successBtn = document.getElementById('livraisonMarkSuccessBtn');
  const failBtn = document.getElementById('livraisonMarkFailedBtn');
  const statusDesc = document.getElementById('livraisonDetailStatusDescription');
  const addPaymentBtn = document.querySelector('.delivery-add-payment-btn');

  const normalizedStatus = normalizeLivraisonStatus(sale.deliveryStatus);
  const isSuccess = normalizedStatus === 'reussie' || normalizedStatus === 'russie';
  const isFailed = normalizedStatus === 'echouee' || normalizedStatus === 'echoue';
  const outstanding = totals ? totals.outstanding : computeLivraisonTotals(sale).outstanding;
  const canClose = !isSuccess && !isFailed && outstanding <= 0.5;
  const canManage = peutGererLivraison(sale);
  window.__currentLivraisonCanManage = canManage;

  if (!canManage) {
    if (successBtn) {
      successBtn.disabled = true;
      successBtn.classList.remove('primary', 'success');
      successBtn.style.display = '';
    }
    if (failBtn) {
      failBtn.disabled = true;
      failBtn.style.display = '';
    }
    if (addPaymentBtn) {
      addPaymentBtn.disabled = true;
    }
    if (statusDesc) {
      statusDesc.textContent = 'Consultation uniquement. Seul le redacteur de la livraison ou un responsable peut agir.';
    }
    return;
  }

  if (successBtn) {
    successBtn.style.display = isSuccess ? 'none' : '';
    successBtn.disabled = isSuccess;
    successBtn.classList.remove('primary', 'success');
    const label = successBtn.querySelector('.btn-label');
    if (isSuccess) {
      successBtn.classList.add('success');
      if (label) label.textContent = 'Livraison finalis?e';
    } else if (canClose) {
      successBtn.classList.add('success');
      if (label) label.textContent = 'Cl?turer la livraison';
    } else {
      successBtn.classList.add('primary');
      if (label) label.textContent = 'Enregistrer un encaissement';
    }
  }
  if (failBtn) {
    failBtn.style.display = isSuccess ? 'none' : '';
    failBtn.disabled = isFailed;
    const label = failBtn.querySelector('.btn-label');
    if (label) label.textContent = isFailed ? 'Livraison ?chou?e' : 'Marquer comme ?chou?e';
  }
  if (addPaymentBtn) {
    addPaymentBtn.disabled = outstanding <= 0.5;
  }
  if (statusDesc) {
    if (isSuccess) {
      statusDesc.textContent = 'Cette livraison est finalis?e et int?gr?e au chiffre des ventes.';
    } else if (isFailed) {
      statusDesc.textContent = 'Livraison marqu?e comme ?chou?e. Ajustez ou relancez si n?cessaire.';
    } else if (outstanding > 0.5) {
      statusDesc.textContent = `Encaissez ${formatXofAmount(outstanding)} avant de cl?turer la livraison.`;
    } else {
      statusDesc.textContent = 'Vous pouvez maintenant cl?turer la livraison ou la marquer en ?chec.';
    }
  }
}



async function encaisserLivraisonRestante() {
  if (!peutGererLivraisonCourante()) {
    setLivraisonDetailAlert("Vous ne pouvez pas encaisser cette livraison.", 'warning');
    return;
  }
  ouvrirModalLivraisonEncaissement();
}
async function marquerLivraisonReussie() {
  if (!currentLivraisonData || !currentLivraisonId) return;
  if (!peutGererLivraisonCourante()) {
    setLivraisonDetailAlert("Vous ne pouvez pas modifier cette livraison.", 'warning');
    return;
  }

  const totals = computeLivraisonTotals(currentLivraisonData);
  if (totals.outstanding > 0.5) {
    setLivraisonDetailAlert(`Il reste ${formatXofAmount(totals.outstanding)} à encaisser avant de clôturer la livraison.`, 'info');
    ouvrirModalLivraisonEncaissement();
    return;
  }

  const confirmer = confirm('Confirmer que la livraison est réussie ?');
  if (!confirmer) return;

  showLivraisonDetailLoader(true);
  try {
    await finaliserLivraisonReussie();
  } catch (error) {
    console.error('Erreur finalisation livraison :', error);
    setLivraisonDetailAlert("Impossible de marquer la livraison comme réussie : " + error.message, 'danger');
  } finally {
    showLivraisonDetailLoader(false);
  }
}
async function marquerLivraisonEchouee() {
  if (!currentLivraisonData || !currentLivraisonId) return;
  if (currentLivraisonData.deliveryStatus === 'échouée') {
    setLivraisonDetailAlert('La livraison est déjà marquée comme échouée.', 'info');
    return;
  }
  if (!peutGererLivraisonCourante()) {
    setLivraisonDetailAlert("Vous ne pouvez pas modifier cette livraison.", 'warning');
    return;
  }
  const raison = prompt("Indiquez la raison de l'échec (facultatif) :");
  showLivraisonDetailLoader(true);
  try {
    const payload = {
      deliveryStatus: 'échouée',
      convertedToSale: false,
      deliveryClosedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    if (raison) {
      payload.deliveryFailureReason = raison;
    }
    await updateSaleFirestore(currentLivraisonId, payload);
    currentLivraisonData.deliveryStatus = 'échouée';
    currentLivraisonData.convertedToSale = false;
    if (raison) currentLivraisonData.deliveryFailureReason = raison;
    populateLivraisonDetailView(currentLivraisonData);
    setLivraisonDetailAlert('Livraison marquée comme échouée.', 'danger');
    filterSalesHistory(document.getElementById('sales-tabs').value || 'all');
    afficherLivraisons();
    updateAccueilSummary();
  } catch (error) {
    console.error('Erreur marquage échec livraison :', error);
    setLivraisonDetailAlert("Impossible de marquer la livraison comme échouée : " + error.message, 'danger');
  } finally {
    showLivraisonDetailLoader(false);
  }
}

function updateLivraisonQuickIndicators(count) {
  const value = Number(count || 0);
  const formatted = value.toLocaleString('fr-FR');
  const badge = document.getElementById('livraisonsEnCoursBadge');
  if (badge) {
    badge.textContent = formatted;
  }
  const quickBtn = document.getElementById('livraisonsQuickButton');
  if (quickBtn) {
    quickBtn.style.display = value > 0 ? 'flex' : 'none';
  }
  const headerCount = document.getElementById('livraisons-header-count');
  if (headerCount) {
    headerCount.textContent = formatted;
  }
  const homeCardCount = document.getElementById('accueil-livraisons-count');
  if (homeCardCount) {
    homeCardCount.textContent = formatted;
  }
  const homeCardSub = document.getElementById('accueil-livraisons-subtext');
  if (homeCardSub) {
    homeCardSub.textContent = value === 1 ? '1 livraison à suivre' : `${formatted} livraisons à suivre`;
  }
}


function ouvrirLivraisonsDepuisAccueil() {
  window.location.hash = 'livraisons';
  setTimeout(() => {
    if (typeof afficherLivraisons === 'function') {
      afficherLivraisons();
    }
  }, 80);
}

function ouvrirLivraisonsDepuisBadge() {
  ouvrirLivraisonsDepuisAccueil();
}

function peutGererLivraison(sale) {
  if (!sale) return false;
  const auth = typeof firebase !== 'undefined' && typeof firebase.auth === 'function' ? firebase.auth() : null;
  const currentUser = auth && auth.currentUser ? auth.currentUser : null;
  const userUid = currentUser && currentUser.uid ? currentUser.uid : null;
  if (!userUid) return false;

  const privilegedRoles = new Set(['patron', 'admin', 'manager', 'gerant', 'superviseur']);
  if (privilegedRoles.has(window.userRole)) {
    return true;
  }

  const possibleOwners = [
    sale.enregistreParUid,
    sale.preparedByUid,
    sale.createdByUid,
    sale.captureUid,
    sale.livreurUid,
    sale.deliveryAgentUid
  ].filter(Boolean);

  if (!possibleOwners.length) {
    return true;
  }

  return possibleOwners.includes(userUid);
}

function peutGererLivraisonCourante() {
  return peutGererLivraison(currentLivraisonData || null);
}

function updateAccueilSummary() {
  const countEl = document.getElementById('accueil-ventes-count');
  const revenueEl = document.getElementById('accueil-ventes-ca');
  const profitEl = document.getElementById('accueil-ventes-profit');
  const depenseEl = document.getElementById('accueil-depenses');
  const stockEl = document.getElementById('accueil-stock-items');
  const stockDetailEl = document.getElementById('accueil-stock-detail');
  const livraisonsEl = document.getElementById('accueil-ventes-livraison');
  const livraisonCardCountEl = document.getElementById('accueil-livraisons-count');
  const livraisonCardSubtextEl = document.getElementById('accueil-livraisons-subtext');
  const dateEl = document.getElementById('accueil-date');
  if (!countEl || !revenueEl || !profitEl || !depenseEl || !stockEl || !livraisonsEl) {
    return;
  }

      const now = new Date();
      if (dateEl) {
        dateEl.textContent = now.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      }

      const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
      const endOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
      const startTimestamp = firebase.firestore.Timestamp.fromDate(startOfDay);
      const endTimestamp = firebase.firestore.Timestamp.fromDate(endOfDay);
      const startMillis = startOfDay.getTime();
      const endMillis = endOfDay.getTime();

      const stockPromise = (Array.isArray(cachedStock) && cachedStock.length)
        ? Promise.resolve(cachedStock)
        : getAllStockFirestore();

      Promise.all([
        dbFirestore.collection('ventes')
          .where('timestamp', '>=', startTimestamp)
          .where('timestamp', '<=', endTimestamp)
          .get()
          .catch(err => { console.error('Erreur chargement ventes accueil:', err); return null; }),
        dbFirestore.collection('depenses')
          .where('timestamp', '>=', startMillis)
          .where('timestamp', '<=', endMillis)
          .get()
          .catch(err => { console.error('Erreur chargement depenses accueil:', err); return null; }),
        stockPromise.catch(err => { console.error('Erreur chargement stock accueil:', err); return []; })
      ]).then(([ventesSnap, depensesSnap, stocks]) => {
        let ventesCount = 0;
        let totalCA = 0;
        let totalProfit = 0;
        let livraisonsEnAttente = 0;

        if (ventesSnap && typeof ventesSnap.forEach === 'function') {
          ventesSnap.forEach(doc => {
            const data = doc.data() || {};
            if (data.status === 'annulé') return;
            ventesCount++;
            totalCA += parseFloat(data.overallTotal) || 0;
            totalProfit += parseFloat(data.totalProfit) || 0;
            if (data.isDelivery && data.deliveryStatus !== 'réussie') {
              livraisonsEnAttente++;
            }
          });
        }

        let depensesTotal = 0;
        if (depensesSnap && typeof depensesSnap.forEach === 'function') {
          depensesSnap.forEach(doc => {
            depensesTotal += parseFloat(doc.data()?.montant) || 0;
          });
        }

        let totalStock = 0;
        let detailsStock = '';
        if (Array.isArray(stocks) && stocks.length) {
          const telephones = stocks
            .filter(s => (s.category || '').toLowerCase() === 'telephones')
            .reduce((sum, s) => sum + (parseFloat(s.stock) || 0), 0);
          const accessoires = stocks
            .filter(s => (s.category || '').toLowerCase() === 'accessoires')
            .reduce((sum, s) => sum + (parseFloat(s.stock) || 0), 0);
          totalStock = telephones + accessoires;
          detailsStock = `T\u00E9l: ${telephones.toLocaleString('fr-FR')} \u00B7 Acc: ${accessoires.toLocaleString('fr-FR')}`;
        }

        countEl.textContent = ventesCount.toLocaleString('fr-FR');
        revenueEl.textContent = `${totalCA.toLocaleString('fr-FR')} FCFA`;
        profitEl.textContent = `Profit : ${totalProfit.toLocaleString('fr-FR')} FCFA`;
        depenseEl.textContent = `${depensesTotal.toLocaleString('fr-FR')} FCFA`;
        stockEl.textContent = totalStock.toLocaleString('fr-FR');
        if (stockDetailEl) {
          stockDetailEl.textContent = detailsStock || '---';
        }
        const livraisonsFormatted = livraisonsEnAttente.toLocaleString('fr-FR');
        livraisonsEl.textContent = `${livraisonsFormatted} livraisons en attente`;
        if (livraisonCardCountEl) {
          livraisonCardCountEl.textContent = livraisonsFormatted;
        }
        if (livraisonCardSubtextEl) {
          livraisonCardSubtextEl.textContent = livraisonsEnAttente === 1
            ? '1 livraison \u00E0 suivre'
            : `${livraisonsFormatted} livraisons \u00E0 suivre`;
        }
        updateLivraisonQuickIndicators(livraisonsEnAttente);
      });
    }

    // Sale Loader Functions
    function showSaleLoader() {
      document.getElementById("saleLoader").style.display = "flex";
    }
    function hideSaleLoader() {
      document.getElementById("saleLoader").style.display = "none";
    }

    // Gestion des étapes de vente (Stepper)
    let currentStep = 0;
    const steps = document.querySelectorAll(".sale-step");
    function showStep(index) {
      steps.forEach((step, i) => {
        step.classList.remove("active");
        if(i === index) {
          step.classList.add("active");
        }
      });
      const progress = ((index + 1) / steps.length) * 100;
      document.getElementById("progressBar").style.width = progress + "%";
      document.getElementById("progressText").innerText = `Étape ${index + 1} / ${steps.length}`;
      toggleDeliveryFields();
      if (index === 1) {
        initClientSearchStep();
      }
      if (index === 2) {
        ensureVentePaymentsInitialized();
        rafraichirResumePaiementVente();
      }
      if(index === steps.length - 1) {
        generateRecap();
      }
    }
    function nextStep() {
  if (currentStep === 1) {
    const nom = document.getElementById('clientNom')?.value.trim() || '';
    const numero = document.getElementById('clientNumero')?.value.trim() || '';
    const typeSelection = document.getElementById('clientType')?.value.trim() || '';
    if (!nom || !numero) {
      showToast("Sélectionnez ou créez un client avant de continuer.");
      return;
    }
    if (!typeSelection) {
      showToast("Choisissez le type de client avant de continuer.");
      return;
    }
  }
  if (currentStep === 2) {
    if (!validateVentePayments(true)) {
      return;
    }
  }

  if (currentStep < steps.length - 1) {
    currentStep++;
    showStep(currentStep);
  }
}

    function prevStep() {
      if(currentStep > 0) {
        currentStep--;
        showStep(currentStep);
      }
    }
    function generateRecap() {
      const recap = document.getElementById("saleRecap");
      let html = "<h3>Récapitulatif de la Vente</h3><strong>Articles :</strong><br>";
      currentItems.forEach(item => {
        html += "- " + item.produit + " (Prix : " + item.prix + ", Qté : " + item.quantite + ", Total : " + item.total + ")<br>";
      });
      const recapClientNom = document.getElementById("clientNom").value;
      const recapClientNumero = document.getElementById("clientNumero").value;
      const recapClientTypeRaw = document.getElementById("clientType")?.value || '';
      const recapClientType = normalizeClientType(recapClientTypeRaw, '');
      const recapClientTypeLabel = recapClientType === 'revendeur'
        ? 'Revendeur'
        : recapClientType === 'ordinaire'
          ? 'Client ordinaire'
          : 'Type non défini';
      html += "<br><strong>Client :</strong> " + recapClientNom + " (" + recapClientNumero + ") - " + recapClientTypeLabel + "<br>";
      html += "<strong>Canal de vente :</strong> " + document.getElementById("vendeurSelect").value + "<br>";
      const livraisonNom = (document.getElementById("livreurNom")?.value || "").trim();
      const livraisonNumero = (document.getElementById("livreurNumero")?.value || "").trim();
      const livraisonLieu = (document.getElementById("lieuLivraison")?.value || "").trim();
      const isDelivery = currentSaleMode === 'delivery';
      html += "<strong>Total :</strong> " + currentItems.reduce((acc, item) => acc + parseFloat(item.total), 0).toFixed(2) + "<br>";
      html += "<strong>Mode :</strong> " + (isDelivery ? "Livraison" : "Vente directe") + "<br>";
      if (isDelivery) {
        html += "<strong>Livreur :</strong> " + (livraisonNom ? livraisonNom : "Non renseigné") + " (" + (livraisonNumero ? livraisonNumero : "Contact manquant") + ")<br>";
        html += "<strong>Lieu de livraison :</strong> " + (livraisonLieu ? livraisonLieu : "Non renseigné") + "<br>";
      }
      const recapPaiements = ventePayments
        .map(p => {
          const compteId = p.compteId || '';
          const montantEncaisse = parseFloat(p.montantEncaisse) || 0;
          const monnaieRendue = parseFloat(p.monnaieRendue) || 0;
          if (!compteId && montantEncaisse === 0 && monnaieRendue === 0) {
            return null;
          }
          if (!compteId) {
            return null;
          }
          const compteInfo = Array.isArray(comptesCache) ? comptesCache.find(c => c.id === compteId) || {} : {};
          return {
            compteNom: compteInfo.nom || compteId,
            montantEncaisse,
            monnaieRendue
          };
        })
        .filter(Boolean);
      if (recapPaiements.length > 0) {
        const statsPaiements = rafraichirResumePaiementVente();
        html += "<br><strong>Encaissements :</strong><br>";
        recapPaiements.forEach(p => {
          html += `- ${p.compteNom} : ${fmt(p.montantEncaisse)} FCFA` + (p.monnaieRendue > 0 ? ` (monnaie rendue ${fmt(p.monnaieRendue)} FCFA)` : '') + '<br>';
        });
        html += `<em>Total encaisse : ${fmt(statsPaiements.totalEncaisse)} FCFA - Monnaie rendue : ${fmt(statsPaiements.totalChange)} FCFA - Net : ${fmt(statsPaiements.net)} FCFA</em><br>`;
      } else if (isDelivery) {
        html += "<br><strong>Encaissements :</strong> Prévu lors de la livraison.<br>";
      }
      recap.innerHTML = html;
    }


let ventePayments = [];
let ventePaymentAutoId = 0;

function resetVentePayments() {
  ventePayments = [];
  ventePaymentAutoId = 0;
  ensureVentePaymentsInitialized();
  rafraichirResumePaiementVente();
}

function ensureVentePaymentsInitialized() {
  const container = document.getElementById('ventePaymentsContainer');
  if (!container) {
    return;
  }

  if (ventePayments.length === 0) {
    ajouterLignePaiementVente();
  } else if (!container.childElementCount) {
    renderVentePayments();
  }

  rafraichirResumePaiementVente();
}

function getCurrentSaleTotal() {
  return currentItems.reduce((sum, item) => sum + (parseFloat(item.total) || 0), 0);
}

function ajouterLignePaiementVente(initialData) {
  const payload = initialData || {};
  ventePayments.push({
    id: ++ventePaymentAutoId,
    compteId: payload.compteId || '',
    montantEncaisse: payload.montantEncaisse || '',
    monnaieRendue: payload.monnaieRendue || '',
    encaissePhoto: payload.encaissePhoto || null,
    monnaiePhoto: payload.monnaiePhoto || null
  });
  renderVentePayments();
  rafraichirResumePaiementVente();
}

function renderVentePayments() {
  const container = document.getElementById('ventePaymentsContainer');
  if (!container) {
    return;
  }

  container.innerHTML = '';

  ventePayments.forEach(payment => {
    const row = document.createElement('div');
    row.className = 'vente-payment-row vente-payment-row-vente';
    row.dataset.paymentId = payment.id;

    const card = document.createElement('div');
    card.className = 'vente-payment-card';
    row.appendChild(card);

    const header = document.createElement('div');
    header.className = 'vente-payment-card-header';
    card.appendChild(header);

    const compteSelect = document.createElement('select');
    compteSelect.id = 'compteSelectVente-' + payment.id;
    compteSelect.className = 'vente-payment-account';
    compteSelect.addEventListener('change', event => {
      onVentePaymentFieldChange(payment.id, 'compteId', event.target.value);
    });
    header.appendChild(compteSelect);

    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'vente-payment-remove btn-modern secondary';
    removeBtn.innerHTML = '<i data-lucide="trash-2"></i>';
    removeBtn.addEventListener('click', () => supprimerLignePaiementVente(payment.id));
    header.appendChild(removeBtn);

    const proofsWrapper = document.createElement('div');
    proofsWrapper.className = 'vente-payment-proof-wrapper';
    card.appendChild(proofsWrapper);

    const encaisseInput = document.createElement('input');
    encaisseInput.type = 'file';
    encaisseInput.accept = 'image/*';
    encaisseInput.style.display = 'none';
    encaisseInput.addEventListener('change', event => {
      onVentePaymentPhotoSelected(payment.id, 'encaisse', event.target.files);
      encaisseInput.value = '';
    });
    proofsWrapper.appendChild(encaisseInput);

    const monnaieInput = document.createElement('input');
    monnaieInput.type = 'file';
    monnaieInput.accept = 'image/*';
    monnaieInput.style.display = 'none';
    monnaieInput.addEventListener('change', event => {
      onVentePaymentPhotoSelected(payment.id, 'monnaie', event.target.files);
      monnaieInput.value = '';
    });
    proofsWrapper.appendChild(monnaieInput);

    const proofsActions = document.createElement('div');
    proofsActions.className = 'vente-payment-proof-actions';
    proofsWrapper.appendChild(proofsActions);

    const encaisseBtn = document.createElement('button');
    encaisseBtn.type = 'button';
    encaisseBtn.className = 'btn-modern secondary';
    encaisseBtn.style.whiteSpace = 'nowrap';
    encaisseBtn.innerHTML = '<i data-lucide="camera"></i> Preuve encaissement';
    encaisseBtn.addEventListener('click', () => encaisseInput.click());
    proofsActions.appendChild(encaisseBtn);

    const monnaieBtn = document.createElement('button');
    monnaieBtn.type = 'button';
    monnaieBtn.className = 'btn-modern secondary';
    monnaieBtn.style.whiteSpace = 'nowrap';
    monnaieBtn.innerHTML = '<i data-lucide="camera"></i> Preuve monnaie';
    monnaieBtn.addEventListener('click', () => monnaieInput.click());
    proofsActions.appendChild(monnaieBtn);

    if (payment.encaissePhoto) {
      const thumb = document.createElement('img');
      thumb.src = payment.encaissePhoto;
      thumb.alt = 'Preuve encaissement';
      thumb.className = 'vente-payment-proof-thumb';
      thumb.addEventListener('click', () => ouvrirPreuvePaiement(thumb.src));
      proofsWrapper.appendChild(thumb);

      const removeEncaisse = document.createElement('button');
      removeEncaisse.type = 'button';
      removeEncaisse.className = 'vente-payment-proof-remove';
      removeEncaisse.textContent = 'Retirer';
      removeEncaisse.addEventListener('click', () => supprimerVentePaymentPhoto(payment.id, 'encaisse'));
      proofsWrapper.appendChild(removeEncaisse);
    }

    if (payment.monnaiePhoto) {
      const thumbMonnaie = document.createElement('img');
      thumbMonnaie.src = payment.monnaiePhoto;
      thumbMonnaie.alt = 'Preuve monnaie';
      thumbMonnaie.className = 'vente-payment-proof-thumb';
      thumbMonnaie.addEventListener('click', () => ouvrirPreuvePaiement(thumbMonnaie.src));
      proofsWrapper.appendChild(thumbMonnaie);

      const removeMonnaie = document.createElement('button');
      removeMonnaie.type = 'button';
      removeMonnaie.className = 'vente-payment-proof-remove';
      removeMonnaie.textContent = 'Retirer';
      removeMonnaie.addEventListener('click', () => supprimerVentePaymentPhoto(payment.id, 'monnaie'));
      proofsWrapper.appendChild(removeMonnaie);
    }

    const amountsWrapper = document.createElement('div');
    amountsWrapper.className = 'vente-payment-amounts';
    card.appendChild(amountsWrapper);

    const amountInput = document.createElement('input');
    amountInput.type = 'number';
    amountInput.min = '0';
    amountInput.step = '100';
    amountInput.placeholder = 'Montant encaissé';
    amountInput.value = payment.montantEncaisse || '';
    amountInput.addEventListener('input', event => {
      onVentePaymentFieldChange(payment.id, 'montantEncaisse', event.target.value);
    });
    amountsWrapper.appendChild(amountInput);

    const changeInput = document.createElement('input');
    changeInput.type = 'number';
    changeInput.min = '0';
    changeInput.step = '100';
    changeInput.placeholder = 'Monnaie rendue';
    changeInput.value = payment.monnaieRendue || '';
    changeInput.addEventListener('input', event => {
      onVentePaymentFieldChange(payment.id, 'monnaieRendue', event.target.value);
    });
    amountsWrapper.appendChild(changeInput);

    container.appendChild(row);
  });

  remplirTousSelectComptes();
  ventePayments.forEach(payment => {
    const selectEl = document.getElementById('compteSelectVente-' + payment.id);
    if (selectEl) {
      selectEl.value = payment.compteId || '';
    }
  });

  if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
    refreshLucideIcons();
  }
}

function onVentePaymentFieldChange(paymentId, field, value) {
  const payment = ventePayments.find(p => p.id === paymentId);
  if (!payment) {
    return;
  }

  payment[field] = value;
  rafraichirResumePaiementVente();
}

function supprimerLignePaiementVente(paymentId) {
  if (ventePayments.length <= 1) {
    const unique = ventePayments[0];
    if (unique) {
      unique.compteId = '';
      unique.montantEncaisse = '';
      unique.monnaieRendue = '';
      unique.encaissePhoto = null;
      unique.monnaiePhoto = null;
    }
    renderVentePayments();
    rafraichirResumePaiementVente();
    return;
  }

  ventePayments = ventePayments.filter(p => p.id !== paymentId);
  renderVentePayments();
  rafraichirResumePaiementVente();
}

function onVentePaymentPhotoSelected(paymentId, type, fileList) {
  if (!fileList || !fileList.length) {
    return;
  }
  const file = fileList[0];
  if (!file) return;
  try {
    compressImage(file, 1280, 1280, 0.7, dataUrl => {
      setVentePaymentPhoto(paymentId, type, dataUrl);
    });
  } catch (err) {
    console.error('Erreur lors de la compression de la preuve de paiement :', err);
    alert("Impossible de traiter l'image sélectionnée. Reessayez.");
  }
}

function setVentePaymentPhoto(paymentId, type, dataUrl) {
  const payment = ventePayments.find(p => p.id === paymentId);
  if (!payment) return;
  if (type === 'encaisse') {
    payment.encaissePhoto = dataUrl;
  } else if (type === 'monnaie') {
    payment.monnaiePhoto = dataUrl;
  }
  renderVentePayments();
  rafraichirResumePaiementVente();
}

function supprimerVentePaymentPhoto(paymentId, type) {
  const payment = ventePayments.find(p => p.id === paymentId);
  if (!payment) return;
  if (type === 'encaisse') {
    payment.encaissePhoto = null;
  } else if (type === 'monnaie') {
    payment.monnaiePhoto = null;
  }
  renderVentePayments();
  rafraichirResumePaiementVente();
}

function analyserPaiementsVente() {
  const due = getCurrentSaleTotal();
  let totalEncaisse = 0;
  let totalChange = 0;
  let message = '';
  let valid = true;
  let hasPositiveEncaisse = false;
  const isDeliverySale = currentSaleMode === 'delivery';

  for (const payment of ventePayments) {
    if (!valid) {
      break;
    }
    const encaisse = parseFloat(payment.montantEncaisse) || 0;
    const change = parseFloat(payment.monnaieRendue) || 0;

    if (encaisse < 0 || change < 0) {
      valid = false;
      message = 'Les montants encaissés ou rendus ne peuvent pas être négatifs.';
      break;
    }

    if ((encaisse > 0 || change > 0) && !payment.compteId) {
      valid = false;
      message = 'Sélectionnez un compte de trésorerie pour chaque encaissement.';
      break;
    }

    if (encaisse > 0) {
      hasPositiveEncaisse = true;
    }

    totalEncaisse += encaisse;
    totalChange += change;
  }

  const net = totalEncaisse - totalChange;

  if (valid) {
    if (!isDeliverySale) {
      if (due > 0 && !hasPositiveEncaisse) {
        valid = false;
        message = 'Renseignez au moins un montant encaissé.';
      } else if (Math.abs(net - due) > 0.5) {
        valid = false;
        message = `Le net encaissé (${fmt(net)} FCFA) doit être égal au total de la vente (${fmt(due)} FCFA).`;
      }
    } else if (net < 0) {
      valid = false;
      message = 'Le net encaissé ne peut pas être négatif.';
    }
  }

  return { valid, message, due, totalEncaisse, totalChange, net };
}

function rafraichirResumePaiementVente() {
  const totalDueEl = document.getElementById('vente-summary-total-due');
  if (!totalDueEl) {
    return analyserPaiementsVente();
  }

  const stats = analyserPaiementsVente();
  const totalPaidEl = document.getElementById('vente-summary-total-paid');
  const totalChangeEl = document.getElementById('vente-summary-total-change');
  const netEl = document.getElementById('vente-summary-net');
  const warningEl = document.getElementById('vente-payment-warning');

  totalDueEl.textContent = `${fmt(stats.due)} FCFA`;
  if (totalPaidEl) {
    totalPaidEl.textContent = `${fmt(stats.totalEncaisse)} FCFA`;
  }
  if (totalChangeEl) {
    totalChangeEl.textContent = `${fmt(stats.totalChange)} FCFA`;
  }
  if (netEl) {
    netEl.textContent = `${fmt(stats.net)} FCFA`;
  }
  if (warningEl) {
    warningEl.textContent = stats.valid ? '' : stats.message;
  }

  return stats;
}

function validateVentePayments(showAlert = true) {
  const stats = rafraichirResumePaiementVente();
  if (!stats.valid && showAlert) {
    alert(stats.message || 'Veuillez vérifier le détail des encaissements.');
  }
  return stats.valid;
}

    // Compression d'image
    function compressImage(file, maxWidth, maxHeight, quality, callback) {
      const reader = new FileReader();
      reader.onload = function(event) {
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const ratio = Math.min(maxWidth / img.width, maxHeight / img.height);
          canvas.width = img.width * ratio;
          canvas.height = img.height * ratio;
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          const dataUrl = canvas.toDataURL('image/jpeg', quality);
          callback(dataUrl);
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }

    // Initialisation Firebase et Firestore
    const firebaseConfig = {
      apiKey: "AIzaSyB44wUN_WitWSIjoUKtWXI6z6SuQx41_fg",
      authDomain: "africaphone1-accfb.firebaseapp.com",
      projectId: "africaphone1-accfb",
      storageBucket: "africaphone1-accfb.firebasestorage.app",
      messagingSenderId: "747416222232",
      appId: "1:747416222232:web:36cb8a93f3c8342ad3e16d",
      measurementId: "G-LFT6C3Q9D9"
    };
    firebase.initializeApp(firebaseConfig);
    firebase.firestore().enablePersistence()
  .catch(err => {
    console.error("Erreur d'activation de la persistance Firestore:", err);
  });
    const dbFirestore = firebase.firestore();

    

    // Déclaration globale
// stockId sélectionné pour l'historique
let currentHistoryStockId = null;

// Pagination dépenses  (⚙️ correctif anti-doublon)
let lastVisibleDepenses = null;
let loadingDepenses     = false;
let renderedDepenseIds  = new Set();   // ← mémorise les ID déjà rendus

// Fonction pour charger le stock depuis Firestore et le mettre en cache
function fetchAndCacheStock() {
  dbFirestore.collection("stock").get()
    .then(querySnapshot => {
      cachedStock = [];
      querySnapshot.forEach(doc => {
        cachedStock.push({ id: doc.id, ...doc.data() });
      });
      console.log("Stock chargé en cache :", cachedStock);
    })
    .catch(error => console.error("Erreur lors du chargement du stock :", error));
}

// Appeler la fonction dès le chargement de l'app
fetchAndCacheStock();

// Fonction debounce : exécute la fonction passée après un délai d'attente
function debounce(func, delay) {
  let timeoutId;
  return function(...args) {
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => {
      func.apply(this, args);
    }, delay);
  };
}


    // --- Début de la gestion du solde "dépense papa" ---

  // Fonction pour récupérer le solde actuel de dépense papa
  function getDepensePapaBalance() {
    return dbFirestore.collection("depensePapa").doc("balance")
      .get()
      .then(doc => {
        if (doc.exists) {
          return doc.data().montant || 0;
        } else {
          // Si le document n'existe pas, retourner 0
          return 0;
        }
      })
      .catch(error => {
        console.error("Erreur lors de la récupération du solde de dépense papa :", error);
        return 0;
      });
  }

  // Fonction pour mettre à jour le solde de dépense papa
  function setDepensePapaBalance(newBalance) {
    return dbFirestore.collection("depensePapa").doc("balance").set({ montant: newBalance })
      .catch(error => {
        console.error("Erreur lors de la mise à jour du solde de dépense papa :", error);
      });
  }

  // Fonction pour mettre à jour le texte du bouton "Dépense Papa" avec le solde actuel
  function updateDepensePapaButton() {
    getDepensePapaBalance().then(balance => {
      const btn = document.getElementById("btnDepensePapa");
      if (btn) {
        btn.innerHTML = `<i data-lucide="user-minus"></i> Dépense Papa : ${balance.toLocaleString()} FCFA`;
        // Recharge les icônes Lucide
        refreshLucideIcons();
      }
    }).catch(error => {
      console.error("Erreur lors de la mise à jour du bouton Dépense Papa :", error);
    });
  }

  // Fonction qui interroge la base pour récupérer la somme de toutes les dépenses de papa,
// met à jour le document "depensePapa/balance" et rafraîchit l'affichage sur le bouton.
function updateDepensePapaBalance() {
  console.log("Mise à jour du solde des dépenses Papa...");
  // Récupérer la somme des dépenses papa
  const depensesPromise = dbFirestore.collection("depenses")
    .where("type", "==", "papa")
    .get()
    .then(snapshot => {
      let totalDepenses = 0;
      snapshot.forEach(doc => {
        totalDepenses += parseFloat(doc.data().montant) || 0;
      });
      return totalDepenses;
    });
  
  // Récupérer la somme des remboursements (pour papa)
  const remboursementsPromise = dbFirestore.collection("remboursements")
    // Si nécessaire, vous pouvez filtrer ici uniquement pour les remboursements destinés aux "dépenses papa"
    .get()
    .then(snapshot => {
      let totalRemboursements = 0;
      snapshot.forEach(doc => {
        totalRemboursements += parseFloat(doc.data().montant) || 0;
      });
      return totalRemboursements;
    });
  
  return Promise.all([depensesPromise, remboursementsPromise])
    .then(([totalDepenses, totalRemboursements]) => {
      // Calculer le solde en soustrayant les remboursements des dépenses
      const newBalance = totalDepenses - totalRemboursements;
      return dbFirestore.collection("depensePapa").doc("balance").set({ montant: newBalance })
        .then(() => newBalance);
    })
    .then(newBalance => {
      console.log("Solde des dépenses Papa mis à jour :", newBalance);
      updateDepensePapaButton(); // Rafraîchit l'affichage du bouton
      return newBalance;
    })
    .catch(error => {
      console.error("Erreur dans updateDepensePapaBalance() :", error);
    });
}



  // --- Fin de la gestion du solde "dépense papa"

    /* === Fonctions centralisées pour le calcul des entrées, dépenses et solde === */
    function calculateEntreesToday() {
      const today = new Date();
      const startOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
      const endOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1).getTime() - 1;

      // Total des ventes de la journée
      const ventesPromise = dbFirestore.collection("ventes")
        .where("timestamp", ">=", startOfToday)
        .where("timestamp", "<=", endOfToday)
        .get()
        .then(snapshot => {
          let totalVentes = 0;
          snapshot.forEach(doc => {
            const data = doc.data();
            totalVentes += parseFloat(data.overallTotal) || 0;
          });
          return totalVentes;
        });

      // Total des remboursements de la journée
      const remboursementsPromise = dbFirestore.collection("remboursements")
        .where("timestamp", ">=", startOfToday)
        .where("timestamp", "<=", endOfToday)
        .get()
        .then(snapshot => {
          let totalRemboursements = 0;
          snapshot.forEach(doc => {
            const data = doc.data();
            totalRemboursements += parseFloat(data.montant) || 0;
          });
          return totalRemboursements;
        });

      return Promise.all([ventesPromise, remboursementsPromise])
        .then(([totalVentes, totalRemboursements]) => {
          return totalVentes + totalRemboursements;
        })
        .catch(error => {
          console.error("Erreur dans calculateEntreesToday : " + error.message);
          return 0;
        });
    }

    function calculateDepensesToday() {
  const today = new Date();
  const startOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
  const endOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1).getTime() - 1;

  return dbFirestore.collection("depenses")
    .where("timestamp", ">=", startOfToday)
    .where("timestamp", "<=", endOfToday)
    .get()
    .then(snapshot => {
      let totalDepenses = 0;
      snapshot.forEach(doc => {
        const data = doc.data();
        // On inclut "depense fonctionnelle" dans le calcul
        if (data.type === "depense" ||
            data.type === "depense fonctionnelle" ||
            data.type === "papa" ||
            !data.type) {
          totalDepenses += parseFloat(data.montant) || 0;
        }
      });
      return totalDepenses;
    })
    .catch(error => {
      console.error("Erreur dans calculateDepensesToday : " + error.message);
      return 0;
    });
}

// Remplacez la fonction updateBalanceDisplay existante par celle-ci

// Remplacez la fonction updateBalanceDisplay existante par celle-ci

function updateBalanceDisplay() {
    const selectedDateValue = document.getElementById('treso-date-filter').value;

    if (!selectedDateValue) {
        return;
    }

    const dateString = selectedDateValue;

    const selectedDate = new Date(selectedDateValue + 'T00:00:00');
    const startOfDayMillis = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), 0, 0, 0, 0).getTime();
    const endOfDayMillis = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), 23, 59, 59, 999).getTime();
    const startOfDayTimestamp = firebase.firestore.Timestamp.fromMillis(startOfDayMillis);
    const endOfDayTimestamp = firebase.firestore.Timestamp.fromMillis(endOfDayMillis);

    Promise.all([
        // 1. Récupération du solde initial
        dbFirestore.collection("tresorerieSnapshots").doc(dateString).get().then(doc => {
            return doc.exists ? doc.data().openingBalanceGlobal || 0 : 0;
        }),

        // 2. Récupération des ventes
        dbFirestore.collection("ventes")
            .where("timestamp", ">=", startOfDayTimestamp)
            .where("timestamp", "<=", endOfDayTimestamp)
            .get()
            .then(snapshot => {
                let totalVentes = 0;
                let totalProfit = 0;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.status !== 'annulé') {
                        totalVentes += parseFloat(data.overallTotal) || 0;
                        totalProfit += parseFloat(data.totalProfit) || 0;
                    }
                });
                return { totalVentes, totalProfit };
            }),

        // 3. Récupération des approvisionnements
        dbFirestore.collection("approvisionnement")
            .where("timestamp", ">=", startOfDayTimestamp)
            .where("timestamp", "<=", endOfDayTimestamp)
            .get()
            .then(snapshot => {
                let totalAppro = 0;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.status !== 'annulé') {
                        totalAppro += parseFloat(data.totalCost) || 0;
                    }
                });
                return totalAppro;
            }),

        // 4. Récupération des dépenses (LOGIQUE IDENTIQUE AU PDF)
        dbFirestore.collection("depenses")
            .where("timestamp", ">=", startOfDayMillis)
            .where("timestamp", "<=", endOfDayMillis)
            .get()
            .then(snapshot => {
                let totalDepensesFonctionnelles = 0;
                let totalDepensesPapa = 0;
                let totalFraisTransport = 0; // On continue de l'isoler pour l'affichage
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const montant = parseFloat(data.montant) || 0;
                    const desc = (data.description || "").toLowerCase();
                    
                    const isFraisTransport = desc.includes('frais transport achat');
                    const isApproExpense = desc.startsWith('approvisionnement');

                    if (isFraisTransport) {
                        totalFraisTransport += montant;
                    } else if (data.type === "papa") {
                        totalDepensesPapa += montant;
                    } else if (!isApproExpense) { // LA CONDITION CLÉ : On exclut les dépenses d'appro
                        totalDepensesFonctionnelles += montant;
                    }
                });
                return { totalDepensesFonctionnelles, totalDepensesPapa, totalFraisTransport };
            }),

        // 5. Récupération des remboursements
        dbFirestore.collection("remboursements")
            .where("timestamp", ">=", startOfDayMillis)
            .where("timestamp", "<=", endOfDayMillis)
            .get()
            .then(snapshot => {
                let totalRemboursements = 0;
                snapshot.forEach(doc => {
                    totalRemboursements += parseFloat(doc.data().montant) || 0;
                });
                return totalRemboursements;
            })
    ])
    .then(([
        openingBalanceGlobal,
        { totalVentes, totalProfit },
        totalAppro,
        { totalDepensesFonctionnelles, totalDepensesPapa, totalFraisTransport },
        totalRemboursements
    ]) => {
        // Le solde final doit aussi ignorer les frais de transport car ils sont déjà inclus
        // dans le coût ajusté des approvisionnements. Ici on les soustrait car on les affiche séparément.
        const soldeFinalGlobal =
            openingBalanceGlobal +
            totalVentes +
            totalRemboursements -
            totalDepensesFonctionnelles -
            totalDepensesPapa -
            totalFraisTransport - // On le soustrait car il est affiché à part
            totalAppro;
        
        // Mise à jour de l'interface utilisateur
        document.getElementById("treso-opening-balance").textContent = "XOF " + openingBalanceGlobal.toLocaleString('fr-FR');
        document.getElementById("treso-total-ventes").textContent = "+XOF " + totalVentes.toLocaleString('fr-FR');
        document.getElementById("treso-total-remboursements").textContent = "+XOF " + totalRemboursements.toLocaleString('fr-FR');
        document.getElementById("treso-total-depenses-fonctionnelles").textContent = "-XOF " + totalDepensesFonctionnelles.toLocaleString('fr-FR');
        document.getElementById("treso-total-depenses-papa").textContent = "-XOF " + totalDepensesPapa.toLocaleString('fr-FR');
        document.getElementById("treso-total-frais-transport").textContent = "-XOF " + totalFraisTransport.toLocaleString('fr-FR');
        document.getElementById("treso-total-appro").textContent = "-XOF " + totalAppro.toLocaleString('fr-FR');
        document.getElementById("treso-daily-profit").textContent = "XOF " + totalProfit.toLocaleString('fr-FR');
        document.getElementById("balance-sold").textContent = "XOF " + soldeFinalGlobal.toLocaleString('fr-FR');

        majCartesTresorerie();
    })
    .catch(error => {
        console.error("ERREUR MAJEURE DANS updateBalanceDisplay:", error);
    });
}
        /**
     * Récupère le solde cumulatif depuis le document "tresorerie/balance".
     * Retourne 0 si le doc n'existe pas ou en cas d'erreur.
     */
    function getRunningBalance() {
      return dbFirestore.collection("tresorerie").doc("balance")
        .get()
        .then(doc => {
          if (doc.exists) {
            const data = doc.data();
            return data.montant || 0;
          } else {
            // Si jamais le doc n'existe pas encore
            return 0;
          }
        })
        .catch(error => {
          console.error("Erreur getRunningBalance:", error.message);
          return 0;
        });
    }

  
    

    // Fonctions Firestore pour les ventes
    function addSaleFirestore(vente) {
      return dbFirestore.collection("ventes").add(vente)
        .then(docRef => docRef.id)
        .catch(error => { throw new Error("Erreur lors de l'ajout de la vente : " + error.message); });
    }
    function updateSaleFirestore(venteId, vente) {
      return dbFirestore.collection("ventes").doc(venteId).set(vente, { merge: true })
        .then(() => venteId)
        .catch(error => { throw new Error("Erreur lors de la mise à jour de la vente : " + error.message); });
    }
    function getSalesForTodayFirestore() {
      const today = new Date().toLocaleDateString("fr-FR");
      return dbFirestore.collection("ventes")
        .where("dateVente", "==", today)
        .get()
        .then(querySnapshot => {
          const ventes = [];
          querySnapshot.forEach(doc => {
            ventes.push({ id: doc.id, ...doc.data() });
          });
          return ventes;
        })
        .catch(error => { throw new Error("Erreur lors de la récupération des ventes : " + error.message); });
    }
    function getSaleByIdFirestore(id) {
      return dbFirestore.collection("ventes").doc(id).get()
        .then(doc => {
          if (doc.exists) {
            return { id: doc.id, ...doc.data() };
          } else {
            throw new Error("Vente non trouvée.");
          }
        })
        .catch(error => { throw new Error("Erreur lors de la récupération de la vente : " + error.message); });
    }
    function deleteSaleFirestore(id) {
      return dbFirestore.collection("ventes").doc(id).delete()
        .then(() => true)
        .catch(error => { throw new Error("Erreur lors de la suppression de la vente : " + error.message); });
    }

    function getAllSalesFirestore() {
  return dbFirestore.collection("ventes")
    .orderBy("timestamp", "desc")
    .get()
    .then(querySnapshot => {
      const ventes = [];
      querySnapshot.forEach(doc => {
        ventes.push({ id: doc.id, ...doc.data() });
      });
      return ventes;
    })
    .catch(error => { 
      throw new Error("Erreur lors de la récupération des ventes : " + error.message); 
    });
}


    // Fonctions Firestore pour le stock
    function getAllStockFirestore() {
  return new Promise((resolve, reject) => {
    dbFirestore.collection("stock").onSnapshot(snapshot => {
      const stocks = [];
      snapshot.forEach(doc => {
        stocks.push({ id: doc.id, ...doc.data() });
      });
      // Mettre à jour le cache global
      cachedStock = stocks;
      resolve(stocks);
    }, error => {
      reject(new Error("Erreur lors de la récupération du stock : " + error.message));
    });
  });
}

    function importStockToFirestore(stocks) {
      const batch = dbFirestore.batch();
      return dbFirestore.collection("stock").get()
        .then(querySnapshot => {
          querySnapshot.forEach(doc => {
            batch.delete(doc.ref);
          });
          stocks.forEach(stockItem => {
            const docRef = dbFirestore.collection("stock").doc();
            batch.set(docRef, stockItem);
          });
          return batch.commit();
        })
        .catch(error => { throw new Error("Erreur lors de l'importation du stock : " + error.message); });
    }
    /**
 * Pour chaque article vendu, décrémente le stock
 * et logue la variation (sortie).
 *
 * @param {Array<{ produit: string, quantite: number }>} items
 * @returns {Promise}
 */
function updateStockAfterSaleFirestore(items) {
  const promises = items.map(item => {
    return dbFirestore
      .collection("stock")
      .where("name", "==", item.produit)
      .get()
      .then(querySnapshot => {
        if (!querySnapshot.empty) {
          const docRef   = querySnapshot.docs[0].ref;
          const data     = querySnapshot.docs[0].data();
          const oldStock = parseFloat(data.stock) || 0;
          // on retire la quantité vendue
          const newStock = Math.max(0, oldStock - item.quantite);

          return docRef.update({ stock: newStock })
            .then(() => {
              // Log de la variation ↓
              return docRef
                .collection("history")
                .add({
                  timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                  change: -item.quantite,
                  newStock: newStock,
                  type: 'vente'
                });
            });
        }
      });
  });

  // Après toutes les mises à jour, on peut rafraîchir l'UI
  return Promise.all(promises).then(() => updateStockSummary());
}

    function restockAfterCancellationFirestore(sale) {
      const promises = sale.items.map(item => {
        return dbFirestore.collection("stock")
          .where("name", "==", item.produit)
          .get()
          .then(querySnapshot => {
            if (!querySnapshot.empty) {
              const doc = querySnapshot.docs[0];
              const stockData = doc.data();
              const newStock = stockData.stock + item.quantite;
              return dbFirestore.collection("stock").doc(doc.id).update({ stock: newStock });
            }
          });
      });
      return Promise.all(promises).then(() => updateStockSummary());
    }

    // Mise à jour de l'affichage du stock
    function updateStockSummary() {
      getAllStockFirestore().then(stocks => {
        const totalTelephones = stocks.filter(s => s.category === 'telephones').reduce((sum, s) => sum + s.stock, 0);
        const totalAccessoires = stocks.filter(s => s.category === 'accessoires').reduce((sum, s) => sum + s.stock, 0);
        document.getElementById("total-telephones").innerText = totalTelephones;
        document.getElementById("total-accessoires").innerText = totalAccessoires;
        renderInventoryPreview(stocks);
      }).catch(err => console.error("Erreur dans updateStockSummary : " + err.message));
    }

    function renderInventoryPreview(stocksData = null) {
      const preview = document.getElementById('inventoryPreview');
      const content = document.getElementById('inventoryPreviewContent');
      if (!preview || !content) return;

      const isEmployee = (typeof window !== 'undefined' && window.userRole === 'employe') ||
        (typeof document !== 'undefined' && document.body.classList.contains('role-employe'));

      if (!isEmployee) {
        preview.classList.remove('active');
        content.innerHTML = '';
        return;
      }

      preview.classList.add('active');

      const now = new Date();
      const titleEl = preview.querySelector('h2');
      if (titleEl) {
        titleEl.textContent = `Fiche d'inventaire - ${now.toLocaleDateString('fr-FR')}`;
      }

      const subtitleEl = preview.querySelector('.inventory-preview-subtitle');
      if (subtitleEl) {
        subtitleEl.textContent = "Vue interne mise à jour automatiquement. Les exports sont désactivés pour votre profil.";
      }

      content.innerHTML = '<p class="inventory-placeholder">Chargement de l\'inventaire...</p>';

      const stocksPromise = stocksData
        ? Promise.resolve(stocksData)
        : (Array.isArray(cachedStock) && cachedStock.length
            ? Promise.resolve(cachedStock)
            : getAllStockFirestore());

      stocksPromise.then(stocks => {
        if (!Array.isArray(stocks)) {
          content.innerHTML = '<p class="inventory-error">Inventaire indisponible.</p>';
          return;
        }

        const sanitizeText = (value) => String(value || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');

        const brandOrder = { 'tecno': 1, 'infinix': 2, 'itel': 3, 'redmi': 4, 'samsung': 5 };
        const getBrand = (name) => (name ? name.split(' ')[0].toLowerCase() : '');

        const telephones = stocks
          .filter(item => item.category === 'telephones')
          .sort((a, b) => {
            const orderA = brandOrder[getBrand(a.name)] || 999;
            const orderB = brandOrder[getBrand(b.name)] || 999;
            if (orderA !== orderB) return orderA - orderB;
            const brandA = getBrand(a.name);
            const brandB = getBrand(b.name);
            if (brandA !== brandB) return brandA.localeCompare(brandB);
            return (a.name || '').localeCompare(b.name || '');
          });

        const accessories = stocks
          .filter(item => item.category === 'accessoires')
          .sort((a, b) => (a.name || '').localeCompare(b.name || ''));

        const buildSection = (title, items) => {
          if (!items.length) return '';
          let total = 0;
          const rows = items.map(item => {
            const currentStock = Number(item.stock) || 0;
            total += currentStock;
            return `
              <tr>
                <td>${sanitizeText(item.name)}</td>
                <td class="align-center">${currentStock}</td>
                <td class="align-center">-</td>
              </tr>
            `;
          }).join('');

          return `
            <div class="inventory-section">
              <h3>${sanitizeText(title)}</h3>
              <table>
                <thead>
                  <tr>
                    <th>Produit</th>
                    <th>Stock actuel</th>
                    <th>Quantité comptée</th>
                  </tr>
                </thead>
                <tbody>
                  ${rows}
                </tbody>
                <tfoot>
                  <tr>
                    <td>Total ${sanitizeText(title)}</td>
                    <td class="align-center">${total}</td>
                    <td class="align-center">-</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          `;
        };

        const sections = [
          buildSection('Téléphones', telephones),
          buildSection('Accessoires', accessories)
        ].filter(Boolean);

        if (sections.length === 0) {
          content.innerHTML = '<p class="inventory-placeholder">Aucun article disponible dans l\'inventaire pour le moment.</p>';
        } else {
          content.innerHTML = sections.join('');
        }
      }).catch(err => {
        console.error('Erreur lors du rendu de l\'inventaire :', err);
        content.innerHTML = '<p class="inventory-error">Impossible de charger l\'inventaire. Veuillez réessayer plus tard.</p>';
      });
    }

    // NOUVELLE VERSION CORRIGÉE
async function demanderAnnulation(id) {
  const isEmployee = (typeof window !== 'undefined' && window.userRole === 'employe') ||
    (typeof document !== 'undefined' && document.body.classList.contains('role-employe'));
  if (isEmployee) {
    const message = "Les employés ne sont pas autorisés à annuler une vente.";
    if (typeof showToast === 'function') {
      showToast(message, 'warning');
    } else {
      alert(message);
    }
    return;
  }

  const motDePasse = prompt("Veuillez saisir le mot de passe pour annuler cette vente :");
  if (motDePasse !== "zizou") {
    alert("Mot de passe incorrect !");
    return;
  }

  if (confirm("Voulez-vous vraiment annuler cette vente ? Le stock et la trésorerie seront ajustés.")) {
    showSaleLoader(); // Affiche le spinner
    try {
      await annulerVente(id); // Appelle notre nouvelle fonction sécurisée

      // Rafraîchir l'affichage de l'historique
      const currentStatusFilter = document.getElementById('sales-tabs').value || 'all';
      filterSalesHistory(currentStatusFilter);

      // Rafraîchir les autres affichages
      updateBalanceDisplay();
      updateStockSummary();
    } catch (err) {
      console.error("Erreur lors de l'annulation de la vente :", err);
      const message = err && err.message ? err.message : "Impossible d'annuler la vente.";
      if (typeof showToast === 'function') {
        showToast(message, 'error');
      } else {
        alert(message);
      }
    } finally {
      hideSaleLoader(); // Cache le spinner
    }
  }
}

const salaryState = {
  payments: []
};

function ensureSalaryListeners() {
  const addBtn = document.getElementById('salaryAddBtn');
  if (addBtn && !addBtn.dataset.listenerAttached) {
    addBtn.addEventListener('click', () => {
      const message = "La saisie des salaires sera disponible prochainement.";
      if (typeof showToast === 'function') {
        showToast(message);
      } else {
        alert(message);
      }
    });
    addBtn.dataset.listenerAttached = 'true';
  }

  const exportBtn = document.getElementById('salaryExportBtn');
  if (exportBtn && !exportBtn.dataset.listenerAttached) {
    exportBtn.addEventListener('click', () => {
      const message = "L'export du journal des salaires sera disponible prochainement.";
      if (typeof showToast === 'function') {
        showToast(message);
      } else {
        alert(message);
      }
    });
    exportBtn.dataset.listenerAttached = 'true';
  }
}

function renderSalaryScreen() {
  const tableBody = document.getElementById('salaryTableBody');
  const emptyState = document.getElementById('salaryEmptyState');
  const totalEl = document.getElementById('salarySummaryTotal');
  const paidEl = document.getElementById('salarySummaryPaid');
  const dueEl = document.getElementById('salarySummaryDue');

  if (!tableBody || !emptyState) {
    return;
  }

  const payments = Array.isArray(salaryState.payments) ? salaryState.payments : [];

  tableBody.innerHTML = '';
  let total = 0;
  let paid = 0;

  payments.forEach((payment) => {
    const amount = Number(payment.amount) || 0;
    total += amount;

    const statusValue = ((payment.status || '') + '').toLowerCase();
    if (statusValue === 'paid' || statusValue === 'paye') {
      paid += amount;
    }

    const statusLabel = (statusValue === 'paid' || statusValue === 'paye') ? 'PAYE' : 'EN ATTENTE';

    const row = document.createElement('tr');
    row.innerHTML =
      '<td>' + (payment.employee || 'Employe') + '</td>' +
      '<td>' + (payment.period || '-') + '</td>' +
      '<td>' + fmt(amount) + ' FCFA</td>' +
      '<td>' + statusLabel + '</td>';

    tableBody.appendChild(row);
  });

  const due = Math.max(total - paid, 0);

  if (totalEl) totalEl.textContent = fmt(total) + ' FCFA';
  if (paidEl) paidEl.textContent = fmt(paid) + ' FCFA';
  if (dueEl) dueEl.textContent = fmt(due) + ' FCFA';

  emptyState.style.display = payments.length ? 'none' : 'block';
  tableBody.style.display = payments.length ? '' : 'none';

  ensureSalaryListeners();

  if (typeof lucide !== 'undefined') {
    refreshLucideIcons();
  }
}
// Hash Router pour la navigation
    function handleHashChange() {
    let hash = window.location.hash.substring(1);
    if (!hash) {
      hash = 'vendre';
    }

    if (window.userRole === 'employe') {
      const blockedForEmployees = new Set(['tresorerie', 'tresorerie-compte', 'menu', 'approvisionnement', 'approvisionnement-historique', 'aide-commande', 'article-detail', 'commande-reception', 'fournisseur-balance', 'dettes-fournisseurs', 'canaux-performance']);
      if (blockedForEmployees.has(hash)) {
        if (hash !== 'vendre') {
          window.location.hash = 'vendre';
        }
        return;
      }
    }

    showScreenByHash(hash);
    }
window.handleHashChange = handleHashChange;

let drawerFocusables = [];
let drawerLastFocusedElement = null;
let drawerAccountOutsideHandler = null;
let lastDrawerTarget = 'accueil';

function collectDrawerFocusables() {
  const drawer = document.getElementById('menuDrawerPanel');
  if (!drawer) return [];
  const selector = 'button, [href], [tabindex]:not([tabindex="-1"])';
  return Array.from(drawer.querySelectorAll(selector)).filter(el => !el.hasAttribute('disabled') && el.getAttribute('aria-hidden') !== 'true' && el.offsetParent !== null);
}

function openDrawerMenu() {
  const container = document.getElementById('screen-menu');
  const drawer = document.getElementById('menuDrawerPanel');
  if (!container || !drawer) return;
  container.setAttribute('aria-hidden', 'false');
  drawer.setAttribute('aria-hidden', 'false');
  document.body.classList.add('drawer-open');
  drawerLastFocusedElement = document.activeElement;
  drawerFocusables = collectDrawerFocusables();
  const focusTarget = drawer.querySelector('[data-drawer-focus]') || drawerFocusables[0] || drawer;
  setTimeout(() => {
    if (focusTarget && typeof focusTarget.focus === 'function') {
      focusTarget.focus();
    }
  }, 60);
  document.addEventListener('keydown', handleDrawerKeydown, true);
  closeDrawerAccountMenu();
}

function closeDrawerMenu(options = {}) {
  const { restoreFocus = true } = options;
  const container = document.getElementById('screen-menu');
  const drawer = document.getElementById('menuDrawerPanel');
  if (container) {
    container.setAttribute('aria-hidden', 'true');
  }
  if (drawer) {
    drawer.setAttribute('aria-hidden', 'true');
  }
  document.body.classList.remove('drawer-open');
  document.removeEventListener('keydown', handleDrawerKeydown, true);
  closeDrawerAccountMenu();
  drawerFocusables = [];

  if (restoreFocus) {
    const hamburger = document.querySelector('.ako-icon-btn[aria-label="Ouvrir le menu"]');
    const target = drawerLastFocusedElement && typeof drawerLastFocusedElement.focus === 'function'
      ? drawerLastFocusedElement
      : hamburger;
    setTimeout(() => target && target.focus && target.focus(), 50);
  }
  drawerLastFocusedElement = null;
}

function handleDrawerKeydown(event) {
  if (window.location.hash !== '#menu') {
    return;
  }
  if (event.key === 'Escape') {
    event.preventDefault();
    fermerDrawerMenu();
    return;
  }
  if (event.key !== 'Tab') {
    return;
  }
  if (!drawerFocusables.length) {
    drawerFocusables = collectDrawerFocusables();
  }
  if (!drawerFocusables.length) {
    return;
  }
  const first = drawerFocusables[0];
  const last = drawerFocusables[drawerFocusables.length - 1];
  if (event.shiftKey) {
    if (document.activeElement === first || document.activeElement === document.getElementById('menuDrawerPanel')) {
      event.preventDefault();
      last.focus();
    }
  } else {
    if (document.activeElement === last) {
      event.preventDefault();
      first.focus();
    }
  }
}

function fermerDrawerMenu() {
  if (window.location.hash === '#menu') {
    if (window.history.length > 1) {
      window.history.back();
    } else {
      window.location.hash = 'accueil';
    }
  } else {
    closeDrawerMenu();
  }
}

function toggleDrawerTimeTracking(button) {
  const submenu = document.getElementById('drawerTimeTrackingSubmenu');
  if (!submenu || !button) return;
  const expanded = button.getAttribute('aria-expanded') === 'true';
  button.setAttribute('aria-expanded', String(!expanded));
  submenu.setAttribute('aria-hidden', expanded ? 'true' : 'false');
  drawerFocusables = collectDrawerFocusables();
}

function openDrawerComingSoon(label) {
  const message = `${label} sera disponible prochainement.`;
  if (typeof showToast === 'function') {
    showToast(message, 'info');
  } else {
    console.info(message);
  }
}

function toggleDrawerAccountMenu() {
  const toggle = document.getElementById('drawerAccountToggle');
  const menu = document.getElementById('drawerAccountMenu');
  if (!toggle || !menu) return;
  const expanded = toggle.getAttribute('aria-expanded') === 'true';
  if (expanded) {
    closeDrawerAccountMenu();
    return;
  }
  toggle.setAttribute('aria-expanded', 'true');
  menu.setAttribute('aria-hidden', 'false');
  drawerAccountOutsideHandler = (event) => {
    if (!menu.contains(event.target) && event.target !== toggle) {
      closeDrawerAccountMenu();
    }
  };
  document.addEventListener('click', drawerAccountOutsideHandler);
}

function closeDrawerAccountMenu() {
  const toggle = document.getElementById('drawerAccountToggle');
  const menu = document.getElementById('drawerAccountMenu');
  if (toggle) {
    toggle.setAttribute('aria-expanded', 'false');
  }
  if (menu) {
    menu.setAttribute('aria-hidden', 'true');
  }
  if (drawerAccountOutsideHandler) {
    document.removeEventListener('click', drawerAccountOutsideHandler);
    drawerAccountOutsideHandler = null;
  }
}

function updateDrawerActiveItem(hash) {
  const items = document.querySelectorAll('#screen-menu .drawer-item');
  let matched = false;
  items.forEach(item => {
    const isMatch = item.dataset.hash === hash;
    item.classList.toggle('is-active', isMatch);
    if (isMatch) {
      item.setAttribute('aria-current', 'page');
      matched = true;
    } else {
      item.removeAttribute('aria-current');
    }
  });
  if (!matched) {
    const defaultItem = document.querySelector('#screen-menu .drawer-item[data-hash="accueil"]');
    if (defaultItem) {
      defaultItem.classList.add('is-active');
      defaultItem.setAttribute('aria-current', 'page');
    }
  }
}

window.fermerDrawerMenu = fermerDrawerMenu;
window.toggleDrawerTimeTracking = toggleDrawerTimeTracking;
window.openDrawerComingSoon = openDrawerComingSoon;
window.toggleDrawerAccountMenu = toggleDrawerAccountMenu;

// Votre fonction enregistrerSnapshotDaily ici
function enregistrerSnapshotDaily() {
  const today = new Date();
  const todayString = today.toISOString().split("T")[0];
  
  const historiqueRef = dbFirestore
    .collection("tresorerie")
    .doc("balance")
    .collection("historique");
  
  historiqueRef.where("dateString", "==", todayString).get()
    .then(snapshot => {
      if (snapshot.empty) {
        getRunningBalance().then(balance => {
          historiqueRef.add({
            date: firebase.firestore.Timestamp.fromDate(today),
            dateString: todayString,
            balance: balance
          })
          .then(() => {
            console.log("Snapshot enregistré pour " + todayString);
          })
          .catch(err => {
            console.error("Erreur lors de l'enregistrement du snapshot :", err.message);
          });
        });
      } else {
        console.log("Snapshot déjà existant pour " + todayString);
      }
    })
    .catch(err => {
      console.error("Erreur lors de la vérification du snapshot quotidien :", err.message);
    });
}

  
function voirHistoriqueStock(stockId, e) {
  e.stopPropagation();                       // éviter le "bubbling"
  currentHistoryStockId = stockId;          // mémoriser l'ID du produit
  window.location.hash = 'stock-history';   // basculer vers l'écran historique
}


  function showScreenByHash(hash) {
  // Masquer tous les écrans
  const allScreens = document.querySelectorAll('.screen');
  allScreens.forEach(screen => screen.classList.remove('active'));

  // Afficher l'écran correspondant au hash, sinon afficher "vendre" par défaut
  const targetScreen = document.getElementById(`screen-${hash}`);
  if (targetScreen) {
    targetScreen.classList.add('active');
  } else {
    document.getElementById('screen-vendre').classList.add('active');
    window.location.hash = 'vendre';
  }

  if (hash !== 'menu') {
    lastDrawerTarget = hash;
  }

  // Mettre à jour l'état actif de la navigation
  document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
  const activeNav = document.getElementById(`nav-${hash}`);
  if (activeNav) {
    activeNav.classList.add('active');
  }

  if (hash === 'menu') {
    openDrawerMenu();
    if (typeof refreshLucideIcons === 'function') {
      setTimeout(() => refreshLucideIcons(), 0);
    }
    updateDrawerActiveItem(lastDrawerTarget);
  } else {
    closeDrawerMenu({ restoreFocus: false });
    window.scrollTo(0, 0);
    updateDrawerActiveItem(hash);
  }

  // Gérer les cas spécifiques selon le hash
  switch (hash) {
    case 'menu':
      break;
    case 'vendre':
      break;
    case 'choisir-client':
      setupClientSelectionScreen();
      break;
    case 'ajouter-client':
      resetCreateClientForm();
      if (typeof lucide !== 'undefined') {
        refreshLucideIcons();
      }
      setTimeout(() => document.getElementById('newClientName')?.focus(), 80);
      break;
    case 'choisir-livreur':
      setupLivreurSelectionScreen();
      break;
    case 'ajouter-livreur':
      resetCreateLivreurForm();
      if (typeof lucide !== 'undefined') {
        refreshLucideIcons();
      }
      setTimeout(() => document.getElementById('newLivreurName')?.focus(), 80);
      break;
    case 'stock':
      updateStockSummary();
      renderInventoryPreview();
      break;
    case 'livraisons':
      afficherLivraisons();
      break;
     case 'scan-dynamsoft':
      // Rien de spécial à faire ici, l'écran sera déjà affiché.
      // On s'assure que les icônes sont bien rendues.
      refreshLucideIcons(); 
      break;
    case 'historique':
         populateUserFilters();
         const salesTabsDefaultValue = document.getElementById('sales-tabs').value || 'all';
        filterSalesHistory(salesTabsDefaultValue); // Pass the current tab value
        break;
    case 'aide-commande':
      initializeAideCommandePage();
      break;
    case 'cloture-vendeur':
      initClotureVendeurScreen();
      break;
    case 'livraison-detail':
        prepareLivraisonDetailScreen();
        break;
      case 'depenses':
  initEcranDepenses();        // ← nouvelle fonction
  break;
case 'article-detail':
  loadArticleDetail(); 
  break;

    // Fichier : index.html (MODIFIÉ)
    case 'tresorerie':
      // On s'assure que le filtre de date est bien réglé sur aujourd'hui
      const dateFilter = document.getElementById('treso-date-filter');
      // On ne le remplit que s'il est vide, pour ne pas écraser la sélection de l'utilisateur
      if (!dateFilter.value) {
          dateFilter.value = new Date().toISOString().split('T')[0];
      }
      updateBalanceDisplay(); // Puis on met à jour l'affichage
      break;
    case 'tresorerie-compte':
      initCompteDetailScreen();
      break;
    case 'rapports':
      // Appeler la fonction qui met à jour la section "Rapports & Statistiques"
      updateRapports();
      break;
    case 'canaux-performance':
      initCanauxPerformanceScreen();
      break;
    case 'accueil':
      updateAccueilSummary();
      break;
    case 'commande-reception':
      renderCommandeReceptionSummary();
      renderCommandeReceptionItems();
      break;
    case 'fournisseur-balance':
      renderSupplierBalanceScreen();
      break;

     case 'depots-fournisseurs':
    setupSupplierHub(); // On appelle la nouvelle fonction
    break;

    case 'approvisionnement':
        chargerApprovisionnements();
        handlePurchaseTypeChange(); // Ensure payment UI is correct on entry
        break;
    case 'profit':
      updateProfitScreen(); // Appellez ici la fonction qui met à jour et affiche les détails du profit
        break;
    case 'repertoire-imei':
      // Code spécifique pour le répertoire d'IMEI, si nécessaire
      break;
    // Ajoutez d'autres cas si nécessaire

    case 'advance':  // Ajout du cas pour la section avance
      // Vous pouvez ajouter des actions spécifiques si besoin
      break;
    case 'salaires':
      renderSalaryScreen();
      break;

      case 'panier':
  updatePanierPage();
  mettreAJourBadgeTypeVente();
  break;
       
  case 'stock-history':
  if (currentHistoryStockId) {
    chargerHistoriqueStock(currentHistoryStockId);
  }
  break;

    case 'start-day':
      break;
    case 'dettes-fournisseurs':
            chargerDettesFournisseurs();
            break;
    case 'approvisionnement-historique':
        populateUserFilters();
        chargerApprovisionnements(); 
        break; 
    case 'vendor-credit-detail':
      break;
    case 'fournisseur-credit-detail':
      
      break;
  }
}

    // Récupération de l'overlay
const offlineOverlay = document.getElementById('offlineOverlay');

// Quand on passe hors‑ligne…
window.addEventListener('offline', () => {
  offlineOverlay.style.display = 'flex';
});

// …et quand on revient en ligne
window.addEventListener('online', () => {
  offlineOverlay.style.display = 'none';
});

// Au chargement de la page, si on est déjà hors‑ligne
if (!navigator.onLine) {
  offlineOverlay.style.display = 'flex';
}


 /* ==========================================================
   PANIER – gestion centrale
   ========================================================== */
let currentArticleId = null; // Variable pour garder l'ID de l'article sélectionné
let currentItems = [];              // contenu du panier
let cachedStock  = [];              // stock en mémoire (déjà chargé)
let currentSaleMode = 'direct';     // 'direct' ou 'delivery'
const COMMISSION_PAR_TELEPHONE = 75;
let aideCommandeInitialized = false;
let aideCommandeState = {
  timeframe: 'semaine',
  lastLoadedTimeframe: null,
  articles: [],
  lowStock: [],
  suppliers: [],
  metrics: null,
  range: null
};
let aideCommandeLoadingPromise = null;
const aideCommandeLastPurchaseCache = new Map();
let clotureVendeurState = {
  date: null,
  vendeur: '',
  vendeurUid: null,
  totals: null,
  cashRemis: '',
  existing: null,
  history: [],
  users: [],
  listenersReady: false
};
let clotureVendeurLoading = false;

function getClotureUserContext() {
  const role = typeof window !== 'undefined' ? window.userRole : null;
  const privilegedRoles = new Set(['admin', 'patron']);
  const canViewAll = !!role && privilegedRoles.has(role);
  const user = (typeof firebase !== 'undefined' && firebase.auth) ? firebase.auth().currentUser : null;
  const vendorName = user ? (user.displayName || user.email || '').trim() : '';
  const vendorUid = user && user.uid ? user.uid : '';
  if (canViewAll) {
    return { canViewAll: true, vendorName: null, vendorUid: null };
  }
  return { canViewAll: false, vendorName, vendorUid };
}

function refreshLucideIcons() {
  if (typeof window !== 'undefined' && window.lucide && typeof window.lucide.createIcons === 'function') {
    window.lucide.createIcons();
  }
}

function initializeAideCommandePage(forceReload = false) {
  const topList = document.getElementById('aideCommandeTopList');
  const alertsList = document.getElementById('aideCommandeAlertsList');
  if (!topList || !alertsList) {
    return;
  }

  if (!aideCommandeInitialized) {
    const timeframeSelect = document.getElementById('aideCommandeTimeframe');
    if (timeframeSelect) {
      timeframeSelect.addEventListener('change', () => {
        aideCommandeState.timeframe = timeframeSelect.value || 'semaine';
        loadAideCommandeData(true);
      });
    }
    const supplierSelect = document.getElementById('aideCommandeSupplierFilter');
    if (supplierSelect) {
      supplierSelect.addEventListener('change', () => {
        renderAideCommandeAlerts();
      });
    }
    aideCommandeInitialized = true;
  }

  const timeframeSelect = document.getElementById('aideCommandeTimeframe');
  if (timeframeSelect && timeframeSelect.value && aideCommandeState.timeframe !== timeframeSelect.value) {
    aideCommandeState.timeframe = timeframeSelect.value;
    forceReload = true;
  }

  loadAideCommandeData(forceReload);
}

async function loadAideCommandeData(force = false) {
  const topList = document.getElementById('aideCommandeTopList');
  const alertsList = document.getElementById('aideCommandeAlertsList');
  if (!topList || !alertsList) {
    return;
  }

  if (!force &&
      aideCommandeState.lastLoadedTimeframe === aideCommandeState.timeframe &&
      Array.isArray(aideCommandeState.articles) &&
      aideCommandeState.articles.length > 0) {
    renderAideCommandeSummary(aideCommandeState.metrics, aideCommandeState.range);
    populateAideCommandeSupplierFilter(aideCommandeState.suppliers || []);
    renderAideCommandeTopList();
    renderAideCommandeAlerts();
    return;
  }

  if (aideCommandeLoadingPromise) {
    if (!force) {
      return aideCommandeLoadingPromise;
    }
    try {
      await aideCommandeLoadingPromise;
    } catch (error) {
      console.warn('Chargement precedent aide commande interrompu.', error);
    }
  }

  topList.className = 'aide-commande-empty';
  topList.textContent = 'Analyse en cours...';
  alertsList.className = 'aide-commande-empty';
  alertsList.textContent = 'Analyse en cours...';

  aideCommandeLoadingPromise = fetchAideCommandeData(aideCommandeState.timeframe)
    .then(result => {
      aideCommandeState.lastLoadedTimeframe = aideCommandeState.timeframe;
      aideCommandeState.articles = result.articles;
      aideCommandeState.lowStock = result.lowStock;
      aideCommandeState.suppliers = result.suppliers;
      aideCommandeState.metrics = result.metrics;
      aideCommandeState.range = result.range;
      renderAideCommandeSummary(result.metrics, result.range);
      populateAideCommandeSupplierFilter(result.suppliers);
      renderAideCommandeTopList();
      renderAideCommandeAlerts();
      return result;
    })
    .catch(error => {
      console.error('Erreur lors du chargement de la page aide commande :', error);
      const message = 'Impossible de charger les statistiques. Reessayez dans quelques minutes.';
      topList.className = 'aide-commande-empty';
      topList.textContent = message;
      alertsList.className = 'aide-commande-empty';
      alertsList.textContent = message;
      return null;
    })
    .finally(() => {
      aideCommandeLoadingPromise = null;
    });

  return aideCommandeLoadingPromise;
}

async function fetchAideCommandeData(timeframe) {
  const now = new Date();
  const endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
  const startDate = new Date(endDate);
  const dayOfWeek = endDate.getDay();
  const diffToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;

  if (timeframe === 'deux_semaines') {
    startDate.setDate(startDate.getDate() - (diffToMonday + 7));
  } else {
    startDate.setDate(startDate.getDate() - diffToMonday);
  }
  startDate.setHours(0, 0, 0, 0);

  const startTimestamp = firebase.firestore.Timestamp.fromDate(startDate);
  const ventesSnapshot = await dbFirestore.collection('ventes')
    .where('timestamp', '>=', startTimestamp)
    .orderBy('timestamp', 'desc')
    .get();

  const articleMap = new Map();

  ventesSnapshot.forEach(doc => {
    const data = doc.data() || {};
    const status = (data.status || '').toString().toLowerCase();
    if (status.startsWith('annul')) {
      return;
    }
    const saleTimestamp = data.timestamp && typeof data.timestamp.toDate === 'function'
      ? data.timestamp.toDate()
      : (data.timestamp ? new Date(data.timestamp) : null);

    const items = Array.isArray(data.items) ? data.items : [];
    items.forEach(item => {
      const rawName = (item.produit || item.name || item.modele || '').trim();
      if (!rawName) {
        return;
      }
      const key = rawName.toLowerCase();
      let record = articleMap.get(key);
      if (!record) {
        record = {
          produit: rawName,
          queryName: rawName,
          totalQty: 0,
          totalRevenue: 0,
          totalProfit: 0,
          saleCount: 0,
          category: item.category || null,
          lastSaleDate: saleTimestamp || null
        };
        articleMap.set(key, record);
      } else {
        if (rawName.length > record.queryName.length) {
          record.produit = rawName;
          record.queryName = rawName;
        }
        if (!record.category && item.category) {
          record.category = item.category;
        }
        if (saleTimestamp && (!record.lastSaleDate || saleTimestamp > record.lastSaleDate)) {
          record.lastSaleDate = saleTimestamp;
        }
      }

      const quantity = Number(item.quantite || item.quantity || 0);
      if (!Number.isNaN(quantity)) {
        record.totalQty += quantity;
      }

      const revenue = Number(item.total || (quantity * (Number(item.prix) || 0)));
      if (!Number.isNaN(revenue)) {
        record.totalRevenue += revenue;
      }

      const profit = Number(item.profitTotal || 0);
      if (!Number.isNaN(profit)) {
        record.totalProfit += profit;
      }

      record.saleCount += 1;
    });
  });

  let articles = Array.from(articleMap.values());
  articles.sort((a, b) => {
    if (b.totalQty !== a.totalQty) {
      return b.totalQty - a.totalQty;
    }
    if (b.totalRevenue !== a.totalRevenue) {
      return b.totalRevenue - a.totalRevenue;
    }
    return a.produit.localeCompare(b.produit, 'fr', { sensitivity: 'base' });
  });

  const stocks = await ensureAideCommandeStock();
  const stockMap = new Map();
  stocks.forEach(stockItem => {
    const name = (stockItem.name || '').trim();
    if (!name) {
      return;
    }
    const lower = name.toLowerCase();
    if (!stockMap.has(name)) {
      stockMap.set(name, stockItem);
    }
    if (!stockMap.has(lower)) {
      stockMap.set(lower, stockItem);
    }
  });

  articles = articles.map(record => {
    const stockData = stockMap.get(record.queryName) || stockMap.get(record.queryName.toLowerCase()) || null;
    const stockQty = stockData ? Number(stockData.stock) || 0 : 0;
    const status = stockQty <= 0 ? 'rupture' : stockQty <= 1 ? 'faible' : 'ok';
    const category = stockData && stockData.category ? stockData.category : record.category;
    return {
      ...record,
      stockQuantity: stockQty,
      stockStatus: status,
      category,
      lastPurchase: null
    };
  });

  const uniqueNames = Array.from(new Set(articles.map(article => article.queryName)));
  const lastPurchases = await fetchLastPurchasesForProducts(uniqueNames);

  articles.forEach(article => {
    if (lastPurchases[article.queryName]) {
      article.lastPurchase = lastPurchases[article.queryName];
    }
  });

  const lowStock = articles.filter(article => article.stockStatus !== 'ok');
  const suppliers = Array.from(new Set(
    lowStock
      .map(article => (article.lastPurchase && article.lastPurchase.fournisseur) ? article.lastPurchase.fournisseur : null)
      .filter(Boolean)
  )).sort((a, b) => a.localeCompare(b, 'fr', { sensitivity: 'base' }));

  const metrics = {
    uniqueArticles: articles.length,
    totalQuantity: articles.reduce((sum, article) => sum + (Number(article.totalQty) || 0), 0),
    lowStockCount: lowStock.length
  };

  return {
    articles,
    lowStock,
    suppliers,
    metrics,
    range: { startDate, endDate }
  };
}

async function ensureAideCommandeStock() {
  if (Array.isArray(cachedStock) && cachedStock.length) {
    return cachedStock;
  }
  const snapshot = await dbFirestore.collection('stock').get();
  const stocks = [];
  snapshot.forEach(doc => {
    stocks.push({ id: doc.id, ...doc.data() });
  });
  cachedStock = stocks;
  return stocks;
}

async function fetchLastPurchasesForProducts(productNames) {
  const results = {};
  const seen = new Set();

  for (const name of productNames) {
    const trimmed = (name || '').trim();
    if (!trimmed || seen.has(trimmed)) {
      continue;
    }
    seen.add(trimmed);

    if (aideCommandeLastPurchaseCache.has(trimmed)) {
      results[trimmed] = aideCommandeLastPurchaseCache.get(trimmed);
      continue;
    }

    const purchase = await getLastPurchaseForProduct(trimmed);
    aideCommandeLastPurchaseCache.set(trimmed, purchase);
    results[trimmed] = purchase;
  }

  return results;
}

async function getLastPurchaseForProduct(articleName) {
  const trimmed = (articleName || '').trim();
  if (!trimmed) {
    return null;
  }

  const baseQuery = dbFirestore.collection('approvisionnement')
    .where('productNames', 'array-contains', trimmed);

  try {
    const snapshot = await baseQuery.orderBy('timestamp', 'desc').limit(1).get();
    if (snapshot.empty) {
      return null;
    }
    return buildLastPurchasePayload(snapshot.docs[0], trimmed);
  } catch (error) {
    if (error && error.code === 'failed-precondition') {
      const fallbackSnapshot = await baseQuery.get();
      const docs = [];
      fallbackSnapshot.forEach(doc => docs.push(doc));
      docs.sort((a, b) => {
        const tsA = a.data()?.timestamp;
        const tsB = b.data()?.timestamp;
        const dateA = tsA && typeof tsA.toDate === 'function' ? tsA.toDate().getTime() : new Date(tsA || 0).getTime();
        const dateB = tsB && typeof tsB.toDate === 'function' ? tsB.toDate().getTime() : new Date(tsB || 0).getTime();
        return dateB - dateA;
      });
      if (!docs.length) {
        return null;
      }
      return buildLastPurchasePayload(docs[0], trimmed);
    }
    console.error('Erreur lors de la recherche du dernier achat pour', articleName, error);
    return null;
  }
}

function buildLastPurchasePayload(doc, articleName) {
  if (!doc) {
    return null;
  }
  const data = doc.data() || {};
  const timestamp = data.timestamp && typeof data.timestamp.toDate === 'function'
    ? data.timestamp.toDate()
    : (data.timestamp ? new Date(data.timestamp) : null);

  let price = null;
  if (Array.isArray(data.items)) {
    const target = articleName.toLowerCase();
    const matched = data.items.find(item => {
      const name = (item.produit || item.modele || item.name || '').trim().toLowerCase();
      return name === target;
    }) || data.items.find(item => {
      const name = (item.produit || item.modele || item.name || '').trim().toLowerCase();
      return name.includes(target);
    });

    if (matched) {
      if (matched.adjustedPrixAchat != null) {
        price = Number(matched.adjustedPrixAchat);
      } else if (matched.prixAchat != null) {
        price = Number(matched.prixAchat);
      } else if (matched.coutTotal != null && matched.quantite) {
        const qty = Number(matched.quantite);
        if (!Number.isNaN(qty) && qty > 0) {
          price = Number(matched.coutTotal) / qty;
        }
      }
    }
  }

  return {
    fournisseur: data.fournisseur || 'Inconnu',
    date: (timestamp && !Number.isNaN(timestamp.getTime())) ? timestamp : null,
    price: price != null && !Number.isNaN(price) ? price : null,
    approId: doc.id
  };
}

function renderAideCommandeSummary(metrics, range) {
  const articlesEl = document.getElementById('aideCommandeSummaryArticles');
  const quantitiesEl = document.getElementById('aideCommandeSummaryQuantities');
  const alertsEl = document.getElementById('aideCommandeSummaryAlerts');
  const rangeEl = document.getElementById('aideCommandeRange');

  if (!articlesEl || !quantitiesEl || !alertsEl) {
    return;
  }

  const uniqueArticles = metrics && metrics.uniqueArticles ? metrics.uniqueArticles : 0;
  const totalQuantity = metrics && metrics.totalQuantity ? metrics.totalQuantity : 0;
  const lowStockCount = metrics && metrics.lowStockCount ? metrics.lowStockCount : 0;

  articlesEl.textContent = Number(uniqueArticles).toLocaleString('fr-FR');
  quantitiesEl.textContent = Number(totalQuantity).toLocaleString('fr-FR');
  alertsEl.textContent = Number(lowStockCount).toLocaleString('fr-FR');

  if (rangeEl) {
    if (range && range.startDate && range.endDate) {
      rangeEl.textContent = 'Analyse du ' + formatAideCommandeDate(range.startDate) + ' au ' + formatAideCommandeDate(range.endDate);
    } else {
      rangeEl.textContent = 'Analyse de la periode selectionnee.';
    }
  }
}

function renderAideCommandeTopList() {
  const container = document.getElementById('aideCommandeTopList');
  if (!container) {
    return;
  }

  const articles = Array.isArray(aideCommandeState.articles) ? aideCommandeState.articles : [];
  if (!articles.length) {
    container.className = 'aide-commande-empty';
    container.textContent = 'Aucune vente enregistree sur la periode selectionnee.';
    return;
  }

  container.className = '';

  const rows = articles.map(article => {
    const qtyText = Number(article.totalQty || 0).toLocaleString('fr-FR');
    const revenueText = formatAideCommandeCurrency(article.totalRevenue);
    const stockText = Number(article.stockQuantity || 0).toLocaleString('fr-FR');
    const lastSale = article.lastSaleDate ? formatAideCommandeDate(article.lastSaleDate) : 'N/A';
    const supplierName = article.lastPurchase && article.lastPurchase.fournisseur
      ? aideCommandeEscapeHtml(article.lastPurchase.fournisseur)
      : 'Inconnu';
    const lastPurchaseDate = article.lastPurchase ? formatAideCommandeDate(article.lastPurchase.date) : 'N/A';
    const lastPurchasePrice = article.lastPurchase && article.lastPurchase.price != null
      ? formatAideCommandeCurrency(article.lastPurchase.price)
      : 'Prix non renseigne';
    const statusBadge = aideCommandeStatusBadge(article.stockStatus);
    const category = article.category ? '<small>' + aideCommandeEscapeHtml(article.category) + '</small>' : '';
    const rowClass = article.stockStatus !== 'ok' ? ' class="is-alert"' : '';

    return (
      '<tr' + rowClass + '>' +
        '<td class="aide-commande-article"><strong>' + aideCommandeEscapeHtml(article.produit) + '</strong>' + category + '</td>' +
        '<td><strong>' + qtyText + '</strong></td>' +
        '<td>' + revenueText + '</td>' +
        '<td>' + stockText + '<br>' + statusBadge + '</td>' +
        '<td>' + lastSale + '</td>' +
        '<td><div><strong>' + supplierName + '</strong></div><div>' + lastPurchaseDate + ' · ' + lastPurchasePrice + '</div></td>' +
      '</tr>'
    );
  }).join('');

  container.innerHTML =
    '<table class="aide-commande-table">' +
      '<thead>' +
        '<tr>' +
          '<th>Article</th>' +
          '<th>Qte vendue</th>' +
          '<th>CA (FCFA)</th>' +
          '<th>Stock</th>' +
          '<th>Derniere vente</th>' +
          '<th>Dernier achat</th>' +
        '</tr>' +
      '</thead>' +
      '<tbody>' + rows + '</tbody>' +
    '</table>';
}

function renderAideCommandeAlerts() {
  const container = document.getElementById('aideCommandeAlertsList');
  const supplierSelect = document.getElementById('aideCommandeSupplierFilter');
  if (!container) {
    return;
  }

  const selectedSupplier = supplierSelect ? supplierSelect.value : 'all';
  const alerts = Array.isArray(aideCommandeState.lowStock) ? aideCommandeState.lowStock : [];

  if (!alerts.length) {
    container.className = 'aide-commande-empty';
    container.textContent = 'Aucune alerte de stock sur la periode selectionnee.';
    return;
  }

  const filtered = alerts.filter(article => {
    if (selectedSupplier === 'all') {
      return true;
    }
    const supplierName = article.lastPurchase && article.lastPurchase.fournisseur
      ? article.lastPurchase.fournisseur
      : 'Inconnu';
    return supplierName === selectedSupplier;
  });

  if (!filtered.length) {
    container.className = 'aide-commande-empty';
    container.textContent = 'Aucune alerte pour ce fournisseur.';
    return;
  }

  container.className = 'aide-commande-alerts';
  container.innerHTML = filtered.map(article => {
    const supplierName = article.lastPurchase && article.lastPurchase.fournisseur
      ? aideCommandeEscapeHtml(article.lastPurchase.fournisseur)
      : 'Inconnu';
    const lastPurchaseDate = article.lastPurchase ? formatAideCommandeDate(article.lastPurchase.date) : 'N/A';
    const priceText = article.lastPurchase && article.lastPurchase.price != null
      ? formatAideCommandeCurrency(article.lastPurchase.price)
      : 'Prix non renseigne';
    const lastSale = article.lastSaleDate ? formatAideCommandeDate(article.lastSaleDate) : 'N/A';
    const stockText = Number(article.stockQuantity || 0).toLocaleString('fr-FR');
    const statusBadge = aideCommandeStatusBadge(article.stockStatus);

    return (
      '<div class="aide-commande-alert">' +
        '<div>' +
          '<h3>' + aideCommandeEscapeHtml(article.produit) + '</h3>' +
          statusBadge +
        '</div>' +
        '<p class="alert-meta"><strong>Stock actuel :</strong> ' + stockText + '</p>' +
        '<p class="alert-meta"><strong>Fournisseur :</strong> ' + supplierName + '</p>' +
        '<p class="alert-meta"><strong>Dernier achat :</strong> ' + lastPurchaseDate + ' · ' + priceText + '</p>' +
        '<p class="alert-meta"><strong>Derniere vente :</strong> ' + lastSale + '</p>' +
      '</div>'
    );
  }).join('');
}

function populateAideCommandeSupplierFilter(suppliers) {
  const select = document.getElementById('aideCommandeSupplierFilter');
  if (!select) {
    return;
  }

  const currentValue = select.value;
  select.innerHTML = '';

  const optionAll = document.createElement('option');
  optionAll.value = 'all';
  optionAll.textContent = 'Tous les fournisseurs';
  select.appendChild(optionAll);

  suppliers.forEach(name => {
    const option = document.createElement('option');
    option.value = name;
    option.textContent = name;
    select.appendChild(option);
  });

  if (suppliers.includes(currentValue)) {
    select.value = currentValue;
  } else {
    select.value = 'all';
  }

  select.disabled = suppliers.length === 0;
}

function formatAideCommandeDate(date) {
  if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
    return 'N/A';
  }
  return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' });
}

function formatAideCommandeCurrency(value) {
  const numeric = Number(value);
  if (Number.isNaN(numeric) || !Number.isFinite(numeric)) {
    return '0 FCFA';
  }
  return numeric.toLocaleString('fr-FR') + ' FCFA';
}

function aideCommandeEscapeHtml(value) {
  return String(value || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function aideCommandeStatusBadge(status) {
  const config = {
    rupture: { label: 'Rupture', css: 'rupture' },
    faible: { label: 'Stock 1', css: 'faible' },
    ok: { label: 'OK', css: 'ok' }
  };
  const meta = config[status] || config.ok;
  return '<span class="aide-commande-badge ' + meta.css + '">' + meta.label + '</span>';
}

// Gestion des livreurs (section livraison)
let livreursCache = [];
let livreursCacheLoaded = false;
let livreursLoadingPromise = null;
let livreurSearchMode = 'nom';
let selectedLivreurId = null;
let currentLivraisonId = null;
let currentLivraisonData = null;
let livraisonModalContext = null;
let livraisonPayments = [];
let livraisonPaymentAutoId = 0;
function ensureLivreursCache(force = false) {
  if (livreursCacheLoaded && !force) return Promise.resolve(livreursCache);
  if (livreursLoadingPromise && !force) return livreursLoadingPromise;
  if (typeof dbFirestore === 'undefined' || !dbFirestore || typeof dbFirestore.collection !== 'function') {
    livreursCacheLoaded = true;
    livreursCache = [];
    return Promise.resolve(livreursCache);
  }
  livreursLoadingPromise = dbFirestore.collection('livreurs')
    .get()
    .then(snapshot => {
      livreursCache = [];
      snapshot.forEach(doc => {
        const data = doc.data() || {};
        livreursCache.push({
          id: doc.id,
          nom: data.nom || data.name || '',
          numero: data.numero || data.telephone || data.phone || '',
          zone: data.zone || data.secteur || '',
          ...data
        });
      });
      livreursCacheLoaded = true;
      return livreursCache;
    })
    .catch(error => {
      console.error('Erreur lors du chargement des livreurs :', error);
      livreursCacheLoaded = true;
      livreursCache = [];
      return livreursCache;
    })
    .finally(() => {
      livreursLoadingPromise = null;
    });
  return livreursLoadingPromise;
}

function setLivreurSearchMode(mode, options = {}) {
  if (mode !== 'nom' && mode !== 'numero') return;
  livreurSearchMode = mode;
  const chips = document.querySelectorAll('#screen-choisir-livreur .client-search-chip');
  if (chips.length) {
    chips.forEach(chip => {
      chip.classList.toggle('active', chip.dataset.mode === mode);
    });
  }
  const input = document.getElementById('livreurSearchInput');
  if (input) {
    input.placeholder = mode === 'nom'
      ? 'Rechercher un livreur par nom'
      : 'Rechercher un livreur par numéro';
    if (!options.keepValue) {
      input.value = '';
    }
    if (!options.skipFocus) {
      input.focus();
    }
    if (!options.keepValue) {
      searchLivreurs();
    }
  }
  const feedback = document.getElementById('livreurSearchFeedback');
  if (feedback && !options.preserveFeedback) {
    feedback.textContent = 'Tapez pour lancer la recherche.';
    feedback.style.color = '#6b7280';
  }
}

function initLivreurSection() {
  if (currentSaleMode !== 'delivery') return;
  ensureLivreursCache();
  selectedLivreurId = document.getElementById('livreurId')?.value || null;
  updateLivreurSelectedSummary();
}

function searchLivreurs() {
  const input = document.getElementById('livreurSearchInput');
  const feedback = document.getElementById('livreurSearchFeedback');
  const resultsContainer = document.getElementById('livreurSearchResults');
  if (!input || !resultsContainer) return;

  const query = input.value.trim();
  if (query.length === 0) {
    if (feedback) {
      feedback.textContent = 'Tapez pour lancer la recherche.';
      feedback.style.color = '#6b7280';
    }
    resultsContainer.innerHTML = '';
    return;
  }

  ensureLivreursCache().then(list => {
    const normalized = livreurSearchMode === 'numero'
      ? query.replace(/\s+/g, '').toLowerCase()
      : query.toLowerCase();

    const filtered = list.filter(livreur => {
      if (livreurSearchMode === 'nom') {
        return (livreur.nom || '').toLowerCase().includes(normalized);
      }
      const numero = (livreur.numero || '').replace(/\s+/g, '').toLowerCase();
      return numero.includes(normalized);
    }).slice(0, 30);

    renderLivreurResults(filtered);
    if (feedback) {
      if (filtered.length === 0) {
        feedback.textContent = 'Aucun livreur trouvé. Utilisez le bouton + pour en créer un.';
        feedback.style.color = '#b91c1c';
      } else {
        feedback.textContent = `${filtered.length} livreur(s) trouvé(s).`;
        feedback.style.color = '#2563eb';
      }
    }
  });
}

function renderLivreurResults(results) {
  const container = document.getElementById('livreurSearchResults');
  if (!container) return;
  container.innerHTML = '';
  if (!Array.isArray(results) || results.length === 0) return;

  results.forEach(livreur => {
    const item = document.createElement('div');
    item.className = 'client-search-result';
    item.dataset.livreurId = livreur.id || '';
    if (livreur.id && livreur.id === selectedLivreurId) {
      item.classList.add('selected');
    }
    const numeroDisplay = livreur.numero ? livreur.numero : 'Numéro non renseigné';
    const zoneLine = livreur.zone ? `<small style="color:#64748b;">Zone : ${livreur.zone}</small>` : '';
    item.innerHTML = `
      <div>
        <h4>${livreur.nom || 'Livreur sans nom'}</h4>
        <span>${numeroDisplay}</span>
        ${zoneLine}
      </div>
    `;
    item.addEventListener('click', () => {
      selectLivreurForSale(livreur);
    });
    container.appendChild(item);
  });
}

function selectLivreurForSale(livreur) {
  if (!livreur) return;
  selectedLivreurId = livreur.id || null;
  const idInput = document.getElementById('livreurId');
  const nomInput = document.getElementById('livreurNom');
  const numeroInput = document.getElementById('livreurNumero');
  if (idInput) idInput.value = livreur.id || '';
  if (nomInput) nomInput.value = livreur.nom || '';
  if (numeroInput) numeroInput.value = livreur.numero || '';
  updateLivreurSelectedSummary();
  const items = document.querySelectorAll('#livreurSearchResults .client-search-result');
  items.forEach(item => {
    item.classList.toggle('selected', item.dataset.livreurId === (livreur.id || ''));
  });
  if (typeof lucide !== 'undefined') {
    refreshLucideIcons();
  }
  if (typeof showToast === 'function' && livreur.nom) {
    showToast(`Livreur ${livreur.nom} sélectionné.`);
  }
  if (window.location.hash === '#choisir-livreur' || window.location.hash === '#ajouter-livreur') {
    setTimeout(() => returnToSaleFromSelection(), 50);
  }
}

function updateLivreurSelectedSummary() {
  const summary = document.getElementById('livreurSelectedSummary');
  const textEl = document.getElementById('livreurSelectedText');
  const nom = document.getElementById('livreurNom')?.value.trim() || '';
  const numero = document.getElementById('livreurNumero')?.value.trim() || '';
  if (!summary || !textEl) return;
  if (nom) {
    textEl.textContent = numero ? `${nom} (${numero})` : nom;
  } else {
    textEl.textContent = 'Aucun livreur sélectionné.';
  }
}

function clearSelectedLivreur(silent = false) {
  selectedLivreurId = null;
  ['livreurId', 'livreurNom', 'livreurNumero'].forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) field.value = '';
  });
  const results = document.querySelectorAll('#livreurSearchResults .client-search-result');
  results.forEach(item => item.classList.remove('selected'));
  updateLivreurSelectedSummary();
  const searchInput = document.getElementById('livreurSearchInput');
  if (searchInput) {
    searchInput.value = '';
    searchInput.focus();
  }
  const feedback = document.getElementById('livreurSearchFeedback');
  if (feedback) {
    feedback.textContent = 'Tapez pour lancer la recherche.';
    feedback.style.color = '#6b7280';
  }
  if (!silent && typeof showToast === 'function') {
    showToast('Livreur désélectionné.');
  }
}

function createLivreurFromSale() {
  const nameInput = document.getElementById('newLivreurName');
  const phoneInput = document.getElementById('newLivreurPhone');
  const feedback = document.getElementById('livreurCreateFeedback');
  const submitBtn = document.getElementById('createLivreurSubmitBtn');
  if (!nameInput || !phoneInput) return;

  const nom = nameInput.value.trim();
  const numero = phoneInput.value.trim();

  if (feedback) {
    feedback.style.display = 'none';
    feedback.textContent = '';
  }

  if (!nom) {
    if (feedback) {
      feedback.style.display = 'block';
      feedback.style.color = '#b91c1c';
      feedback.textContent = 'Le nom du livreur est obligatoire.';
    }
    return;
  }
  if (!numero) {
    if (feedback) {
      feedback.style.display = 'block';
      feedback.style.color = '#b91c1c';
      feedback.textContent = 'Le numéro du livreur est obligatoire.';
    }
    return;
  }

  if (submitBtn) submitBtn.disabled = true;

  ensureLivreursCache().then(() => {
    if (typeof dbFirestore === 'undefined' || !dbFirestore || typeof dbFirestore.collection !== 'function') {
      throw new Error('Base de données indisponible');
    }
    return dbFirestore.collection('livreurs').add({
      nom,
      numero,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }).then(docRef => {
    const newLivreur = { id: docRef.id, nom, numero };
    livreursCache.push(newLivreur);
    livreursCacheLoaded = true;
    selectLivreurForSale(newLivreur);
    if (typeof showToast === 'function') {
      showToast('Livreur créé avec succès.');
    }
    nameInput.value = '';
    phoneInput.value = '';
    searchLivreurs();
  }).catch(error => {
    console.error('Erreur lors de la création du livreur :', error);
    if (feedback) {
      feedback.style.display = 'block';
      feedback.style.color = '#b91c1c';
      feedback.textContent = 'Impossible de créer le livreur : ' + error.message;
    }
  }).finally(() => {
    if (submitBtn) submitBtn.disabled = false;
  });
}

function ouvrirModalTypeVente() {
  const modal = document.getElementById('modalSaleType');
  if (modal) {
    modal.style.display = 'flex';
    if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
      refreshLucideIcons();
    }
  }
}

function fermerModalTypeVente() {
  const modal = document.getElementById('modalSaleType');
  if (modal) {
    modal.style.display = 'none';
  }
}

function fermerModalStockPurchase() {
  const modal = document.getElementById('modalStockPurchase');
  if (modal) {
    modal.style.display = 'none';
  }
}

function normaliserNomProduitStock(nom) {
  return (nom || '').toString().trim().toLowerCase();
}

function formatterMontantStock(valeur) {
  const nombre = parseFloat(valeur);
  if (!isFinite(nombre)) {
    return '0 FCFA';
  }
  return `${nombre.toLocaleString('fr-FR')} FCFA`;
}

function escapeHtmlStock(valeur) {
  const helper = document.createElement('div');
  helper.textContent = valeur == null ? '' : valeur;
  return helper.innerHTML;
}

function construireCarteAchatModal(appro, mouvement, articleNom) {
  const fournisseur = appro.fournisseur || 'Fournisseur';
  const initials = fournisseur
    .split(' ')
    .map(part => part && part[0] ? part[0] : '')
    .join('')
    .substring(0, 2)
    .toUpperCase();
  const avatarColor = typeof getAvatarColor === 'function' ? getAvatarColor(fournisseur) : '#3f51b5';
  const timestamp = appro.timestamp && typeof appro.timestamp.toDate === 'function'
    ? appro.timestamp.toDate()
    : (appro.timestamp ? new Date(appro.timestamp) : null);
  const dateAppro = timestamp && !isNaN(timestamp.getTime())
    ? timestamp.toLocaleString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' })
    : 'Date indisponible';

  const cible = normaliserNomProduitStock(articleNom || (mouvement && mouvement.sourceApproItemName) || '');
  const itemsArray = Array.isArray(appro.items) ? appro.items : [];
  const matchedItems = cible
    ? itemsArray.filter(item => normaliserNomProduitStock(item.produit) === cible)
    : itemsArray;

  let itemListHTML = '';
  matchedItems.forEach(item => {
    const quantity = item.quantite != null ? item.quantite : (item.receivedQty != null ? item.receivedQty : 0);
    const unitPrice = parseFloat(item.prixAchat || item.adjustedPrixAchat || 0) || 0;
    itemListHTML += `<p class="item-line">${quantity} x ${item.produit || 'Article'} - ${unitPrice.toLocaleString('fr-FR')} FCFA</p>`;
  });
  if (!itemListHTML) {
    itemListHTML = '<p class="item-line" style="color:#888;">Aucun article correspondant dans cet achat.</p>';
  }

  const fraisTransport = parseFloat(appro.fraisTransport || 0) || 0;
  const fraisTransportDisplay = fraisTransport > 0
    ? `<p class="item-line">Frais transport: <strong>${fraisTransport.toLocaleString('fr-FR')} FCFA</strong></p>`
    : '';

  const remainingAmount = parseFloat(appro.remainingAmount || 0) || 0;
  const isPaid = !!appro.isPaid && remainingAmount <= 0;
  let paymentStatusText = isPaid ? 'PAYE' : 'DUE';
  let amountColor = isPaid ? '#3880ff' : '#f04141';
  let remainingAmountDisplay = '';

  if (!isPaid && remainingAmount > 0) {
    remainingAmountDisplay = `<div class="purchase-date" style="color:${amountColor};">Solde: ${remainingAmount.toLocaleString('fr-FR')} FCFA</div>`;
  } else if (appro.paymentMethod === 'depot') {
    paymentStatusText = 'DEPOT';
    amountColor = '#6c757d';
  } else if (isPaid) {
    if (Array.isArray(appro.paymentsDetails) && appro.paymentsDetails.length > 0) {
      const comptes = [...new Set(appro.paymentsDetails.map(p => {
        const compteId = p.compteId || p.account || '';
        const compteNom = p.compteNom || (typeof getCompteNomById === 'function' ? getCompteNomById(compteId) : '');
        return compteNom || compteId;
      }))].filter(Boolean);
      paymentStatusText = comptes.length > 0 ? comptes.join(' + ') : 'PAYE';
    } else if (appro.paymentMethod === 'credit') {
      paymentStatusText = 'REGLE';
    } else if (appro.paymentMethod && appro.paymentMethod !== 'paid') {
      paymentStatusText = appro.paymentMethod.toUpperCase();
    } else {
      paymentStatusText = 'PAYE';
    }
  }

  const mouvementQty = mouvement && typeof mouvement.change !== 'undefined'
    ? Number(mouvement.change)
    : null;
  const mouvementCost = mouvement && typeof mouvement.costOfChange !== 'undefined'
    ? Number(mouvement.costOfChange)
    : null;
  const mouvementStock = mouvement && typeof mouvement.newStock !== 'undefined'
    ? Number(mouvement.newStock)
    : null;
  const mouvementTypeLabel = mouvement
    ? (mouvement.type === 'approvisionnement-reception' ? 'Reception commande' : 'Achat')
    : 'Achat';

  const productCost = (() => {
    if (typeof mouvementCost === 'number' && !isNaN(mouvementCost)) {
      return mouvementCost;
    }
    if (matchedItems.length > 0) {
      return matchedItems.reduce((total, item) => {
        const qty = parseFloat(item.quantite || item.receivedQty || 0) || 0;
        const unit = parseFloat(item.adjustedPrixAchat || item.prixAchat || 0) || 0;
        return total + qty * unit;
      }, 0);
    }
    return 0;
  })();

  const mouvementQtyDisplay = mouvementQty != null && !isNaN(mouvementQty)
    ? (mouvementQty > 0 ? '+' : '') + mouvementQty
    : 'N/A';
  const mouvementStockDisplay = mouvementStock != null && !isNaN(mouvementStock)
    ? mouvementStock
    : 'N/A';

  const mouvementSummaryHtml = `
    <div class="movement-summary">
      <div><strong>Type:</strong> ${mouvementTypeLabel}</div>
      <div><strong>Quantite:</strong> ${mouvementQtyDisplay}</div>
      <div><strong>Valeur:</strong> ${formatterMontantStock(productCost)}</div>
      <div><strong>Stock apres:</strong> ${mouvementStockDisplay}</div>
    </div>
  `;

  const autresArticles = itemsArray.length > matchedItems.length
    ? itemsArray.length - matchedItems.length
    : 0;
  const achatTotal = parseFloat(appro.totalCost || appro.receivedTotalCost || appro.orderTotalCost || 0) || 0;
  const noteParts = [];
  if (autresArticles > 0) {
    noteParts.push(`Cet achat contient ${autresArticles} autre${autresArticles > 1 ? 's' : ''} article${autresArticles > 1 ? 's' : ''}.`);
  }
  if (achatTotal && Math.abs(achatTotal - productCost) > 1) {
    noteParts.push(`Total achat: ${formatterMontantStock(achatTotal)}.`);
  }
  const noteHtml = noteParts.length ? `<p class="purchase-modal-note">${noteParts.join(' ')}</p>` : '';

  return `
    <div class="purchase-modal-card">
      <div class="main-content-wrapper">
        <div class="avatar-circle" style="background-color:${avatarColor};">${initials || 'F'}</div>
        <div class="left-info">
          <div class="supplier-name">${fournisseur}</div>
          <div class="purchase-date">${dateAppro}</div>
          <div class="item-list-container">${itemListHTML}</div>
          ${fraisTransportDisplay}
          ${remainingAmountDisplay}
          <div class="recorded-by-tag">Saisi par : <strong>${appro.enregistreParNom || 'N/A'}</strong></div>
        </div>
        <div class="right-info">
          <div class="total-amount" style="color:${amountColor};">XOF ${(productCost || 0).toLocaleString('fr-FR')}</div>
          <div class="payment-method">${paymentStatusText}</div>
        </div>
      </div>
      ${mouvementSummaryHtml}
      ${noteHtml}
    </div>
  `;
}

async function ouvrirModalAchatStock(approId, mouvement, articleNom) {
  const modal = document.getElementById('modalStockPurchase');
  const body = document.getElementById('modalStockPurchaseBody');
  if (!modal || !body) {
    console.warn('Modal achat stock indisponible.');
    return;
  }

  modal.style.display = 'flex';
  body.innerHTML = "<p style=\"text-align:center; color:#6b7280;\">Chargement du detail d'achat...</p>";

  if (!approId) {
    body.innerHTML = "<p style=\"text-align:center; color:#ef4444;\">Reference d'achat manquante.</p>";
    return;
  }

  try {
    const approDoc = await dbFirestore.collection('approvisionnement').doc(approId).get();
    if (!approDoc.exists) {
      body.innerHTML = '<p style="text-align:center; color:#ef4444;">Impossible de trouver cet achat.</p>';
      return;
    }
    const approData = approDoc.data();
    body.innerHTML = construireCarteAchatModal(approData, mouvement, articleNom);
    if (typeof refreshLucideIcons === 'function') {
      refreshLucideIcons();
    }
  } catch (error) {
    console.error('Erreur modal achat stock :', error);
    body.innerHTML = '<p style="text-align:center; color:#ef4444;">Erreur lors du chargement du detail.</p>';
  }
}

function ouvrirModalAjustementStock() {
  const isEmployee = (typeof window !== 'undefined' && window.userRole === 'employe') ||
    (typeof document !== 'undefined' && document.body.classList.contains('role-employe'));
  if (isEmployee) {
    if (typeof showToast === 'function') {
      showToast("Ajustement non autorisé pour votre profil.", "error");
    } else {
      alert("Ajustement non autorisé pour votre profil.");
    }
    return;
  }
  if (!currentArticleId) {
    if (typeof showToast === 'function') {
      showToast("Sélectionnez un article avant l'ajustement.", "warning");
    } else {
      alert("Sélectionnez un article avant l'ajustement.");
    }
    return;
  }
  const modal = document.getElementById('modalStockAdjustment');
  if (!modal) {
    console.warn('Modal ajustement stock introuvable.');
    return;
  }
  const qtyInput = document.getElementById('adjustStockQuantity');
  const reasonInput = document.getElementById('adjustStockReason');
  const errorEl = document.getElementById('adjustStockError');
  if (qtyInput) qtyInput.value = '';
  if (reasonInput) reasonInput.value = '';
  if (errorEl) errorEl.style.display = 'none';
  modal.style.display = 'flex';
  setTimeout(() => {
    qtyInput?.focus();
  }, 80);
}

function fermerModalAjustementStock() {
  const modal = document.getElementById('modalStockAdjustment');
  if (modal) {
    modal.style.display = 'none';
  }
}

async function soumettreAjustementStock() {
  const qtyInput = document.getElementById('adjustStockQuantity');
  const reasonInput = document.getElementById('adjustStockReason');
  const errorEl = document.getElementById('adjustStockError');
  const submitBtn = document.querySelector('#formStockAdjustment button[type=\"submit\"]');

  if (!qtyInput || !reasonInput) {
    console.error('Formulaire ajustement incomplet.');
    return;
  }

  const rawQty = parseFloat(qtyInput.value);
  const qty = Number.isFinite(rawQty) ? Math.trunc(rawQty) : NaN;
  const reason = reasonInput.value.trim();

  const displayError = msg => {
    if (errorEl) {
      errorEl.textContent = msg;
      errorEl.style.display = 'block';
    } else {
      alert(msg);
    }
  };

  if (!Number.isFinite(qty) || qty === 0) {
    displayError("Saisissez une quantité non nulle (positive ou négative).");
    qtyInput.focus();
    return;
  }
  if (!reason || reason.length < 3) {
    displayError("Expliquez brièvement la raison de l'ajustement (minimum 3 caractères).");
    reasonInput.focus();
    return;
  }
  if (!currentArticleId) {
    displayError("Aucun article sélectionné.");
    return;
  }

  const user = firebase.auth().currentUser;
  if (!user) {
    displayError("Session expirée. Veuillez vous reconnecter.");
    return;
  }

  if (errorEl) errorEl.style.display = 'none';
  if (submitBtn) submitBtn.disabled = true;

  try {
    await dbFirestore.runTransaction(async tx => {
      const docRef = dbFirestore.collection("stock").doc(currentArticleId);
      const snapshot = await tx.get(docRef);
      if (!snapshot.exists) {
        throw new Error("Article introuvable en base.");
      }
      const data = snapshot.data() || {};
      const currentStock = parseFloat(data.stock || 0);
      const newStock = currentStock + qty;
      if (newStock < 0) {
        throw new Error("Impossible de descendre le stock en dessous de 0.");
      }

      tx.update(docRef, {
        stock: newStock
      });

      const historyRef = docRef.collection("history").doc();
      tx.set(historyRef, {
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        change: qty,
        newStock: newStock,
        type: 'ajustement_stock',
        reason: reason,
        adjustedBy: user.displayName || user.email || user.uid || 'Utilisateur',
        adjustedByUid: user.uid || null
      });
    });

    fermerModalAjustementStock();
    if (typeof showToast === 'function') {
      showToast("Ajustement stock enregistré.", "success");
    }
    loadArticleDetail();
    loadArticleStockHistory(currentArticleId);
    if (typeof currentHistoryStockId !== 'undefined' && currentHistoryStockId === currentArticleId) {
      chargerHistoriqueStock(currentArticleId);
    }
  } catch (error) {
    console.error("Erreur ajustement stock:", error);
    displayError(error.message || "Erreur lors de l'ajustement du stock.");
  } finally {
    if (submitBtn) submitBtn.disabled = false;
  }
}

function selectionnerTypeVente(mode) {
  currentSaleMode = mode === 'delivery' ? 'delivery' : 'direct';
  mettreAJourBadgeTypeVente();
  appliquerTypeVenteAuFormulaire();
  setClientType('');
  fermerModalTypeVente();
  window.location.hash = 'panier';
  updatePanierPage();
  updateCartFooter();
}

function appliquerTypeVenteAuFormulaire() {
  toggleDeliveryFields();
}

function mettreAJourBadgeTypeVente() {
  const badge = document.getElementById('panierSaleTypeBadge');
  if (!badge) return;
  const isDelivery = currentSaleMode === 'delivery';
  badge.classList.toggle('badge-delivery', isDelivery);
  badge.classList.toggle('badge-direct', !isDelivery);
  const iconName = isDelivery ? 'truck' : 'shopping-cart';
  const label = isDelivery ? 'Livraison' : 'Vente directe';
  badge.innerHTML = `<i data-lucide="${iconName}"></i><span>${label}</span>`;
  if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
    refreshLucideIcons();
  }
  toggleDeliveryFields();
}

function ouvrirModalCloseDay() {
  if (closeDayInProgress) {
    return;
  }
  const modal = document.getElementById('modalCloseDay');
  if (modal) {
    modal.style.display = 'flex';
  }
}

function fermerModalCloseDay() {
  const modal = document.getElementById('modalCloseDay');
  if (modal) {
    modal.style.display = 'none';
  }
}

function validerClotureJournee() {
  fermerModalCloseDay();
  closeDayAndPrint();
}

function ouvrirPerformanceUtilisateur() {
  const modal = document.getElementById('modalPerformance');
  if (!modal) {
    console.warn('Modal performance introuvable.');
    return;
  }
  modal.style.display = 'flex';

  const loader = document.getElementById('performanceLoader');
  const metrics = document.getElementById('performanceMetrics');
  const summary = document.getElementById('performanceSummary');

  if (metrics) {
    metrics.innerHTML = '';
  }
  if (summary) {
    summary.textContent = '';
    summary.style.display = 'none';
  }
  if (loader) {
    loader.style.display = 'block';
  }

  chargerPerformanceUtilisateur();

  if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
    refreshLucideIcons();
  }
}

function fermerModalPerformance() {
  const modal = document.getElementById('modalPerformance');
  if (modal) {
    modal.style.display = 'none';
  }
}

async function chargerPerformanceUtilisateur() {
  const metrics = document.getElementById('performanceMetrics');
  const summary = document.getElementById('performanceSummary');
  const loader = document.getElementById('performanceLoader');

  if (!metrics || !summary) {
    if (loader) {
      loader.style.display = 'none';
    }
    return;
  }

  const user = firebase.auth().currentUser;
  if (!user) {
    summary.textContent = "Vous devez être connecté pour voir votre performance.";
    summary.style.display = 'block';
    if (loader) {
      loader.style.display = 'none';
    }
    return;
  }

  try {
    const now = new Date();
    const monthLabel = now.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0, 0);
    const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);

    const ventesSnapshot = await dbFirestore
      .collection('ventes')
      .where('enregistreParUid', '==', user.uid)
      .where('timestamp', '>=', firebase.firestore.Timestamp.fromDate(startOfMonth))
      .where('timestamp', '<=', firebase.firestore.Timestamp.fromDate(endOfMonth))
      .get();

    let totalPhones = 0;
    let totalSales = 0;

    ventesSnapshot.forEach(doc => {
      const data = doc.data();
      totalSales += 1;
      const items = Array.isArray(data.items) ? data.items : [];
      items.forEach(item => {
        const category = (item.category || '').toLowerCase();
        const quantity = Number(item.quantite) || 0;
        if (category && category.startsWith('tel')) {
          totalPhones += quantity;
        }
      });
    });

    const commission = totalPhones * COMMISSION_PAR_TELEPHONE;

    metrics.innerHTML = `
      <div class="performance-card">
        <h3>Téléphones vendus</h3>
        <strong>${totalPhones}</strong>
        <small>Mois en cours (${monthLabel})</small>
      </div>
      <div class="performance-card">
        <h3>Commission estimée</h3>
        <strong>${commission.toLocaleString('fr-FR')} FCFA</strong>
        <small>${COMMISSION_PAR_TELEPHONE.toLocaleString('fr-FR')} FCFA par téléphone</small>
      </div>
      <div class="performance-card">
        <h3>Ventes enregistrées</h3>
        <strong>${totalSales}</strong>
        <small>Toutes catégories confondues</small>
      </div>
    `;

    summary.textContent = totalPhones > 0
      ? `Bravo ! Ces chiffres couvrent vos ventes du ${monthLabel}.`
      : `Aucune vente de téléphones enregistrée pour ${monthLabel}.`;
    summary.style.display = 'block';
  } catch (error) {
    console.error('Erreur lors du calcul de la performance :', error);
    metrics.innerHTML = '';
    summary.textContent = "Impossible de récupérer vos performances pour le moment.";
    summary.style.display = 'block';
  } finally {
    if (loader) {
      loader.style.display = 'none';
    }
  }
}

/* --- MÀJ DU FOOTER PANIER ---------------------------------- */
function updateCartFooter () {
  const qtyEl   = document.getElementById('footerQuantity');
  const totalEl = document.getElementById('footerTotal');
  const btn     = document.getElementById('footerCheckout');
  if (!qtyEl || !totalEl || !btn) return;          // footer pas (encore) présent

  const q  = currentItems.reduce((s, it) => s + it.quantite, 0);
  const tt = currentItems.reduce((s, it) => s + it.total   , 0);

  qtyEl.textContent   = q;
  totalEl.textContent = tt.toLocaleString() + ' FCFA';
  btn.disabled        = (q === 0);
  if (typeof rafraichirResumePaiementVente === 'function') {
    rafraichirResumePaiementVente();
  }
}



function updateSearchCartBadge() {
  const count = currentItems.length;
  const badge = document.getElementById('searchCartCount');
  badge.textContent = count;
  badge.style.display = count > 0 ? 'flex' : 'none';
}


// Au clic sur l'icône, on va directement au panier
document.getElementById('searchCartIcon').addEventListener('click', () => {
  window.location.hash = 'panier';
  updatePanierPage();
  mettreAJourBadgeTypeVente();
});

/* Ajoute un produit ou incrémente sa quantité ------------------ */
function addOrIncrementItem(prod) {
  const isEmployee = (typeof window !== 'undefined' && window.userRole === 'employe') || (typeof document !== 'undefined' && document.body.classList.contains('role-employe'));
  const idx = currentItems.findIndex(it => it.produit === prod.name);

  if (idx > -1) {                               // déjà présent → on incrémente
    if (currentItems[idx].quantite >= prod.stock) {
      showToast("Stock épuisé !");
      return;
    }
    currentItems[idx].quantite += 1;
    currentItems[idx].total     = currentItems[idx].quantite * currentItems[idx].prix;
    currentItems[idx].category  = prod.category;
  } else {                                      // premier ajout
    if (prod.stock < 1) {
      showToast("Stock épuisé !");
      return;
    }
    currentItems.push({
      produit  : prod.name,
      prix     : isEmployee ? 0 : prod.price,
      quantite : 1,
      total    : isEmployee ? 0 : prod.price,
      category : prod.category
    });
  }

  renderMiniPanier();
  updatePanierPage();
  updateSearchCartBadge();
  updateCartFooter();            // ← NOUVEL appel
}

/* ========== Aperçu rapide dans l'étape 1 ========= */
function renderMiniPanier(){
  const zone = document.getElementById("miniPanier");
  if (!zone) return;
  if (currentItems.length === 0){
    zone.textContent = "— panier vide —";
    return;
  }
  zone.innerHTML = currentItems
      .map(it => `${it.quantite}× ${it.produit}`)
      .join("<br>");
}

/* ========== Écran #panier complet ========= */
function updatePanierPage() {
  const container = document.getElementById("panierContainer");
  const isEmployee = (typeof window !== 'undefined' && window.userRole === 'employe') || (typeof document !== 'undefined' && document.body.classList.contains('role-employe'));

  container.innerHTML = currentItems.length
    ? ""
    : "<p>Votre panier est vide.</p>";

  currentItems.forEach((item, index) => {
    const row = document.createElement("div");
    row.className = "panier-item";
    const priceValue = (isEmployee && (!item.prix || Number(item.prix) === 0)) ? '' : item.prix;
    const pricePlaceholder = isEmployee ? ' placeholder="Montant a saisir"' : '';
    row.innerHTML = `
      <strong>${item.produit}</strong><br>
      Qté :
        <input type="number" min="1" value="${item.quantite}"
               data-idx="${index}" class="inpQt">
      Prix :
        <input type="number" min="0" step="100" value="${priceValue}"${pricePlaceholder}
               data-idx="${index}" class="inpPx">
      Total :
        <span class="ligneTotal">${item.total.toLocaleString()} FCFA</span>
      <span class="remove-item" onclick="retirerArticle(${index})">×</span>
    `;
    container.appendChild(row);
  });

  container.querySelectorAll('.inpQt').forEach(el => el.oninput = onChangeQtOrPx);
  container.querySelectorAll('.inpPx').forEach(el => el.oninput = onChangeQtOrPx);

  updateCartFooter();   // ← un seul point de vérité pour le footer
}

// Le bouton du footer doit appeler la même fonction que l'ancien “Suivant”
document.getElementById('footerCheckout').onclick = continuerDepuisPanier;


// Enfin, au chargement de la page de recherche, initialiser le badge
window.addEventListener('hashchange', () => {
  if (window.location.hash === '#search-article') {
    updateSearchCartBadge();
  }
});
/* Recalcul lors d'une saisie Qté ou Prix ---------------------- */
function onChangeQtOrPx(e) {
  const idx  = +e.target.dataset.idx;
  const wrap = e.target.closest('.panier-item');
  const q    = +wrap.querySelector('.inpQt').value || 0;
  const p    = +wrap.querySelector('.inpPx').value || 0;

  const stockItem = cachedStock.find(s => s.name === currentItems[idx].produit);
  if (stockItem && q > stockItem.stock) {
    showToast("Max " + stockItem.stock);
    wrap.querySelector('.inpQt').value = stockItem.stock;
    currentItems[idx].quantite = stockItem.stock;
  } else {
    currentItems[idx].quantite = q;
  }

  currentItems[idx].prix  = p;
  currentItems[idx].total = currentItems[idx].quantite * currentItems[idx].prix;
  wrap.querySelector('.ligneTotal').textContent =
        currentItems[idx].total.toLocaleString() + " FCFA";

  updateCartFooter();            // ← NOUVEL appel
}

/* Retirer un article ----------------------------------------- */
function retirerArticle(i) {
  currentItems.splice(i, 1);

  if (window.location.hash === '#panier') {
    updatePanierPage();
  } else {
    renderMiniPanier();
  }

  updateSearchCartBadge();
  updateCartFooter();            // ← NOUVEL appel
}

/* Passer à l'écran Panier ------------------------------------ */
function ouvrirPanier(){
  window.location.hash = 'panier';
  updatePanierPage();
  updateSearchCartBadge();
  mettreAJourBadgeTypeVente();

}

function retourAccueilDepuisPanier() {
  window.location.hash = 'accueil';
  mettreAJourBadgeTypeVente();
}

/* Bouton "Suivant" depuis l'écran Panier --------------------- */
function continuerDepuisPanier() {
  if (currentItems.length === 0) return;
  appliquerTypeVenteAuFormulaire();
  window.location.hash = 'vendre';   // retour au wizard
  currentStep = 1;                   // Étape 2 : infos client
  showStep(currentStep);
  updateCartFooter();                // ← garde le footer frais
}
    // Gestion de la livraison dans la vente
    function toggleDeliveryFields() {
      const isDelivery = currentSaleMode === 'delivery';
      const deliveryCard = document.getElementById("deliveryCard");
      const paymentHint = document.getElementById("deliveryPaymentHint");
      const btnValider = document.getElementById("btnValider");
      const saleModeSummary = document.getElementById("saleModeSummary");
      const deliveryBadge = document.getElementById("deliveryModeBadge");
      if (deliveryCard) {
        deliveryCard.style.display = isDelivery ? "flex" : "none";
        if (isDelivery) {
          initLivreurSection();
        } else {
          clearSelectedLivreur(true);
          resetCreateLivreurForm();
          const lieuInput = document.getElementById("lieuLivraison");
          if (lieuInput) {
            lieuInput.value = "";
          }
        }
      }
      if (paymentHint) {
        paymentHint.style.display = isDelivery ? "block" : "none";
      }
      if (btnValider) {
        btnValider.textContent = isDelivery ? "Valider Livraison" : "Valider Vente";
      }
      if (saleModeSummary) {
        saleModeSummary.textContent = isDelivery ? "Mode de vente : Livraison" : "Mode de vente : Vente directe";
      }
      if (deliveryBadge) {
        deliveryBadge.style.display = isDelivery ? "inline-flex" : "none";
      }
    }
    function getValidationMessage() {
      return currentSaleMode === 'delivery' ? "Valider la livraison ?" : "Valider la vente ?";
    }

    // Validation et finalisation de la vente
    async function validerVente() {
      if(currentItems.length === 0) {
        alert("Veuillez ajouter au moins un article.");
        return;
      }
      const clientNom = document.getElementById("clientNom").value.trim();
      const clientNumero = document.getElementById("clientNumero").value.trim();
      const clientTypeRaw = document.getElementById("clientType")?.value || '';
      const clientTypeValue = normalizeClientType(clientTypeRaw, null);
      if(!clientNom) {
        alert("Veuillez entrer le nom du client.");
        return;
      }
      if(!clientNumero) {
        alert("Veuillez entrer le numéro WhatsApp du client.");
        return;
      }
      if(!clientTypeValue) {
        alert("Sélectionnez le type de client.");
        return;
      }
      const vendeur = document.getElementById("vendeurSelect").value;
      if(!vendeur) {
        alert("Veuillez sélectionner un canal de vente.");
        return;
      }
      const photoInput = document.getElementById("photoFacture");
      const photoFiles = photoInput ? Array.from(photoInput.files || []) : [];
      const observationsVendeur = document.getElementById("observationsVendeur").value.trim();
      const isDelivery = currentSaleMode === 'delivery';
      let livreurId = "";
      let livreurNom = "";
      let livreurNumero = "";
      let lieuLivraison = "";
      if(isDelivery) {
        livreurId = document.getElementById("livreurId")?.value.trim() || "";
        livreurNom = document.getElementById("livreurNom")?.value.trim() || "";
        livreurNumero = document.getElementById("livreurNumero")?.value.trim() || "";
        lieuLivraison = document.getElementById("lieuLivraison")?.value.trim() || "";
        if(!livreurId || !livreurNom || !livreurNumero || !lieuLivraison) {
          alert("Sélectionnez un livreur et complétez le lieu de livraison.");
          return;
        }
      }
      let compressedPhotos = [];
      try {
        compressedPhotos = await Promise.all(photoFiles.map(file => new Promise((resolve, reject) => {
          try {
            compressImage(file, 800, 800, 0.7, data => resolve(data));
          } catch (err) {
            reject(err);
          }
        })));
      } catch (error) {
        console.error("Erreur lors de la compression des images :", error);
        alert("Impossible de traiter les photos selectionnees. Veuillez reessayer.");
        return;
      }
      await finaliserVente(clientNom, clientNumero, clientTypeValue, vendeur, compressedPhotos, observationsVendeur, isDelivery, livreurId, livreurNom, livreurNumero, lieuLivraison);
    }
 async function finaliserVente(clientNom, clientNumero, clientType, vendeur, photosData, observationsVendeur, isDelivery, livreurId, livreurNom, livreurNumero, lieuLivraison) {
    const user = firebase.auth().currentUser;
    if (!user) {
      alert("Erreur: Utilisateur non connecté. Reconnexion nécessaire.");
      hideSaleLoader();
      return;
    }
    if (!validateVentePayments(true)) {
      return;
    }
  showSaleLoader();
    const saleClientType = normalizeClientType(clientType, 'ordinaire');
    
    const now = new Date();
    const dateVente = now.toLocaleDateString("fr-FR");
    const heureVente = now.toLocaleTimeString("fr-FR");

    // Calcul de l'overallTotal et calcul du profit par article
    let overallTotal = 0;
    let totalProfit = 0;

    // Pour chaque article vendu, on calcule le profit en récupérant le coût d'achat moyen
    const profitCalculations = currentItems.map(item => {
        overallTotal += parseFloat(item.total);
        return dbFirestore.collection("stock")
            .where("name", "==", item.produit)
            .get()
            .then(querySnapshot => {
                if (!querySnapshot.empty) {
                    const stockData = querySnapshot.docs[0].data();
                    // Profit unitaire = Prix de vente saisi - coût moyen (stock.price)
                    const profitUnitaire = item.prix - (stockData.price || 0);
                    const profitTotal = profitUnitaire * item.quantite;
                    totalProfit += profitTotal;
                    // Vous pouvez aussi ajouter ce profit à l'article pour le report détaillé
                    item.profitUnitaire = profitUnitaire;
                    item.profitTotal = profitTotal;
                    item.coutAchat = stockData.price || 0; // TRÈS IMPORTANT: On stocke le coût pour la dette
                }
            });
    });
    
    // On attend que tous les calculs de profit soient terminés
    await Promise.all(profitCalculations);

    const paiementStats = rafraichirResumePaiementVente();
    if (!paiementStats || !paiementStats.valid) {
        hideSaleLoader();
        alert(paiementStats && paiementStats.message ? paiementStats.message : 'Veuillez vérifier le détail des encaissements.');
        return;
    }

    const paiementDetails = ventePayments
        .map(paiement => {
            const compteId = paiement.compteId || '';
            const montantEncaisse = parseFloat(paiement.montantEncaisse) || 0;
            const monnaieRendue = parseFloat(paiement.monnaieRendue) || 0;
            if (!compteId && montantEncaisse === 0 && monnaieRendue === 0) {
                return null;
            }
            if (!compteId) {
                return null;
            }
            const compteInfo = Array.isArray(comptesCache) ? comptesCache.find(c => c.id === compteId) || {} : {};
            return {
                compteId,
                compteNom: compteInfo.nom || compteId,
                montantEncaisse,
                monnaieRendue,
                netEncaisse: montantEncaisse - monnaieRendue,
                encaissePhoto: paiement.encaissePhoto || null,
                monnaiePhoto: paiement.monnaiePhoto || null
            };
        })
        .filter(Boolean);

    if (!isDelivery && paiementDetails.length === 0) {
        hideSaleLoader();
        alert('Ajoutez au moins un encaissement valide pour finaliser la vente.');
        return;
    }

    let principalCompteId = null;
    if (paiementDetails.length > 0) {
        const paiementsPositifs = paiementDetails.filter(p => p.netEncaisse > 0);
        if (paiementsPositifs.length > 0) {
            principalCompteId = paiementsPositifs.reduce((best, current) => current.netEncaisse > best.netEncaisse ? current : best).compteId;
        } else {
            principalCompteId = paiementDetails[0].compteId;
        }
    }

    const facturePhotos = Array.isArray(photosData)
        ? photosData.filter(Boolean)
        : (photosData ? [photosData] : []);

    const vente = {
        dateVente,
        heureVente,
        clientNom,
        clientNumero,
        clientType: saleClientType,
        clientId: document.getElementById("clientId")?.value || null,
        vendeur,
        items: currentItems,
        overallTotal: overallTotal.toFixed(2),
        totalProfit: totalProfit.toFixed(2),
        photoFacture: facturePhotos[0] || null,
        photosFacture: facturePhotos,
        observationsVendeur,
        isDelivery,
        deliveryStatus: isDelivery ? "en cours" : null,
        livreurId: isDelivery ? (livreurId || null) : null,
        livreurNom: isDelivery ? livreurNom : null,
        livreurNumero: isDelivery ? livreurNumero : null,
        lieuLivraison: isDelivery ? lieuLivraison : null,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        enregistreParUid: user.uid,
        enregistreParNom: user.displayName || user.email,
        paymentsDetails: paiementDetails,
        paymentsTotalEncaisse: paiementStats.totalEncaisse,
        paymentsTotalChange: paiementStats.totalChange,
        paymentsNetEncaisse: paiementStats.net,
        principalCompteId,
        compteId: principalCompteId || null
    };

    try {
        // Étape 1 : Enregistrer la vente et récupérer son nouvel ID
        const newSaleId = await addSaleFirestore(vente);

        // Étape 2 : Mettre à jour le stock
        if (!isDelivery) {
            await updateStockAfterSaleFirestore(currentItems);
        }

        // Étape 3 : Enregistrer le mouvement de trésorerie pour la vente
        for (const paiement of paiementDetails) {
            if (paiement.montantEncaisse > 0) {
                await enregistrerMouvementTresorerie({
                    compteId: paiement.compteId,
                    type: 'vente',
                    sens: 'in',
                    montant: paiement.montantEncaisse,
                    description: `Vente ${clientNom} - encaissement`,
                    refId: newSaleId
                });
            }
            if (paiement.monnaieRendue > 0) {
                await enregistrerMouvementTresorerie({
                    compteId: paiement.compteId,
                    type: 'vente_change',
                    sens: 'out',
                    montant: paiement.monnaieRendue,
                    description: `Monnaie rendue vente ${clientNom}`,
                    refId: newSaleId
                });
            }
        }

        // --- ÉTAPE LA PLUS IMPORTANTE ---
        // Étape 4 : On lance la création des dettes de dépôt pour cette vente
        await creerDettesDeVente(newSaleId, { ...vente, timestamp: firebase.firestore.Timestamp.now() });

        // Étape 5 : Mettre à jour l'affichage des soldes
        await updateBalanceDisplay();

        // Si tout s'est bien passé
        hideSaleLoader();
        alert(isDelivery ? "Livraison validée !" : "Vente validée !");

        // Réinitialisation du formulaire et redirection
        resetVentePayments();
        clearSelectedClient();
        setClientType('');
        currentItems = [];
        window.location.hash = 'historique';
        
    } catch (error) {
        hideSaleLoader();
        alert("Erreur lors de la finalisation de la vente : " + error.message);
        console.error(error);
    }
}



    // Compression de l'image via canvas
    function compressImage(file, maxWidth, maxHeight, quality, callback) {
      const reader = new FileReader();
      reader.onload = function(event) {
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const ratio = Math.min(maxWidth / img.width, maxHeight / img.height);
          canvas.width = img.width * ratio;
          canvas.height = img.height * ratio;
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          const dataUrl = canvas.toDataURL('image/jpeg', quality);
          callback(dataUrl);
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }

    // Affichage et détails des ventes
    function afficherVentes() {
  getAllSalesFirestore()
    .then(ventes => {
      const container = document.getElementById("ventesContainer");
      container.innerHTML = "";
      if (ventes.length === 0) {
        container.innerHTML = `
          <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 250px;">
            <i data-lucide="smile" style="width: 80px; height: 80px; color: #ccc;"></i>
            <p style="font-size: 18px; color: #888; margin-top: 20px;">
              Aucune vente enregistrée…
            </p>
          </div>`;
        refreshLucideIcons();
        return;
      }
      ventes.forEach(sale => {
        const card = document.createElement("div");
        card.className = "vente-card";
        card.innerHTML = `
          <p><strong>${sale.clientNom}</strong> (${sale.clientNumero})</p>
          <p>Canal de vente : ${sale.vendeur}</p>
          <p>Articles : ${sale.items ? sale.items.length : 0}</p>
          <p>Total : ${sale.overallTotal}</p>
          <button onclick="ouvrirDetails('${sale.id}')">Détails</button>
          <button class="delete-btn" onclick="demanderAnnulation('${sale.id}')" title="Annuler la vente">×</button>
        `;
        container.appendChild(card);
      });
    })
    .catch(error => console.error("Erreur lors de la récupération des ventes : " + error.message));
}

    
    
    
    // Détails d'une vente
    function ouvrirDetails(id) {
      getSaleByIdFirestore(id)
        .then(sale => {
          let articlesText = "";
          if (Array.isArray(sale.items)) {
            sale.items.forEach(item => {
              articlesText += "• " + item.produit + " (Prix : " + item.prix + ", Qté : " + item.quantite + ", Total : " + item.total + ")<br>";
            });
          } else {
            articlesText = "Aucun article.";
          }
          let detailHTML = 
            `<p><strong>Date :</strong> ${sale.dateVente}</p>
            <p><strong>Heure :</strong> ${sale.heureVente}</p>
            <p><strong>Client :</strong> ${sale.clientNom} (${sale.clientNumero})</p>
            <p><strong>Canal de vente :</strong> ${sale.vendeur}</p>
            <p><strong>Articles :</strong><br>${articlesText}</p>
            <p><strong>Total Général :</strong> ${sale.overallTotal}</p>
            <p><strong>Observations :</strong> ${sale.observationsVendeur || "Aucune"}</p>
          `;
          if (Array.isArray(sale.paymentsDetails) && sale.paymentsDetails.length) {
            detailHTML += "<p><strong>Encaissements :</strong><br>";
            sale.paymentsDetails.forEach(paiement => {
              const compteLabel = paiement.compteNom || paiement.compteId || 'Compte';
              const monnaie = parseFloat(paiement.monnaieRendue) || 0;
              detailHTML += `- ${compteLabel} : ${fmt(parseFloat(paiement.montantEncaisse) || 0)} FCFA`;
              if (monnaie > 0) {
                detailHTML += ` (monnaie rendue ${fmt(monnaie)} FCFA)`;
              }
              detailHTML += '<br>';
            });
            const totalEncaisse = fmt(parseFloat(sale.paymentsTotalEncaisse) || 0);
            const totalChange = fmt(parseFloat(sale.paymentsTotalChange) || 0);
            const netEncaisse = fmt(parseFloat(sale.paymentsNetEncaisse) || parseFloat(sale.overallTotal) || 0);
            detailHTML += `<em>Total encaisse : ${totalEncaisse} FCFA - Monnaie rendue : ${totalChange} FCFA - Net : ${netEncaisse} FCFA</em></p>`;
          }

          if(sale.isDelivery) {
            let statusEmoji = "à En cours";
            const recapLivreurNom = sale.livreurNom || "Non renseigne";
            const recapLivreurNumero = sale.livreurNumero || "-";
            const recapLieuLivraison = sale.lieuLivraison || "Non renseigne";
            if(sale.deliveryStatus === "réussie") {
              statusEmoji = "🟢 Réussie";
            } else if(sale.deliveryStatus === "échouée") {
              statusEmoji = "🔴 Échouée";
            }
            detailHTML += 
              `<p><strong>Livraison par :</strong> ${recapLivreurNom} (${recapLivreurNumero})</p>
              <p><strong>Lieu de Livraison :</strong> ${recapLieuLivraison}</p>
              <p><strong>Statut de Livraison :</strong> ${statusEmoji}</p>`;
          }
          const facturePhotos = Array.isArray(sale.photosFacture) ? sale.photosFacture.filter(Boolean) : [];
          if (!facturePhotos.length && sale.photoFacture) {
            facturePhotos.push(sale.photoFacture);
          }
          if(facturePhotos.length) {
            const photosHtml = facturePhotos
              .map((photo, idx) => `<img src="${photo}" alt="Photo ${idx + 1}" style="max-width:100%; border-radius:5px; margin-bottom:8px;">`)
              .join("<br>");
            detailHTML += `<p><strong>Photos :</strong><br>${photosHtml}</p>`;
          }
          document.getElementById("detailContent").innerHTML = detailHTML;
          document.getElementById("modalDetail").style.display = "flex";
        })
        .catch(error => console.error("Erreur lors de la récupération de la vente : " + error.message));
    }
    function fermerModal() {
      document.getElementById("modalDetail").style.display = "none";
    }
    window.onclick = function(event) {
      if (event.target === document.getElementById("modalDetail")) {
        fermerModal();
      }
      if (event.target === document.getElementById("modalPanier")) {
        fermerPanier();
      }
      if (event.target === document.getElementById("modalAjoutOperation")) {
        fermerModalTresorerie();
      }
      if (event.target === document.getElementById("modalSaleType")) {
        fermerModalTypeVente();
      }
      if (event.target === document.getElementById("modalStockPurchase")) {
        fermerModalStockPurchase();
      }
      if (event.target === document.getElementById("modalStockAdjustment")) {
        fermerModalAjustementStock();
      }
      if (event.target === document.getElementById("modalPerformance")) {
        fermerModalPerformance();
      }
      if (event.target === document.getElementById("modalLivraisonEncaissement")) {
        fermerModalLivraisonEncaissement();
      }
      if (event.target === document.getElementById("modalVirementTresorerie")) {
        fermerModalVirementTresorerie();
      }
    };


/* ============================================================
   EXPORT PDF POUR INVENTAIRE TÉLÉPHONES (AVEC CHOIX DE LA DATE)
   ============================================================ */
document.getElementById('exportInventoryBtn')
    .addEventListener('click', async () => {
      if ((typeof window !== 'undefined' && window.userRole === 'employe') ||
          (typeof document !== 'undefined' && document.body.classList.contains('role-employe'))) {
        if (typeof showToast === 'function') {
          showToast("L'export d'inventaire n'est pas autorisé pour votre profil.", "warning");
        } else {
          alert("L'export d'inventaire n'est pas autorisé pour votre profil.");
        }
        return;
      }
      
      // --- Demander la date à l'utilisateur ---
      const dateInput = prompt(
        "Pour quelle date souhaitez-vous générer l'inventaire ? (AAAA-MM-JJ)",
        new Date().toISOString().slice(0, 10) // Propose la date du jour par défaut
      );

      // Annuler si l'utilisateur ne saisit rien ou clique sur "Annuler"
      if (!dateInput) {
        showToast("Opération annulée.");
        return;
      }

      // Valider la date saisie
      const reportDate = new Date(dateInput + 'T00:00:00'); // 'T00:00:00' évite les pbs de fuseau horaire
      if (isNaN(reportDate.getTime())) {
        alert("Date invalide ! Veuillez utiliser le format AAAA-MM-JJ.");
        return;
      }

      try {
        showToast(`Préparation de l'inventaire pour le ${reportDate.toLocaleDateString('fr-FR')}...`);

        const startOfDay = new Date(reportDate.getFullYear(), reportDate.getMonth(), reportDate.getDate());
        const startOfDayTimestamp = firebase.firestore.Timestamp.fromDate(startOfDay);

        // MODIFIÉ : On récupère tout le stock, sans filtrer par catégorie ici
        const stockSnapshot = await dbFirestore.collection("stock").get();

        let allStockItems = [];
        stockSnapshot.forEach(doc => {
            allStockItems.push({ id: doc.id, ...doc.data() });
        });

        const inventoryPhones = [];
        const inventoryAccessories = []; // NOUVEAU : Liste pour les accessoires

        const checkMovementPromises = allStockItems.map(async (item) => {
            let shouldInclude = false;
            if (item.stock >= 1) {
                shouldInclude = true;
            } else if (item.stock === 0) {
                const historySnapshot = await dbFirestore.collection("stock").doc(item.id)
                    .collection("history")
                    .where("timestamp", ">=", startOfDayTimestamp)
                    .limit(1)
                    .get();
                if (!historySnapshot.empty) {
                    shouldInclude = true;
                }
            }
            if (shouldInclude) {
                // NOUVEAU : On sépare les articles dans les bonnes listes
                if (item.category === 'telephones') {
                    inventoryPhones.push(item);
                } else if (item.category === 'accessoires') {
                    inventoryAccessories.push(item);
                }
            }
        });

        await Promise.all(checkMovementPromises);

        if (inventoryPhones.length === 0 && inventoryAccessories.length === 0) {
            alert(`Aucun article en stock ou avec un mouvement le ${reportDate.toLocaleDateString('fr-FR')} à exporter.`);
            return;
        }

        // --- Tri pour les téléphones (inchangé) ---
        const brandOrder = { 'tecno': 1, 'infinix': 2, 'itel': 3, 'redmi': 4, 'samsung': 5 };
        const getBrand = (name) => (name ? name.split(' ')[0].toLowerCase() : '');
        inventoryPhones.sort((a, b) => {
            const brandA = getBrand(a.name), brandB = getBrand(b.name);
            const orderA = brandOrder[brandA] || 999, orderB = brandOrder[brandB] || 999;
            if (orderA !== orderB) return orderA - orderB;
            if (brandA !== brandB) return brandA.localeCompare(brandB);
            return a.name.localeCompare(b.name);
        });

        // NOUVEAU : Tri alphabétique pour les accessoires
        inventoryAccessories.sort((a, b) => a.name.localeCompare(b.name));

        // --- Génération du PDF ---
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const tableColumn = ["Produit", "Stock Actuel", "Quantité Comptée"];
        let yPos = 40; // Position de départ pour le premier tableau

        // --- SECTION TÉLÉPHONES ---
        if (inventoryPhones.length > 0) {
            const phoneRows = [];
            let totalStockPhones = 0;

            inventoryPhones.forEach(item => {
                phoneRows.push([item.name, item.stock, ""]);
                totalStockPhones += (item.stock || 0);
            });

            doc.setFontSize(18);
            doc.text(`Fiche d'Inventaire des Téléphones - ${reportDate.toLocaleDateString('fr-FR')}`, 14, 22);
            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(`Rapport généré le: ${new Date().toLocaleDateString('fr-FR')}`, 14, 30);

            doc.autoTable({
                startY: yPos,
                head: [tableColumn],
                body: phoneRows,
                foot: [['TOTAL TÉLÉPHONES', totalStockPhones.toString(), '']],
                showFoot: 'lastPage',
                theme: 'grid',
                headStyles: { fillColor: [0, 96, 100] },
                footStyles: { fontStyle: 'bold', fillColor: [240, 240, 240], textColor: [0, 0, 0] },
                columnStyles: { 1: { halign: 'center' } }
            });
            
            yPos = doc.lastAutoTable.finalY + 30; // NOUVEAU : On met à jour la position pour le prochain tableau
        }

        // --- NOUVEAU : SECTION ACCESSOIRES ---
        if (inventoryAccessories.length > 0) {
            const accessoryRows = [];
            let totalStockAccessories = 0;

            inventoryAccessories.forEach(item => {
                accessoryRows.push([item.name, item.stock, ""]);
                totalStockAccessories += (item.stock || 0);
            });
            
            // On ajoute un titre pour cette nouvelle section
            doc.setFontSize(16);
            doc.text(`Fiche d'Inventaire des Accessoires`, 14, yPos);
            yPos += 15;

            doc.autoTable({
                startY: yPos,
                head: [tableColumn],
                body: accessoryRows,
                foot: [['TOTAL ACCESSOIRES', totalStockAccessories.toString(), '']],
                showFoot: 'lastPage',
                theme: 'grid',
                headStyles: { fillColor: [0, 77, 64] }, // Couleur légèrement différente pour distinguer
                footStyles: { fontStyle: 'bold', fillColor: [240, 240, 240], textColor: [0, 0, 0] },
                columnStyles: { 1: { halign: 'center' } }
            });
        }
        
        // --- Sauvegarde finale ---
        doc.save(`inventaire_complet_${dateInput}.pdf`);
        showToast("Exportation de la fiche d'inventaire terminée.");

      } catch (err) {
          console.error('Erreur lors de l\'exportation PDF de l\'inventaire :', err);
          alert('Impossible d\'exporter la fiche d\'inventaire : ' + err.message);
      }
    });

    // Export PDF (Format JSON)
    function exporterPDF() {
      const progressElem = document.getElementById("downloadProgress");
      progressElem.style.display = "block";
      progressElem.textContent = "Téléchargement en cours...";
      getSalesForTodayFirestore()
        .then(sales => {
          try {
            if (!sales || sales.length === 0) {
              throw new Error("Aucune vente récupérée.");
            }
            const jsonOutput = JSON.stringify(sales, (key, value) => {
              if(key === "photoRecu" || key === "photoFacture" || key === "photosFacture") return undefined;
              return value;
            }, 2);
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(10);
            const lines = doc.splitTextToSize(jsonOutput, 180);
            doc.text(lines, 10, 10);
            doc.addJS("var p = app.response('Entrez le mot de passe pour ouvrir ce document :'); if(p !== 'Karim123456789,x1'){ app.alert('Mot de passe incorrect. Le document va être fermé.'); this.closeDoc(); }");
            doc.save("ventes_json.pdf");
            setTimeout(() => {
              progressElem.textContent = "Téléchargement terminé";
              setTimeout(() => { progressElem.style.display = "none"; }, 2000);
            }, 1000);
          } catch (e) {
            console.error("Erreur lors de l'exportation du PDF JSON : " + e.message);
            progressElem.textContent = "Erreur lors du téléchargement: " + e.message;
            setTimeout(() => { progressElem.style.display = "none"; }, 4000);
            alert("Erreur : " + e.message);
          }
        })
        .catch(error => {
          console.error("Erreur lors de l'exportation du PDF JSON : " + error.message);
          progressElem.textContent = "Erreur lors du téléchargement: " + error.message;
          setTimeout(() => { progressElem.style.display = "none"; }, 4000);
          alert("Erreur : " + error.message);
        });
    }

    // Export Factures PDF
    function exporterFacturesPDF() {
      getSalesForTodayFirestore()
        .then(sales => {
          try {
            const preparePhotos = sale => {
              const photos = Array.isArray(sale.photosFacture) ? sale.photosFacture.filter(Boolean) : [];
              if (!photos.length && sale.photoFacture) {
                photos.push(sale.photoFacture);
              }
              return photos;
            };
            const salesWithFacture = sales
              .map(sale => ({ sale, photos: preparePhotos(sale) }))
              .filter(item => item.photos.length);
            if (!salesWithFacture.length) {
              alert("Aucune vente avec facture disponible pour l'exportation.");
              return;
            }
            salesWithFacture.sort((a, b) => b.sale.id.localeCompare(a.sale.id));
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(14);
            doc.text("Factures des Ventes", 14, 15);
            doc.setFontSize(10);
            let currentY = 25;
            const PAGE_LIMIT = 270;
            salesWithFacture.forEach(({ sale, photos }, index) => {
              if(index > 0) {
                doc.addPage();
                currentY = 20;
              }
              const writeHeader = () => {
                doc.text("Date : " + sale.dateVente, 14, currentY);
                currentY += 7;
                doc.text("Heure : " + sale.heureVente, 14, currentY);
                currentY += 7;
                doc.text("Client : " + sale.clientNom + " (" + sale.clientNumero + ")", 14, currentY);
                currentY += 7;
                doc.text("Observations : " + (sale.observationsVendeur || "Aucune"), 14, currentY);
                currentY += 7;
              };
              writeHeader();
              photos.forEach((photo, photoIdx) => {
                if(photoIdx > 0 && currentY + 45 > PAGE_LIMIT) {
                  doc.addPage();
                  currentY = 20;
                  writeHeader();
                }
                doc.text("Photo " + (photoIdx + 1), 14, currentY);
                currentY += 5;
                try {
                  doc.addImage(photo, "JPEG", 14, currentY, 60, 40);
                  currentY += 45;
                } catch (err) {
                  console.error("Erreur lors de l'ajout de l'image : " + err.message);
                  alert("Erreur lors de l'ajout de l'image pour une vente: " + err.message);
                }
              });
            });
            doc.addJS("var p = app.response('Entrez le mot de passe pour ouvrir ce document :'); if(p !== 'Karim123456789,x1'){ app.alert('Mot de passe incorrect. Le document va être fermé.'); this.closeDoc(); }");
            doc.save("factures.pdf");
          } catch (e) {
            console.error("Erreur lors de l'exportation des factures en PDF : " + e.message);
            alert("Erreur : " + e.message);
          }
        })
        .catch(error => {
          console.error("Erreur lors de l'exportation des factures en PDF : " + error.message);
          alert("Erreur : " + error.message);
        });
    }

    // Auto-suggestion pour la Vente
    const produitInput = document.getElementById("produit");
    const suggestionList = document.getElementById("suggestionList");
    produitInput.addEventListener("input", debounce(function () {
      const query = this.value.trim().toLowerCase();
      suggestionList.innerHTML = "";
      if (query === "") {
        suggestionList.style.display = "none";
        return;
      }
      // Utiliser le cache au lieu d'interroger Firestore à chaque saisie
      if (cachedStock.length === 0) {
        suggestionList.innerHTML = "<div class='suggestion-item no-result'>Données non chargées</div>";
        suggestionList.style.display = "block";
        return;
      }
      const produits = cachedStock.map(s => s.name);
      const filtered = produits.filter(name => name.toLowerCase().includes(query));
      if (filtered.length === 0) {
        const noResult = document.createElement("div");
        noResult.className = "suggestion-item no-result";
        noResult.textContent = "Aucun produit trouvé";
        suggestionList.appendChild(noResult);
      } else {
        filtered.forEach(prod => {
          const div = document.createElement("div");
          div.className = "suggestion-item";
          div.textContent = prod;
          div.addEventListener("click", function () {
            produitInput.value = prod;
            suggestionList.innerHTML = "";
            suggestionList.style.display = "none";
          });
          suggestionList.appendChild(div);
        });
      }
      suggestionList.style.display = "block";
    }, 300));


    // Auto-suggestion pour l'Entrée de Stock
    const produitEntreeInput = document.getElementById("produitEntree");
    const suggestionListEntree = document.getElementById("suggestionListEntree");
    produitEntreeInput.addEventListener("input", debounce(function () {
      const query = this.value.trim().toLowerCase();
      suggestionListEntree.innerHTML = "";
      if (query === "") {
        suggestionListEntree.style.display = "none";
        return;
      }
      // Utiliser le cache pour filtrer les produits
      if (cachedStock.length === 0) {
        suggestionListEntree.innerHTML = "<div class='suggestion-item no-result'>Données non chargées</div>";
        suggestionListEntree.style.display = "block";
        return;
      }
      const produits = cachedStock.map(s => s.name);
      const filtered = produits.filter(name => name.toLowerCase().includes(query));
      if (filtered.length === 0) {
        const noResult = document.createElement("div");
        noResult.className = "suggestion-item no-result";
        noResult.textContent = "Aucun produit trouvé";
        suggestionListEntree.appendChild(noResult);
      } else {
        filtered.forEach(prod => {
          const div = document.createElement("div");
          div.className = "suggestion-item";
          div.textContent = prod;
          div.addEventListener("click", function () {
            produitEntreeInput.value = prod;
            suggestionListEntree.innerHTML = "";
            suggestionListEntree.style.display = "none";
          });
          suggestionListEntree.appendChild(div);
        });
      }
      suggestionListEntree.style.display = "block";
    }, 300));

   // Auto-suggestion for Fournisseur (Supplier)
const fournisseurInput = document.getElementById("fournisseurAppro");
const suggestionListFournisseur = document.getElementById("suggestionListFournisseur");

fournisseurInput.addEventListener("input", debounce(async function () { // Added 'async' keyword here
  const query = this.value.trim(); // Keep original casing for 'add new' suggestion
  const lowerCaseQuery = query.toLowerCase();
  suggestionListFournisseur.innerHTML = ""; // Clear previous suggestions
  suggestionListFournisseur.style.display = "none"; // Hide by default

  if (lowerCaseQuery === "") {
    return; // No query, no suggestions
  }

  try {
    const querySnapshot = await dbFirestore.collection("fournisseurs").get();
    const suppliers = [];
    querySnapshot.forEach(doc => {
      const data = doc.data();
      if (data.name) {
        suppliers.push(data.name);
      }
    });

    let filtered = [];

    // Prioritize exact start, then includes, then fuzzy match
    // Exact match (case-insensitive)
    filtered = suppliers.filter(name => name.toLowerCase() === lowerCaseQuery);
    if (filtered.length === 0) { // If no exact match, try broader filtering
        // Contains query (case-insensitive)
        filtered = suppliers.filter(name => name.toLowerCase().includes(lowerCaseQuery));

        // Basic "fuzzy" matching for suggestions:
        // You can implement more sophisticated fuzzy matching (e.g., Levenshtein distance)
        // For simplicity, this example uses a basic "starts with any word in query" or common partials
        if (filtered.length === 0 && lowerCaseQuery.length > 2) { // Only try fuzzy if query is long enough
            const queryWords = lowerCaseQuery.split(' ').filter(word => word.length > 0);
            filtered = suppliers.filter(name => {
                const lowerName = name.toLowerCase();
                // Check if any word in the supplier name starts with the query, or query starts with supplier name's word
                return queryWords.some(qWord => lowerName.includes(qWord) || lowerName.startsWith(qWord)) ||
                       lowerName.startsWith(lowerCaseQuery); // Also include if name starts with query
            });
        }
    }


    const alreadySuggestedNames = new Set(); // To avoid duplicate suggestions (e.g. from fuzzy)

    // Add actual supplier suggestions
    filtered.forEach(supplierName => {
        if (!alreadySuggestedNames.has(supplierName)) {
            const div = document.createElement("div");
            div.className = "suggestion-item";
            div.textContent = supplierName;
            div.addEventListener("click", function () {
                fournisseurInput.value = supplierName; // Select the suggested name
                suggestionListFournisseur.innerHTML = ""; // Clear suggestions
                suggestionListFournisseur.style.display = "none"; // Hide suggestion list
            });
            suggestionListFournisseur.appendChild(div);
            alreadySuggestedNames.add(supplierName);
        }
    });

    // Option to add as new supplier
    // Only show if the typed query is not already a perfect match
    const isPerfectMatch = suppliers.some(name => name.toLowerCase() === lowerCaseQuery);
   if (!isPerfectMatch && query.length > 0) { // Ensure query is not empty
        const addNewDiv = document.createElement("div");
        addNewDiv.className = "suggestion-item add-new-supplier";
        addNewDiv.innerHTML = `<i data-lucide="plus"></i> Ajouter "<strong>${query}</strong>"`; // Texte plus court
        // Au lieu de mettre à jour directement le champ, on appelle la fonction de confirmation
        addNewDiv.addEventListener("click", function () {
            confirmerAjoutFournisseur(query); // Appelle la nouvelle fonction de confirmation
        });
        suggestionListFournisseur.appendChild(addNewDiv);
    }

    


    if (suggestionListFournisseur.children.length > 0) {
      suggestionListFournisseur.style.display = "block"; // Show if there are any suggestions (including 'add new')
    } else {
        // If no suggestions at all (even fuzzy matches) and no 'add new' option
        const noResult = document.createElement("div");
        noResult.className = "suggestion-item no-result";
        noResult.textContent = "Aucun fournisseur trouvé";
        suggestionListFournisseur.appendChild(noResult);
        suggestionListFournisseur.style.display = "block";
    }

    // Refresh Lucide icons for the new 'plus' icon if added
    refreshLucideIcons();

  } catch (err) {
    console.error("Erreur lors de la récupération des fournisseurs : " + err.message);
    const errorDiv = document.createElement("div");
    errorDiv.className = "suggestion-item no-result";
    errorDiv.textContent = "Erreur de chargement des fournisseurs.";
    suggestionListFournisseur.appendChild(errorDiv);
    suggestionListFournisseur.style.display = "block";
  }
}, 300)); // Debounce to prevent too many Firestore calls

// Hide supplier suggestions when clicking outside the input
document.addEventListener("click", function (e) {
  // Ensure we don't hide the list if the click is on the input itself
  if (e.target !== fournisseurInput && !suggestionListFournisseur.contains(e.target)) {
    suggestionListFournisseur.style.display = "none";
  }
});

function confirmerAjoutFournisseur(fournisseurName) {
    // Cacher la liste de suggestions immédiatement
    document.getElementById("suggestionListFournisseur").style.display = "none";

    // Afficher une boîte de dialogue de confirmation native
    const isConfirmed = confirm(
        `Êtes-vous sûr de vouloir ajouter "${fournisseurName}" comme nouveau fournisseur ?\n\n` +
        `Ce nom sera enregistré lorsque vous validerez l'achat.`
    );

    if (isConfirmed) {
        document.getElementById("fournisseurAppro").value = fournisseurName;
        showToast(`"${fournisseurName}" sera ajouté comme nouveau fournisseur.`);
    } else {
        // Si l'utilisateur annule, on peut vider le champ ou laisser l'utilisateur re-saisir
        // Pour l'instant, on ne fait rien, l'utilisateur peut continuer à modifier
        console.log("Ajout du fournisseur annulé par l'utilisateur.");
    }
    // Assurez-vous de vider la liste de suggestions après l'interaction
    document.getElementById("suggestionListFournisseur").innerHTML = "";
}
    // Gestion des onglets dans la section Stock
    function filterStockItems(category){
  const inputId     = category === 'telephones'
                        ? "search-telephones"
                        : category === 'accessoires'
                          ? "search-accessoires"
                          : "search-prix";
  const containerId = category === 'telephones'
                        ? "telephones-container"
                        : category === 'accessoires'
                          ? "accessoires-container"
                          : "liste-prix-container";

  const searchTerm  = document.getElementById(inputId)
                              .value.toLowerCase();
  const cont        = document.getElementById(containerId);
  cont.innerHTML = "";

  getAllStockFirestore().then(stocks=>{
    const filtered = stocks.filter(p =>
      p.category === category &&
      p.name.toLowerCase().includes(searchTerm));

    if(filtered.length === 0){
      cont.innerHTML = "<p>Aucun produit trouvé.</p>";
      return;
    }

    filtered.forEach(prod=>{
      const card = document.createElement("div");
      card.className = "product-card";
      card.innerHTML = `
        <button class="history-btn"
                onclick="voirHistoriqueStock('${prod.id}', event)"
                title="Historique">
          <i data-lucide="history"></i>
        </button>

        <div class="product-icon">${prod.icon}</div>
        <div class="product-details">
          <h3>${prod.name}</h3>
          <p>🔹 Stock : ${prod.stock} unités</p>
          <p class="price-label">💰 Prix : ${prod.price.toLocaleString()} FCFA</p>
        </div>
      `;
      cont.appendChild(card);
    });

    refreshLucideIcons();
  })
  .catch(err=>console.error("filterStockItems :",err.message));
}
    let currentStockCategory = "";
    function updateStockSummary() {
      getAllStockFirestore().then(stocks => {
        const totalTelephones = stocks.filter(s => s.category === 'telephones').reduce((sum, s) => sum + s.stock, 0);
        const totalAccessoires = stocks.filter(s => s.category === 'accessoires').reduce((sum, s) => sum + s.stock, 0);
        document.getElementById("total-telephones").innerText = totalTelephones;
        document.getElementById("total-accessoires").innerText = totalAccessoires;
      }).catch(err => console.error("Erreur dans updateStockSummary : " + err.message));
    }
    function showStockCategory(category) {
      currentStockCategory = category;
      document.getElementById("stock-home").style.display = "none";
      document.getElementById("stock-category").style.display = "block";
      const searchInput = document.getElementById("search-category");
      if (!searchInput) {
        console.error('L\'élément avec l\'id "search-category" n\'a pas été trouvé.');
        return;
      }
      searchInput.placeholder = category === "telephones" ? "Rechercher un téléphone..." : "Rechercher un accessoire...";
      searchInput.value = "";
      filterStockCategory();
    }
    function backToStockHome() {
      document.getElementById("stock-category").style.display = "none";
      document.getElementById("stock-home").style.display = "block";
    }
    function filterStockCategory() {
    const searchTerm = document
        .getElementById("search-category")
        .value.toLowerCase();

    getAllStockFirestore().then(stocks => {
        /* -- filtrage + tri perso -- */
        const filtered = stocks
            .filter(p =>
                p.category === currentStockCategory &&
                p.name.toLowerCase().includes(searchTerm))
            .sort((a, b) => {
                const ordre = { tecno: 1, infinix: 2, itel: 3, redmi: 4 };
                const rA = ordre[a.name.split(" ")[0].toLowerCase()] || 5;
                const rB = ordre[b.name.split(" ")[0].toLowerCase()] || 5;
                return rA !== rB ? rA - rB : a.name.localeCompare(b.name);
            });

        /* -- construction DOM -- */
        const cont = document.getElementById("category-container");
        cont.innerHTML = "";
        if (filtered.length === 0) {
            cont.innerHTML = "<p>Aucun produit trouvé.</p>";
            return;
        }

        filtered.forEach(prod => {
            const card = document.createElement("div");
            card.className = "product-card";
            card.innerHTML = `
                <button class="history-btn"
                        onclick="voirHistoriqueStock('${prod.id}', event)"
                        title="Historique">
                  <i data-lucide="history"></i>
                </button>
                <div class="product-icon">${prod.icon}</div>
                <div class="product-details">
                  <h3>${prod.name}</h3>
                  <p>🔹 Stock : ${prod.stock} unités</p>
                  <p class="price-label">💰 Prix : ${prod.price.toLocaleString()} FCFA</p>
                </div>
              `;

            // =========================================================
            // === LA LIGNE MAGIQUE À AJOUTER EST ICI ===
            // =========================================================
            card.onclick = function() {
                showArticleDetail(prod.id);
            };
            // =========================================================

            cont.appendChild(card);
        });

        refreshLucideIcons();
    })
    .catch(err => console.error("filterStockCategory :", err.message));
}

    // Importation du stock depuis un fichier TXT
    function importStockFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      readAndImport(file);
    }
    function readAndImport(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        parseStockText(text);
      };
      reader.readAsText(file);
    }
    function parseStockText(text) {
      const lines = text.split("\n");
      let importedStocks = [];
      const selectedCategory = document.getElementById("importCategorie").value;
      for (let i = 0; i < lines.length; i++) {
        let line = lines[i].trim();
        if (!line) continue;
        if (line.toLowerCase().includes("articles")) continue;
        const parts = line.split("\t").filter(Boolean);
        if (parts.length < 3) continue;
        const name = parts[0].trim();
        const stock = parseInt(parts[1].trim());
        let priceText = parts[2].trim();
        let price = parseInt(priceText.replace(/[^\d]/g, ""));
        const category = selectedCategory;
        const icon = category === "accessoires" ? "🎧" : "📱";
        importedStocks.push({ name, category, stock, price, icon, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      }
      importStockToFirestore(importedStocks)
        .then(() => {
          alert("Stock importé avec succès !");
          updateStockSummary();
        })
        .catch(err => {
          alert("Erreur lors de l'importation du stock : " + err.message);
        });
    }

    // Gestion de l'Entrée de Stock
    function calculerTotalEntree() {
      const prix = parseFloat(document.getElementById("prixEntree").value) || 0;
      const quantite = parseInt(document.getElementById("quantiteEntree").value) || 0;
      document.getElementById("totalEntree").value = (prix * quantite).toFixed(2);
    }
    function decrementQuantityEntree() {
      const input = document.getElementById("quantiteEntree");
      let value = parseInt(input.value) || 1;
      if(value > 1) {
        input.value = --value;
        calculerTotalEntree();
      }
    }
    function incrementQuantityEntree() {
      const input = document.getElementById("quantiteEntree");
      let value = parseInt(input.value) || 1;
      input.value = ++value;
      calculerTotalEntree();
    }
    function ajouterEntreeStock() {
      const produit = document.getElementById("produitEntree").value.trim();
      const prix = parseFloat(document.getElementById("prixEntree").value);
      const quantite = parseInt(document.getElementById("quantiteEntree").value);
      const categorie = document.getElementById("categorieEntree").value;
      const total = document.getElementById("totalEntree").value;
      if(!produit) {
        alert("Veuillez saisir le nom de l'article.");
        return;
      }
      if(!prix || prix <= 0) {
        alert("Veuillez entrer un prix d'achat valide.");
        return;
      }
      if(!quantite || quantite <= 0) {
        alert("Veuillez entrer une quantité valide.");
        return;
      }
      ajouterOuMettreAJourStock(produit, quantite, prix, categorie)
        .then(() => {
          alert("Entrée de stock ajoutée !");
          document.getElementById("produitEntree").value = "";
          document.getElementById("prixEntree").value = "";
          document.getElementById("quantiteEntree").value = 1;
          document.getElementById("totalEntree").value = "";
          updateStockSummary();
        })
        .catch(err => {
          alert("Erreur lors de l'ajout de l'entrée de stock : " + err.message);
        });
    }
    function ajouterOuMettreAJourStock(produit, quantite, prix, category) {
  // Cherche si le produit existe déjà 
  return dbFirestore
    .collection("stock")
    .where("name", "==", produit)
    .get()
    .then(querySnapshot => {
      if (!querySnapshot.empty) {
        // —— CAS EXISTANT : on met à jour le stock + prix moyen
        const docRef   = querySnapshot.docs[0].ref;
        const data     = querySnapshot.docs[0].data();
        const oldStock = parseFloat(data.stock) || 0;
        const oldPrice = parseFloat(data.price) || 0;

        const newStock = oldStock + quantite;
        // Prix moyen pondéré
        const newPrice = ((oldStock * oldPrice) + (quantite * prix)) / newStock;

        return docRef.update({
          stock: newStock,
          price: newPrice
        })
        .then(() => {
          // Log de la variation ↑
          return docRef
            .collection("history")
            .add({
              timestamp: firebase.firestore.FieldValue.serverTimestamp(),
              change: +quantite,
              newStock: newStock
            });
        });
      } else {
        // —— CAS NOUVEAU : on crée un nouveau document
        const icon = category === "accessoires" ? "🎧" : "📱";
        const newRecord = {
          name: produit,
          category: category,
          stock: quantite,
          price: prix,
          icon: icon,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        return dbFirestore
          .collection("stock")
          .add(newRecord)
          .then(docRef => {
            // Log de la variation ↑ (équivalent à "stock = quantite")
            return docRef
              .collection("history")
              .add({
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                change: +quantite,
                newStock: quantite
              });
          });
      }
    });
}

    // Gestion des canaux de vente (liste fixe)
    const CANAUX_VENTE = [
      "Facebook Marketplace",
      "Publicité Facebook",
      "Facebook",
      "Publicité Tiktok",
      "Tiktok",
      "Publicité Google",
      "Google",
      "Boutique",
      "CoinAfrique"
    ];

    function chargerVendeurs() {
      const select = document.getElementById("vendeurSelect");
      if (select) {
        select.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "Sélectionnez un canal";
        placeholder.disabled = true;
        placeholder.selected = true;
        select.appendChild(placeholder);
        CANAUX_VENTE.forEach(canal => {
          const option = document.createElement("option");
          option.value = canal;
          option.textContent = canal;
          select.appendChild(option);
        });
      }

      const liste = document.getElementById("listeVendeurs");
      if (liste) {
        liste.innerHTML = "";
        CANAUX_VENTE.forEach(canal => {
          const div = document.createElement("div");
          div.textContent = canal;
          liste.appendChild(div);
        });
      }
    }
    function ajouterVendeur() {
      alert("La liste des canaux de vente est fixe : Boutique, WhatsApp, Facebook Marketplace, Instagram et CoinAfrique.");
    }
    function supprimerVendeur(id) {
      alert("La liste des canaux de vente est fixe et ne peut pas être modifiée depuis cette interface.");
    }
    window.addEventListener("load", function() {
      chargerVendeurs();
    });

    // Vibration sur clic
    document.querySelectorAll('.btn-modern').forEach(button => {
      button.addEventListener('click', () => {
        if(navigator.vibrate) {
          navigator.vibrate(30);
        }
      });
    });
    window.addEventListener('load', () => {
      refreshLucideIcons();
    });
    let comptesCache = [];   // [{id:'caisse', nom:'Caisse', solde:…}, …]

let currentCompteDetailId = null;

function getCompteDisplayName(compteId) {
  if (!compteId) {
    return 'Compte';
  }
  const match = comptesCache.find(c => c.id === compteId);
  if (match && match.nom) {
    return match.nom;
  }
  return compteId;
}

function getOpeningSnapshotValue(snapshotDoc, compteId) {
  if (!snapshotDoc || !snapshotDoc.exists || !compteId) {
    return 0;
  }
  const data = snapshotDoc.data() || {};
  const capitalizedId = compteId.charAt(0).toUpperCase() + compteId.slice(1);
  const directKey = `opening${capitalizedId}`;
  if (Object.prototype.hasOwnProperty.call(data, directKey)) {
    return Number(data[directKey]) || 0;
  }
  if (data.openingBalances && Object.prototype.hasOwnProperty.call(data.openingBalances, compteId)) {
    return Number(data.openingBalances[compteId]) || 0;
  }
  return 0;
}

function formatXof(amount) {
  const numeric = Number(amount) || 0;
  return 'XOF ' + numeric.toLocaleString('fr-FR');
}

function formatSignedXof(amount, signType) {
  const numeric = Number(amount) || 0;
  const absolute = Math.abs(numeric).toLocaleString('fr-FR');
  if (signType === 'positive') {
    return '+XOF ' + absolute;
  }
  if (signType === 'negative') {
    return '-XOF ' + absolute;
  }
  return formatXof(numeric);
}

function openCompteDetail(compteId) {
  if (!compteId) {
    return;
  }
  currentCompteDetailId = compteId;
  window.location.hash = 'tresorerie-compte';
}

function initCompteDetailScreen() {
  const alertEl = document.getElementById('compte-detail-alert');
  const summaryEl = document.getElementById('compte-detail-summary');
  const loadingEl = document.getElementById('compte-detail-loading');
  const titleEl = document.getElementById('compte-detail-name');
  const dateInput = document.getElementById('compte-detail-date');

  if (summaryEl) {
    summaryEl.style.display = 'none';
  }
  if (loadingEl) {
    loadingEl.style.display = 'none';
  }

  if (!currentCompteDetailId) {
    if (alertEl) {
      alertEl.textContent = 'Selectionnez un compte depuis la tresorerie.';
      alertEl.style.display = 'block';
    }
    if (titleEl) {
      titleEl.textContent = 'Compte';
    }
    return;
  }

  if (titleEl) {
    titleEl.textContent = getCompteDisplayName(currentCompteDetailId);
  }
  if (alertEl) {
    alertEl.style.display = 'none';
  }

  if (dateInput) {
    if (!dateInput.value) {
      const mainFilter = document.getElementById('treso-date-filter');
      const fallbackDate = (mainFilter && mainFilter.value) || new Date().toISOString().split('T')[0];
      dateInput.value = fallbackDate;
    }
    if (!dateInput.dataset.bound) {
      dateInput.addEventListener('change', updateCompteDetailSummary);
      dateInput.dataset.bound = 'true';
    }
  }

  updateCompteDetailSummary();
}

function updateCompteDetailSummary() {
  if (!currentCompteDetailId) {
    return;
  }

  const summaryEl = document.getElementById('compte-detail-summary');
  const loadingEl = document.getElementById('compte-detail-loading');
  const alertEl = document.getElementById('compte-detail-alert');
  const dateInput = document.getElementById('compte-detail-date');
  const movementsContainer = document.getElementById('compte-detail-movements');
  const emptyStateEl = document.getElementById('compte-detail-empty');

  if (!dateInput || !dateInput.value) {
    return;
  }

  const selectedDate = dateInput.value;

  if (loadingEl) {
    loadingEl.style.display = 'block';
  }
  if (alertEl) {
    alertEl.style.display = 'none';
  }
  if (summaryEl) {
    summaryEl.style.display = 'none';
  }
  if (movementsContainer) {
    movementsContainer.innerHTML = '';
  }
  if (emptyStateEl) {
    emptyStateEl.style.display = 'none';
  }

  const dateLabel = document.getElementById('compte-detail-date-label');
  if (dateLabel) {
    const parsedDate = new Date(selectedDate + 'T00:00:00');
    if (!isNaN(parsedDate.getTime())) {
      dateLabel.textContent = parsedDate.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    } else {
      dateLabel.textContent = selectedDate;
    }
  }

  const compteRef = dbFirestore
    .collection('tresorerie')
    .doc('balance')
    .collection('comptesTresorerie')
    .doc(currentCompteDetailId);

  Promise.all([
    dbFirestore.collection('tresorerieSnapshots').doc(selectedDate).get(),
    compteRef.collection('mouvements').where('dateString', '==', selectedDate).get()
  ])
    .then(([snapshotDoc, mouvementsSnap]) => {
      const opening = getOpeningSnapshotValue(snapshotDoc, currentCompteDetailId);

      let totalIn = 0;
      let totalOut = 0;
      let latestBalance = null;
      let latestTimestamp = -Infinity;
      const mouvements = [];

      mouvementsSnap.forEach(doc => {
        const data = doc.data() || {};
        const amount = Number(data.montant) || 0;
        if (data.sens === 'in') {
          totalIn += amount;
        } else if (data.sens === 'out') {
          totalOut += amount;
        }

        const ts = typeof data.timestamp === 'number'
          ? data.timestamp
          : data.timestamp && typeof data.timestamp.toMillis === 'function'
            ? data.timestamp.toMillis()
            : doc.updateTime && typeof doc.updateTime.toMillis === 'function'
              ? doc.updateTime.toMillis()
              : 0;

        const balanceValue = typeof data.newBalance === 'number'
          ? data.newBalance
          : Number(data.newBalance);

        if (!Number.isNaN(balanceValue) && ts >= latestTimestamp) {
          latestTimestamp = ts;
          latestBalance = balanceValue;
        }

        mouvements.push({
          id: doc.id,
          type: data.type || '',
          sens: data.sens || '',
          montant: amount,
          description: data.description || '',
          timestamp: ts,
          newBalance: Number.isNaN(balanceValue) ? null : balanceValue
        });
      });

      const finalBalance = latestBalance !== null ? latestBalance : opening + totalIn - totalOut;

      const openingEl = document.getElementById('compte-detail-opening');
      const entriesEl = document.getElementById('compte-detail-entries');
      const expensesEl = document.getElementById('compte-detail-expenses');
      const finalEl = document.getElementById('compte-detail-final');

      if (openingEl) {
        openingEl.textContent = formatXof(opening);
      }
      if (entriesEl) {
        entriesEl.textContent = formatSignedXof(totalIn, 'positive');
      }
      if (expensesEl) {
        expensesEl.textContent = formatSignedXof(totalOut, 'negative');
      }
      if (finalEl) {
        finalEl.textContent = formatXof(finalBalance);
      }

      if (summaryEl) {
        summaryEl.style.display = 'grid';
      }

      if (movementsContainer) {
        if (!mouvements.length) {
          if (emptyStateEl) {
            emptyStateEl.style.display = 'block';
          }
        } else {
          mouvements
            .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0))
            .forEach(mv => {
              const movementEl = document.createElement('div');
              movementEl.className = 'compte-detail-movement';

              const isIn = mv.sens === 'in';
              const isOut = mv.sens === 'out';
              const amountClass = isIn ? 'positive' : isOut ? 'negative' : '';
              const amountLabel = isIn
                ? formatSignedXof(mv.montant, 'positive')
                : isOut
                  ? formatSignedXof(mv.montant, 'negative')
                  : formatXof(mv.montant);
              const typeLabel = mv.type ? mv.type.replace(/[_-]/g, ' ') : (mv.sens === 'in' ? 'Entrée' : mv.sens === 'out' ? 'Sortie' : 'Mouvement');
              const timeLabel = mv.timestamp
                ? new Date(mv.timestamp).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })
                : '--:--';
              const balanceLabel = mv.newBalance !== null ? formatXof(mv.newBalance) : null;
              const description = mv.description || 'Sans description';

              movementEl.innerHTML = `
                <div class="compte-detail-movement-header">
                  <span class="compte-detail-movement-type">${typeLabel}</span>
                  <span class="compte-detail-movement-amount ${amountClass}">${amountLabel}</span>
                </div>
                <div class="compte-detail-movement-description">${description}</div>
                <div class="compte-detail-movement-meta">
                  <span>${timeLabel}</span>
                  <span>${balanceLabel ? 'Solde: ' + balanceLabel : ''}</span>
                </div>
              `;

              movementsContainer.appendChild(movementEl);
            });
        }
      }
    })
    .catch(error => {
      console.error('Erreur lors du chargement du detail du compte :', error);
      if (alertEl) {
        alertEl.textContent = 'Impossible de charger les mouvements du compte.';
        alertEl.style.display = 'block';
      }
    })
    .finally(() => {
      if (loadingEl) {
        loadingEl.style.display = 'none';
      }
    });
}
window.updateBalanceDisplay = updateBalanceDisplay;

function ensureCanauxPerformanceOptions(selectEl) {
  if (!selectEl) return;
  if (selectEl.dataset.filled === 'true') return;
  selectEl.innerHTML = '';

  const placeholder = document.createElement('option');
  placeholder.value = '';
  placeholder.textContent = '- Sélectionnez un canal -';
  placeholder.disabled = true;
  placeholder.selected = true;
  selectEl.appendChild(placeholder);

  CANAUX_VENTE.forEach(canal => {
    const option = document.createElement('option');
    option.value = canal;
    option.textContent = canal;
    selectEl.appendChild(option);
  });

  selectEl.dataset.filled = 'true';
}

function initCanauxPerformanceScreen() {
  const selectEl = document.getElementById('canaux-performance-select');
  const startInput = document.getElementById('canaux-performance-start');
  const endInput = document.getElementById('canaux-performance-end');
  if (!selectEl || !startInput || !endInput) return;

  ensureCanauxPerformanceOptions(selectEl);

  if (!selectEl.value && CANAUX_VENTE.length) {
    selectEl.value = CANAUX_VENTE[0];
  }

  const today = new Date();
  const todayIso = today.toISOString().split('T')[0];
  if (!endInput.value) {
    endInput.value = todayIso;
  }
  if (!startInput.value) {
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    startInput.value = firstDay.toISOString().split('T')[0];
  }

  if (!selectEl.dataset.bound) {
    const onDateChange = () => {
      if (startInput.value && endInput.value && startInput.value > endInput.value) {
        endInput.value = startInput.value;
      }
      updateCanauxPerformance();
    };

    selectEl.addEventListener('change', updateCanauxPerformance);
    startInput.addEventListener('change', onDateChange);
    endInput.addEventListener('change', onDateChange);
    selectEl.dataset.bound = 'true';
  }

  updateCanauxPerformance();
}

function updateCanauxPerformance() {
  const selectEl = document.getElementById('canaux-performance-select');
  const startInput = document.getElementById('canaux-performance-start');
  const endInput = document.getElementById('canaux-performance-end');
  const loadingEl = document.getElementById('canaux-performance-loading');
  const emptyEl = document.getElementById('canaux-performance-empty');
  const listEl = document.getElementById('canaux-performance-list');
  const countEl = document.getElementById('canaux-performance-count');
  const revenueEl = document.getElementById('canaux-performance-revenue');
  const profitEl = document.getElementById('canaux-performance-profit');

  if (!selectEl || !startInput || !endInput || !listEl || !countEl || !revenueEl || !profitEl) {
    return;
  }

  const canal = selectEl.value;
  if (!canal) {
    if (listEl) listEl.innerHTML = '';
    if (emptyEl) emptyEl.style.display = 'block';
    if (emptyEl) emptyEl.textContent = 'Sélectionnez un canal pour afficher les ventes.';
    if (countEl) countEl.textContent = '0';
    if (revenueEl) revenueEl.textContent = '0 FCFA';
    if (profitEl) profitEl.textContent = '0 FCFA';
    if (loadingEl) loadingEl.style.display = 'none';
    return;
  }

  if (loadingEl) loadingEl.style.display = 'block';
  if (emptyEl) {
    emptyEl.style.display = 'none';
    emptyEl.textContent = 'Aucune vente pour ce canal et cette période.';
  }
  listEl.innerHTML = '';
  countEl.textContent = '0';
  revenueEl.textContent = '0 FCFA';
  profitEl.textContent = '0 FCFA';

  if (!startInput.value || !endInput.value) {
    if (loadingEl) loadingEl.style.display = 'none';
    if (emptyEl) {
      emptyEl.style.display = 'block';
      emptyEl.textContent = 'Définissez une période valide.';
    }
    return;
  }

  const startDate = new Date(startInput.value + 'T00:00:00');
  let endDate = new Date(endInput.value + 'T23:59:59.999');
  if (startDate > endDate) {
    endDate = new Date(startDate);
    endInput.value = endDate.toISOString().split('T')[0];
  }

  const startTimestamp = firebase.firestore.Timestamp.fromDate(startDate);
  const endTimestamp = firebase.firestore.Timestamp.fromDate(endDate);

  dbFirestore.collection('ventes')
    .where('vendeur', '==', canal)
    .where('timestamp', '>=', startTimestamp)
    .where('timestamp', '<=', endTimestamp)
    .get()
    .then(snapshot => {
      const sales = [];
      let totalRevenue = 0;
      let totalProfit = 0;

      snapshot.forEach(doc => {
        const data = doc.data() || {};
        if (data.status === 'annulé') return;

        const revenue = parseFloat(data.overallTotal) || 0;
        const profit = parseFloat(data.totalProfit) || 0;
        totalRevenue += revenue;
        totalProfit += profit;

        let saleDate = null;
        if (data.timestamp) {
          if (typeof data.timestamp.toDate === 'function') {
            saleDate = data.timestamp.toDate();
          } else if (typeof data.timestamp.toMillis === 'function') {
            saleDate = new Date(data.timestamp.toMillis());
          } else if (typeof data.timestamp === 'number') {
            saleDate = new Date(data.timestamp);
          }
        }

        sales.push({
          id: doc.id,
          date: saleDate,
          revenue,
          profit,
          client: data.clientNom || 'Client inconnu',
          numero: data.clientNumero || '',
          payments: Array.isArray(data.paymentsDetails) ? data.paymentsDetails : []
        });
      });

      countEl.textContent = sales.length.toString();
      revenueEl.textContent = `${totalRevenue.toLocaleString('fr-FR')} FCFA`;
      profitEl.textContent = `${totalProfit.toLocaleString('fr-FR')} FCFA`;

      if (sales.length === 0) {
        if (emptyEl) emptyEl.style.display = 'block';
        return;
      }

      sales
        .sort((a, b) => {
          const dateA = a.date ? a.date.getTime() : 0;
          const dateB = b.date ? b.date.getTime() : 0;
          return dateB - dateA;
        })
        .forEach(sale => {
          const item = document.createElement('div');
          item.className = 'canaux-performance-item';

          const dateLabel = sale.date
            ? `${sale.date.toLocaleDateString('fr-FR')} ${sale.date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}`
            : 'Date inconnue';

          const paymentsSummary = sale.payments
            .map(p => {
              const net = parseFloat(p.netEncaisse) || (parseFloat(p.montantEncaisse) || 0) - (parseFloat(p.monnaieRendue) || 0);
              const label = net.toLocaleString('fr-FR');
              const compte = p.compteNom || p.compteId || 'Compte';
              return `${compte} : ${label} FCFA`;
            })
            .join(' · ');

          item.innerHTML = `
            <div class="canaux-performance-item-header">
              <span class="canaux-performance-item-title">Vente ${sale.id}</span>
              <span class="canaux-performance-item-amount">${sale.revenue.toLocaleString('fr-FR')} FCFA</span>
            </div>
            <div class="canaux-performance-item-meta">
              <span>${dateLabel}</span>
              <span>Client : ${sale.client}${sale.numero ? ' (' + sale.numero + ')' : ''}</span>
              <span class="canaux-performance-item-profit">Profit : ${sale.profit.toLocaleString('fr-FR')} FCFA</span>
            </div>
            ${paymentsSummary ? `<div class="canaux-performance-item-payments">Encaissements : ${paymentsSummary}</div>` : ''}
          `;

          listEl.appendChild(item);
        });
    })
    .catch(error => {
      console.error('Erreur lors du chargement des ventes par canal :', error);
      if (emptyEl) {
        emptyEl.style.display = 'block';
        emptyEl.textContent = 'Erreur lors du chargement des ventes.';
      }
    })
    .finally(() => {
      if (loadingEl) loadingEl.style.display = 'none';
    });
}

function loadComptes() {
  return dbFirestore
    .collection("tresorerie")
    .doc("balance")
    .collection("comptesTresorerie")
    .onSnapshot(snap => {
      comptesCache = [];
      snap.forEach(doc => comptesCache.push({ id: doc.id, ...doc.data() }));
      remplirTousSelectComptes();   // met à jour le <select> de la vente
      majCartesTresorerie();   // (facultatif) met à jour l'écran Trésorerie
    });
}

function remplirTousSelectComptes(specificSelectElement = null) {
    const selectsToFill = specificSelectElement
        ? [specificSelectElement] // Remplir uniquement l'élément fourni
        : document.querySelectorAll('[id^="compteSelect"]'); // Remplir tous les éléments correspondant au sélecteur

    selectsToFill.forEach(sel => {
        // Empêche la mise à jour des sélecteurs non présents dans le DOM à ce moment
        if (!document.body.contains(sel)) return; //

        sel.innerHTML = '';

        /* ➜ option "vide" d'abord */
        const placeholder = document.createElement('option'); //
        placeholder.value = ''; //
        placeholder.textContent = '— Choisir un compte —'; //
        placeholder.disabled = true; //
        placeholder.selected = true; //
        sel.appendChild(placeholder); //

        /* ➜ puis les comptes réels */
        comptesCache.forEach(c => { //
            const opt = document.createElement('option'); //
            opt.value = c.id; //
            opt.textContent = c.nom || c.id; //
            sel.appendChild(opt); //
        });
    });
}
/** Met à jour l'affichage des soldes de chaque compte dans #accounts-balances */
function majCartesTresorerie() {
  const container = document.getElementById('accounts-balances');
  if (!container) return;
  container.innerHTML = '';

  if (!Array.isArray(comptesCache) || !comptesCache.length) {
    const emptyChip = document.createElement('div');
    emptyChip.className = 'account-chip account-chip-empty';
    emptyChip.textContent = 'Aucun compte configure';
    container.appendChild(emptyChip);
    return;
  }

  const ordre = ['caisse', 'momo', 'banque'];

  comptesCache
    .slice()
    .sort((a, b) => {
      const nameA = (a.nom || a.id || '').toLowerCase();
      const nameB = (b.nom || b.id || '').toLowerCase();
      const indexA = ordre.indexOf(nameA);
      const indexB = ordre.indexOf(nameB);
      if (indexA !== -1 || indexB !== -1) {
        const posA = indexA === -1 ? ordre.length : indexA;
        const posB = indexB === -1 ? ordre.length : indexB;
        return posA - posB;
      }
      return nameA.localeCompare(nameB);
    })
    .forEach(compte => {
      const chip = document.createElement('button');
      chip.type = 'button';
      chip.className = 'account-chip';
      chip.setAttribute('data-compte-id', compte.id);
      chip.innerHTML = `
        <span class="chip-label">${compte.nom || compte.id}</span>
        <span class="chip-amount">${formatXof(compte.solde)}</span>
      `;
      chip.addEventListener('click', () => openCompteDetail(compte.id));
      container.appendChild(chip);
    });
}



   firebase.auth().onAuthStateChanged(user => {
  if (user) {
    // Firebase is ready and user is authenticated
    loadComptes();

    user.getIdTokenResult().then(idTokenResult => {
      window.userRole = idTokenResult.claims.role || "employe";
      console.log("Rôle de l'utilisateur :", window.userRole);
      ajusterInterfaceSelonRole(window.userRole);
      
      // =================== FIX STARTS HERE ===================
      // Initialize the app's router and main logic safely inside the auth listener.
      
      // 1. Set the initial route if none exists
      if (!window.location.hash) {
        window.location.hash = 'accueil';
      }
      
      // 2. Handle the initial screen display and attach the router listener
      handleHashChange(); 
      window.addEventListener('hashchange', handleHashChange);

      // 3. Perform initial UI updates
      updateDepensePapaBalance();
      refreshLucideIcons();
      // =================== FIX ENDS HERE =====================

      // Display the app now that everything is ready
      document.getElementById("app").style.display = "block";

      if (window.userRole === "patron") {
        const allowedHashes = ['#stock', '#historique', '#menu'];
        if (!allowedHashes.includes(window.location.hash)) {
          window.location.hash = 'stock';
        }
      }
    }).catch(error => {
      console.error("Erreur lors de la récupération des Custom Claims :", error);
      window.location.href = 'login.html';
    });
  } else {
    // No user, redirect to login
    window.location.href = 'login.html';
  }
});


    function ajusterInterfaceSelonRole(role) {

      // applique une classe sur <body> selon le rôle
      document.body.classList.toggle('role-employe', role === 'employe');
      const navMenu = document.getElementById("nav-menu");
      const navTresorerie = document.getElementById("nav-tresorerie");
      const navApproHist = document.getElementById("nav-appro-hist");
      const navAideCommande = document.getElementById("nav-aide-commande");
      const navDettes = document.getElementById("nav-dettes-fournisseurs");
      const tresorerieMenuItem = document.querySelector("#screen-menu .menu-list-item[onclick*='tresorerie']");
      const dettesMenuItem = document.querySelector("#screen-menu .menu-list-item[onclick*='dettes-fournisseurs']");
      const exportStockBtn = document.getElementById("exportStockBtn");
      const exportInventoryBtn = document.getElementById("exportInventoryBtn");
      const stockSummary = document.querySelector('#screen-stock .summary');

      if (navMenu) {
        navMenu.classList.remove('hidden-by-role');
        navMenu.style.display = "flex";
      }
      if (navTresorerie) {
        navTresorerie.classList.remove('hidden-by-role');
        navTresorerie.style.display = "flex";
      }
      if (navApproHist) {
        navApproHist.classList.remove('hidden-by-role');
        navApproHist.style.display = "flex";
      }
      if (navAideCommande) {
        navAideCommande.classList.remove('hidden-by-role');
        navAideCommande.style.display = "flex";
      }
      if (navDettes) {
        navDettes.classList.remove('hidden-by-role');
        navDettes.style.display = "flex";
      }
      if (tresorerieMenuItem) {
        tresorerieMenuItem.style.display = "grid";
      }
      if (dettesMenuItem) {
        dettesMenuItem.style.display = "grid";
      }
      if (exportStockBtn) {
        exportStockBtn.style.removeProperty('display');
      }
      if (exportInventoryBtn) {
        exportInventoryBtn.style.removeProperty('display');
      }

      // Pour le menu de navigation
      if (role === "employe") {
        // Les employés ne voient pas le bouton Menu
        if (navMenu) {
          navMenu.classList.add('hidden-by-role');
          navMenu.style.setProperty('display', 'none', 'important');
        }
        const disallowedForEmployee = ['tresorerie', 'menu', 'approvisionnement', 'approvisionnement-historique', 'article-detail', 'dettes-fournisseurs', 'fournisseur-balance', 'aide-commande', 'cloture-vendeur'];
        const currentHash = window.location.hash.replace('#', '');
        if (disallowedForEmployee.includes(currentHash)) {
          window.location.hash = 'vendre';
        }

        if (navTresorerie) {
          navTresorerie.classList.add('hidden-by-role');
          navTresorerie.style.setProperty('display', 'none', 'important');
        }
        if (navApproHist) {
          navApproHist.classList.add('hidden-by-role');
          navApproHist.style.setProperty('display', 'none', 'important');
        }
        if (navAideCommande) {
          navAideCommande.classList.add('hidden-by-role');
          navAideCommande.style.setProperty('display', 'none', 'important');
        }
        if (navDettes) {
          navDettes.classList.add('hidden-by-role');
          navDettes.style.setProperty('display', 'none', 'important');
        }
        if (tresorerieMenuItem) {
          tresorerieMenuItem.style.setProperty('display', 'none', 'important');
        }
        if (dettesMenuItem) {
          dettesMenuItem.style.setProperty('display', 'none', 'important');
        }
        if (exportStockBtn) {
          exportStockBtn.style.setProperty('display', 'none', 'important');
        }
        if (exportInventoryBtn) {
          exportInventoryBtn.style.setProperty('display', 'none', 'important');
        }
        if (stockSummary) {
          stockSummary.style.setProperty('display', 'none', 'important');
        }
        // Vous pouvez ajouter ici d'autres masquages spécifiques aux employés.
      } else if (role === "patron") {
        // Le patron ne doit voir que Stock, Historique et Menu.
        if (stockSummary) {
          stockSummary.style.removeProperty('display');
        }
        if (navMenu) {
          navMenu.classList.remove('hidden-by-role');
          navMenu.style.display = "flex";
        }
        if (navTresorerie) {
          navTresorerie.classList.remove('hidden-by-role');
          navTresorerie.style.display = "flex";
        }
        // Masquer Vente et Livraisons
        const navVendre = document.getElementById("nav-vendre");
        const navLivraisons = document.getElementById("nav-livraisons");
        if (navVendre) { navVendre.style.display = "none"; }
        if (navLivraisons) { navLivraisons.style.display = "none"; }
        // Dans l'écran Menu, n'afficher que Rapport & Statistiques, Trésorerie, Dépenses et Déconnexion.
        const sections = document.querySelectorAll("#screen-menu .section");
        sections.forEach(section => {
          const txt = section.textContent.toLowerCase();
          if (!(txt.includes("rapport") || txt.includes("trésorerie") || txt.includes("dépense") || txt.includes("déconnexion"))) {
            section.style.display = "none";
          }
        });
      } else if (role === "admin") {
        // Pour l'admin, tout doit être visible.
        if (navMenu) {
          navMenu.classList.remove('hidden-by-role');
          navMenu.style.display = "flex";
        }
        if (navTresorerie) {
          navTresorerie.classList.remove('hidden-by-role');
          navTresorerie.style.display = "flex";
        }
        if (tresorerieMenuItem) {
          tresorerieMenuItem.style.display = "flex";
        }
        if (stockSummary) {
          stockSummary.style.removeProperty('display');
        }
        const sections = document.querySelectorAll("#screen-menu .section");
        sections.forEach(section => {
          section.style.display = "flex";
        });

  

      }

      renderInventoryPreview();
    }


    function deconnexion() {
      firebase.auth().signOut().then(() => {
        window.location.href = 'login.html';
      }).catch(error => {
        alert("Erreur lors de la déconnexion: " + error.message);
      });
    }

    // Fonctions du Menu Principal
    function ouvrirGestionVendeurs() {
      alert('Ouvrir la page de gestion des canaux de vente.');
    }

    // Actualisation de l'heure dans le menu
    function updateTimeMenu() {
      const menuTime = document.getElementById("current-time-menu");
      if(menuTime) {
        const now = new Date();
        menuTime.textContent = now.toLocaleTimeString("fr-FR", { hour: '2-digit', minute: '2-digit' });
      }
    }
    setInterval(updateTimeMenu, 1000);

    // *************** MODIFICATIONS POUR L'ÉCRAN DE RECHERCHE D'ARTICLE ***************
    produitInput.addEventListener('focus', function() {
      window.location.hash = 'search-article';
    });
    window.addEventListener('hashchange', function() {
      if(window.location.hash === '#search-article') {
        document.getElementById("searchProduitInput").value = "";
        document.getElementById("searchProduitInput").focus();
        loadProductsList();
      }
    });
    function loadProducts(query = "") {
    const searchQuery = query.toLowerCase();
    getAllStockFirestore().then(stocks => {
        let filtered = stocks.filter(p => p.name.toLowerCase().includes(document.getElementById("searchProduitInput").value.toLowerCase()));
        const container = document.getElementById("searchResults");
        container.innerHTML = "";
        if (filtered.length === 0) {
            container.innerHTML = "<p>Aucun produit trouvé.</p>";
            return;
        }
        filtered.forEach(prod => {
            const card = document.createElement("div");
            card.className = "product-card";
            card.innerHTML = `
              <div class="product-icon">${prod.icon}</div>
              <div class="product-details">
                <h3>${prod.name}</h3>
                <p>🔹 Stock : ${prod.stock} unités</p>
                <p class="price-label">💰 Prix : ${prod.price.toLocaleString()} FCFA</p>
              </div>`;

            // === LA CORRECTION EST ICI ===
            card.onclick = function() {
                // Au lieu d'afficher les détails, on ajoute le produit au panier
                selectProduct(prod);
            };
            // ===========================

            container.appendChild(card);
        });
    });
}
    function showArticleDetail(articleId) {
  const isEmployee = (typeof window !== 'undefined' && window.userRole === 'employe') ||
    (typeof document !== 'undefined' && document.body.classList.contains('role-employe'));
  if (isEmployee) {
    showToast("Acces interdit aux details pour les employes.", "error");
    return;
  }
  currentArticleId = articleId;
  window.location.hash = 'article-detail';
}
/**
 * Récupère les données de l'article depuis Firestore et met à jour l'interface.
 */
function loadArticleDetail() {
  const isEmployee = (typeof window !== 'undefined' && window.userRole === 'employe') ||
    (typeof document !== 'undefined' && document.body.classList.contains('role-employe'));
  if (isEmployee) {
    showToast("Acces interdit aux details pour les employes.", "error");
    window.location.hash = 'stock';
    return;
  }
  if (!currentArticleId) {
    console.error("Aucun ID d'article sélectionné.");
    window.location.hash = 'stock'; // Retourne au stock si pas d'ID
    return;
  }

  dbFirestore.collection("stock").doc(currentArticleId).get()
    .then(doc => {
      if (doc.exists) {
        const data = doc.data();

        // Remplissage des champs de la page de détail
        document.getElementById('detail-product-title').textContent = data.name || 'Nom indisponible';

        const sellingPrice = (data.price * 1.25) || 0; // Exemple: Marge de 25%
        document.getElementById('detail-selling-price').textContent = `XOF ${sellingPrice.toLocaleString()}`;

        const purchaseCost = data.price || 0;
        document.getElementById('detail-purchase-cost').textContent = `XOF ${purchaseCost.toLocaleString()}`;

        const stockOnHand = data.stock || 0;
        document.getElementById('detail-stock-on-hand').textContent = stockOnHand;
        document.getElementById('detail-available-for-sale').textContent = stockOnHand;

      } else {
        console.error("Document non trouvé !");
        showToast("Erreur: Article non trouvé.", "error");
        window.location.hash = 'stock';
      }
    })
    .catch(error => {
      console.error("Erreur lors de la récupération de l'article: ", error);
      showToast("Erreur de chargement.", "error");
    });
}
    function loadProductsList() {
      loadProducts();
    }
    /* -------- selectProduct : ajoute direct & ouvre panier -------- */
    function selectProduct(prod){
  addOrIncrementItem(prod);     // ajoute ou incrémente
  updatePanierPage();
  showToast(`+1 ${prod.name} ajouté au panier`);           // met à jour badge & totaux
  // → on reste sur l'écran de recherche pour pouvoir enchaîner plusieurs sélections
  // window.location.hash = 'panier';
}

    document.addEventListener("input", function(e) {
      if(e.target.id === "searchProduitInput") {
        loadProducts();
      }
    });
    // **********************************************************************************

    /* Fonctions pour la Trésorerie */
    function ouvrirFormOperationTresorerie() {
      document.getElementById("modalAjoutOperation").style.display = "flex";
    }
    function fermerModalTresorerie() {
      document.getElementById("modalAjoutOperation").style.display = "none";
    }
    function ajouterOperationTresorerie() {
      const type = document.getElementById("typeOperation").value;
      const montant = document.getElementById("montantOperation").value;
      const description = document.getElementById("descriptionOperation").value;
      alert("Opération ajoutée : " + type + " de " + montant + " FCFA");
      fermerModalTresorerie();
    }
    function ouvrirModalVirementTresorerie() {
      if (!Array.isArray(comptesCache) || comptesCache.length < 2) {
        alert("Configurez au moins deux comptes de tresorerie avant un virement.");
        return;
      }
      const form = document.getElementById("formVirementTresorerie");
      if (form) {
        form.reset();
      }
      const sourceSelect = document.getElementById("compteSelectSource");
      const destinationSelect = document.getElementById("compteSelectDestination");
      if (sourceSelect) {
        remplirTousSelectComptes(sourceSelect);
      }
      if (destinationSelect) {
        remplirTousSelectComptes(destinationSelect);
      }
      const modal = document.getElementById("modalVirementTresorerie");
      if (modal) {
        modal.style.display = "flex";
      }
    }
    function fermerModalVirementTresorerie() {
      const modal = document.getElementById("modalVirementTresorerie");
      if (modal) {
        modal.style.display = "none";
      }
      const form = document.getElementById("formVirementTresorerie");
      if (form) {
        form.reset();
      }
    }
    async function soumettreVirementTresorerie(event) {
      event.preventDefault();
      const sourceSelect = document.getElementById("compteSelectSource");
      const destinationSelect = document.getElementById("compteSelectDestination");
      const montantInput = document.getElementById("montantVirement");
      const descriptionInput = document.getElementById("descriptionVirement");

      const sourceId = sourceSelect ? sourceSelect.value : "";
      const destinationId = destinationSelect ? destinationSelect.value : "";
      const montant = montantInput ? parseFloat(montantInput.value) : NaN;

      if (!sourceId) {
        alert("Selectionnez le compte a debiter.");
        return;
      }
      if (!destinationId) {
        alert("Selectionnez le compte a crediter.");
        return;
      }
      if (sourceId === destinationId) {
        alert("Choisissez deux comptes differents pour le virement.");
        return;
      }
      if (Number.isNaN(montant) || montant <= 0) {
        alert("Saisissez un montant de virement valide.");
        return;
      }

      const note = descriptionInput ? descriptionInput.value.trim() : "";
      const sourceLabel = getCompteDisplayName(sourceId);
      const destinationLabel = getCompteDisplayName(destinationId);

      try {
        await enregistrerMouvementTresorerie({
          compteId: sourceId,
          type: "virement",
          sens: "out",
          montant,
          description: note || `Virement vers ${destinationLabel}`
        });

        await enregistrerMouvementTresorerie({
          compteId: destinationId,
          type: "virement",
          sens: "in",
          montant,
          description: note || `Virement depuis ${sourceLabel}`
        });

        fermerModalVirementTresorerie();
        if (typeof showToast === "function") {
          showToast(`Virement de ${formatXof(montant)} transfere de ${sourceLabel} vers ${destinationLabel}.`);
        } else {
          alert(`Virement de ${formatXof(montant)} transfere de ${sourceLabel} vers ${destinationLabel}.`);
        }
      } catch (error) {
        console.error("Erreur lors du virement de tresorerie :", error);
        alert("Erreur lors de l'enregistrement du virement : " + error.message);
      }
    }
  </script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then(reg => {
          console.log('[App] SW enregistré, scope :', reg.scope);

          // Dès qu'on déploie une nouvelle version (CACHE_NAME incrémenté)…
          reg.addEventListener('updatefound', () => {
            const newSW = reg.installing;
            newSW.addEventListener('statechange', () => {
              // Quand le nouvel SW est prêt et qu'il y avait déjà un SW actif
              if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
                console.log('[App] Nouvelle version dispo → reload');
                window.location.reload();
              }
            });
          });
        })
        .catch(err => console.error('[App] Échec enregistrement SW :', err));
    });
  }
</script>

  <script>
  let deferredPrompt;
  const installBtn = document.getElementById('installBtn');

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = 'block';

    installBtn.addEventListener('click', () => {
      installBtn.style.display = 'none';
      deferredPrompt.prompt();

      deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
          console.log('User accepted the install prompt');
        } else {
          console.log('User dismissed the install prompt');
        }
        deferredPrompt = null;
      });
    });
  });

  /* ==========================================================
   DÉPENSES – Helpers scroll & ré-initialisation
   ========================================================== */
function onScrollDepenses(e) {
  const el = e.target;
  if (el.scrollTop + el.clientHeight >= el.scrollHeight - 50) {
    chargerHistoriqueDepensesSuivant();
  }
}

function attachScrollHandlerDepenses() {
  const c = document.getElementById("recent-depenses");
  if (!c || c._scrollAttached) return;
  c.addEventListener("scroll", onScrollDepenses);
  c._scrollAttached = true;
}

function detachScrollHandlerDepenses() {
  const c = document.getElementById("recent-depenses");
  if (c && c._scrollAttached) {
    c.removeEventListener("scroll", onScrollDepenses);
    c._scrollAttached = false;
  }
}

/* Lance un reset complet de l'écran Dépenses */
function initEcranDepenses() {
  const cont = document.getElementById("recent-depenses");
  cont.innerHTML = "";
  renderedDepenseIds.clear();

  detachScrollHandlerDepenses();      // pour ne pas empiler les listeners
  chargerHistoriqueDepensesInitial()
    .then(() => attachScrollHandlerDepenses());

  updateBalanceDisplay();
}

</script>

<script>
document.getElementById('exportStockBtn')
    .addEventListener('click', () => {
      if ((typeof window !== 'undefined' && window.userRole === 'employe') ||
          (typeof document !== 'undefined' && document.body.classList.contains('role-employe'))) {
        if (typeof showToast === 'function') {
          showToast("L'export de stock n'est pas autorisé pour votre profil.", "warning");
        } else {
          alert("L'export de stock n'est pas autorisé pour votre profil.");
        }
        return;
      }
      getAllStockFirestore()
        .then(stocks => {
          const phones = stocks.filter(s => s.category === 'telephones' && s.stock >= 1);

          if (phones.length === 0) {
            alert("Aucun téléphone en stock à exporter.");
            return;
          }

          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();

          const tableColumn = ["Produit", "Stock", "Prix d'Achat Unitaire", "Valeur du Stock"];
          const tableRows = [];

          let totalStock = 0;
          let totalValue = 0;

          phones.forEach(phone => {
            const phoneValue = phone.stock * phone.price;
            const phoneData = [
              phone.name,
              phone.stock,
              `${fmt(phone.price)} FCFA`,
              `${fmt(phoneValue)} FCFA`
            ];
            tableRows.push(phoneData);
            totalStock += phone.stock;
            totalValue += phoneValue;
          });
          
          doc.setFontSize(18);
          doc.text("Rapport du Stock de Téléphones", 14, 22);
          doc.setFontSize(11);
          doc.setTextColor(100);
          doc.text(`Date: ${new Date().toLocaleDateString('fr-FR')}`, 14, 30);

          doc.autoTable({
            startY: 35,
            head: [tableColumn],
            body: tableRows,
            foot: [
              [
                'TOTAL',
                totalStock,
                '',
                `${fmt(totalValue)} FCFA`
              ]
            ],
            // LA LIGNE SUIVANTE A ÉTÉ AJOUTÉE
            showFoot: 'lastPage',
            theme: 'grid',
            headStyles: {
              fillColor: [0, 96, 100]
            },
            footStyles: {
              fontStyle: 'bold',
              fillColor: [240, 240, 240],
              textColor: [0, 0, 0]
            },
            columnStyles: {
              1: { halign: 'center' },
              2: { halign: 'right' },
              3: { halign: 'right' }
            }
          });
          
          doc.save('stock_telephones.pdf');
          showToast("Exportation PDF du stock terminée.");

        })
        .catch(err => {
          console.error('Erreur lors de l\'exportation PDF du stock :', err);
          alert('Impossible d\'exporter le stock en PDF : ' + err.message);
        });
    });
/* ============================================================
   MOUVEMENT DE TRÉSORERIE - MISE À JOUR DES SOLDES
   ============================================================ */
   async function enregistrerMouvementTresorerie({
  compteId,      // 'caisse' | 'momo' | 'banque'
  type,          // 'vente' | 'depense' | 'papa' | 'remboursement' | ...
  sens,          // 'in' (entrée) ou 'out' (sortie)
  montant,       // nombre positif
  description = '',
  refId = null
}) {
  await dbFirestore.runTransaction(async tx => {

    /* 1) Préparation des références ---------------------------------------- */
    const today        = new Date();
    const yyyy_mm_dd   = today.toISOString().slice(0, 10);          // AAAA-MM-JJ

    const balanceDoc   = dbFirestore.collection('tresorerie').doc('balance');
    const comptesCol   = balanceDoc.collection('comptesTresorerie');

    const compteDoc    = comptesCol.doc(compteId);    // compte concerné

    /* 2) Lectures en parallèle --------------------------------------------- */
    const compteSnap = await tx.get(compteDoc);

    /* 3) Calcul du nouveau solde du compte touché --------------------------- */
    const delta          = sens === 'in' ?  montant : -montant;
    const oldSoldeCompte = compteSnap.exists ? (compteSnap.data().solde || 0) : 0;
    const newSoldeCompte = oldSoldeCompte + delta;

    /* 4) Écritures ---------------------------------------------------------- */

    /* 4a) Mise à jour du solde du sous-compte concerné */
    tx.set(compteDoc, { solde: newSoldeCompte }, { merge: true });

    /* 4b) Enregistrement du mouvement dans la sous-collection */
    tx.set(
      compteDoc.collection('mouvements').doc(),
      {
        timestamp  : Date.now(),
        dateString : yyyy_mm_dd,
        type,
        sens,
        montant,
        description,
        refId,
        newBalance : newSoldeCompte
      }
    );

    /* 4c) Mise à jour du solde global (document "tresorerie/balance") */
    tx.set(
      balanceDoc,
      { montant: firebase.firestore.FieldValue.increment(delta) },
      { merge: true }
    );
  });

  return true;   // succès
}


function fmt(x){
  return Number(x).toLocaleString("fr-FR").replace(/\u202F/g," ");
}


function exportDailyReportPDF() {
  const exportOptions = window.__exportDailyReportOptions || {};
  window.__exportDailyReportOptions = undefined;
  const autoPrintReport = !!exportOptions.autoPrint;
  const fileNamePrefix = exportOptions.fileNamePrefix || 'Rapport_';
  const afterGenerateCallback = typeof exportOptions.onAfterGenerate === 'function' ? exportOptions.onAfterGenerate : null;

  /* ── 1) Choix de la date et de l'option de profit ─────────────────── */
  const saisie = prompt(
    "Date du rapport (AAAA-MM-JJ) :",
    new Date().toISOString().slice(0, 10)
  );
  if (!saisie) return;

  // ✅ NOUVEAU : On demande à l'utilisateur s'il veut voir les profits
  const inclureProfitDetail = confirm("Voulez-vous inclure le détail des profits par article dans le rapport ?");

  const jsDate = new Date(saisie + 'T00:00:00');
  if (isNaN(jsDate.getTime())) {
    alert("Date invalide !");
    return;
  }

  const startOfDayMillis = new Date(jsDate.getFullYear(), jsDate.getMonth(), jsDate.getDate(), 0, 0, 0, 0).getTime();
  const endOfDayMillis = new Date(jsDate.getFullYear(), jsDate.getMonth(), jsDate.getDate(), 23, 59, 59, 999).getTime();
  const startOfDayTimestamp = firebase.firestore.Timestamp.fromMillis(startOfDayMillis);
  const endOfDayTimestamp = firebase.firestore.Timestamp.fromMillis(endOfDayMillis);
  const dateFR = jsDate.toLocaleDateString("fr-FR");

  /* ── 2) VENTES : CA + Profit + Téléphones vendus ─────────── */
  const ventesP = dbFirestore.collection("ventes")
    .where("timestamp", ">=", startOfDayTimestamp)
    .where("timestamp", "<=", endOfDayTimestamp)
    .get()
    .then(snap => {
      let qty = 0, ca = 0, profit = 0;
      let soldPhonesQty = 0, soldPhonesVal = 0, soldPhonesProfit = 0;
      let soldAccQty = 0, soldAccVal = 0, soldAccProfit = 0;
      let soldPhonesCAMV = 0;

      const phoneRows = [];
      const accRows = [];

      snap.forEach(doc => {
        const v = doc.data();
        if (v.status === 'annulé') return;
        profit += parseFloat(v.totalProfit) || 0;
        v.items.forEach(item => {
          const total = parseFloat(item.total) || 0;
          const itemProfit = parseFloat(item.profitTotal) || 0;
          qty += item.quantite;
          ca += total;

          // ✅ NOUVEAU : On construit la ligne de données avec ou without la colonne profit
          let rowData;
          if (inclureProfitDetail) {
              rowData = [item.produit, fmt(item.prix), item.quantite.toString(), fmt(total) + " FCFA", fmt(itemProfit) + " FCFA"];
          } else {
              rowData = [item.produit, fmt(item.prix), item.quantite.toString(), fmt(total) + " FCFA"];
          }

          if (isPhone(item)) {
            phoneRows.push(rowData);
            soldPhonesQty += item.quantite;
            soldPhonesVal += total;
            soldPhonesProfit += itemProfit; // On cumule le profit des téléphones
            soldPhonesCAMV += item.quantite * (item.coutAchat || 0);
          } else {
            accRows.push(rowData);
            soldAccQty += item.quantite;
            soldAccVal += total;
            soldAccProfit += itemProfit; // On cumule le profit des accessoires
          }
        });
      });

      // On retourne toutes les données nécessaires, y compris les profits par catégorie
      return { phoneRows, accRows, qty, ca, profit, soldPhonesQty, soldPhonesVal, soldPhonesProfit, soldAccQty, soldAccVal, soldAccProfit, soldPhonesCAMV };
    });

  // ... (Les autres promesses : depensesP, injectionP, etc. restent inchangées) ...
    /* ── 3) DÉPENSES (utilise les millisecondes) ────────────────────────── */
    const depensesP = dbFirestore.collection("depenses")
        .where("timestamp", ">=", startOfDayMillis)
        .where("timestamp", "<=", endOfDayMillis)
        .get()
        .then(snap => {
            const papa = [], fonc = [];
            let totPapa = 0, totFonc = 0;
            snap.forEach(doc => {
                const d = doc.data();
                const desc = d.description || "";
                const isAppro = desc.toLowerCase().startsWith("approvisionnement");
                const isFraisTransport = desc.toLowerCase().includes("frais transport achat");
                const ligne = [desc, fmt(d.montant)];
                if ((d.type || "").toLowerCase() === "papa") {
                    papa.push(ligne);
                    totPapa += +d.montant;
                } else if (!isAppro && !isFraisTransport) {
                    fonc.push(ligne);
                    totFonc += +d.montant;
                }
            });
            return { papa, fonc, totPapa, totFonc };
        });

    /* ── 4) INJECTION (remboursements, utilise les millisecondes) ────────── */
    const injectionP = dbFirestore.collection("remboursements")
        .where("timestamp", ">=", startOfDayMillis)
        .where("timestamp", "<=", endOfDayMillis)
        .get()
        .then(snap => {
            let total = 0;
            snap.forEach(d => total += +d.data().montant);
            return total;
        });

    /* ── 5) APPROVISIONNEMENTS ───────────────────────────────────── */
    const approP = dbFirestore.collection("approvisionnement")
        .where("timestamp", ">=", startOfDayTimestamp)
        .where("timestamp", "<=", endOfDayTimestamp)
        .get()
        .then(snapshot => {
            const rowsPhones = [], rowsAcc = [];
            let totQtyPhones = 0, totQtyAcc = 0;
            let totPhones = 0, totAcc = 0;
            snapshot.forEach(doc => {
                if (doc.data().status === 'annulé') return;
                (doc.data().items || []).forEach(it => {
                    const prixUnitaire = it.adjustedPrixAchat || it.prixAchat;
                    const totalLigne = it.quantite * prixUnitaire;
                    const ligne = [it.produit, it.quantite.toString(), fmt(prixUnitaire) + " FCFA", fmt(totalLigne) + " FCFA"];
                    if (it.category === "telephones") {
                        rowsPhones.push(ligne);
                        totQtyPhones += it.quantite;
                        totPhones += totalLigne;
                    } else {
                        rowsAcc.push(ligne);
                        totQtyAcc += it.quantite;
                        totAcc += totalLigne;
                    }
                });
            });
            return { phones: { rows: rowsPhones, qty: totQtyPhones, total: totPhones }, acc: { rows: rowsAcc, qty: totQtyAcc, total: totAcc }, grandTotal: totPhones + totAcc };
        });

    /* ── 5bis) APPORT PAPA ───────────────────────────────────── */
    const papaSupplyP = dbFirestore.collection("apportPapa")
        .where("dateString", "==", dateFR)
        .get()
        .then(snap => {
            const rows = [];
            let totalQty = 0, totalAmount = 0;
            snap.forEach(doc => {
                (doc.data().items || []).forEach(it => {
                    const lineTotal = it.quantite * it.coutUnitaire;
                    rows.push([it.produit, it.quantite.toString(), fmt(it.coutUnitaire) + " FCFA", fmt(lineTotal) + " FCFA"]);
                    totalQty += it.quantite;
                    totalAmount += lineTotal;
                });
            });
            return { rows, totalQty, totalAmount };
        });

    /* ── 6) SOLDE INITIAL (trésorerie) ───────────────────────── */
    const snapshotP = dbFirestore.collection("tresorerieSnapshots")
        .doc(saisie)
        .get()
        .then(snap => snap.exists ? snap.data().openingBalanceGlobal || 0 : 0);

    /* ── 7) VALEUR STOCK TÉLÉPHONES (fin de journée) ──────── */
    const stockPhonesP = dbFirestore.collection("stock")
        .where("category", "==", "telephones")
        .get()
        .then(snap => {
            let tot = 0;
            snap.forEach(doc => {
                const d = doc.data();
                tot += (parseFloat(d.stock) || 0) * (parseFloat(d.price) || 0);
            });
            return tot;
        });

    /* ── 8) DETTE PAPA ───────────────────────────────────────── */
    const papaBalanceP = dbFirestore.collection("depensePapa")
        .doc("balance")
        .get()
        .then(doc => doc.exists ? doc.data().montant || 0 : 0);

    /* ── 9) STOCK SNAPSHOT – SOLDE INITIAL TÉLÉPHONES ────────── */
    const openingStockP = dbFirestore.collection("stockSnapshots")
        .doc(saisie)
        .get()
        .then(d => d.exists ? { qty: d.data().openingStock || 0, val: d.data().openingStockValue || 0 } : { qty: 0, val: 0 });

    /* ── 10) ACHATS TÉLÉPHONES (jour) ────────────────────────── */
    const achatsPhonesP = dbFirestore.collection("approvisionnement")
        .where("timestamp", ">=", startOfDayTimestamp)
        .where("timestamp", "<=", endOfDayTimestamp)
        .get()
        .then(snap => {
            let qty = 0, val = 0;
            snap.forEach(doc => {
                if (doc.data().status === 'annulé') return;
                (doc.data().items || []).forEach(it => {
                    if (it.category === "telephones") {
                        qty += +it.quantite;
                        const prixUnitaireReel = it.adjustedPrixAchat || it.prixAchat;
                        val += +it.quantite * +prixUnitaireReel;
                    }
                });
            });
            return { qty, val };
        });

  /* ── 11) GÉNÉRATION PDF ─────────────────────────────────── */
  return Promise.all([ventesP, depensesP, injectionP, approP, papaSupplyP, snapshotP, stockPhonesP, papaBalanceP, openingStockP, achatsPhonesP])
    .then(([ventes, deps, injection, appro, papaApport, soldeInitial, valeurStockPhones, dettePapa, openingStock, achatsPhones]) => {
      // ... (calcul des totaux, inchangé)
      const totalEntrees = ventes.ca;
      const totalInjection = injection;
      const totalDepenses = deps.totPapa + deps.totFonc;
      const totalAppro = appro.grandTotal;
      const totalProfit = ventes.profit;
      const soldeFinal = soldeInitial + totalEntrees + totalInjection - totalDepenses - totalAppro;
      const closingQty = openingStock.qty + achatsPhones.qty + papaApport.totalQty - ventes.soldPhonesQty;
      const closingVal = openingStock.val + achatsPhones.val + papaApport.totalAmount - ventes.soldPhonesCAMV;
      const valeurBusiness = soldeFinal + closingVal + dettePapa;

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "pt", format: "a4" });
      const autoTable = doc.autoTable;
      doc.setFontSize(16);
      doc.text(`Rapport du ${jsDate.toLocaleDateString("fr-FR")}`, 40, 40);
      let y = 60;
      doc.setFontSize(14);
      doc.text("Téléphones vendus", 40, y);
      
      // ✅ NOUVEAU : Définition conditionnelle des en-têtes et pieds de page
      let phoneHead, phoneFoot, accHead, accFoot;
      if(inclureProfitDetail) {
          phoneHead = [["Modèle", "Prix U.", "Qté", "Total", "Profit"]];
          phoneFoot = [["", "", ventes.soldPhonesQty.toString(), fmt(ventes.soldPhonesVal) + " FCFA", fmt(ventes.soldPhonesProfit) + " FCFA"]];
          accHead = [["Modèle", "Prix U.", "Qté", "Total", "Profit"]];
          accFoot = [["", "", ventes.soldAccQty.toString(), fmt(ventes.soldAccVal) + " FCFA", fmt(ventes.soldAccProfit) + " FCFA"]];
      } else {
          phoneHead = [["Modèle", "Prix U.", "Qté", "Total"]];
          phoneFoot = [["", "", ventes.soldPhonesQty.toString(), fmt(ventes.soldPhonesVal) + " FCFA"]];
          accHead = [["Modèle", "Prix U.", "Qté", "Total"]];
          accFoot = [["", "", ventes.soldAccQty.toString(), fmt(ventes.soldAccVal) + " FCFA"]];
      }

      // ✅ MODIFIÉ : Utilisation des variables pour les tableaux
      autoTable.call(doc, { 
          startY: y + 10, 
          head: phoneHead, 
          body: ventes.phoneRows.length ? ventes.phoneRows : [["—", "—", "0", "0"]], 
          foot: phoneFoot, 
          styles: { fontSize: 9 } 
      });
      y = doc.lastAutoTable.finalY + 30;
      doc.setFontSize(14);
      doc.text("Accessoires vendus", 40, y);
      autoTable.call(doc, { 
          startY: y + 10, 
          head: accHead, 
          body: ventes.accRows.length ? ventes.accRows : [["—", "—", "0", "0"]], 
          foot: accFoot, 
          styles: { fontSize: 9 } 
      });
      
      // ... (Le reste de la génération du PDF est inchangé) ...
      y = doc.lastAutoTable.finalY + 30;
      doc.setFontSize(14);
      doc.text("Achats – Téléphones", 40, y);
      doc.autoTable({ startY: y + 10, head: [["Produit", "Qté", "Prix U.", "Total"]], body: appro.phones.rows.length ? appro.phones.rows : [["—", "0", "0", "0"]], foot: [["TOTAL", appro.phones.qty.toString(), "", fmt(appro.phones.total) + " FCFA"]], showFoot: 'lastPage', headStyles: { fillColor: [0, 96, 100], textColor: 255 }, styles: { fontSize: 9 } });
      y = doc.lastAutoTable.finalY + 25;
      doc.setFontSize(14);
      doc.text("Achats – Accessoires", 40, y);
      doc.autoTable({ startY: y + 10, head: [["Produit", "Qté", "Prix U.", "Total"]], body: appro.acc.rows.length ? appro.acc.rows : [["—", "0", "0", "0"]], foot: [["TOTAL", appro.acc.qty.toString(), "", fmt(appro.acc.total) + " FCFA"]], showFoot: 'lastPage', headStyles: { fillColor: [0, 96, 100], textColor: 255 }, styles: { fontSize: 9 } });
      y = doc.lastAutoTable.finalY + 30;
      doc.setFontSize(14);
      doc.text("Dépenses Papa", 40, y);
      autoTable.call(doc, { startY: y + 10, head: [["Description", "Montant"]], body: deps.papa.length ? deps.papa : [["—", "0 FCFA"]], foot: [["Sous-total", fmt(deps.totPapa) + " FCFA"]], showFoot: 'lastPage', styles: { fontSize: 8 }, footStyles: { fontStyle: "bold" } });
      y = doc.lastAutoTable.finalY + 20;
      doc.setFontSize(14);
      doc.text("Dépenses fonctionnelles", 40, y);
      autoTable.call(doc, { startY: y + 10, head: [["Description", "Montant"]], body: deps.fonc.length ? deps.fonc : [["—", "0 FCFA"]], foot: [["Sous-total", fmt(deps.totFonc) + " FCFA"]], showFoot: 'lastPage', footStyles: { fontStyle: "bold" }, styles: { fontSize: 8 }, });
      y = doc.lastAutoTable.finalY + 30;
      doc.setFontSize(14);
      doc.text("Apport de marchandises par Papa", 40, y);
      doc.autoTable({ startY: y + 10, head: [["Produit", "Qté", "Coût U.", "Total"]], body: papaApport.rows.length ? papaApport.rows : [["—", "0", "0", "0"]], foot: [["TOTAL", papaApport.totalQty.toString(), "", fmt(papaApport.totalAmount) + " FCFA"]], showFoot: 'lastPage', styles: { fontSize: 9 } });
      y = doc.lastAutoTable.finalY + 30;
      doc.setFontSize(14);
      doc.text("Variation du stock – Téléphones", 40, y);
      autoTable.call(doc, { startY: y + 10, theme: "grid", head: [["Libellé", "Nombre", "Coût d'Achat"]], body: [["Solde initial", fmt(openingStock.qty), fmt(openingStock.val) + " FCFA"], ["Apport Papa", "+" + papaApport.totalQty, "+" + fmt(papaApport.totalAmount) + " FCFA"], ["Ventes", "-" + ventes.soldPhonesQty, "-" + fmt(ventes.soldPhonesCAMV) + " FCFA"], ["Achats", "+" + achatsPhones.qty, "+" + fmt(achatsPhones.val) + " FCFA"], ["Solde finale", fmt(closingQty), fmt(closingVal) + " FCFA"]], headStyles: { fillColor: [255, 255, 255], textColor: [0, 0, 0], fontStyle: "bold" }, columnStyles: { 0: { fontStyle: "bold" } }, styles: { fontSize: 10 } });
      y = doc.lastAutoTable.finalY + 30;
      doc.setFontSize(14);
      doc.text("Variation de la Trésorerie", 40, y);
      autoTable.call(doc, { startY: y + 10, body: [["Solde initial", fmt(soldeInitial) + " FCFA"], ["Entrées", fmt(totalEntrees) + " FCFA"], ["Injection", fmt(totalInjection) + " FCFA"], ["Dépenses", "-" + fmt(totalDepenses) + " FCFA"], ["Approvisionnement", "-" + fmt(totalAppro) + " FCFA"], ["Profit", fmt(totalProfit) + " FCFA"], ["Solde final", fmt(soldeFinal) + " FCFA"], ["Dette Papa", fmt(dettePapa) + " FCFA"], ["Stock téléphones", fmt(closingVal) + " FCFA"], ["Valeur business", fmt(valeurBusiness) + " FCFA"],], theme: "grid", headStyles: { fillColor: [255, 255, 255], textColor: [0, 0, 0], fontStyle: "bold" }, columnStyles: { 0: { fontStyle: "bold" } }, styles: { fontSize: 10 } });


      const fileName = `${fileNamePrefix}${saisie}.pdf`;
      if (autoPrintReport) {
        try {
          doc.autoPrint();
          const blobUrl = doc.output('bloburl');
          window.open(blobUrl);
        } catch (printErr) {
          console.warn("Impossible de lancer l'impression automatique du rapport :", printErr);
        }
      }
      doc.save(fileName);
      if (afterGenerateCallback) {
        try {
          afterGenerateCallback({
            fileName,
            dateString: saisie,
            totals: {
              soldeInitial,
              totalEntrees,
              totalInjection,
              totalDepenses,
              totalAppro,
              soldeFinal,
              closingStockValue: closingVal,
              valeurBusiness
            }
          });
        } catch (callbackError) {
          console.warn("Callback post-génération du rapport journalier en erreur :", callbackError);
        }
      }
    })
    .catch(err => {
      console.error("Erreur lors de la génération du PDF:", err);
      alert("Erreur lors de la génération du PDF : " + err.message);
      throw err;
    });
}


const exportDailyReportPDFOriginal = exportDailyReportPDF;

function exportDailyReportPDFForDate(dateString, options = {}) {
  if (!dateString) {
    return Promise.reject(new Error('La date du rapport est requise.'));
  }

  const {
    includeProfitDetail = true,
    autoPrint = false,
    fileNamePrefix = 'Rapport_',
    onAfterGenerate = null
  } = options;

  const originalPrompt = window.prompt;
  const originalConfirm = window.confirm;

  window.__exportDailyReportOptions = {
    autoPrint,
    fileNamePrefix,
    onAfterGenerate
  };

  window.prompt = () => dateString;
  window.confirm = () => includeProfitDetail;

  let promise;
  try {
    promise = exportDailyReportPDFOriginal();
  } finally {
    window.prompt = originalPrompt;
    window.confirm = originalConfirm;
  }

  if (promise && typeof promise.then === 'function') {
    return promise;
  }
  return Promise.resolve();
}

let closeDayInProgress = false;

async function finalizeTresorerieForDate(dateString) {
  const trimmedDate = (dateString || '').trim();
  const parsedDate = new Date(trimmedDate + 'T00:00:00');
  if (isNaN(parsedDate.getTime())) {
    throw new Error('Date de clôture invalide.');
  }

  const nextDate = new Date(parsedDate);
  nextDate.setDate(parsedDate.getDate() + 1);
  const nextDateString = nextDate.toISOString().slice(0, 10);

  const comptesSnapshot = await dbFirestore
    .collection('tresorerie')
    .doc('balance')
    .collection('comptesTresorerie')
    .get();

  const compteRefs = comptesSnapshot.docs.map(doc => doc.ref);

  const result = await dbFirestore.runTransaction(async tx => {
    const snapshotsCol = dbFirestore.collection('tresorerieSnapshots');
    const todayRef = snapshotsCol.doc(trimmedDate);
    const tomorrowRef = snapshotsCol.doc(nextDateString);

    const todaySnapPromise = tx.get(todayRef);
    const tomorrowSnapPromise = tx.get(tomorrowRef);
    const compteSnapPromises = compteRefs.map(ref => tx.get(ref));

    const todaySnap = await todaySnapPromise;
    const tomorrowSnap = await tomorrowSnapPromise;
    const compteSnaps = await Promise.all(compteSnapPromises);

    const serializeAccounts = () => {
      const acc = {};
      compteRefs.forEach((ref, index) => {
        const snap = compteSnaps[index];
        const data = snap && snap.exists ? snap.data() || {} : {};
        const solde = Number(data.solde) || 0;
        acc[ref.id] = {
          nom: data.nom || ref.id,
          solde
        };
      });
      return acc;
    };

    const closingAccounts = serializeAccounts();
    const closingBalanceGlobal = Object.values(closingAccounts)
      .reduce((sum, info) => sum + (Number(info.solde) || 0), 0);

    const closingCaisse = closingAccounts.caisse ? Number(closingAccounts.caisse.solde) || 0 : 0;
    const closingMomo = closingAccounts.momo ? Number(closingAccounts.momo.solde) || 0 : 0;
    const closingBanque = closingAccounts.banque ? Number(closingAccounts.banque.solde) || 0 : 0;

    const user = firebase.auth && firebase.auth().currentUser ? firebase.auth().currentUser : null;
    const serverTimestamp = firebase.firestore.FieldValue.serverTimestamp;

    const existingTodayData = todaySnap.exists ? todaySnap.data() || {} : {};
    const openingFallback = {};
    if (typeof existingTodayData.openingBalanceGlobal !== 'number') {
      openingFallback.openingBalanceGlobal = closingBalanceGlobal;
    }
    if (typeof existingTodayData.openingCaisse !== 'number') {
      openingFallback.openingCaisse = closingCaisse;
    }
    if (typeof existingTodayData.openingMomo !== 'number') {
      openingFallback.openingMomo = closingMomo;
    }
    if (typeof existingTodayData.openingBanque !== 'number') {
      openingFallback.openingBanque = closingBanque;
    }
    if (!existingTodayData.openingByAccount) {
      openingFallback.openingByAccount = closingAccounts;
    }

    const todayPayload = Object.assign({}, openingFallback, {
      dateString: trimmedDate,
      closingBalanceGlobal,
      closingCaisse,
      closingMomo,
      closingBanque,
      closingByAccount: closingAccounts,
      closedAt: serverTimestamp(),
      closedBy: user ? user.uid : null
    });

    if (!todaySnap.exists) {
      todayPayload.createdAt = serverTimestamp();
    }

    const openingAccountsForTomorrow = JSON.parse(JSON.stringify(closingAccounts));
    const tomorrowPayload = {
      dateString: nextDateString,
      openingBalanceGlobal: closingBalanceGlobal,
      openingCaisse: closingCaisse,
      openingMomo: closingMomo,
      openingBanque: closingBanque,
      openingByAccount: openingAccountsForTomorrow,
      openingPreparedFrom: trimmedDate,
      openingPreparedAt: serverTimestamp()
    };

    if (!tomorrowSnap.exists) {
      tomorrowPayload.createdAt = serverTimestamp();
    }

    tx.set(todayRef, todayPayload, { merge: true });
    tx.set(tomorrowRef, tomorrowPayload, { merge: true });

    return {
      dateString: trimmedDate,
      nextDateString,
      closingBalanceGlobal,
      closingAccounts
    };
  });

  return result;
}

async function closeDayAndPrint() {
  if (closeDayInProgress) {
    return;
  }

  const filterInput = document.getElementById('treso-date-filter');
  const todayIso = new Date().toISOString().slice(0, 10);
  const targetDateString = filterInput && filterInput.value ? filterInput.value : todayIso;
  const parsedDate = new Date(targetDateString + 'T00:00:00');

  if (isNaN(parsedDate.getTime())) {
    alert('Date de clôture invalide.');
    return;
  }

  const now = new Date();
  const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  if (parsedDate > todayStart) {
    alert('Impossible de clôturer une journée future.');
    return;
  }

  const formattedDate = parsedDate.toLocaleDateString('fr-FR');

  const closeButton = document.getElementById('btnCloseDay');
  let originalHtml = null;
  if (closeButton) {
    originalHtml = closeButton.innerHTML;
    closeButton.disabled = true;
    closeButton.innerHTML = '<span>Cloture en cours…</span>';
  }

  closeDayInProgress = true;

  try {
    const closingInfo = await finalizeTresorerieForDate(targetDateString);

    const stockSnapshot = await enregistrerSnapshotStockPourDate(
      closingInfo.nextDateString,
      null,
      { preparedFrom: targetDateString }
    );

    await exportDailyReportPDFForDate(targetDateString, {
      includeProfitDetail: true,
      autoPrint: true,
      fileNamePrefix: 'Cloture_'
    });

    if (typeof showToast === 'function') {
      const stockInfo = stockSnapshot
        ? ` | Stock téléphones demain : ${stockSnapshot.units} u.`
        : '';
      showToast(`Clôture du ${formattedDate} enregistrée. Solde final : ${fmt(closingInfo.closingBalanceGlobal)} FCFA${stockInfo}.`);
    }
  } catch (error) {
    console.error('Erreur lors de la clôture quotidienne :', error);
    alert('Impossible de clôturer la journée : ' + error.message);
  } finally {
    closeDayInProgress = false;
    if (closeButton) {
      closeButton.disabled = false;
      closeButton.innerHTML = originalHtml;
      if (typeof lucide !== 'undefined' && lucide.createIcons) {
        refreshLucideIcons();
      }
    }

    if (filterInput && !filterInput.value) {
      filterInput.value = targetDateString;
    }

    try {
      updateBalanceDisplay();
    } catch (refreshError) {
      console.warn('Actualisation du tableau de trésorerie impossible :', refreshError);
    }
  }
}


const isPhone = it => (it.category || "").toLowerCase() === "telephones";


function getRange(collection, field, startTs, endTs){
  return dbFirestore.collection(collection)
    .where(field, '>=', startTs)
    .where(field, '<=', endTs)
    .get();
}

async function countPhonesSold(startTs, endTs){
  const snap = await getRange('ventes','timestamp',startTs,endTs);
  let total = 0;
  snap.forEach(d=>{
    (d.data().items||[]).forEach(it=>{
      if(isPhone(it)) total += parseInt(it.quantite)||0;
    });
  });
  return total;
}

/* ============================================================
   UI : demande le mois puis lance l'export
   ============================================================ */
function askMonthlyExport(){
  const mois = prompt('Mois à exporter (AAAA-MM) :',
                      new Date().toISOString().slice(0,7));
  if(!mois || !/^\d{4}-\d{2}$/.test(mois)) return;
  exportMonthlyReportPDF(mois)
    .catch(err=>alert('Erreur export mensuel : '+err.message));
}
// ===== EXPORT MENSUEL AVEC DÉTECTION D'ANOMALIES =====
async function exportMonthlyReportPDF(month) {
  if (!/^\d{4}-\d{2}$/.test(month)) {
    throw new Error("Format de mois invalide (AAAA-MM attendu).");
  }

  // 1) Bornes temporelles
  const [Y, M] = month.split("-").map(Number);
  const startTs = new Date(Y, M - 1, 1, 0, 0, 0, 0).getTime();
  const endTs = new Date(Y, M, 0, 23, 59, 59, 999).getTime();

  // 2) Snapshots
  const [
    ventesSnap,
    depSnap,
    rembSnap,
    approSnap,
    stockPhonesVal,
    dettePapa,
    nbPhones
  ] = await Promise.all([
    getRange("ventes", "timestamp", startTs, endTs),
    getRange("depenses", "timestamp", startTs, endTs),
    getRange("remboursements", "timestamp", startTs, endTs),
    getRange("approvisionnement", "timestamp", startTs, endTs),
    dbFirestore
      .collection("stock")
      .where("category", "==", "telephones")
      .get()
      .then(s => {
        let v = 0;
        s.forEach(d => {
          v += (d.data().stock || 0) * (d.data().price || 0);
        });
        return v;
      }),
    dbFirestore
      .collection("depensePapa")
      .doc("balance")
      .get()
      .then(d => (d.exists ? d.data().montant || 0 : 0)),
    countPhonesSold(startTs, endTs)
  ]);

  // 3) Agrégations VENTES → CA, profit, quantité
  let ca = 0,
    profit = 0,
    qtyVentes = 0;
  const caParJour = Array(new Date(Y, M, 0).getDate()).fill(0);
  const profitByProd = {};
  const qtyByProd = {};

  ventesSnap.forEach(doc => {
    const v = doc.data();
    if (v.status === 'annulé') return;
    const dayIdx = new Date(v.timestamp).getDate() - 1;
    caParJour[dayIdx] += +v.overallTotal;
    ca += +v.overallTotal;
    profit += +v.totalProfit;
    qtyVentes++;

    (v.items || []).forEach(item => {
      const p = item.produit;
      const q = parseInt(item.quantite) || 0;
      const pTot = parseFloat(item.profitTotal) || 0;
      qtyByProd[p] = (qtyByProd[p] || 0) + q;
      profitByProd[p] = (profitByProd[p] || 0) + pTot;
    });
  });

  // 4) Préparation tableau profit par article
  const profitRows = Object.entries(profitByProd)
    .sort((a, b) => b[1] - a[1])
    .map(([prod, p]) => [prod, qtyByProd[prod].toString(), fmt(p) + " FCFA"]);

  // 5) Détection anomalies sur totalProfit de chaque vente mensuelle
  const allProfits = ventesSnap.docs.map(d => parseFloat(d.data().totalProfit) || 0);
  const mean = allProfits.reduce((s, v) => s + v, 0) / allProfits.length || 0;
  const variance =
    allProfits.reduce((s, v) => s + Math.pow(v - mean, 2), 0) / allProfits.length || 0;
  const stdDev = Math.sqrt(variance);
  const threshold = mean + 3 * stdDev;
  const outliers = ventesSnap.docs
    .map(d => ({ id: d.id, ...d.data() }))
    .filter(sale => parseFloat(sale.totalProfit) > threshold);

  // 6) Génération du PDF
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "pt", format: "a4", compress: true });
  doc.setFontSize(18);
  doc.text(`Rapport mensuel – ${month}`, 40, 40);

  // --- Résumé exécutif ---
  doc.autoTable({
    startY: 60,
    theme: "grid",
    styles: { fontSize: 10 },
    body: [
      ["CA total", fmt(ca) + " FCFA"],
      ["Profit brute", fmt(profit) + " FCFA"],
      ["Nb ventes", qtyVentes.toString()],
      ["Téléphones vendus", nbPhones.toString()],

      [
        "Approvisionnements",
      fmt(
        // ✅ ON AJOUTE LE FILTRE AVANT LE RESTE DES OPERATIONS
        approSnap.docs.filter(doc => doc.data().status !== 'annulé') 
          .flatMap(d => d.data().items || [])
          .reduce((s, it) => s + it.quantite * it.prixAchat, 0)
      ) + " FCFA"
      ],

    ],
    columnStyles: { 0: { fontStyle: "bold" } }
  });

  // --- Top 10 modèles ---
  const top10 = Object.entries(qtyByProd)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10)
    .map(([m, q]) => [m, q.toString()]);
  doc.addPage();
  doc.setFontSize(14);
  doc.text("Top 10 modèles (quantité)", 40, 40);
  doc.autoTable({
    startY: 50,
    head: [["Modèle", "Qté"]],
    body: top10,
    styles: { fontSize: 10 }
  });

  // --- Profit par article ---
  doc.addPage();
  doc.setFontSize(14);
  doc.text("Profit par article", 40, 40);
  doc.autoTable({
  startY: 50,
  head: [["Article", "Qté", "Profit cumulé"]],
  body: profitRows,
  foot: [["", "TOTAL", fmt(profit) + " FCFA"]],
  showFoot: 'lastPage',               // ← n'affiche le pied que sur la dernière page
  headStyles: { fillColor: [240,240,240] },
  footStyles: { fontStyle: "bold" },
  styles: { fontSize: 10 }
});


  doc.save(`Rapport_${month}.pdf`);
}

async function lireEtatStockTelephones() {
  const snap = await dbFirestore
    .collection("stock")
    .where("category", "==", "telephones")
    .get();

  let units = 0;
  let value = 0;

  snap.forEach(doc => {
    const data  = doc.data();
    const qty   = parseFloat(data.stock) || 0;
    const price = parseFloat(data.price) || 0;
    units += qty;
    value += qty * price;
  });

  return { units, value };
}

async function enregistrerSnapshotStockPourDate(dateString, stockState = null, options = {}) {
  const target = (dateString || "").trim();
  if (!target) {
    throw new Error("Date de snapshot invalide.");
  }

  const state = stockState || await lireEtatStockTelephones();
  const preparedFrom = options.preparedFrom || options.sourceDate || dateString;

  await dbFirestore
    .collection("stockSnapshots")
    .doc(target)
    .set({
      openingStock      : state.units,
      openingStockValue : state.value,
      preparedAt        : firebase.firestore.FieldValue.serverTimestamp(),
      preparedFrom
    }, { merge: true });

  return state;
}

async function startDay() {
  const today = new Date().toISOString().slice(0, 10);
  const snapshot = await enregistrerSnapshotStockPourDate(today);

  showToast(
    `Stock initial : ${snapshot.units} u. - ${snapshot.value.toLocaleString()} FCFA`
  );
  window.location.hash = 'vendre';
}


// Attacher l'écouteur
document.getElementById("btnStartDay").addEventListener("click", startDay);

window.addEventListener('load', async () => {
  const today = new Date().toISOString().slice(0,10);
  const doc = await dbFirestore.collection("stockSnapshots").doc(today).get();
  if (!doc.exists) {
    window.location.hash = 'start-day';
  } else if (!window.location.hash) {
    window.location.hash = 'vendre';
  }
});

window.addEventListener('hashchange', handleHashChange);

/**
 * Charge et affiche l'historique des variations
 * pour un stock donné (appro + ventes).
 *
 * @param {string} stockId
 */
async function chargerHistoriqueStock(stockId) {
  const container = document.getElementById("stockHistoryContainer");
  container.innerHTML = "<p>Chargement de l'historique...</p>";

  try {
    let articleName = '';
    if (stockId) {
      const stockDoc = await dbFirestore.collection("stock").doc(stockId).get();
      if (stockDoc.exists) {
        articleName = stockDoc.data().name || '';
      }
    }

    const snapshot = await dbFirestore
      .collection("stock")
      .doc(stockId)
      .collection("history")
      .orderBy("timestamp", "desc")
      .get();

    container.innerHTML = "";
    if (snapshot.empty) {
      container.innerHTML = "<p>Aucune variation de stock.</p>";
      return;
    }

    snapshot.forEach(doc => {
      const d = doc.data();
      const dateObj = d.timestamp && typeof d.timestamp.toDate === "function"
        ? d.timestamp.toDate()
        : null;
      const date = dateObj ? dateObj.toLocaleString("fr-FR") : "Date indisponible";
      const change = d.change || 0;
      const signe = change > 0 ? "+" : "";

      let typeDisplay = "Mouvement";
      let iconHtml = '<i data-lucide="help-circle"></i>';
      switch (d.type) {
        case "approvisionnement":
        case "approvisionnement-reception":
          typeDisplay = "Approvisionnement";
          iconHtml = '<i data-lucide="arrow-up" style="color: green;"></i>';
          break;
        case "vente":
          typeDisplay = "Vente";
          iconHtml = '<i data-lucide="arrow-down" style="color: red;"></i>';
          break;
        case "annulation_achat":
          typeDisplay = "Annulation achat";
          iconHtml = '<i data-lucide="arrow-down" style="color: orange;"></i>';
          break;
        case "annulation_vente":
          typeDisplay = "Retour vente";
          iconHtml = '<i data-lucide="arrow-up" style="color: #3880ff;"></i>';
          break;
        case "ajustement_stock":
          typeDisplay = "Ajustement stock";
          iconHtml = '<i data-lucide="settings" style="color: #6366f1;"></i>';
          break;
      }

      const row = document.createElement("div");
      row.className = "history-item";
      row.style.cssText = "display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee;";
      row.innerHTML = `
        <div style="margin-right: 12px; font-size: 24px; line-height: 1;">${iconHtml}</div>
        <div style="flex-grow: 1;">
          <strong style="font-size: 1em;">${typeDisplay}</strong><br>
          <small style="color: #666;">${date}</small>
          ${d.reason ? `<span class="history-reason">Raison : ${escapeHtmlStock(d.reason)}</span>` : ''}
        </div>
        <div style="text-align: right;">
          <strong style="color: ${change > 0 ? 'green' : 'red'}; font-size: 1.1em;">${signe}${change}</strong><br>
          <small>Stock final: ${d.newStock != null ? d.newStock : 'N/A'}</small>
        </div>
      `;

      if (['approvisionnement', 'approvisionnement-reception'].includes(d.type)) {
        row.classList.add('history-item-clickable');
        const openPurchaseModal = () => {
          if (d.sourceApproId) {
            ouvrirModalAchatStock(d.sourceApproId, d, articleName || d.sourceApproItemName || '');
          } else if (typeof showToast === 'function') {
            showToast("Aucun detail disponible pour cet achat.", "warning");
          } else {
            alert("Aucun detail disponible pour cet achat.");
          }
        };
        row.addEventListener('click', openPurchaseModal);
        row.setAttribute('role', 'button');
        row.setAttribute('tabindex', '0');
        row.addEventListener('keydown', evt => {
          if (evt.key === 'Enter' || evt.key === ' ') {
            evt.preventDefault();
            openPurchaseModal();
          }
        });
      }

      container.appendChild(row);
    });

    if (typeof refreshLucideIcons === 'function') {
      refreshLucideIcons();
    }
  } catch (err) {
    console.error("Erreur historique :", err);
    container.innerHTML = "<p>Erreur de chargement.</p>";
  }
}

/**
 * Prépare et demande la confirmation pour l'annulation d'un achat.
 * @param {string} approId - L'ID du document d'approvisionnement à annuler.
 * @param {Event} event - L'objet d'événement du clic.
 */
async function preparerAnnulationAchat(approId, event) {
    // Empêche le clic de se propager et ferme l'item-sliding
    event.stopPropagation();
    const slidingItem = event.target.closest('ion-item-sliding');
    if (slidingItem) {
        await slidingItem.close();
    }

    const confirmation = confirm("Êtes-vous certain de vouloir annuler cet achat ?\n\nCette action va retirer les articles du stock et annuler l'impact sur la trésorerie. Elle est irréversible.");
    
    if (!confirmation) {
        showToast("Opération abandonnée.");
        return;
    }

    showSaleLoader(); // Affiche le spinner de chargement

    try {
        const approRef = dbFirestore.collection("approvisionnement").doc(approId);
        const approDoc = await approRef.get();

        if (!approDoc.exists) throw new Error("Cet achat n'existe pas.");
        
        const approData = approDoc.data();
        if (approData.status === 'annulé') throw new Error("Cet achat est déjà annulé.");

        await annulerAchatTransaction(approId, approData);
        
        showToast("Achat annulé avec succès !");
        
        chargerApprovisionnements(document.getElementById('purchase-tabs').value);
        updateBalanceDisplay();
        updateStockSummary();

    } catch (error) {
        console.error("Erreur lors de l'annulation de l'achat :", error);
        alert("Erreur : " + error.message);
    } finally {
        hideSaleLoader(); // Masque le spinner
    }
}


/**
 * Executes the cancellation of a purchase within a secure Firestore transaction.
 * @param {string} approId - The ID of the purchase.
 * @param {object} approData - The data of the purchase to cancel.
 */
/**
 * Executes the cancellation of a purchase within a secure Firestore transaction.
 * MODIFIED: Deletes the purchase record instead of marking it as cancelled.
 * @param {string} approId - The ID of the purchase.
 * @param {object} approData - The data of the purchase to cancel.
 */
function annulerAchatTransaction(approId, approData) {
    return dbFirestore.runTransaction(async (transaction) => {
        const approRef = dbFirestore.collection("approvisionnement").doc(approId);

        // --- 1. Supprimer le document d'achat au lieu de le mettre à jour ---
        transaction.delete(approRef); // ✅ LIGNE MODIFIÉE

        // 2. Reverse stock impact for each item AND recalculate average cost
        for (const item of approData.items) {
            const stockQuerySnapshot = await dbFirestore.collection("stock").where("name", "==", item.produit).limit(1).get();

            if (!stockQuerySnapshot.empty) {
                const stockDocRef = stockQuerySnapshot.docs[0].ref;
                const stockData = stockQuerySnapshot.docs[0].data();

                const currentStock = stockData.stock || 0;
                const currentAvgPrice = stockData.price || 0;
                const cancelledQty = item.quantite;
                const cancelledItemCost = item.adjustedPrixAchat || item.prixAchat;
                
                const newStock = Math.max(0, currentStock - cancelledQty);

                let newAvgPrice;
                if (newStock > 0) {
                    newAvgPrice = ((currentStock * currentAvgPrice) - (cancelledQty * cancelledItemCost)) / newStock;
                } else {
                    newAvgPrice = currentAvgPrice; // Garde l'ancien prix si le stock tombe à 0
                }

                transaction.update(stockDocRef, {
                    stock: newStock,
                    price: newAvgPrice 
                });

                const historyRef = stockDocRef.collection("history").doc();
                transaction.set(historyRef, {
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    change: -cancelledQty,
                    type: 'annulation_achat',
                    refId: approId,
                    newStock: newStock,
                    sourceApproId: approId,
                    sourceApproItemName: item.produit || ''
                });

                if (item.category === 'telephones' && item.imeis && item.imeis.length > 0) {
                    for (const imei of item.imeis) {
                        const imeiDocRef = stockDocRef.collection("imeis").doc(imei);
                        transaction.delete(imeiDocRef);
                    }
                }
            }
        }

        // 3. Reverse ALL payments (initial cash AND subsequent credit payments)
        const paymentsSnapshot = await approRef.collection("payments").get();
        if (!paymentsSnapshot.empty) {
            for (const paymentDoc of paymentsSnapshot.docs) {
                const paymentData = paymentDoc.data();
                const compteId = paymentData.account;
                const amount = paymentData.amount;

                const compteRef = dbFirestore.collection('tresorerie').doc('balance').collection('comptesTresorerie').doc(compteId);
                transaction.update(compteRef, { solde: firebase.firestore.FieldValue.increment(amount) });

                const mouvementRef = compteRef.collection('mouvements').doc();
                transaction.set(mouvementRef, {
                    timestamp: Date.now(),
                    type: 'annulation_paiement_achat',
                    sens: 'in',
                    montant: amount,
                    description: `Annulation Paiement Achat #${approId.substring(0,5)}`,
                    refId: approId
                });

                transaction.update(paymentDoc.ref, { status: 'annulé' });
            }
        } else if (approData.paymentMethod === 'cash') {
            const compteId = approData.compteId;
            if (compteId) {
                const totalCost = parseFloat(approData.totalCost) || 0;
                const compteRef = dbFirestore.collection('tresorerie').doc('balance').collection('comptesTresorerie').doc(compteId);
                transaction.update(compteRef, { solde: firebase.firestore.FieldValue.increment(totalCost) });

                const mouvementRef = compteRef.collection('mouvements').doc();
                transaction.set(mouvementRef, {
                    timestamp: Date.now(),
                    type: 'annulation_achat',
                    sens: 'in',
                    montant: totalCost,
                    description: `Annulation Achat #${approId.substring(0, 5)}`,
                    refId: approId
                });
            }
        }

        // 4. Reverse and DELETE the transport fee expense
        if (approData.fraisTransport && approData.fraisTransport > 0) {
            const transportExpenseQuery = await dbFirestore.collection("depenses").where("refId", "==", approId).where("type", "==", "depense fonctionnelle").limit(1).get();
            if (!transportExpenseQuery.empty) {
                const expenseDocRef = transportExpenseQuery.docs[0].ref;
                const expenseData = transportExpenseQuery.docs[0].data();
                const transportCompteId = expenseData.compteId || 'caisse';
                
                transaction.delete(expenseDocRef);

                const compteRef = dbFirestore.collection('tresorerie').doc('balance').collection('comptesTresorerie').doc(transportCompteId);
                transaction.update(compteRef, { solde: firebase.firestore.FieldValue.increment(approData.fraisTransport) });

                const mouvementRef = compteRef.collection('mouvements').doc();
                transaction.set(mouvementRef, {
                    timestamp: Date.now(),
                    type: 'annulation_frais_transport',
                    sens: 'in',
                    montant: approData.fraisTransport,
                    description: `Annulation Frais Transport Achat #${approId.substring(0,5)}`,
                    refId: approId
                });
            }
        }
    });
}


/**
 * Gère l'annulation d'une vente dans une transaction sécurisée.
 * @param {string} saleId - L'ID de la vente à annuler.
 */
/**
 * Gère l'annulation d'une vente dans une transaction sécurisée.
 * MODIFIÉ : Supprime la vente au lieu de la marquer comme annulée.
 * @param {string} saleId - L'ID de la vente à annuler.
 */
async function annulerVente(saleId) {
    if ((typeof window !== 'undefined' && window.userRole === 'employe') ||
        (typeof document !== 'undefined' && document.body.classList.contains('role-employe'))) {
        throw new Error("Permission refusée : vous ne pouvez pas annuler cette vente.");
    }
    const saleRef = dbFirestore.collection("ventes").doc(saleId);

    try {
        await dbFirestore.runTransaction(async (transaction) => {
            const saleDoc = await transaction.get(saleRef);
            if (!saleDoc.exists) {
                throw new Error("La vente n'existe pas !");
            }

            const saleData = saleDoc.data();

            // Si la vente a déjà le statut "annulé" (ancienne méthode), on la supprime aussi
            if (saleData.status === 'annulé') {
                 console.log("Cette vente était déjà marquée comme annulée, suppression en cours...");
            }

            // --- 1. On supprime la vente de la base de données ---
            transaction.delete(saleRef); // ✅ LIGNE MODIFIÉE

            // --- 2. On remet les articles dans le stock ---
            // NOUVEAU BLOC À COLLER À LA PLACE DE L'ANCIEN
for (const item of saleData.items) {
    const stockQuery = await dbFirestore.collection("stock").where("name", "==", item.produit).limit(1).get();

    if (!stockQuery.empty) {
        const stockDocRef = stockQuery.docs[0].ref;
        const stockData = stockQuery.docs[0].data();
        const oldStock = stockData.stock || 0;
        const newStockAfterCancellation = oldStock + item.quantite;

        // 1. On met à jour le stock (on remet les articles)
        transaction.update(stockDocRef, {
            stock: newStockAfterCancellation
        });

        // --- C'EST LA PARTIE QUI EST AJOUTÉE ---
        // 2. On enregistre ce retour en stock dans l'historique de l'article
        const historyRef = stockDocRef.collection("history").doc();
        transaction.set(historyRef, {
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            change: +item.quantite, // Mouvement positif car on remet en stock
            newStock: newStockAfterCancellation,
            type: 'annulation_vente', // L'étiquette pour l'affichage
            refId: saleId
        });
        // --- FIN DE LA PARTIE AJOUTÉE ---
    }
}

            // --- 3. On inverse l'opération de trésorerie ---
            const paiementDetails = Array.isArray(saleData.paymentsDetails) ? saleData.paymentsDetails : [];
            if (paiementDetails.length > 0) {
                for (const paiement of paiementDetails) {
                    const compteAnnulation = paiement.compteId || saleData.principalCompteId || 'caisse';
                    const montantEncaisse = parseFloat(paiement.montantEncaisse) || 0;
                    const monnaieRendue = parseFloat(paiement.monnaieRendue) || 0;

                    if (montantEncaisse > 0) {
                        await enregistrerMouvementTresorerie({
                            compteId: compteAnnulation,
                            type: 'annulation_vente',
                            sens: 'out',
                            montant: montantEncaisse,
                            description: `Annulation Vente ${saleData.clientNom} - retrait encaissement`,
                            refId: saleId
                        });
                    }

                    if (monnaieRendue > 0) {
                        await enregistrerMouvementTresorerie({
                            compteId: compteAnnulation,
                            type: 'annulation_vente_change',
                            sens: 'in',
                            montant: monnaieRendue,
                            description: `Annulation Vente ${saleData.clientNom} - restitution monnaie`,
                            refId: saleId
                        });
                    }
                }
            } else {
                const montantVente = parseFloat(saleData.overallTotal) || 0;
                const compteId = saleData.compteId || 'caisse';

                await enregistrerMouvementTresorerie({
                    compteId: compteId,
                    type: 'annulation_vente',
                    sens: 'out',
                    montant: montantVente,
                    description: `Annulation Vente ${saleData.clientNom}`,
                    refId: saleId
                });
            }
        });

        // Si tout s'est bien passé
        showToast("Vente supprimée avec succès !");

    } catch (error) {
        console.error("Erreur lors de la suppression de la vente : ", error);
        alert("Erreur : " + error.message);
    }
}
async function creerDettesDeVente(saleId, saleData) {
    console.log("Vérification des dettes de consignation pour la vente :", saleId);

    const batch = dbFirestore.batch();

    for (const item of saleData.items) {
        // Pour chaque article vendu, on cherche le dernier approvisionnement de type "dépôt" le contenant.
        // Cette méthode (Dernier entré, premier sorti) est la plus simple à implémenter.
        const approQuery = dbFirestore.collection('approvisionnement')
            .where('typeAchat', '==', 'depot')
            .where('productNames', 'array-contains', item.produit)
            .orderBy('timestamp', 'desc')
            .limit(1);

        const approSnapshot = await approQuery.get();

        // Si on trouve un approvisionnement en dépôt correspondant...
        if (!approSnapshot.empty) {
            const approDoc = approSnapshot.docs[0];
            const approInfo = approDoc.data();

            console.log(`L'article ${item.produit} provient d'un dépôt du fournisseur ${approInfo.fournisseur}. Création de la dette.`);

            // On récupère le coût d'achat au moment de la vente (calculé sur le prix moyen)
            const coutAchatReel = item.coutAchat || 0;

            // On crée une nouvelle "fiche de dette" dans une nouvelle collection "dettesConsignation"
            const detteRef = dbFirestore.collection("dettesConsignation").doc();
            batch.set(detteRef, {
                fournisseur: approInfo.fournisseur,
                produit: item.produit,
                quantite: item.quantite,
                coutAchat: coutAchatReel,
                montantDu: coutAchatReel * item.quantite, // Montant dû pour cet article
                venteId: saleId,
                dateVente: saleData.timestamp,
                approvisionnementId: approDoc.id,
                status: 'a_payer' // Le statut initial est "à payer"
            });
        }
    }

    // On exécute toutes les créations de dettes en une seule fois
    await batch.commit();
    console.log("Traitement des dettes de consignation terminé.");
}

/**
 * Gère l'affichage principal du Hub Dépôts.
 */
function setupSupplierHub() {
    const listContainer = document.getElementById('fournisseurs-hub-list');
    const detailContainer = document.getElementById('fournisseur-detail-view');

    if (!listContainer || !detailContainer) return;

    // Affiche la liste et cache les détails par défaut
    listContainer.style.display = 'block';
    detailContainer.style.display = 'none';

    chargerHubDepots(); // La fonction est renommée pour plus de clarté

    // Logique du bouton retour et des onglets
    document.getElementById('backToHubListBtn').addEventListener('click', () => {
        listContainer.style.display = 'block';
        detailContainer.style.display = 'none';
    });

    const tabs = document.getElementById('supplier-detail-tabs');
    tabs.addEventListener('ionChange', (event) => {
        if (currentSupplierDetailData) {
            renderSupplierDetailContent(event.detail.value, currentSupplierDetailData);
        }
    });
}

/**
 * Récupère et agrège les données des fournisseurs ayant des dépôts actifs.
 */
async function chargerHubDepots() {
    const listContainer = document.getElementById("fournisseursHubListContainer");
    listContainer.innerHTML = `<ion-item><ion-label style="text-align:center;"><ion-spinner name="crescent"></ion-spinner></ion-label></ion-item>`;

    try {
        const suppliersWithDeposits = {};

        // 1. Récupérer UNIQUEMENT les approvisionnements de type 'dépôt'
        const approSnapshot = await dbFirestore.collection("approvisionnement")
            .where('typeAchat', '==', 'depot')
            .where('status', '!=', 'annulé')
            .get();

        approSnapshot.forEach(doc => {
            const appro = { id: doc.id, ...doc.data() };
            const name = appro.fournisseur || 'Inconnu';

            if (!suppliersWithDeposits[name]) {
                suppliersWithDeposits[name] = { name: name, initialValue: 0, soldValue: 0, procurements: [] };
            }
            suppliersWithDeposits[name].initialValue += parseFloat(appro.totalCost || 0);
            suppliersWithDeposits[name].procurements.push(appro);
        });

        // 2. Récupérer les dettes de consignation pour calculer la valeur vendue
        const dettesSnapshot = await dbFirestore.collection("dettesConsignation").get();
        dettesSnapshot.forEach(doc => {
            const dette = doc.data();
            const name = dette.fournisseur;
            if (suppliersWithDeposits[name]) {
                // On somme la valeur de tous les articles vendus (payés ou non)
                suppliersWithDeposits[name].soldValue += parseFloat(dette.montantDu || 0);
            }
        });

        // Vider la liste
        listContainer.innerHTML = "";
        
        // Filtrer pour ne garder que les fournisseurs avec un stock de dépôt restant
        const activeDepositSuppliers = Object.values(suppliersWithDeposits)
            .filter(s => (s.initialValue - s.soldValue) > 1); // Garde une marge pour les erreurs de calcul

        if (activeDepositSuppliers.length === 0) {
            listContainer.innerHTML = `<ion-item><ion-label style="text-align:center; color: #888;">Aucun dépôt fournisseur actif trouvé.</ion-label></ion-item>`;
            return;
        }

        // 3. Afficher chaque fournisseur
        for (const data of activeDepositSuppliers) {
            const remainingValue = data.initialValue - data.soldValue;
            const initials = data.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            const avatarBgColor = getAvatarColor(data.name);

            const ionItem = document.createElement('ion-item');
            ionItem.button = true;
            ionItem.innerHTML = `
                <div class="avatar-circle" slot="start" style="background-color: ${avatarBgColor};">${initials}</div>
                <ion-label>
                    <h2>${data.name}</h2>
                    <p>Dépôt initial: ${data.initialValue.toLocaleString('fr-FR')} FCFA</p>
                </ion-label>
                <div class="right-info" slot="end">
                    <div class="total-amount" style="color: #28a745;">
                        ${remainingValue.toLocaleString('fr-FR')} FCFA
                    </div>
                    <div class="payment-method">STOCK RESTANT</div>
                </div>
            `;
            ionItem.addEventListener('click', () => afficherVueDetailleeFournisseur(data));
            listContainer.appendChild(ionItem);
        }

    } catch (error) {
        console.error("Erreur chargement Hub Dépôts:", error);
        listContainer.innerHTML = `<ion-item><ion-label style="color:red; text-align:center;">Erreur de chargement.</ion-label></ion-item>`;
    }
}

/**
 * Affiche la vue détaillée pour un fournisseur spécifique.
 */
function afficherVueDetailleeFournisseur(supplierData) {
    currentSupplierDetailData = supplierData;
    document.getElementById('fournisseurs-hub-list').style.display = 'none';
    document.getElementById('fournisseur-detail-view').style.display = 'block';
    document.getElementById('supplierDetailNameHeader').textContent = `Dépôt - ${supplierData.name}`;

    document.getElementById('supplier-detail-tabs').value = 'resume';
    renderSupplierDetailContent('resume', supplierData);
}

/**
 * Génère le contenu HTML pour l'onglet sélectionné dans la vue de détail.
 */
async function renderSupplierDetailContent(tabName, supplierData) {
    const contentEl = document.getElementById('supplier-detail-content');
    contentEl.innerHTML = `<div class="ion-text-center ion-padding"><ion-spinner name="crescent"></ion-spinner></div>`;

    let html = '';
    switch (tabName) {
        case 'resume':
            const initialValue = supplierData.initialValue || 0;
            const soldValue = supplierData.soldValue || 0;
            const remainingValue = initialValue - soldValue;

            html = `
                <ion-card>
                    <ion-card-header><ion-card-title>Résumé du Dépôt</ion-card-title></ion-card-header>
                    <ion-card-content>
                        <ion-list lines="none">
                            <ion-item>
                                <ion-label>Valeur initiale totale déposée:</ion-label>
                                <ion-note slot="end">${initialValue.toLocaleString('fr-FR')} FCFA</ion-note>
                            </ion-item>
                            <ion-item>
                                <ion-label>Valeur des articles vendus (dette):</ion-label>
                                <ion-note slot="end" color="danger">${soldValue.toLocaleString('fr-FR')} FCFA</ion-note>
                            </ion-item>
                            <ion-item>
                                <ion-label><h2>Valeur du stock restant:</h2></ion-label>
                                <ion-note slot="end" color="primary"><h2>${remainingValue.toLocaleString('fr-FR')} FCFA</h2></ion-note>
                            </ion-item>
                        </ion-list>
                    </ion-card-content>
                </ion-card>
            `;
            break;

        case 'stock':
             html = `<ion-card>
                        <ion-card-header><ion-card-title>Articles en Dépôt (Liste Initiale)</ion-card-title></ion-card-header>
                        <ion-card-content><ion-list lines="full">`;
            supplierData.procurements.forEach(appro => {
                 (appro.items || []).forEach(item => {
                    html += `<ion-item><ion-label>${item.produit}</ion-label><ion-note slot="end">Qté initial: ${item.quantite}</ion-note></ion-item>`;
                });
            });
            html += `</ion-list></ion-card-content></ion-card>`;
            break;

        case 'history':
            html = `<ion-card>
                        <ion-card-header><ion-card-title>Historique des Dépôts</ion-card-title></ion-card-header>
                        <ion-card-content><ion-list>`;
            supplierData.procurements
                .sort((a,b) => b.timestamp.toMillis() - a.timestamp.toMillis())
                .forEach(appro => {
                    const approDate = appro.timestamp.toDate().toLocaleDateString('fr-FR');
                    html += `
                        <ion-item>
                            <ion-label>
                                <h2>Dépôt du ${approDate}</h2>
                                <p>Total: ${parseFloat(appro.totalCost || 0).toLocaleString('fr-FR')} FCFA</p>
                                <p>${(appro.items || []).map(i => i.quantite + 'x ' + i.produit).join(', ')}</p>
                            </ion-label>
                        </ion-item>
                    `;
                });
            html += `</ion-list></ion-card-content></ion-card>`;
            break;
    }
    contentEl.innerHTML = html;
}

window.addEventListener('hashchange', function() {
    if (window.location.hash === '#depots-fournisseurs') {
        setupSupplierHub();
    }
});
// Appel initial si la page est chargée directement avec le hash
if (window.location.hash === '#depots-fournisseurs') {
    setupSupplierHub();
}

/**
 * Après une vente, cette fonction vérifie chaque article vendu.
 * Si un article provient d'un approvisionnement en dépôt, elle crée
 * une "dette de consignation" envers le fournisseur concerné.
 * @param {string} saleId - L'ID de la vente qui vient d'être enregistrée.
 * @param {object} saleData - Les données complètes de la vente.
 */
async function creerDettesDeVente(saleId, saleData) {
    console.log("Vérification des dettes de consignation pour la vente :", saleId);

    const batch = dbFirestore.batch();

    for (const item of saleData.items) {
        // Pour chaque article vendu, on cherche le dernier approvisionnement de type "dépôt" le contenant.
        // Cette méthode (Dernier entré, premier sorti) est la plus simple à implémenter.
        const approQuery = dbFirestore.collection('approvisionnement')
            .where('typeAchat', '==', 'depot')
            .where('productNames', 'array-contains', item.produit)
            .orderBy('timestamp', 'desc')
            .limit(1);

        const approSnapshot = await approQuery.get();

        // Si on trouve un approvisionnement en dépôt correspondant...
        if (!approSnapshot.empty) {
            const approDoc = approSnapshot.docs[0];
            const approInfo = approDoc.data();

            console.log(`L'article ${item.produit} provient d'un dépôt du fournisseur ${approInfo.fournisseur}. Création de la dette.`);

            // On récupère le coût d'achat au moment de la vente (calculé sur le prix moyen)
            const coutAchatReel = item.coutAchat || 0;

            // On crée une nouvelle "fiche de dette" dans une nouvelle collection "dettesConsignation"
            const detteRef = dbFirestore.collection("dettesConsignation").doc();
            batch.set(detteRef, {
                fournisseur: approInfo.fournisseur,
                produit: item.produit,
                quantite: item.quantite,
                coutAchat: coutAchatReel,
                montantDu: coutAchatReel * item.quantite, // Montant dû pour cet article
                venteId: saleId,
                dateVente: saleData.timestamp,
                approvisionnementId: approDoc.id,
                status: 'a_payer' // Le statut initial est "à payer"
            });
        }
    }

    // On exécute toutes les créations de dettes en une seule fois
    await batch.commit();
    console.log("Traitement des dettes de consignation terminé.");
}









</script>
<script src="livraison.js"></script>
<script>
function ouvrirModalLivraisonEncaissement() {
  if (!currentLivraisonData || !currentLivraisonId) {
    setLivraisonDetailAlert("Sélectionnez une livraison avant d'encaisser.", 'danger');
    return;
  }
  if (!peutGererLivraisonCourante()) {
    setLivraisonDetailAlert("Vous ne pouvez pas encaisser cette livraison.", 'warning');
    return;
  }
  livraisonModalContext = {
    totals: computeLivraisonTotals(currentLivraisonData)
  };
  const modal = document.getElementById('modalLivraisonEncaissement');
  if (!modal) return;
  resetLivraisonPayments(livraisonModalContext.totals.outstanding);
  rafraichirResumePaiementLivraison();
  modal.style.display = 'flex';
  if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
    refreshLucideIcons();
  }
}

function fermerModalLivraisonEncaissement() {
  const modal = document.getElementById('modalLivraisonEncaissement');
  if (modal) {
    modal.style.display = 'none';
  }
  const warningEl = document.getElementById('livraison-payment-warning');
  if (warningEl) {
    warningEl.textContent = '';
  }
  livraisonModalContext = null;
}

function resetLivraisonPayments(defaultAmount = 0) {
  livraisonPayments = [];
  livraisonPaymentAutoId = 0;
  const preset = defaultAmount > 0 ? { montantEncaisse: defaultAmount.toFixed(2) } : {};
  ajouterLignePaiementLivraison(preset);
}

function ajouterLignePaiementLivraison(initialData) {
  const payload = initialData || {};
  livraisonPayments.push({
    id: ++livraisonPaymentAutoId,
    compteId: payload.compteId || '',
    montantEncaisse: payload.montantEncaisse || '',
    monnaieRendue: payload.monnaieRendue || ''
  });
  renderLivraisonPayments();
}

function renderLivraisonPayments() {
  const container = document.getElementById('livraisonPaymentsContainer');
  if (!container) return;
  container.innerHTML = '';

  livraisonPayments.forEach(payment => {
    const row = document.createElement('div');
    row.className = 'vente-payment-row';
    row.dataset.paymentId = payment.id;

    const compteSelect = document.createElement('select');
    compteSelect.id = `compteSelectLivraisonModal-${payment.id}`;
    compteSelect.className = 'vente-payment-account';
    compteSelect.addEventListener('change', event => {
      onLivraisonPaymentFieldChange(payment.id, 'compteId', event.target.value);
    });
    row.appendChild(compteSelect);

    const amountInput = document.createElement('input');
    amountInput.type = 'number';
    amountInput.min = '0';
    amountInput.step = '100';
    amountInput.placeholder = 'Montant encaissé';
    amountInput.value = payment.montantEncaisse || '';
    amountInput.addEventListener('input', event => {
      onLivraisonPaymentFieldChange(payment.id, 'montantEncaisse', event.target.value);
    });
    row.appendChild(amountInput);

    const changeInput = document.createElement('input');
    changeInput.type = 'number';
    changeInput.min = '0';
    changeInput.step = '100';
    changeInput.placeholder = 'Monnaie rendue';
    changeInput.value = payment.monnaieRendue || '';
    changeInput.addEventListener('input', event => {
      onLivraisonPaymentFieldChange(payment.id, 'monnaieRendue', event.target.value);
    });
    row.appendChild(changeInput);

    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'vente-payment-remove btn-modern secondary';
    removeBtn.innerHTML = '<i data-lucide="trash-2"></i>';
    removeBtn.addEventListener('click', () => supprimerLignePaiementLivraison(payment.id));
    row.appendChild(removeBtn);

    container.appendChild(row);

    remplirTousSelectComptes(compteSelect);
    compteSelect.value = payment.compteId || '';
  });

  if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
    refreshLucideIcons();
  }

  rafraichirResumePaiementLivraison();
}

function onLivraisonPaymentFieldChange(paymentId, field, value) {
  const payment = livraisonPayments.find(p => p.id === paymentId);
  if (!payment) return;
  payment[field] = value;
  rafraichirResumePaiementLivraison();
}

function supprimerLignePaiementLivraison(paymentId) {
  if (livraisonPayments.length <= 1) {
    const unique = livraisonPayments[0];
    if (unique) {
      unique.compteId = '';
      unique.montantEncaisse = '';
      unique.monnaieRendue = '';
    }
    renderLivraisonPayments();
    return;
  }
  livraisonPayments = livraisonPayments.filter(p => p.id !== paymentId);
  renderLivraisonPayments();
}

function analyserPaiementsLivraison() {
  let totalEncaisse = 0;
  let totalChange = 0;
  let message = '';
  let valid = true;

  for (const payment of livraisonPayments) {
    if (!valid) break;
    const encaisse = parseFloat(payment.montantEncaisse) || 0;
    const change = parseFloat(payment.monnaieRendue) || 0;

    if (encaisse < 0 || change < 0) {
      valid = false;
      message = 'Les montants encaissés ou rendus ne peuvent pas être négatifs.';
      break;
    }

    if ((encaisse > 0 || change > 0) && !payment.compteId) {
      valid = false;
      message = 'Sélectionnez un compte de trésorerie pour chaque encaissement.';
      break;
    }

    totalEncaisse += encaisse;
    totalChange += change;
  }

  const net = totalEncaisse - totalChange;
  if (valid && net < 0) {
    valid = false;
    message = 'Le net encaissé ne peut pas être négatif.';
  }

  return { valid, message, totalEncaisse, totalChange, net };
}

function rafraichirResumePaiementLivraison() {
  const totals = livraisonModalContext ? livraisonModalContext.totals : { due: 0, totalEncaisse: 0, totalChange: 0, net: 0, outstanding: 0 };
  const stats = analyserPaiementsLivraison();
  const totalEncaisseGlobal = totals.totalEncaisse + stats.totalEncaisse;
  const totalChangeGlobal = totals.totalChange + stats.totalChange;
  const netGlobal = totals.net + stats.net;
  const remaining = Math.max(0, totals.due - netGlobal);

  const dueEl = document.getElementById('livraison-summary-total-due');
  const paidEl = document.getElementById('livraison-summary-total-paid');
  const changeEl = document.getElementById('livraison-summary-total-change');
  const netEl = document.getElementById('livraison-summary-net');
  const warningEl = document.getElementById('livraison-payment-warning');

  if (dueEl) dueEl.textContent = formatXofAmount(totals.due);
  if (paidEl) paidEl.textContent = formatXofAmount(totalEncaisseGlobal - totalChangeGlobal);
  if (changeEl) changeEl.textContent = formatXofAmount(totalChangeGlobal);
  if (netEl) netEl.textContent = formatXofAmount(netGlobal);
  if (warningEl) warningEl.textContent = stats.valid ? '' : (stats.message || '');

  return { stats, totals, totalEncaisseGlobal, totalChangeGlobal, netGlobal, remaining };
}

async function validerEncaissementLivraison() {
  if (!currentLivraisonData || !currentLivraisonId || !livraisonModalContext) return;
  if (!peutGererLivraisonCourante()) {
    setLivraisonDetailAlert("Vous ne pouvez pas encaisser cette livraison.", 'warning');
    return;
  }

  const summary = rafraichirResumePaiementLivraison();
  const { stats, remaining } = summary;
  const warningEl = document.getElementById('livraison-payment-warning');

  if (!stats.valid) {
    if (warningEl) warningEl.textContent = stats.message || 'Veuillez vérifier les encaissements.';
    return;
  }

  if (remaining > 0.5) {
    if (warningEl) warningEl.textContent = `Il reste ${formatXofAmount(remaining)} à encaisser avant de clôturer.`;
    return;
  }

  const newPayments = livraisonPayments
    .map(payment => {
      const montant = parseFloat(payment.montantEncaisse) || 0;
      const monnaie = parseFloat(payment.monnaieRendue) || 0;
      if (montant === 0 && monnaie === 0) {
        return null;
      }
      const compteId = payment.compteId;
      const compteInfo = Array.isArray(comptesCache) ? comptesCache.find(c => c.id === compteId) || {} : {};
      return {
        compteId,
        compteNom: compteInfo.nom || compteId,
        montantEncaisse: montant,
        monnaieRendue: monnaie,
        netEncaisse: montant - monnaie
      };
    })
    .filter(Boolean);

  if (warningEl) warningEl.textContent = '';

  showLivraisonDetailLoader(true);
  try {
    if (newPayments.length) {
      await appliquerEncaissementsLivraison(newPayments);
    }
    await finaliserLivraisonReussie();
    fermerModalLivraisonEncaissement();
  } catch (error) {
    console.error('Erreur validation livraison :', error);
    setLivraisonDetailAlert("Impossible de finaliser la livraison : " + error.message, 'danger');
  } finally {
    showLivraisonDetailLoader(false);
  }
}

async function appliquerEncaissementsLivraison(newPayments) {
  if (!newPayments || !newPayments.length) return;

  const sumEncaisse = newPayments.reduce((acc, p) => acc + (parseFloat(p.montantEncaisse) || 0), 0);
  const sumChange = newPayments.reduce((acc, p) => acc + (parseFloat(p.monnaieRendue) || 0), 0);
  const netAdditionnel = sumEncaisse - sumChange;

  const updatedPayments = Array.isArray(currentLivraisonData.paymentsDetails)
    ? [...currentLivraisonData.paymentsDetails, ...newPayments]
    : [...newPayments];

  const payload = {
    paymentsDetails: updatedPayments,
    paymentsTotalEncaisse: (parseFloat(currentLivraisonData.paymentsTotalEncaisse) || 0) + sumEncaisse,
    paymentsTotalChange: (parseFloat(currentLivraisonData.paymentsTotalChange) || 0) + sumChange,
    paymentsNetEncaisse: (parseFloat(currentLivraisonData.paymentsNetEncaisse) || 0) + netAdditionnel,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  if (!currentLivraisonData.principalCompteId) {
    const netPositif = newPayments.find(p => (p.netEncaisse || 0) > 0);
    if (netPositif) {
      payload.principalCompteId = netPositif.compteId;
      payload.compteId = netPositif.compteId;
    }
  }

  await updateSaleFirestore(currentLivraisonId, payload);

  for (const payment of newPayments) {
    if (payment.montantEncaisse > 0) {
      await enregistrerMouvementTresorerie({
        compteId: payment.compteId,
        type: 'livraison_encaissement',
        sens: 'in',
        montant: payment.montantEncaisse,
        description: `Encaissement livraison ${currentLivraisonData.clientNom || ''}`,
        refId: currentLivraisonId
      });
    }
    if (payment.monnaieRendue > 0) {
      await enregistrerMouvementTresorerie({
        compteId: payment.compteId,
        type: 'livraison_change',
        sens: 'out',
        montant: payment.monnaieRendue,
        description: `Monnaie rendue livraison ${currentLivraisonData.clientNom || ''}`,
        refId: currentLivraisonId
      });
    }
  }

  currentLivraisonData.paymentsDetails = updatedPayments;
  currentLivraisonData.paymentsTotalEncaisse = payload.paymentsTotalEncaisse;
  currentLivraisonData.paymentsTotalChange = payload.paymentsTotalChange;
  currentLivraisonData.paymentsNetEncaisse = payload.paymentsNetEncaisse;
  if (payload.principalCompteId) {
    currentLivraisonData.principalCompteId = payload.principalCompteId;
    currentLivraisonData.compteId = payload.principalCompteId;
  }
}

async function finaliserLivraisonReussie() {
  if (!currentLivraisonData || !currentLivraisonId) return;

  if (!currentLivraisonData.convertedToSale) {
    await updateStockAfterSaleFirestore(currentLivraisonData.items || []);
  }

  await updateSaleFirestore(currentLivraisonId, {
    deliveryStatus: 'réussie',
    convertedToSale: true,
    deliveryClosedAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  currentLivraisonData.deliveryStatus = 'réussie';
  currentLivraisonData.convertedToSale = true;
  populateLivraisonDetailView(currentLivraisonData);
  setLivraisonDetailAlert('Livraison marquée comme réussie.', 'success');
  filterSalesHistory(document.getElementById('sales-tabs').value || 'all');
  afficherLivraisons();
  updateAccueilSummary();
}
</script>
</body>
</html>

